// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/Accessor ../../core/Collection ../../core/CollectionFlattener ../../core/Error ../../core/lang ../../core/Logger ../../core/accessorSupport/decorators ../../core/accessorSupport/ensureType ../../core/accessorSupport/PropertyOrigin ../support/Sublayer ../support/sublayerUtils".split(" "),function(r,t,v,w,f,x,l,y,z,u,A,d,B,m,k,n){function p(c,b,a){var g=
[],h={};c.forEach(function(e){var c=new k;c.read(e,b);a&&(-1===a.indexOf(c.id)?c.visible=!1:c.visible=!0);h[c.id]=c;null!=e.parentLayerId&&-1!==e.parentLayerId?(e=h[e.parentLayerId],e.sublayers||(e.sublayers=[]),e.sublayers.unshift(c)):g.unshift(c)});return g}function q(c,b){var a=b.get(c.id);a?(u.mixin(c.__accessor__.store._values,a.__accessor__.store._values),a.__accessor__.overridden&&(c.__accessor__.overridden=u.mixin(c.__accessor__.overridden||{},a.__accessor__.overridden)),a.sublayers&&(c.sublayers=
a.sublayers.map(function(a){return q(a,b)}))):c.sublayers&&c.sublayers.forEach(function(a){return q(a,b)});return c}Object.defineProperty(t,"__esModule",{value:!0});var C=A.getLogger("esri.layers.TileLayer");r=function(c){function b(){var a=c.call(this)||this;a.allSublayers=new y({root:a,rootCollectionNames:["sublayers"],getChildrenFunction:function(a){return a.sublayers}});a.watch("sublayers",function(g,b){return a._handleSublayersChange(g,b)},!0);return a}w(b,c);b.prototype.readServiceSublayers=
function(a,g,b){return p(g.layers,b)};b.prototype.readSublayersFromItemOrWebMap=function(a,b,c){return!b.layers&&b.visibleLayers?b.visibleLayers.map(function(a){return{id:a}}):p(b.layers,c,b.visibleLayers)};b.prototype.readSublayers=function(a,b,c){a=p(b.layers,c);this._updateSublayersForOrigin(m.OriginId.PORTAL_ITEM,a);this._updateSublayersForOrigin(m.OriginId.WEB_MAP,a);this._updateSublayersForOrigin(m.OriginId.WEB_SCENE,a);return a};b.prototype.writeSublayers=function(a,b,c,e){a=a.flatten(function(a){return(a=
a.sublayers)&&a.toArray().reverse()}).toArray().reverse();var g=this.serviceSublayers.flatten(function(a){return(a=a.sublayers)&&a.toArray().reverse()}).toArray().reduce(function(a,b){a.set(b.id,b);return a},new Map),h=!1,d=!0;this.capabilities&&this.capabilities.operations.supportsExportMap&&this.capabilities.exportMap.supportsDynamicLayers?(h=n.isExportDynamic(a,this.serviceSublayers,this),d=!h&&n.sameStructureAsService(a,this.serviceSublayers)):d=n.sameStructureAsService(a,this.serviceSublayers);
b.layers=[];a.forEach(function(a){var c=g.get(a.id),c=v({writeAsDynamic:h,writeOverridesOnly:d,serviceSublayer:c},e);a=a.write({},c);(!d||d&&1<Object.keys(a).length)&&b.layers.push(a)});b.visibleLayers=a.filter(function(a){return a.visible}).map(function(a){return a.id})};b.prototype.findSublayerById=function(a){return this.allSublayers.find(function(b){return b.id===a})};b.prototype.createServiceSublayers=function(){return this.serviceSublayers.map(function(a){return a.clone()})};b.prototype._updateSublayersForOrigin=
function(a,b){var c=this.__accessor__.store;if(c.has("sublayers",a)){var e=c.get("sublayers",a).flatten(function(a){return a.sublayers});if(e.every(function(a){return!a.__accessor__.store._values.hasOwnProperty("minScale")})){var d=e.reduce(function(a,b){a.set(b.id,b);return a},new Map);b=b.map(function(a){return q(a.clone(),d)});c.set("sublayers",new (l.ofType(k))(b),a)}}};b.prototype._handleSublayersChange=function(a,b){var c=this;b&&(b.forEach(function(a){a.parent=null;a.layer=null}),this._sublayersHandles.forEach(function(a){return a.remove()}),
this._sublayersHandles=null);a&&(a.forEach(function(a){a.parent=c;a.layer=c}),this._sublayersHandles=[a.on("after-add",function(a){a=a.item;a.parent=c;a.layer=c}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})],"tile"===this.type&&this._sublayersHandles.push(a.on("before-changes",function(a){C.error(new z("tilelayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{layer:c}));a.preventDefault()})))};f([d.property({readOnly:!0})],
b.prototype,"allSublayers",void 0);f([d.property({readOnly:!0,type:l.ofType(k)})],b.prototype,"serviceSublayers",void 0);f([d.reader("service","serviceSublayers",["layers"])],b.prototype,"readServiceSublayers",null);f([d.property({value:null,type:l.ofType(k),json:{type:[Number],write:{target:"subLayerIds",allowNull:!0}}})],b.prototype,"sublayers",void 0);f([d.reader(["web-map","web-scene","portal-item"],"sublayers",["layers","visibleLayers"])],b.prototype,"readSublayersFromItemOrWebMap",null);f([d.reader("service",
"sublayers",["layers"])],b.prototype,"readSublayers",null);f([d.writer(["web-map","web-scene","portal-item"],"sublayers",{layers:{type:[k]},visibleLayers:{type:[B.Integer]}})],b.prototype,"writeSublayers",null);return b=f([d.subclass("esri.layers.mixins.SublayersOwner")],b)}(d.declared(x));t.default=r});