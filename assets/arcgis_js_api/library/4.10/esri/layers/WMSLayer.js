// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper dojo/_base/url ../config ../Graphic ../PopupTemplate ../request ../core/Collection ../core/CollectionFlattener ../core/Handles ../core/promiseUtils ../core/accessorSupport/decorators ../core/accessorSupport/write ../geometry/Extent ../geometry/SpatialReference ../geometry/support/spatialReferenceUtils ./Layer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/ExportWMSImageParameters ./support/WMSSublayer ./support/wmsUtils".split(" "),
function(p,O,g,y,e,z,q,A,B,l,C,D,r,m,d,E,t,h,F,G,H,I,J,K,L,u,M,n,v){function N(d,b){return d.some(function(a){for(var f in a)if(E.willPropertyWrite(a,f,null,b))return!0;return!1})}function x(d,b,a){var f=[],c=new Map;d.forEach(function(d){var e=new n;e.read(d,b);a&&-1===a.indexOf(e.name)&&(e.visible=!1);c[e.id]=e;null!=d.parentLayerId&&-1!==d.parentLayerId?(d=c[d.parentLayerId],d.sublayers||(d.sublayers=[]),d.sublayers.unshift(e)):f.unshift(e)});return f}return function(w){function b(a,f){var c=w.call(this)||
this;c._sublayersHandles=new r;c.allSublayers=new D({root:c,rootCollectionNames:["sublayers"],getChildrenFunction:function(a){return a.sublayers}});c.customParameters=null;c.customLayerParameters=null;c.copyright=null;c.description=null;c.fullExtent=null;c.fullExtents=null;c.featureInfoFormat=null;c.featureInfoUrl=null;c.imageFormat=null;c.imageMaxHeight=2048;c.imageMaxWidth=2048;c.imageTransparency=!0;c.legendEnabled=!0;c.mapUrl=null;c.operationalLayerType="WMS";c.spatialReference=null;c.spatialReferences=
null;c.sublayers=null;c.type="wms";c.url=null;c.version=null;c.watch("sublayers",function(a,f){f&&(f.forEach(function(a){a.layer=null}),c._sublayersHandles.removeAll(),c._sublayersHandles=null);a&&(a.forEach(function(a){a.parent=c;a.layer=c}),c._sublayersHandles||(c._sublayersHandles=new r),c._sublayersHandles.add([a.on("after-add",function(a){a=a.item;a.parent=c;a.layer=c}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})]))},!0);return c}y(b,w);b.prototype.normalizeCtorArgs=
function(a,f){return"string"===typeof a?g({url:a},f):a};b.prototype.load=function(){var a=this;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]}).then(function(){return a._fetchService()}));return this.when()};b.prototype.readFullExtentFromItemOrMap=function(a,f,c){a=f.extent;return(f=f.spatialReferences)&&0<f.length?new t({xmin:a[0][0],ymin:a[0][1],xmax:a[1][0],ymax:a[1][1],spatialReference:f[0]}):new t({xmin:a[0][0],ymin:a[0][1],xmax:a[1][0],ymax:a[1][1]})};b.prototype.writeFullExtent=
function(a,f,c,b){f.extent=[[a.xmin,a.ymin],[a.xmax,a.ymax]]};b.prototype.readImageFormat=function(a,f){return(a=f.supportedImageFormatTypes)&&-1<a.indexOf("image/png")?"image/png":a&&a[0]};b.prototype.readSpatialReferenceFromItemOrDocument=function(a,f,c){return new h(f.spatialReferences[0])};b.prototype.writeSpatialReferences=function(a,f,c,b){var d=this.spatialReference&&this.spatialReference.wkid;a&&d?(f.spatialReferences=a.filter(function(a){return a!==d}),f.spatialReferences.unshift(d)):f.spatialReferences=
a};b.prototype.readSublayersFromItemOrMap=function(a,f,c){return x(f.layers,c,f.visibleLayers)};b.prototype.readSublayers=function(a,f,c){return x(f.layers,c)};b.prototype.writeSublayers=function(a,f,c,b){f.layers=[];var d=new Map;a=a.flatten(function(a){return(a=a.sublayers)&&a.toArray()}).toArray();a.forEach(function(a){"number"===typeof a.parent.id&&(d.has(a.parent.id)?d.get(a.parent.id).push(a.id):d.set(a.parent.id,[a.id]))});a.forEach(function(a){var c=g({sublayer:a},b),e=a.write({parentLayerId:"number"===
typeof a.parent.id?a.parent.id:-1},c);d.has(a.id)&&(e.sublayerIds=d.get(a.id));!a.sublayers&&a.name&&(a=a.write({},c),delete a.id,f.layers.push(a))});f.visibleLayers=a.filter(function(a){return a.visible&&!a.sublayers}).map(function(a){return a.name})};b.prototype.createExportImageParameters=function(a){this._exportWMSImageParameters=new M({layer:this,extent:a});return this._exportWMSImageParameters.toJSON()};b.prototype.fetchImage=function(a,f,c,b){var d=this.mapUrl;a={responseType:"image",query:this._mixCustomParameters(g({width:f,
height:c},this.createExportImageParameters(a)))};b&&b.timestamp&&(a.query=g({_ts:b.timestamp},a.query));return l(d,a).then(function(a){return a.data})};b.prototype.fetchFeatureInfo=function(a,b,c,d,e){var f=this,h=v.getPopupLayers(this._exportWMSImageParameters.visibleSublayers);if(!this.featureInfoUrl||!h)return null;b=g({query_layers:h,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:b,height:c},"1.3.0"===this.version?{I:d,J:e}:{x:d,y:e});var k=g({},this.createExportImageParameters(a),
b),k=this._mixCustomParameters(k);return l(this.featureInfoUrl,{query:k,responseType:"text"}).then(function(a){var b=f.featureInfoUrl,b=b+(-1===b.indexOf("?")?"?":""),c;for(c in k)b+="?"===b.substring(b.length-1,b.length)?"":"\x26",b+=c+"\x3d"+k[c];return new A({sourceLayer:f,popupTemplate:new B({title:f.title,content:'\x3ciframe src\x3d"'+b+'" frameborder\x3d"0" marginwidth\x3d"0" marginheight\x3d"0"\x3e'+a.data+"\x3c/iframe\x3e"})})})};b.prototype.findSublayerById=function(a){return this.allSublayers.find(function(b){return b.id===
a})};b.prototype.supportsSpatialReference=function(a){return L.isWmsServer(this.url)||this.spatialReferences.some(function(b){b=900913===b?h.WebMercator:new h({wkid:b});return F.equals(b,a)})};b.prototype.importLayerViewModule=function(a){switch(a.type){case "2d":return m.create(function(a){return p(["../views/2d/layers/WMSLayerView2D"],a)});case "3d":return m.create(function(a){return p(["../views/3d/layers/WMSLayerView3D"],a)})}};b.prototype._fetchService=function(){var a=this;return m.resolve().then(function(){if(a.resourceInfo)return{data:a.resourceInfo};
a.parsedUrl.query&&a.parsedUrl.query.service&&(a.parsedUrl.query.SERVICE=a.parsedUrl.query.service,delete a.parsedUrl.query.service);a.parsedUrl.query&&a.parsedUrl.query.request&&(a.parsedUrl.query.REQUEST=a.parsedUrl.query.request,delete a.parsedUrl.query.request);return l(a.parsedUrl.path,{query:g({SERVICE:"WMS",REQUEST:"GetCapabilities"},a.parsedUrl.query,a.customParameters),responseType:"xml"})}).then(function(b){if(!a.resourceInfo){b.data=v.parseCapabilities(b.data);var c=new z(a.parsedUrl.path);
"https"!==c.scheme||c.port&&"443"!==c.port||-1!==q.request.httpsDomains.indexOf(c.host)||q.request.httpsDomains.push(c.host)}b.data&&a.read(b.data,{origin:"service"})})};b.prototype._mixCustomParameters=function(a){if(!this.customLayerParameters&&!this.customParameters)return a;var b=g({},this.customParameters,this.customLayerParameters),c;for(c in b)a[c.toLowerCase()]=b[c];return a};e([d.property({readOnly:!0})],b.prototype,"allSublayers",void 0);e([d.property({json:{write:!0}})],b.prototype,"customParameters",
void 0);e([d.property({json:{write:!0}})],b.prototype,"customLayerParameters",void 0);e([d.property({type:String,json:{write:!0}})],b.prototype,"copyright",void 0);e([d.property()],b.prototype,"description",void 0);e([d.property({json:{type:[[Number]],read:{source:"extent"},write:{target:"extent"},origins:{service:{read:{source:"extent"}}}}})],b.prototype,"fullExtent",void 0);e([d.reader(["web-document","portal-item"],"fullExtent",["extent"])],b.prototype,"readFullExtentFromItemOrMap",null);e([d.writer(["web-document",
"portal-item"],"fullExtent",{extent:{type:[[Number]]}})],b.prototype,"writeFullExtent",null);e([d.property()],b.prototype,"fullExtents",void 0);e([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"featureInfoFormat",void 0);e([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"featureInfoUrl",void 0);e([d.property({type:String,json:{origins:{"web-document":{default:"png",read:{source:"format"},write:{target:"format"}}}}})],b.prototype,"imageFormat",void 0);
e([d.reader("imageFormat",["supportedImageFormatTypes"])],b.prototype,"readImageFormat",null);e([d.property({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],b.prototype,"imageMaxHeight",void 0);e([d.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],b.prototype,"imageMaxWidth",void 0);e([d.property()],b.prototype,"imageTransparency",void 0);e([d.property(u.legendEnabled)],b.prototype,"legendEnabled",void 0);e([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],
b.prototype,"mapUrl",void 0);e([d.property({type:["WMS"]})],b.prototype,"operationalLayerType",void 0);e([d.property({type:h,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],b.prototype,"spatialReference",void 0);e([d.reader(["web-document","portal-item"],"spatialReference",["spatialReferences"])],b.prototype,"readSpatialReferenceFromItemOrDocument",null);e([d.property({type:[Number],json:{read:{source:"spatialReferences"},write:{ignoreOrigin:!0}}})],b.prototype,"spatialReferences",
void 0);e([d.writer(["web-document","portal-item"],"spatialReferences")],b.prototype,"writeSpatialReferences",null);e([d.property({type:C.ofType(n),json:{write:{target:"layers",overridePolicy:function(a,b,c){if(N(this.allSublayers,c))return{ignoreOrigin:!0}}}}})],b.prototype,"sublayers",void 0);e([d.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],b.prototype,"readSublayersFromItemOrMap",null);e([d.reader("service","sublayers",["layers"])],b.prototype,"readSublayers",
null);e([d.writer("sublayers",{layers:{type:[n]},visibleLayers:{type:[String]}})],b.prototype,"writeSublayers",null);e([d.property({json:{read:!1},readOnly:!0,value:"wms"})],b.prototype,"type",void 0);e([d.property(u.url)],b.prototype,"url",void 0);e([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"version",void 0);return b=e([d.subclass("esri.layers.WMSLayer")],b)}(d.declared(G,H,I,J,K))});