// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports @dojo/framework/shim/Set ../../../core/promiseUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./utils".split(" "),function(z,A,D,l,B,E,F,C,G,H,u){function I(d){return d?JSON.parse(JSON.stringify(d,["latestWkid","wkid","wkt"])):d}Object.defineProperty(A,"__esModule",{value:!0});z=function(){function d(a,b){this.items=a;this.definitionExpression=
b.definitionExpression;this.geometryType=b.geometryType;this.hasM=b.hasM;this.hasZ=b.hasZ;this.objectIdField=b.objectIdField;this.spatialReference=b.spatialReference;this.fieldsMap=b.fieldsMap}Object.defineProperty(d.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0});d.prototype.createQueryResponse=function(a){return a.outStatistics?a.outStatistics.some(function(b){return"exceedslimit"===b.statisticType})?this._createExceedsLimitQueryResponse(a):this._createStatisticsQueryResponse(a):
this._createFeatureQueryResponse(a)};d.prototype.executeAttributesQuery=function(a){var b=G.getWhereClause(a.where);if(!b)return l.resolve(this);if(b.isStandardized()){for(var f=0,h=[],c=0,g=this.items;c<g.length;c++){var e=g[c];b.testFeature(e.attributes)&&(h[f++]=e)}b=this._createNew(h);b.definitionExpression=a.where;return l.resolve(b)}return l.reject(new TypeError("Where clause is not standardized"))};d.prototype.executeObjectIdsQuery=function(a){if(!a.objectIds||!a.objectIds.length)return l.resolve(this);
var b=new D.default(a.objectIds);return l.resolve(this._createNew(this.items.filter(function(a){return b.has(a.objectId)})))};d.prototype.project=function(a){var b=this;return!a||E.equals(this.spatialReference,a)?l.resolve(this):H.projectMany(this.items.map(function(a){return u.getGeometry(b,a)}),this.spatialReference,a).then(function(f){for(var h=[],c=0;c<b.items.length;c++)h[c]={attributes:b.items[c].attributes,geometry:f[c]};f=[];F.convertFromFeatures(f,h,b.geometryType,b.hasZ,b.hasM,b.objectIdField);
return new d(f,{definitionExpression:b.definitionExpression,geometryType:b.geometryType,hasM:b.hasM,hasZ:b.hasZ,objectIdField:b.objectIdField,spatialReference:a,fieldsMap:b.fieldsMap})})};d.prototype._createFeatureQueryResponse=function(a){var b=this,f=this.items,h=this.geometryType,c=this.hasM,g=this.hasZ,e=this.objectIdField,d=this.spatialReference,m=a.outFields,p=a.outSpatialReference,q=a.quantizationParameters,t=!1;if(null!=a.num&&null!=a.start)var k=a.start+a.num,t=f.length>k,f=f.slice(a.start,
Math.min(f.length,k));return{exceededTransferLimit:t,features:this._createFeatures(a,f),fields:m&&m.map(function(a){return b.fieldsMap.get(a)}),geometryType:h,hasM:c,hasZ:g,objectIdFieldName:e,spatialReference:I(p?p.toJSON():d),transform:q&&B.toTransform(q)}};d.prototype._createFeatures=function(a,b){var f=new C.default(a,this.fieldsMap),h=a.quantizationParameters,c=a.returnGeometry,g=a.returnCentroid,e=a.maxAllowableOffset,d=a.orderByFields;a=[];var m=0;if(b.length&&d&&d.length){var d=d[0].split(" "),
p=d[0],q="DESC"===d[1];b.sort(function(a,b){a=f.getFieldValue(a,p);b=f.getFieldValue(b,p);if("number"===typeof a&&"number"===typeof b)return q?b-a:a-b;if("string"===typeof a&&"string"===typeof b)return a=a.toUpperCase(),b=b.toUpperCase(),(q?a>b:a<b)?-1:(q?a<b:a>b)?1:0})}if(c||g)if(h=B.toTransform(h),c&&!g)for(g=0;g<b.length;g++)c=b[g],a[m++]={attributes:f.getAttributes(c),geometry:u.getGeometry(this,c,e,h)};else if(!c&&g)for(e=0;e<b.length;e++)c=b[e],a[m++]={attributes:f.getAttributes(c),centroid:u.getCentroid(this,
c,h)};else for(g=0;g<b.length;g++)c=b[g],a[m++]={attributes:f.getAttributes(c),centroid:u.getCentroid(this,c,h),geometry:u.getGeometry(this,c,e,h)};else for(e=0;e<b.length;e++)c=b[e],(c=f.getAttributes(c))&&(a[m++]={attributes:c});return a};d.prototype._createNew=function(a){return new d(a,this)};d.prototype._createExceedsLimitQueryResponse=function(a){var b=!1,f=null;a.outStatistics.some(function(a){f=a;return"exceedslimit"===a.statisticType});var b=null!=f.maxPointCount?f.maxPointCount:Number.POSITIVE_INFINITY,
h=null!=f.maxRecordCount?f.maxRecordCount:Number.POSITIVE_INFINITY;a=null!=f.maxVertexCount?f.maxVertexCount:Number.POSITIVE_INFINITY;"esriGeometryPoint"===this.geometryType?b=this.items.length>b:this.items.length>h?b=!0:(b=this.hasZ?this.hasM?4:3:this.hasM?3:2,b=this.items.reduce(function(a,b){return a+(b.geometry&&b.geometry.coords.length||0)},0)/b>a);return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};
d.prototype._createStatisticsQueryResponse=function(a){var b=new C.default(a,this.fieldsMap),f=[],h=[],c=a.groupByFieldsForStatistics,g=a.having,e=c&&c.length,c=e&&c[0],d={},m={},p={},q={attributes:{}},t=0;for(a=a.outStatistics;t<a.length;t++){var k=a[t],r=k.onStatisticField,x=k.outStatisticFieldName,v=k.statisticType,l="1"===r;if(e&&(r===c||l)&&"count"===v){d[r]||(d[r]=this._calculateUniqueValues(b,l?c:r));var v=d[r],u;for(u in v){var n=v[u],y=n.count,k=n.data,w=n.items,n=m[k]||{attributes:{}};if(!g||
b.validateItems(w,g))n.attributes[x]=y,n.attributes[l?"EXPR_1":r]=k,m[k]=n}h.push({name:x,alias:x,type:"esriFieldTypeString"})}else{if(e)for(u in l=this._calculateUniqueValues(b,c),l){if(n=l[u],k=n.data,w=n.items,!g||b.validateItems(w,g))n=m[k]||{attributes:{}},w=this._calculateStatistics(w,b,r),y="var"===v?"variance":v,n.attributes[x]=w[y],n.attributes[c]=k,m[k]=n}else p[r]||(p[r]=this._calculateStatistics(this.items,b,r)),w=p[r],y="var"===v?"variance":v,q.attributes[x]=w[y];h.push({name:x,alias:x,
type:"esriFieldTypeDouble"})}}if(e)for(var z in m)f.push(m[z]);else f.push(q);return{fields:h,features:f}};d.prototype._calculateStatistics=function(a,b,f){for(var d=a.length,c=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,e=null,l=null,m=null,p=null,q=[],t=0;t<d;t++){var k=q[t]=b.getFieldValue(a[t],f);isNaN(k)||(e+=k,c=Math.min(c,k),g=Math.max(g,k))}if(d){l=e/d;for(b=a=0;b<q.length;b++)k=q[b],a+=Math.pow(k-l,2);p=1<d?a/(d-1):0;m=Math.sqrt(p)}else g=c=null;return{avg:l,count:d,max:g,min:c,stddev:m,
sum:e,variance:p}};d.prototype._calculateUniqueValues=function(a,b){for(var d={},h=0,c=this.items;h<c.length;h++){var g=c[h],e=a.getFieldValue(g,b);if(null==e||"string"===typeof e&&""===e.trim())e=null;null==d[e]?d[e]={count:1,data:e,items:[g]}:(d[e].count++,d[e].items.push(g))}return d};return d}();A.default=z});