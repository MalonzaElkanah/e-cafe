// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper dojo/errors/CancelError ../../../core/Accessor ../../../core/arrayUtils ../../../core/Evented ../../../core/Handles ../../../core/has ../../../core/Logger ../../../core/PooledArray ../../../core/Promise ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/gl-matrix ../../../core/sql/WhereClause ../../../geometry/support/aaBoundingBox ../../../views/3d/layers/i3s/I3SFrameWorker ../../../views/3d/layers/i3s/I3SIndex ../../../views/3d/layers/i3s/I3SLodHandling ../../../views/3d/layers/i3s/I3SNodeLoader ../../../views/3d/layers/i3s/I3SUtil ../../../views/3d/layers/i3s/I3SViewportQueries ../../../views/3d/layers/i3s/IdleQueue ../../../views/3d/support/projectionUtils ../../../views/3d/support/ResourceController".split(" "),
function(k,Q,x,e,l,y,z,A,B,C,D,E,F,r,G,d,g,H,I,J,K,L,p,m,M,N,v,O){function q(d,c){return d.length===c.length&&d.every(function(a){return 0<=t(c,a.name)})}function t(d,c){c=c.toLowerCase();for(var a=0;a<d.length;a++)if(d[a].name.toLowerCase()===c)return a;return-1}function w(d){return null!=d&&null!=d.loadedAttributes&&null!=d.attributeData}var h=D.getLogger("esri.layers.graphics.controllers.I3SOnDemandController");k=function(k){function c(a){a=k.call(this)||this;a.nodeIndex={};a.screenSizeFactor=
0;a.featureTarget=5E4;a.fixedFeatureTarget=!1;a.updating=!0;a.updatingPercentage=0;a.leafsReached=!1;a.uncompressedTextureDownsamplingEnabled=!1;a.alwaysLoadEverythingModeEnabled=!1;a._featureLOD=1;a._stableFeatureLOD=!1;a._isIdle=!1;a._cameraDirty=!0;a._hasFeatures=!1;a._downloadingNodes=new Set;a._loadingNodes=new Set;a._updatingNodes=new Map;a._progressMaxNumNodes=1;a._poi=null;a._requiredAttributesDirty=!0;a._updatesDisabled=!1;a.disableIDBCache=!1;a.disableMemCache=!1;a._restartNodeLoading=!1;
a._fields=null;a._attributeStorageInfo=null;a._handles=new B;a._idleQueue=new N.IdleQueue;a._errorCount=0;return a}x(c,k);Object.defineProperty(c.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"streamDataSupplier",{get:function(){return this.layerView.view.resourceController.getStreamDataSupplier(O.ClientType.SCENE,{trackRequests:!0})},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"parsedDefinitionExpression",{get:function(){if("definitionExpression"in this.layer&&this.layer.definitionExpression)try{var a=H.create(this.layer.definitionExpression);if(!a.isStandardized())return h.error("definitionExpression is using non standard function"),null;var b=[],c=a.getFields();m.findFieldsCaseInsensitive(c,this.layer.fields,{missingFields:b});return 0<b.length?(h.error("definitionExpression references unknown fields: "+b.join(", ")),null):a}catch(f){return h.error("Failed to parse definitionExpression: "+
f),null}else return null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"definitionExpressionFields",{get:function(){if(this.parsedDefinitionExpression){var a=this.parsedDefinitionExpression.getFields();return m.findFieldsCaseInsensitive(a,this._fields)}return null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"crsVertex",{get:function(){return m.getVertexCrs(this.layer)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"crsIndex",{get:function(){return m.getIndexCrs(this.layer)},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rootNodeVisible",{get:function(){var a=this._rootNodeId&&this.nodeIndex[this._rootNodeId];return a&&this._viewportQueries?this._viewportQueries.isNodeVisible(a):!0},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;this.updateEventListener={needsUpdate:function(){return!1},idleBegin:function(){return a._updateIdleState(!0)},idleEnd:function(){return a._updateIdleState(!1)}};this.updateEventListenerWhileSuspended=
{idleBegin:function(){return a._startNodeLoadingWhileSuspended()}};this._lodHandling=new L(this.layerView,function(){return a.updatingChanged()});var b=this.layerView.layer;this.layer=b;this._defaultGeometrySchema=b.store.defaultGeometrySchema;this._rootNodeUrl=b.store.rootNode;var c=this._rootNodeUrl.split("/");this._rootNodeId=c[c.length-1];this.disableIDBCache=C("disable-feature:idb-cache");"fields"in b&&(this._fields=b.fields,this._attributeStorageInfo=b.attributeStorageInfo);b=r.all([this.layer.when(),
this.layerView.when()]).then(function(){if(!a.destroyed&&a.layerView&&!a.layerView.destroyed){var b=a.layerView.view;a.setClippingArea(b.clippingArea);a._centerOnSurface=b.pointsOfInterest.centerOnSurfaceFrequent;a._handles.add(a._centerOnSurface.watch("renderLocation",function(){return a._pointOfInterestChanged()}));var c=a.layerView.view.resourceController;a._handles.add(c.memoryEvents.on("quality-changed",function(){return a._setCameraDirty()}));a._handles.add(G.init(a.layerView,"suspended",function(b){a._idleFrameWorker&&
(a._idleFrameWorker.remove(),a._idleFrameWorker=null,a.restartNodeLoading());a._removeFrameWorker();b?a._idleFrameWorker=c.registerIdleFrameWorker(a.updateEventListenerWhileSuspended):(a._idleFrameWorker=c.registerIdleFrameWorker(a.updateEventListener),a._initFrameWorker())}),"layerview");a._handles.add(a.layer.watch("elevationInfo",function(b){return a._elevationInfoChanged(b)}),"layer");a.watch("uncompressedTextureDownsamplingEnabled",function(){return a.restartNodeLoading()});a.watch("alwaysLoadEverythingModeEnabled",
function(){return a.restartNodeLoading()});a._handles.add(b.state.watch("camera",function(){return a._setCameraDirty()}));a._handles.add(a.watch(["featureTarget","fixedFeatureTarget"],function(){return a._stableFeatureLOD=!1}));a._handles.add(a.layerView.watch("lodFactor",function(){return a._setCameraDirty()}),"quality");a._handles.add([a.layer.watch("renderer",function(){return a._requiredFieldsChange()}),a.layer.watch("definitionExpression",function(){return a._requiredFieldsChange()}),a.layer.watch("labelsVisible",
function(){return a._labelingChanged()}),a.layer.watch("labelingInfo",function(){return a._labelingChanged()}),a.layerView.watch("additionalRequiredFields",function(){return a._requiredFieldsChange()})],"requiredAttributes")}});this.addResolvingPromise(b);this.when(function(){return a._startNodeLoading()})};c.prototype.destroy=function(){this._removeFrameWorker();this._idleFrameWorker&&(this._isIdle=!1,this._idleFrameWorker.remove(),this._idleFrameWorker=null);this._handles.destroy();this._nodeLoader=
null};c.prototype._initFrameWorker=function(){var a=this;this._frameWorker=J.addFrameWorker(this.layerView.view.resourceController,function(b,c){a._frame(b,c);return a._index?a._index.getPriority():-Infinity})};c.prototype._removeFrameWorker=function(){null!=this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null)};c.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields)return[];var a=Object.create(null);this.layer.renderer&&this.layer.renderer.collectRequiredFields(a);
this.layer.labelsVisible&&this.layer.labelingInfo&&this.layer.labelingInfo.forEach(function(b){b._collectRequiredFields(a)});if(null!=this.definitionExpressionFields)for(var b=0,c=this.definitionExpressionFields;b<c.length;b++){var f=c[b];a[f]=!0}if(null!=this.layerView.additionalRequiredFields)for(b=0,c=this.layerView.additionalRequiredFields;b<c.length;b++)f=c[b],a[f]=!0;var d=this._attributeStorageInfo,e=this._fields,g=this.layer.objectIdField;return Object.keys(a).map(function(a){var b=t(d,a);
a=t(e,a);return 0<=b&&0<=a?{index:b,name:e[a].name,field:e[a],attributeStorageInfo:d[b]}:null}).filter(function(a){return null!=a&&a.name!==g}).sort(function(a,b){return b.index-a.index}).filter(function(a,b,c){return 0===b||c[b-1].index!==a.index})};c.prototype._requiredFieldsChange=function(){this._requiredAttributesDirty=!0;this.restartNodeLoading()};c.prototype._labelingChanged=function(){var a=this._requiredAttributes,b=this._getRequiredAttributes();q(a,b)||this._requiredFieldsChange()};c.prototype.setClippingArea=
function(a){var b=I.create();v.extentToBoundingBox(a,b,this.layerView.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null};c.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.updatePointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=u.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestReload())))};c.prototype._calculatePointOfInterest=
function(a){void 0===a&&(a=g.vec3f64.create());var b=this._centerOnSurface.renderLocation,c=g.vec3f64.create();g.vec3.subtract(c,b,this.camPos);g.vec3.normalize(c,c);var f=this.layerView.view.renderCoordsHelper,d=g.vec3f64.create();f.worldUpAtPosition(b,d);c=Math.acos(g.vec3.dot(d,c))-.5*Math.PI;g.vec3.lerp(a,this.camPos,b,Math.max(0,Math.min(1,c/(.5*Math.PI))));return a};c.prototype.updateClippingArea=function(a){this.setClippingArea(a);this._cameraDirty=!0;this._viewportQueries&&this._viewportQueries.updateExtent(this._clippingArea)};
c.prototype._setCameraDirty=function(){this._cameraDirty=!0;this.updatingChanged()};c.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path};c.prototype.updateElevationChanged=function(a,b,c){m.findIntersectingNodes(a,b,this.nodeIndex.root,this.crsIndex,this.nodeIndex,function(a){c.push(a)});for(a=0;a<c.length;a++)b=c.data[a],this._viewportQueries.invalidateCache(b.id),b.id===this._rootNodeId&&this.notifyChange("rootNodeVisible");c.length&&this.restartNodeLoading()};c.prototype._elevationInfoChanged=
function(a){this._viewportQueries.invalidateCache();this._initViewData()};c.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0;this.updatingChanged()};c.prototype.schedule=function(a,b){var c=this;return this._idleQueue.push(b).then(function(b){if(!c._loadingNodes.has(a)&&!c._updatingNodes.has(a))throw new l;return b})};c.prototype.reschedule=function(a,b){var c=this;return this._idleQueue.unshift(b).then(function(b){if(!c._loadingNodes.has(a)&&!c._updatingNodes.has(a))throw new l;
return b})};Object.defineProperty(c.prototype,"unloadedMemoryEstimate",{get:function(){return!this._index||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0});c.prototype._frame=function(a,b){null!==this._viewportQueries&&this._viewportQueries.setCameraIdle(!this._cameraDirty);this.layerView.visible&&this._processLogError(a,b)};c.prototype._processLogError=function(a,b){try{this._process(a,b)}catch(P){50>this._errorCount?h.error("Error during processing: "+
P):50===this._errorCount&&h.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}};c.prototype._process=function(a,b){var c=this;this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading());if(null!=this._nodeLoader&&null!=this._index){this._updateViewData();a.runWithProgress(function(){return c._processIndex(b)});this._updateFeatureLOD();for(a.runWithProgress(function(){return c._processNodes(a,b)});0<this._idleQueue.length()&&!a.doneWithProgress();)this._idleQueue.process(),
a.madeProgress();a.runWithProgress(function(){return c._prefetchIndex(b)});b.numIndexLoading+=this._index.getIndexLoading();b.numNodesLoading+=this._downloadingNodes.size;this.updatingChanged();this._lodHandling.lodGlobalHandling()}};c.prototype._processIndex=function(a){a=Math.min(10-a.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,a));this._index.update(z.keysOfSet(this._loadingNodes));var b=this._index.getFeatureEstimate().leafsReached;this._index.isLoading()||b===
this._get("leafsReached")||this._set("leafsReached",b);return this._index.load(a)};c.prototype._prefetchIndex=function(a){if(0<this._loadingNodes.size)return!1;a=Math.min(10-a.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,a));return this._index.prefetch(a)};c.prototype._updateFeatureLOD=function(){var a=this._index.getFeatureEstimate();if(a.estimate){var b=this.featureTarget*this.baseLOD,c=!this._index.isLoading();if(500<this._index.getIndexMissing()){if(1E-4>=this._featureLOD)return;
this._featureLOD/=1.5;this._stableFeatureLOD=!1}else if(c&&a.estimate<b){if(a.leafsReached||1E4<=this._featureLOD||this._stableFeatureLOD)return;this._featureLOD*=Math.max(b/a.estimate,1.001);a=this.lod;b=this._index.checkFeatureTarget(b,a);b!==a&&(this._featureLOD=b/this.baseLOD,this._stableFeatureLOD=!0)}else if(a.estimate>1.2*b||c&&a.estimate>b){if(1E-4>=this._featureLOD)return;this._featureLOD/=1+.25*(a.estimate/b-1);this._stableFeatureLOD=!1}else return;this._featureLOD=Math.min(1E4,Math.max(1E-4,
this._featureLOD));this._viewportQueries.updateScreenSpaceErrorBias(this.lod);this._index.requestReload()}};c.prototype._processNodes=function(a,b){var c=this,f=this._index.getUpdates((this._isIdle?100:2)-this._loadingNodes.size);f.cancel.forEach(this._cancelNodeIdLoading,this);f.update.some(function(b){if(a.doneWithProgress())return!0;c._updateLoadedNode(b);a.madeProgress();return!1});f.add.some(function(f){if(a.doneWithProgress())return!0;if(f.notInCache&&!c._hasNodeLoadToken(b))return!1;c._loadNode(f);
a.madeProgress();return!1});return a.hasProgressed};c.prototype._cancelNodeLoading=function(){var a=this;this._loadingNodes.clear();this._downloadingNodes.clear();this._updatingNodes.forEach(function(b,c){return a._updatingNodes.get(c).cancel()});this._updatingNodes.clear()};c.prototype._cancelNodeIdLoading=function(a){this._loadingNodes.delete(a);this._downloadingNodes.delete(a)};c.prototype._getAvailableLoadTokens=function(a,b){var c=b.numIndexLoading+this._index.getIndexLoading();return Math.floor((12-
1*c-2*(b.numNodesLoading+this._loadingNodes.size))/a)};c.prototype._hasNodeLoadToken=function(a){var b=this._isIdle&&!this._index.isLoading()?5:2;return a.numNodesLoading+this._loadingNodes.size>=b?!1:0<this._getAvailableLoadTokens(2,a)};c.prototype.updatingChanged=function(){var a=this._index?this._index.getIndexMissing():0,b=this._index?this._index.getNodesMissing():0,a=a+3*b+2*this._loadingNodes.size,b=!(!(0<a||0<this._updatingNodes.size||this._restartNodeLoading||this._cameraDirty||0<this._idleQueue.length()||
this._lodHandling&&this._lodHandling.requiresLODGlobalHandling)&&this._isIdle);0===a&&(this._progressMaxNumNodes=1);this._progressMaxNumNodes=Math.max(a,this._progressMaxNumNodes);b!==this._get("updating")&&this._set("updating",b);a=100*a/this._progressMaxNumNodes;a!==this._get("updatingPercentage")&&this._set("updatingPercentage",a)};c.prototype._initViewData=function(){var a=this.layerView.view,b=a.state.camera,c=a.renderCoordsHelper;this.camPos=g.vec3f64.clone(a.pointsOfInterest.renderPointOfView);
this.screenSizeFactor=1/b.perPixelRatio;this._poi=this._calculatePointOfInterest();var f=this.lod;this._viewportQueries=new M(this.crsIndex,c,b,this._poi,this._clippingArea,a.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(this.layer),screenspaceErrorBias:f,angleDependentLoD:.5>f,disableLod:this.alwaysLoadEverythingModeEnabled});this._cameraDirty=!1;this.notifyChange("rootNodeVisible")};c.prototype._updateViewData=function(){if(this._cameraDirty&&this._index){var a=
this.layerView.view,b=a.state.camera;this.camPos=g.vec3f64.clone(a.pointsOfInterest.renderPointOfView);this.screenSizeFactor=1/b.perPixelRatio;this._poi=this._calculatePointOfInterest(this._poi);this._viewportQueries.updateCamera(b);this._viewportQueries.updatePointOfInterest(this._poi);this._viewportQueries.updateScreenSpaceErrorBias(this.lod);this._index.progressiveLoadPenalty=u.distancePenalty*this._viewportQueries.distCameraToPOI();this._index.requestReload();this._stableFeatureLOD=!1;this.alwaysLoadEverythingModeEnabled||
this._removeInvisibleNodes();this._cameraDirty=!1;this.notifyChange("rootNodeVisible")}};c.prototype._getProgressiveLoadFactor=function(a){return 1>this.layerView.view.resourceController.memoryFactor?1:this.layerView.progressiveLoadFactor};Object.defineProperty(c.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseLOD",{get:function(){return this.fixedFeatureTarget?1:this.layerView.lodFactor*this.layerView.view.resourceController.memoryFactor},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"lodDropFactor",{get:function(){return this.fixedFeatureTarget?0:2*Math.min(this.layerView.view.resourceController.memoryFactor,.5)},enumerable:!0,configurable:!0});c.prototype._startNodeLoadingWhileSuspended=function(){this._initViewData();this.alwaysLoadEverythingModeEnabled&&this.layerView.visible&&!this.layerView.get("parent.suspended")||this._removeInvisibleNodes()};c.prototype.isGeometryVisible=function(a){return this._viewportQueries.isGeometryVisible(a)};
c.prototype.updateVisibility=function(a){return this._viewportQueries.updateNode(a)};c.prototype._shouldLoadNode=function(a){return!this._lodHandling.shouldLoadNode(a)||this._shouldDropNode(a)?!1:a.obb?this._viewportQueries.isGeometryVisible(a):!0};c.prototype._shouldDropNode=function(a){var b=this.lodDropFactor;return 1>b&&this._lodHandling.childrenEmpty(a)&&this._viewportQueries.calcCameraDistance(a)>this._viewportQueries.maxDistance*b};c.prototype._startNodeLoading=function(){var a=this;this._restartNodeLoading=
!1;if(!this._updatesDisabled&&null!=this.streamDataSupplier){this._initViewData();this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var b=p.TextureFormat.Normal;this.layerView.useCompressedTextures?b=p.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(b=p.TextureFormat.Downsampled);var c=this._defaultGeometrySchema;this._nodeLoader=new p(this.streamDataSupplier,h,c,this._requiredAttributes,{textureFormat:b,
loadTextureData:this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid||null==c||null==c.ordering});b=u.distancePenalty*this._viewportQueries.distCameraToPOI();this._index=new K(this.getBaseUrl(),this._rootNodeUrl,this._rootNodeId,b,this.nodeIndex,this.streamDataSupplier,this._viewportQueries,h,function(b){return a.layerView.isNodeLoaded(b)},function(b){return a._shouldLoadNode(b)},function(b){return a._enableFromGPUCache(b)},function(b){return a._needsUpdate(b)});b=this.layerView.view.renderSpatialReference;
b=this.crsIndex.equals(b)||this.crsIndex.isWGS84&&b.equals(v.SphericalECEFSpatialReference);this._index.ignoreServiceOBB=!b;this.alwaysLoadEverythingModeEnabled||this._removeInvisibleNodes();this._lodHandling.startNodeLoading(function(b){return a._viewportQueries.isNodeVisible(b)},function(b){return a._viewportQueries.isGeometryVisible(b)},function(b){return a._index.nodeTraversalState(b)},this.nodeIndex,this._rootNodeId,{maxLodLevel:this._viewportQueries.maxLodLevel});this.updatingChanged()}};c.prototype.isNodeLoading=
function(){return null!=this._nodeLoader&&null!=this._index};c.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this._nodeLoader.cancelAll(),this.streamDataSupplier.cancelAll(),this._idleQueue.cancelAll(),this._cancelNodeLoading(),this._poi=this._index=this._nodeLoader=null,this.layerView.additionalCancelNodeLoadingHandler&&this.layerView.additionalCancelNodeLoadingHandler(),this.updatingChanged())};c.prototype._removeInvisibleNodes=function(){var a=this.layerView.getLoadedNodeIDs();
n.clear();for(var b=0;b<a.length;b++){var c=this.nodeIndex[a[b]];if(!this._viewportQueries.isGeometryVisible(c)||this._shouldDropNode(c))this._lodHandling.setLodGlobalDirty(),n.push(c)}return 0<n.length?(this.layerView.removeNodeData(n),n.clear(),!0):!1};c.prototype._needsUpdate=function(a){if(null==a.featureData||0===a.featureData.length||this._updatingNodes.has(a.id))return!1;a=this.layerView.getLoadedAttributes(a);return null!=a&&a!==this._requiredAttributes};c.prototype._updateLoadedNode=function(a){var b=
this,c=a.baseUrl,d=this.layerView.getLoadedAttributes(a),c=q(d,this._requiredAttributes)?r.resolve(this.layerView.getAttributeData(a)):this._nodeLoader.loadAttributes(a,c,this._requiredAttributes);this._updatingNodes.set(a.id,c);c.then(function(c){return b.schedule(a.id).then(function(){return b.layerView.setAttributeData(a,{loadedAttributes:b._requiredAttributes,attributeData:c})})}).catch(function(c){c instanceof l||b.layerView.setAttributeData(a,{loadedAttributes:b._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){b._updatingNodes.delete(a.id);
b.updatingChanged()});this.updatingChanged()};c.prototype._loadNode=function(a){var b=this;this._loadingNodes.add(a.id);this.updatingChanged();this._loadAndAddBundle(a).catch(function(a){return a}).then(function(){b._loadingNodes.delete(a.id);b._hasFeatures=b._hasFeatures||!!a.numFeatures;b.updatingChanged()})};c.prototype._loadAndAddBundle=function(a){1!==a.featureData.length&&h.warn("Node ${node.id} has ${node.featureData.length} bundles. Only the first bundle will be loaded.");return a.notInCache?
this._loadUncached(a):this._loadCached(a).then(function(b){b||(a.notInCache=!0)}).catch(function(b){b instanceof l||(a.notInCache=!0)})};c.prototype._enableFromGPUCache=function(a){if(this.disableMemCache||!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData)return!1;var b=this.layerView.loadCachedGPUData(a);if(!b||!w(b.attributeInfo)||!q(b.attributeInfo.loadedAttributes,this._requiredAttributes))return!1;this.layerView.addCachedGPUData(a,b);this._lodHandling.lodSwapBundleLoaded(a);
return!0};c.prototype._loadCached=function(a){var b=this,c=this.layerView;return!this.disableIDBCache&&c.loadCachedNodeData&&c.addCachedNodeData?this.schedule(a.id).then(function(){return c.loadCachedNodeData(a,function(a,c){return b._nodeLoader.loadTextures(a,c)})}).then(function(d){if(null==d)return!1;var e=b._requiredAttributes;return w(d)&&q(d.loadedAttributes,e)?b.reschedule(a.id).then(function(){return c.addCachedNodeData(a,d,d)}).then(function(){b._lodHandling.lodSwapBundleLoaded(a);return!0}):
b.reschedule(a.id).then(function(){return b._nodeLoader.loadAttributes(a,a.baseUrl,e)}).then(function(c){return b.reschedule(a.id,{loadedAttributes:e,attributeData:c})}).then(function(b){return c.addCachedNodeData(a,d,b)}).then(function(){b._lodHandling.lodSwapBundleLoaded(a);return!0})}):r.resolve(!1)};c.prototype._loadUncached=function(a){var b=this;this._downloadingNodes.add(a.id);return this._nodeLoader.loadBundleData(a,0).then(function(c){b._downloadingNodes.delete(a.id);return b.schedule(a.id,
c)}).then(function(c){return b.layerView.addNodeData(a,c)}).then(function(){b._lodHandling.lodSwapBundleLoaded(a);a.notInCache=!1}).catch(function(b){b instanceof l||(h.error("Failed to load node '"+a.id+"' bundle 0: "+b),a.failed=!0)})};c.prototype._updateIdleState=function(a){a!==this._isIdle&&(this._isIdle=a,this._viewportQueries&&this._viewportQueries.setCameraIdle(!0),this.updatingChanged())};c.prototype.updateStats=function(a){a.index=Object.keys(this.nodeIndex).length;this._hasFeatures&&(a.detail=
this._featureLOD,a.target=this.featureTarget*this.baseLOD);this._index&&this._index.updateStats(a)};e([d.property({readOnly:!0})],c.prototype,"isMeshPyramid",null);e([d.property({readOnly:!0})],c.prototype,"streamDataSupplier",null);e([d.property({readOnly:!0,dependsOn:["layer.definitionExpression"]})],c.prototype,"parsedDefinitionExpression",null);e([d.property({readOnly:!0,dependsOn:["parsedDefinitionExpression"]})],c.prototype,"definitionExpressionFields",null);e([d.property({readOnly:!0})],c.prototype,
"crsVertex",null);e([d.property({readOnly:!0})],c.prototype,"crsIndex",null);e([d.property({readOnly:!0})],c.prototype,"nodeIndex",void 0);e([d.property()],c.prototype,"camPos",void 0);e([d.property()],c.prototype,"screenSizeFactor",void 0);e([d.property()],c.prototype,"featureTarget",void 0);e([d.property()],c.prototype,"fixedFeatureTarget",void 0);e([d.property()],c.prototype,"layerView",void 0);e([d.property()],c.prototype,"layer",void 0);e([d.property({readOnly:!0})],c.prototype,"updating",void 0);
e([d.property({readOnly:!0})],c.prototype,"updatingPercentage",void 0);e([d.property({readOnly:!0})],c.prototype,"leafsReached",void 0);e([d.property({readOnly:!0})],c.prototype,"rootNodeVisible",null);e([d.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled"})],c.prototype,"uncompressedTextureDownsamplingEnabled",void 0);e([d.property({aliasOf:"layerView.alwaysLoadEverythingModeEnabled"})],c.prototype,"alwaysLoadEverythingModeEnabled",void 0);return c=e([d.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],
c)}(d.declared(y,F,A));var n=new E,u={factorIM:.2,factor3dObject:.05,distancePenalty:10};return k});