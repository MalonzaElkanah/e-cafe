// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../geometry ../../../Graphic ../../../core/Accessor ../../../core/Collection ../../../core/Error ../../../core/has ../../../core/Loadable ../../../core/Logger ../../../core/promiseUtils ../../../core/requireUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/typescript ../../../tasks/support/FeatureSet module".split(" "),
function(w,q,x,h,p,u,f,y,r,z,A,B,v,C,D,m,E,F,G,H){Object.defineProperty(q,"__esModule",{value:!0});var I=0,t=B.getLogger("esri.layers.graphics.sources.MemorySource");f=function(f){function b(){var a=null!==f&&f.apply(this,arguments)||this;a._idToClientGraphic=null;a.type="memory";return a}x(b,f);b.prototype.load=function(){var a=this,c;c=v.resolve();this.addResolvingPromise(c.then(function(){return D.open(C.getAbsMid("./support/MemorySourceWorker",w,H),{strategy:z("esri-workers-for-memory-layers")?
"dedicated":"local"}).then(function(c){a._connection=c;var b=a.layer,e=b.fields,g=b.spatialReference,k=b.objectIdField,l=b.hasM,b=b.hasZ,d=a._prepareAddFeatures(a.items);a.on("before-changes",function(a){t.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead");a.preventDefault()});return c.invoke("load",{features:d.features,fields:e&&e.map(function(a){return a.toJSON()}),geometryType:p.typeKebabDictionary.toJSON(a.workerGeometryType),hasM:l,
hasZ:b,objectIdField:k,spatialReference:g&&g.toJSON()}).then(function(c){for(var b=0,e=c.warnings;b<e.length;b++)t.warn(e[b]);c.featureErrors.length&&t.warn("Encountered "+c.featureErrors.length+" validation errors while loading features",c.featureErrors);b=c.layerDefinition;a._geometryTypeRequiresClientGraphicMapping(d.inferredGeometryType)&&(b.geometryType=p.typeKebabDictionary.toJSON(d.inferredGeometryType));a.layerDefinition=b;a._requiresClientGraphicMapping()&&(a._idToClientGraphic=new Map);
d.finish(c.assignedObjectIds)})})}));return this.when()};Object.defineProperty(b.prototype,"workerGeometryType",{get:function(){var a=this.layer&&this.layer.geometryType;return a?this._geometryTypeRequiresClientGraphicMapping(a)?"polygon":a:null},enumerable:!0,configurable:!0});b.prototype.applyEdits=function(a){var c=this;return this.load().then(function(){return c._applyEdits(a)})};b.prototype.openPorts=function(){var a=this;return this.load().then(function(){return a._connection.openPorts()})};
b.prototype.queryFeatures=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatures",a?a.toJSON():null)}).then(function(a){a=G.fromJSON(a);if(!c._idToClientGraphic)return a;for(var b=c.layer.objectIdField,e=0,g=a.features;e<g.length;e++){var k=g[e],l=c._idToClientGraphic.get(k.attributes[b]);l&&(k.geometry=l.geometry)}return a})};b.prototype.queryFeaturesJSON=function(a){var c=this;return this._requiresClientGraphicMapping()?v.reject(new r("query-features-json:unsupported",
"Cannot query in JSON format for client only geometry types (mesh and extent)")):this.load().then(function(){return c._connection.invoke("queryFeatures",a?a.toJSON():null)})};b.prototype.queryFeatureCount=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatureCount",a?a.toJSON():null)})};b.prototype.queryObjectIds=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryObjectIds",a?a.toJSON():null)})};b.prototype.queryExtent=
function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryExtent",a?a.toJSON():null)}).then(function(a){return{count:a.count,extent:p.Extent.fromJSON(a.extent)}})};b.prototype._applyEdits=function(a){var c=this;if(!this._connection)throw new r("feature-layer-source:edit-failure","Memory source not loaded");var b=this.layer.objectIdField,n=null,f=[],g=[];a.addFeatures&&(n=this._prepareAddFeatures(a.addFeatures));if(a.deleteFeatures)for(var k=0,l=a.deleteFeatures;k<
l.length;k++){var d=l[k];"objectId"in d&&null!=d.objectId?f.push(d.objectId):"attributes"in d&&null!=d.attributes[b]&&f.push(d.attributes[b])}if(a.updateFeatures)for(b=0,a=a.updateFeatures;b<a.length;b++)d=a[b],g.push(this._serializeFeature(d));return this._connection.invoke("applyEdits",{adds:n?n.features:[],updates:g,deletes:f}).then(function(a){var b=a.featureEditResults;c.fullExtent=a.fullExtent;n&&n.finish(b.uidToObjectId);if(c._idToClientGraphic){a=0;for(var d=b.deleteResults;a<d.length;a++){var e=
d[a];e.success&&c._idToClientGraphic.delete(e.objectId)}}return c._createEditsResult(b)})};b.prototype._createEditsResult=function(a){return{addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};b.prototype._createFeatureEditResult=function(a){var b=!0===a.success?null:a.error||
{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new r("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};b.prototype._prepareAddFeatures=function(a){for(var b=new Map,e=Array(a.length),f=null,h=0;h<a.length;h++){var g=a[h],k=this._serializeFeature(g);!f&&g.geometry&&(f=g.geometry.type);e[h]=k;b.set(""+k.uid,g)}var l=this;return{features:e,inferredGeometryType:f,finish:function(a){var c=l.layerDefinition.objectIdField,e;for(e in a){var f=
a[e],d=b.get(e);d&&(d.attributes||(d.attributes={}),-1===f?delete d.attributes[c]:d.attributes[c]=f,l._addIdToClientGraphic(d))}}}};b.prototype._addIdToClientGraphic=function(a){if(this._idToClientGraphic){var b=this.layerDefinition.objectIdField,b=a.attributes&&a.attributes[b];null!=b&&this._idToClientGraphic.set(b,a)}};b.prototype._requiresClientGraphicMapping=function(){return this._geometryTypeRequiresClientGraphicMapping(this.layer.geometryType||this.layerDefinition.geometryType)};b.prototype._geometryRequiresClientGraphicMapping=
function(a){return this._geometryTypeRequiresClientGraphicMapping(a.type)};b.prototype._geometryTypeRequiresClientGraphicMapping=function(a){return"mesh"===a||"multipatch"===a||"extent"===a};b.prototype._serializeFeature=function(a){var b=a.attributes;a=this._geometryForSerialization(a);var e=(I++).toString();return a?{uid:e,geometry:a.toJSON(),attributes:b}:{uid:e,attributes:b}};b.prototype._geometryForSerialization=function(a){return(a=a.geometry)?this._geometryRequiresClientGraphicMapping(a)?p.Polygon.fromExtent(a.extent):
a:null};h([F.shared({Type:u,ensureType:E.ensureType(u)})],b.prototype,"itemType",void 0);h([m.property()],b.prototype,"type",void 0);h([m.property({constructOnly:!0})],b.prototype,"layer",void 0);h([m.property({readOnly:!0,dependsOn:["layer.geometryType"]})],b.prototype,"workerGeometryType",null);h([m.property()],b.prototype,"layerDefinition",void 0);return b=h([m.subclass("esri.layers.graphics.sources.MemorySource")],b)}(m.declared(f,y,A));q.MemorySource=f;q.default=f});