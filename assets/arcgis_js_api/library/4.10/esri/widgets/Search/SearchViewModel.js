// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper dojo/i18n!./nls/Search ../../Graphic ../../PopupTemplate ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Evented ../../core/geolocationUtils ../../core/Handles ../../core/has ../../core/Logger ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/Point ../../geometry/SpatialReference ../../portal/Portal ../../styles/basic ../../symbols/PictureMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../symbols/TextSymbol ../../views/support/layerViewUtils ./FeatureLayerSearchSource ./LocatorSearchSource ./SearchSource ./support/geometryUtils ./support/locatorUtils ../support/GoTo".split(" "),
function(F,ba,G,d,q,B,w,H,I,k,J,p,K,L,M,g,u,f,x,N,C,O,P,Q,R,S,T,U,v,r,V,z,W,X){function h(f,b){return f.hasOwnProperty(b)&&null!=f[b]&&""!==f[b]}var l=M.getLogger("esri.widgets.Search.SearchViewModel"),t=I.ofType({key:function(f){return f.featureLayer?"feature-layer":"locator"},base:V,typeMap:{"feature-layer":v,locator:r}}),E=N.WGS84,Y=/<(?:.|\s)*?>/g;return function(D){function b(a){a=D.call(this)||this;a._handles=new K;a._gotoPromise=null;a._searching=null;a._loadingDefaultSources=null;a.allPlaceholder=
q.allPlaceholder;a.autoNavigate=!0;a.autoSelect=!0;a.defaultSources=new t;a.defaultSymbol=new P({url:F.toUrl(L("trident")?"../../images/search/search-symbol-32.png":"../../images/search/search-symbol-32.svg"),size:24,width:24,height:24});a.includeDefaultSources=!0;a.locationToAddressDistance=1500;a.maxInputLength=128;a.maxResults=6;a.maxSuggestions=6;a.minSuggestCharacters=1;a.popupEnabled=!0;a.popupTemplate=new w({title:q.searchResult,content:"{Match_addr}"});a.portal=C.getDefault();a.resultGraphicEnabled=
!0;a.resultGraphic=null;a.results=null;a.selectedSuggestion=null;a.searchAllEnabled=!0;a.selectedResult=null;a.sources=new t;a.suggestionDelay=150;a.suggestions=null;a.suggestionsEnabled=!0;a.view=null;return a}G(b,D);b.prototype.initialize=function(){var a=this;this._handles.add([u.init(this,"portal",function(a){a&&!a.loaded&&a.load()}),u.init(this,["view","portal","includeDefaultSources"],function(){return a._loadDefaultSources()}),u.on(this,["defaultSources","sources"],"change",function(){return a.notifyChange("allSources")})])};
b.prototype.destroy=function(){this.clearGraphics();this._cancelLoadingDefaultSources();this._clearLoadingDefaultSources();this._handles.destroy();this._handles=null};Object.defineProperty(b.prototype,"activeSource",{get:function(){return this.allSources.getItemAt(this.activeSourceIndex)||null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"activeSourceIndex",{get:function(){return 1!==this.allSources.length&&this.searchAllEnabled?-1:0},set:function(a){void 0===a?this._clearOverride("activeSourceIndex"):
this._override("activeSourceIndex",a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"allSources",{get:function(){var a=this.sources,c=this.defaultSources,e=this.includeDefaultSources,a="function"===typeof e?e.call(null,{sources:a,defaultSources:c}):e?c.concat(a):a,c=this._get("allSources");c.removeAll();c.addMany(a.filter(Boolean));return c},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"locationEnabled",{get:function(){return this._get("locationEnabled")||
p.supported()},set:function(a){if(void 0===a)this._clearOverride("locationEnabled");else{var c=p.supported();if(a&&!c){var e=new k("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});l.error(e)}this._override("locationEnabled",a&&c)}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"placeholder",{get:function(){var a=this.activeSourceIndex,c=this.allPlaceholder,c=void 0===c?q.allPlaceholder:c;return-1===a?c:(a=this.allSources.getItemAt(a))?
a.placeholder:""},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(a){this._set("searchTerm",a||"");this.clearGraphics();this.selectedSuggestion&&this.selectedSuggestion.text!==a&&this._set("selectedSuggestion",null);""===a&&this._clear()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this._searching?"searching":this._loadingDefaultSources?"loading":0===
this.allSources.length?"disabled":"ready"},enumerable:!0,configurable:!0});b.prototype.clear=function(){this.searchTerm=""};b.prototype.clearGraphics=function(){this._removeHighlight();this._closePopup();this.view&&this.view.graphics.remove(this.resultGraphic);this._set("resultGraphic",null)};b.prototype.search=function(a){var c=this;this.emit("search-start");this.clearGraphics();var e=this._createSuggestionForSearch(a);this._searching=a=this._whenViewAndPortalLoaded().then(function(){return c._getResultsFromSources(e).then(function(a){var b=
{activeSourceIndex:c.activeSourceIndex,searchTerm:e.text,numResults:0,numErrors:0,errors:[],results:[]};c._formatResponse(b,a,e);a=c._getFirstResult(b.results);var m=(e.location&&a?a.name:e.text).replace(Y,"");c._set("searchTerm",m);(e.key&&"number"===typeof e.sourceIndex||e.location)&&c._set("selectedSuggestion",e);c._set("results",b.results);c.emit("search-complete",b);return c._selectFirstResult(a).then(function(){return b})})});this.notifyChange("state");a.then(function(){return c._clearSearching()}).catch(function(){return c._clearSearching()});
return a};b.prototype.searchNearby=function(){var a=this;if(!this.locationEnabled){var c=new k("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});l.error(c);return g.reject(c)}this._searching=c=p.getCurrentPosition().then(function(c){return p.positionToPoint(c,a.view).then(function(c){return a.search(c)})});this.notifyChange("state");c.then(function(){return a._clearSearching()}).catch(function(){return a._clearSearching()});return c};b.prototype.select=
function(a){var c=this;this.clearGraphics();if(!a){var e=new k("select:missing-parameter","Cannot select without a searchResult.",{searchResult:a});l.error(e);return g.reject(e)}var b=this.view,f=h(a,"sourceIndex")?a.sourceIndex:this._getSourceIndexOfResult(a),d=this.allSources.getItemAt(f);if(!d)return e=new k("select:missing-source","Cannot select without a source.",{source:d}),l.error(e),g.reject(e);var e=d instanceof v?this._getSourcePopupTemplate(d):null,A=d.resultSymbol||this._getDefaultSymbol(a),
aa=h(d,"resultGraphicEnabled")?d.resultGraphicEnabled:this.resultGraphicEnabled,q=h(d,"autoNavigate")?d.autoNavigate:this.autoNavigate,p=h(d,"popupEnabled")?d.popupEnabled:this.popupEnabled,t=p?e||this.popupTemplate:null,n=a.feature;if(!n)return e=new k("select:missing-feature","Cannot select without a feature.",{feature:n}),l.error(e),g.reject(e);var u=n.attributes,r=n.geometry,w=n.layer,x=n.sourceLayer,y=z.getPointFromGeometry(r),e={layerViewQuery:this._getHighlightLayerView(n),elevationQuery:b&&
y?z.getPointWithElevation(y,b).catch(function(){return y}):g.resolve(y)};return g.eachAlways(e).then(function(e){var m=e.layerViewQuery.value,Z=e.elevationQuery.value;A instanceof T&&(A.text=a.name);e=b&&q?c._getGoToTarget(a,d):null;return(e?c._goToSearchResult(e):g.resolve()).then(function(){c._gotoPromise=null;var e=m?n:new B({geometry:r,symbol:A,attributes:u,layer:w,sourceLayer:x,popupTemplate:t});m?c._highlightFeature({graphic:e,layerView:m}):aa&&b&&b.graphics.push(e);p&&c.get("view.popup")&&
e.getEffectivePopupTemplate()&&b.popup.open({features:[e],location:Z});c._set("selectedResult",a);c._set("resultGraphic",e);c.emit("select-result",{result:a,source:d,sourceIndex:f});return a})})};b.prototype.suggest=function(a,c){var e=this,b=a||this.searchTerm;this.emit("suggest-start",{searchTerm:b});return this._suggestTimer(c).then(function(){return e._suggestImmediate(b).then(function(a){e._set("suggestions",a.results);e.emit("suggest-complete",a);return a})})};b.prototype._cancelLoadingDefaultSources=
function(){var a=this._loadingDefaultSources;a&&a.cancel()};b.prototype._clearLoadingDefaultSources=function(){this._loadingDefaultSources=null;this.notifyChange("state")};b.prototype._clearSearching=function(){this._searching=null;this.notifyChange("state")};b.prototype._convertHelperServices=function(){var a=this.get("portal.helperServices.geocode");return a?a.map(function(a){if(!1!==a.placefinding&&(a=r.fromJSON(a),W.isArcGISWorldGeocoder(a.get("locator.url"))&&a.set({singleLineFieldName:"SingleLine",
outFields:["Addr_type","Match_addr","StAddr","City"],localSearchOptions:{minScale:3E5,distance:5E4},placeholder:q.placeholder}),a.singleLineFieldName))return a}).filter(Boolean):[]};b.prototype._convertApplicationProperties=function(){var a=this,c=this.get("view.map.applicationProperties.viewing.search"),e=this.get("view.map");if(!e||!c)return[];var b=c.hintText;return c.enabled?c.layers.map(function(c){var d=e.findLayerById(c.id);if(d){c=a._getLayerJSON(c);var m=v.fromJSON(c);m.placeholder=b;a._getFeatureLayer(d,
c).then(function(a){m.featureLayer=a});return m}}).filter(Boolean):[]};b.prototype._getSubFeatureLayer=function(a,c){return a&&a.allSublayers?(a=a.allSublayers.find(function(a){return a.id===c.subLayer}))?g.resolve(a.createFeatureLayer()):g.reject():g.reject()};b.prototype._getFeatureLayer=function(a,c){var e=this;if("feature"===a.type||"scene"===a.type)return g.resolve(a);if("map-image"===a.type)return a.load().then(function(){return e._getSubFeatureLayer(a,c).catch(function(){var c=new k("search:create-featurelayer",
"Could not create a FeatureLayer from the MapImageLayer",{layer:a});l.error(c);return null})})};b.prototype._getLayerJSON=function(a){return"function"===typeof a.toJSON?a.toJSON():a};b.prototype._updateDefaultSources=function(){var a=this.defaultSources,c=this.includeDefaultSources;a.removeAll();c&&a.addMany(this._convertApplicationProperties().concat(this._convertHelperServices()));this.notifyChange("allSources")};b.prototype._clear=function(){this._gotoPromise&&(this._gotoPromise.cancel(),this._gotoPromise=
null);this._set("results",null);this._set("suggestions",null);this._set("selectedResult",null);this._set("selectedSuggestion",null);this.emit("search-clear")};b.prototype._closePopup=function(){var a=this.get("view.popup"),c=this.resultGraphic;if(a&&c){var e=a.selectedFeature;e&&e===c&&a.close()}};b.prototype._suggestTimer=function(a){return g.after(null!=a?a:this.suggestionDelay)};b.prototype._createLocationForSearch=function(a){if(a instanceof B)return z.getPointFromGeometry(a.geometry);if(a instanceof
x)return a;if(Array.isArray(a)&&2===a.length)return new x({longitude:a[0],latitude:a[1]})};b.prototype._createSuggestionForSearch=function(a){if(a&&h(a,"key")&&h(a,"text")&&h(a,"sourceIndex"))return a;var c=this._createLocationForSearch(a)||null,e="string"===typeof a?a:this.searchTerm,b=this.selectedSuggestion,d=this.selectedResult,f=(a=!a&&b&&d)&&b.location;return a&&b.key===d.key&&b.sourceIndex===d.sourceIndex||f?b:{location:c,text:c?"":e,sourceIndex:null,key:null}};b.prototype._getFirstResult=
function(a){var c=null;a&&a.some(function(a){a=a.results[0];var b=!!a;b&&(c=a);return b});return c};b.prototype._selectFirstResult=function(a){return this.autoSelect&&a?this.select(a):g.resolve()};b.prototype._suggestImmediate=function(a){var c=this;return this._whenViewAndPortalLoaded().then(function(){return c._getSuggestionsFromSources(a)}).then(function(b){var e={activeSourceIndex:c.activeSourceIndex,searchTerm:a,numResults:0,numErrors:0,errors:[],results:[]};c._formatResponse(e,b);return e})};
b.prototype._formatSourceResponse=function(a,c,b){var e=c&&c.value||[];c=c&&c.error;var d=this.allSources.getItemAt(b);c?(a.errors.push({sourceIndex:b,source:d,error:c}),a.numErrors++):(a.results.push({sourceIndex:b,source:d,results:e}),a.numResults+=e.length)};b.prototype._formatResponse=function(a,c,b){var e=this;if(c)if(-1===a.activeSourceIndex){var d=b&&h(b,"sourceIndex")&&-1!==b.sourceIndex?b.sourceIndex:void 0;c.forEach(function(c,b){e._formatSourceResponse(a,c,void 0!==d?d:b)})}else this._formatSourceResponse(a,
c[0],a.activeSourceIndex)};b.prototype._getResultsFromSources=function(a){var c=this,b=this.allSources,d=!a.location&&h(a,"sourceIndex")?a.sourceIndex:this.activeSourceIndex,f=[];if(!b.length)return b=new k("search:no-sources-defined","At least one source is required.",{allSources:b}),l.error(b),g.reject(b);-1===d?b.forEach(function(b,e){f.push(c._getResultsFromSource(a,e))}):f.push(this._getResultsFromSource(a,d));return g.eachAlways(f)};b.prototype._getSuggestionsFromSources=function(a){var c=this,
b=this.allSources,d=this.activeSourceIndex,f=[];if(!b.length)return b=new k("suggest:no-sources-defined","At least one source is required.",{allSources:b}),l.error(b),g.reject(b);-1===d?b.forEach(function(b,e){f.push(c._getSuggestionsFromSource(a,e))}):f.push(this._getSuggestionsFromSource(a,d));return g.eachAlways(f)};b.prototype._getResultsFromSource=function(a,c){var b=this.allSources.getItemAt(c),d=a.location,d=void 0===d?null:d,f=this.get("view.spatialReference")||E,g=h(b,"maxResults")?b.maxResults:
this.maxResults,k=b instanceof v&&h(b,"exactMatch")?b.exactMatch:!1,l=b instanceof r&&h(b,"locationToAddressDistance")?b.locationToAddressDistance:this.locationToAddressDistance;return b.getResults({view:this.view,sourceIndex:c,location:d,suggestResult:a,spatialReference:f,exactMatch:k,maxResults:g,distance:l})};b.prototype._getSuggestionsFromSource=function(a,b){var c=this.allSources.getItemAt(b),d=h(c,"suggestionsEnabled")?c.suggestionsEnabled:this.suggestionsEnabled,f=a.trim().length,k=h(c,"minSuggestCharacters")?
c.minSuggestCharacters:this.minSuggestCharacters;return d&&f>=k?(d=this.get("view.spatialReference")||E,f=h(c,"maxSuggestions")?c.maxSuggestions:this.maxSuggestions,c.getSuggestions({view:this.view,sourceIndex:b,suggestTerm:a,spatialReference:d,maxSuggestions:f})):g.resolve()};b.prototype.createDefaultSymbol=function(a,b){if("point"===b)return new S({color:a.color,size:a.size,outline:{color:a.outline.color,width:a.outline.width}});if("polyline"===b)return new R({color:a.color,width:a.width});if("polygon"===
b)return new Q({color:a.color,outline:{color:a.outline.color,width:a.outline.width}})};b.prototype._getSourcePopupTemplate=function(a){var b=a.featureLayer;if(b)return h(a,"popupTemplate")?a.popupTemplate:b.popupTemplate};b.prototype._getSourceIndexOfResult=function(a){var b=null;this.results.some(function(c){return c.results.some(function(e){if(e===a)return b=c.sourceIndex,!0})});return b};b.prototype._getGoToTarget=function(a,b){var c=a.extent;a=a.feature;return b instanceof v?a||c:c||a};b.prototype._goToSearchResult=
function(a){var b=!!a;a=this.callGoTo({target:{target:a},options:{animate:b}});b&&(this._gotoPromise=a);return a};b.prototype._whenViewAndPortalLoaded=function(){var a=this.portal,b=this.view,b=b?b.when():g.resolve(),a=a?a.when():g.resolve();return g.eachAlways([b,a]).then(function(){})};b.prototype._loadDefaultSources=function(){var a=this,b=this.includeDefaultSources;this._cancelLoadingDefaultSources();this._clearLoadingDefaultSources();var b=b?this._whenViewAndPortalLoaded():g.resolve(),d=!1;b.catch(function(){}).then(function(){d=
!0;a._clearLoadingDefaultSources();a._updateDefaultSources()});d||(this._loadingDefaultSources=b,this.notifyChange("state"));return b};b.prototype._getDefaultSymbol=function(a){var b=this.get("view.map.basemap.id");if(a=a&&a.feature&&a.feature.geometry&&a.feature.geometry.type)if(b=(b=O.getSchemes({theme:"default",basemap:b||"topo",geometryType:a}))&&b.primaryScheme)return b.color&&h(b,"opacity")&&(b.color.a=b.opacity),this.createDefaultSymbol(b,a);return this.defaultSymbol};b.prototype._removeHighlight=
function(){this._handles.remove("highlight")};b.prototype._getHighlightLayerView=function(a){var b=this.view;if(!a||!b)return g.resolve(null);var d=a.layer;return b.when().then(function(){return b.whenLayerView(d).then(function(a){return U.hasHighlight(a)?a:null})})};b.prototype._highlightFeature=function(a){var b=a.graphic,d=b.attributes,f=b.layer.objectIdField;a=a.layerView.highlight(d&&d[f]||b);this._handles.add(a,"highlight")};b.ALL_INDEX=-1;d([f.property({readOnly:!0,dependsOn:["activeSourceIndex",
"allSources.length"],value:null})],b.prototype,"activeSource",null);d([f.property({dependsOn:["allSources.length","searchAllEnabled"]})],b.prototype,"activeSourceIndex",null);d([f.property()],b.prototype,"allPlaceholder",void 0);d([f.property({value:new t,dependsOn:["defaultSources.length","sources.length","includeDefaultSources"],readOnly:!0})],b.prototype,"allSources",null);d([f.property()],b.prototype,"autoNavigate",void 0);d([f.property()],b.prototype,"autoSelect",void 0);d([f.property({readOnly:!0})],
b.prototype,"defaultSources",void 0);d([f.property()],b.prototype,"defaultSymbol",void 0);d([f.property()],b.prototype,"includeDefaultSources",void 0);d([f.property()],b.prototype,"locationEnabled",null);d([f.property()],b.prototype,"locationToAddressDistance",void 0);d([f.property()],b.prototype,"maxInputLength",void 0);d([f.property()],b.prototype,"maxResults",void 0);d([f.property()],b.prototype,"maxSuggestions",void 0);d([f.property()],b.prototype,"minSuggestCharacters",void 0);d([f.property({readOnly:!0,
dependsOn:["activeSourceIndex","activeSource.placeholder","allPlaceholder","allSources"]})],b.prototype,"placeholder",null);d([f.property()],b.prototype,"popupEnabled",void 0);d([f.property({type:w})],b.prototype,"popupTemplate",void 0);d([f.property({type:C})],b.prototype,"portal",void 0);d([f.property()],b.prototype,"resultGraphicEnabled",void 0);d([f.property({readOnly:!0})],b.prototype,"resultGraphic",void 0);d([f.property({readOnly:!0})],b.prototype,"results",void 0);d([f.property({readOnly:!0})],
b.prototype,"selectedSuggestion",void 0);d([f.property()],b.prototype,"searchAllEnabled",void 0);d([f.property({readOnly:!0})],b.prototype,"selectedResult",void 0);d([f.property()],b.prototype,"searchTerm",null);d([f.property({type:t})],b.prototype,"sources",void 0);d([f.property({readOnly:!0,dependsOn:["allSources.length"]})],b.prototype,"state",null);d([f.property()],b.prototype,"suggestionDelay",void 0);d([f.property({readOnly:!0})],b.prototype,"suggestions",void 0);d([f.property()],b.prototype,
"suggestionsEnabled",void 0);d([f.property()],b.prototype,"view",void 0);d([f.property()],b.prototype,"clear",null);return b=d([f.subclass("esri.widgets.Search.SearchViewModel")],b)}(f.declared(H,J,X))});