// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports dojo/date/locale ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/promiseUtils ../../../geometry/support/scaleUtils ./geometryUtils".split(" "),function(T,t,I,w,J,K,g,L,B){function C(a,b){var c=a.filter,h=a.searchExtent;b=b&&b.extent;a=a.withinViewEnabled&&b?b:void 0;return c&&c.geometry||h||a}function D(a){return a?a.load().then(g.resolve).catch(g.reject):g.resolve()}function E(a){return a&&!!a.get("capabilities.query.supportsPagination")}function F(a){var b=
"";a&&(a=a.fields)&&a.some(function(a){if("string"===a.type)return b=a.name,!0});return b}function z(a,b){return a&&b?b.every(function(b){return!!a.getField(b)}):!1}function M(a){for(var b=0;b<a.length;b++)if(255<a.charCodeAt(b))return!0;return!1}function N(a,b,c){var h=null;(a=a.codedValues)&&a.some(function(a){var k=a.name,k=c?k:k.toLowerCase();if((c?b:b.toLowerCase())===k)return h=a.code.toString(),!0});return h}function r(a,b){return(b=b&&b.where)?"("+a+") AND ("+b+")":a}function G(a,b,c,h,u){var k=
b.definitionExpression,d="";if(a){var g=O.test(b.url)&&M(a)?"N":"";c&&c.forEach(function(c){var f=b.getField(c);c=((c="function"===typeof b.getFieldDomain&&b.getFieldDomain(c))&&"coded-value"===c.type?N(c,a,u):null)||a||null;if(null!==c){var e=f.type,f=f.name;"string"===e||"date"===e?u?f=r(f+" \x3d "+g+"'"+c+"'",h):(c=c.toUpperCase(),f=r("UPPER("+f+") LIKE "+g+"'%"+c+"%'",h)):"oid"===e||"small-integer"===e||"integer"===e||"single"===e||"double"===e?(c=parseFloat(c),f=isNaN(c)?null:r(f+" \x3d "+c,
h)):f=r(f+" \x3d "+c,h);f&&(d+=d?" OR ("+f+")":"("+f+")")}})}return k?"("+k+") AND ("+d+")":d}function P(a,b){var c=null;(a=a.codedValues)&&a.length&&a.some(function(a){if(a.code===b)return c=a.name,!0});return c}function H(a,b,c){var h=a.layer,g=a.attributes,k="function"===typeof h.getFieldDomain&&h.getFieldDomain(c);return b?J.substitute(g,b):c&&a.hasOwnProperty("attributes")&&g.hasOwnProperty(c)?(a=g[c],c=h.getField(c),k&&"coded-value"===k.type?P(k,a):c&&"date"===c.type?I.format(new Date(a)):c&&
"integer"===c.type?a.toString():a):""}function Q(a,b,c,h){return a.features.map(function(a){var g=a.attributes[a.layer.objectIdField];return{text:H(a,b.suggestionTemplate,h),key:g,sourceIndex:c}})}function R(a,b,c,g,u,k,d){return a.features.map(function(a){var h=a.clone(),f=a.layer,f=(f=f&&f.objectIdField)&&a.attributes[f];a=H(a,c.searchTemplate,u);var e=B.createExtentFromGeometry(h.geometry,b,k);return{extent:d?B.scaleExtent(e.clone(),b,d):e,feature:h,key:f,name:a,sourceIndex:g}})}Object.defineProperty(t,
"__esModule",{value:!0});var O=/https?:\/\/services.*\.arcgis\.com/i,S=/(?:\{([^}]+)\})/g,y=K.getLogger("esri.widgets.Search.support.featureLayerUtils");t.getResults=function(a){var b=a.exactMatch,c=void 0===b?!1:b,h=a.location,u=a.maxResults,k=a.spatialReference,d=a.source,r=a.sourceIndex,x=a.suggestResult,f=a.view,e=d.featureLayer,q=d.filter,m=d.zoomScale,n=f&&f.scale,v=C(d,f);return D(e).then(function(){var a=e.objectIdField,b=e.returnZ,A=d.displayField||d.featureLayer.displayField||F(d.featureLayer);
if(!e.getField(A))return y.error("invalid-field: displayField is invalid."),g.reject(new w("searchfeaturelayerutils:invalid-field","displayField is invalid."));var l=e.get("popupTemplate.requiredFields"),l=l&&l.length?l:null,p=(l=d.outFields||l||[A],-1!==l.indexOf("*"));-1!==l.indexOf(a)||p||l.push(a);if(!p&&!z(e,l))return y.error("invalid-field: outField is invalid."),g.reject(new w("searchfeaturelayerutils:invalid-field","outField is invalid."));a=e.createQuery();(p=d.searchQueryParams)&&a.set(p);
k&&(a.outSpatialReference=k,p=L.getMetersPerUnitForSR(k))&&(a.maxAllowableOffset=p);p=!!e.get("capabilities.data.supportsZ");a.returnZ=p&&!1!==b;a.returnGeometry=!0;l&&(a.outFields=l);if(h)a.geometry=h;else if(x.key)a.objectIds=[parseInt(x.key,10)];else{b=d.searchFields||[A];if(!z(e,b))return y.error("invalid-field: search field is invalid."),g.reject(new w("searchfeaturelayerutils:invalid-field","search field is invalid."));E(e)&&(a.num=u);v&&(a.geometry=v);l=x.text.trim();if(!l)return g.resolve();
var p=d.prefix,t=d.suffix,l=(""+(void 0===p?"":p)+l+(void 0===t?"":t)).replace(/\'/g,"''"),b=G(l,e,b,q,c);if(!b)return g.resolve();a.where=b}return e.queryFeatures(a).then(function(a){return R(a,f,d,r,A,n,m)})})};t.getSuggestions=function(a){var b=a.source,c=a.spatialReference,h=a.suggestTerm,u=a.maxSuggestions,k=a.sourceIndex,d=b.featureLayer,t=b.filter,r=C(b,a.view);return D(d).then(function(){if(!E(d))return g.resolve();var a=b.displayField||b.featureLayer.displayField||F(b.featureLayer),e=b.searchFields||
[a],q=[];b.suggestionTemplate?b.suggestionTemplate.replace(S,function(a,b){q.push(b);return a}):q.push(a);var m=q&&-1!==q.indexOf("*");-1!==q.indexOf(d.objectIdField)||m||q.push(d.objectIdField);var n=!!d.getField(a),m=m||z(d,q),v=z(d,e);if(!n)return y.error("invalid-field: displayField is invalid."),g.reject(new w("searchfeaturelayerutils:invalid-field","displayField is invalid."));if(!m)return y.error("invalid-field: outField is invalid."),g.reject(new w("searchfeaturelayerutils:invalid-field",
"outField is invalid."));if(!v)return y.error("invalid-field: search field is invalid."),g.reject(new w("searchfeaturelayerutils:invalid-field","search field is invalid."));n=d.createQuery();(m=b.suggestQueryParams)&&n.set(m);n.outSpatialReference=c;n.returnGeometry=!1;n.num=u;n.outFields=q;r&&(n.geometry=r);m=h.trim();if(!m)return g.resolve();var v=b.prefix,x=b.suffix,m=(""+(void 0===v?"":v)+m+(void 0===x?"":x)).replace(/\'/g,"''"),e=G(m,d,e,t,!1);if(!e)return g.resolve();n.where=e;return d.queryFeatures(n).then(function(c){return Q(c,
b,k,a)})})}});