// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../Graphic ../../core/Collection ../../core/Handles ../../core/accessorSupport/decorators ../../geometry/geometryEngine ../../geometry/Point ../../geometry/Polyline ../../geometry/projection ../../geometry/ScreenPoint ../../geometry/SpatialReference ../../geometry/support/geodesicUtils ../../layers/GraphicsLayer ../../views/2d/draw/Draw ../../views/interactive/InteractiveToolBase ../../views/interactive/interactiveToolUtils".split(" "),
function(F,G,x,d,n,p,t,f,u,y,z,h,A,B,q,C,D,E,r){return function(v){function c(b){b=v.call(this,b)||this;b._handles=new t;b._mapHandles=new t;b._sketchHandles=new t;b._sketchLayer=new C;b._vertices=null;b._vertexDrag=null;b._vertexHoverIndex=-1;return b}x(c,v);c.prototype.initialize=function(){var b=this;this._draw=new D({view:this.view});var a=this.view;a.map.add(this._sketchLayer);a.focus();this._mapHandles.add(a.on("pointer-move",function(a){return b._updateCursor(new A(a.x,a.y))}));this._mapHandles.add(a.on("drag",
function(c){switch(c.action){case "start":a.hitTest(c).then(function(a){a=new p(a.results);if(0!==a.length){var k=b._sketchLayer.graphics.filter(function(a){return"point"===a.geometry.type});if(0!==k.length&&(a=a.find(function(a){return-1!==k.indexOf(a.graphic)}))){var e=a.graphic.geometry;a=(new p(b._vertices)).findIndex(function(a){return a[0]===e.x&&a[1]===e.y});b._vertexDrag={index:a,origin:e};r.setActive(b,!0);c.stopPropagation()}}});break;case "update":if(b._vertexDrag){var e=a.toMap(c.origin),
w=a.toMap(c);b._vertices[b._vertexDrag.index]=[b._vertexDrag.origin.x+w.x-e.x,b._vertexDrag.origin.y+w.y-e.y];b._updateMeasurements();c.stopPropagation()}break;case "end":b._vertexDrag=null,r.setActive(b,!1)}}));this._handles.add(this.watch(["viewModel.unit","viewModel.mode"],function(){b._updateMeasurements()}));this.projectionEngineRequired&&this.projectionEngineSupported&&(h.isLoaded()||h.load())};c.prototype.destroy=function(){this.detach();this._sketchHandles.removeAll();this._mapHandles.removeAll();
this._sketchLayer.removeAll();this.viewModel.view.map.remove(this._sketchLayer);this.viewModel.measurement=null;this._draw&&(this._draw.destroy(),this._draw=null);this._drawAction&&(this._drawAction.destroy(),this._drawAction=null);this._sketchHandles&&(this._sketchHandles.destroy(),this._sketchHandles=null);this._mapHandles&&(this._mapHandles.destroy(),this._mapHandles=null);this._sketchLayer&&(this._sketchLayer.destroy(),this._sketchLayer=null);this._handles&&(this._handles.destroy(),this._handles=
null)};Object.defineProperty(c.prototype,"editable",{set:function(b){this._set("editable",b);!b&&this._drawAction&&(this._drawAction.destroyed||this._drawAction.destroy(),this._drawAction=null,this._sketchHandles.removeAll());this._updateMeasurements()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"projectionEngineRequired",{get:function(){if(!this.view||!this.view.spatialReference)return!1;var b=this.view.spatialReference;return!b.isWebMercator&&!b.isWGS84&&!q.isSupported(b)},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"projectionEngineSupported",{get:function(){return h.isSupported()},enumerable:!0,configurable:!0});c.prototype.show=function(){this._sketchLayer.visible=!0};c.prototype.hide=function(){this._sketchLayer.visible=!1};c.prototype.reset=function(){this._vertexDrag=this._vertices=null;this._vertexHoverIndex=-1;this._sketchLayer.removeAll();this.viewModel.measurement=null};c.prototype.newMeasurement=function(){this.reset();r.setActive(this,
!0);this._startSketch()};c.prototype.clearMeasurement=function(){this.reset()};c.prototype._startSketch=function(){var b=this;this._drawAction=this._draw.create("polyline",{mode:"click"});this._sketchHandles.add([this._drawAction.on("vertex-add",function(a){return b._updateSketch(a.vertices)}),this._drawAction.on("vertex-update",function(a){return b._updateSketch(a.vertices)}),this._drawAction.on("vertex-remove",function(a){return b._updateSketch(a.vertices)}),this._drawAction.on("cursor-update",
function(a){return b._updateSketch(a.vertices)}),this._drawAction.on("undo",function(a){return b._updateSketch(a.vertices)}),this._drawAction.on("redo",function(a){return b._updateSketch(a.vertices)}),this._drawAction.on("draw-complete",function(){return b._stopSketch()})])};c.prototype._stopSketch=function(){this._sketchHandles.removeAll();this._drawAction=null;r.setActive(this,!1)};c.prototype._updateSketch=function(b){this._vertices=b;this._updateMeasurements()};c.prototype._updateCursor=function(b){var a=
this,c=this.viewModel.view;this._vertexDrag?c.cursor="grabbing":this._drawAction?c.cursor="crosshair":c.hitTest(b).then(function(b){var c=-1;if(0!==b.results.length&&(b=(new p(b.results)).map(function(a){return a.graphic}).find(function(b){return b&&b.layer===a._sketchLayer&&"point"===b.geometry.type})))var e=b.geometry,c=(new p(a._vertices)).findIndex(function(a){return a[0]===e.x&&a[1]===e.y});c!==a._vertexHoverIndex&&(a._vertexHoverIndex=c,a.cursor=-1===a._vertexHoverIndex?null:"pointer",a._updateMeasurements())})};
c.prototype._updateMeasurements=function(){var b=this;if(!(!this._vertices||this.projectionEngineRequired&&!h.isLoaded()||(this._sketchLayer.removeAll(),2>this._vertices.length))){var a=this.viewModel,c=a.palette,e=a.view.spatialReference,f=[],d=q.isSupported(e),k=!d&&!e.isWebMercator&&!e.isWGS84,l=new z({paths:[this._vertices],spatialReference:e}),g=k?h.project(l,B.WGS84):l,m=null;d||k?(a.measurement={geometry:g,length:q.geodesicLengths([g],"meters")[0]},m=q.geodesicDensify(g,1E5)):(d=u.planarLength(g,
"meters"),"geodesic"===a.mode||"auto"===a.mode&&d>=a.geodesicDistanceThreshold?(a.measurement={geometry:g,length:u.geodesicLength(g,"meters")},m=u.geodesicDensify(l,1E5,"meters")):(a.measurement={geometry:g,length:d},m=l.clone()));f.push(new n({geometry:m,symbol:{type:"simple-line",cap:"butt",join:"round",color:c.pathPrimaryColor,width:c.pathWidth}}),new n({geometry:m,symbol:{type:"simple-line",style:"dash",cap:"butt",join:"round",color:c.pathSecondaryColor,width:c.pathWidth-2}}));f.push(new n({geometry:l.extent.center,
symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:a.measurementLabel,font:{size:14,family:"sans-serif"}}}));this.editable&&this._vertices.forEach(function(a,d){d=b._vertexHoverIndex===d?1.5:1;f.push(new n({geometry:new y({x:a[0],y:a[1],spatialReference:e}),symbol:{type:"simple-marker",color:c.handleColor,size:c.handleWidth*d,outline:{type:"simple-line",width:0}}}))});this._sketchLayer.addMany(f)}};d([f.property({constructOnly:!0})],c.prototype,"viewModel",void 0);d([f.property()],
c.prototype,"cursor",void 0);d([f.property({value:!0})],c.prototype,"editable",null);d([f.property({dependsOn:["view.spatialReference"],readOnly:!0})],c.prototype,"projectionEngineRequired",null);d([f.property({readOnly:!0})],c.prototype,"projectionEngineSupported",null);return c=d([f.subclass("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],c)}(f.declared(E))});