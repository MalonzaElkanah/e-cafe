// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../geometry ../../core/Accessor ../../core/arrayUtils ../../core/Collection ../../core/Handles ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/support/contains ../../geometry/support/webMercatorUtils".split(" "),function(z,A,t,k,u,v,w,p,x,m,f,y,q){return function(r){function d(a){a=r.call(this,a)||this;a._handles=new x;a._pendingAttributionItemsByLayerId={};a._attributionDataByLayerId=
{};a.items=new p;a.view=null;a._updateAttributionItems=a._updateAttributionItems.bind(a);return a}t(d,r);d.prototype.initialize=function(){this._handles.add(m.init(this,"view",this._viewWatcher))};d.prototype.destroy=function(){this._handles.destroy();this.view=this._handles=null};Object.defineProperty(d.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!0,configurable:!0});d.prototype._viewWatcher=function(a){var e=this,c=this._handles;c&&c.remove();a&&
(c.add([a.allLayerViews.on("change",function(a){e._addLayerViews(a.added);0<a.removed.length&&(a.removed.forEach(function(a){c.remove(a.uid)}),e._updateAttributionItems())}),m.init(a,"stationary",this._updateAttributionItems)]),this._addLayerViews(a.allLayerViews))};d.prototype._addLayerViews=function(a){var e=this;a.forEach(function(a){e._handles.has(a.uid)||e._handles.add(m.init(a,"suspended",e._updateAttributionItems),a.uid)})};d.prototype._updateAttributionItems=function(){var a=this,e=[];this._getActiveLayerViews().forEach(function(c){var b=
c.layer;if(b&&"function"===typeof b.originOf&&"user"===b.originOf("copyright"))a._addIfUnique(e,{layer:b,text:b.copyright});else if(c=b.get("portalItem.accessInformation"))a._addIfUnique(e,{layer:b,text:c});else if(b.hasAttributionData){var d=a._attributionDataByLayerId;if(d[b.uid])a._addIfUnique(e,{layer:b,text:a._getDynamicAttribution(d[b.uid],a.view,b)});else{var h=a._pendingAttributionItemsByLayerId;a._inProgress(h[b.uid])||(h[b.uid]=b.fetchAttributionData().then(function(c){c=a._createContributionIndex(c,
a._isBingLayer(b));delete h[b.uid];d[b.uid]=c;a._updateAttributionItems()}))}}else a._addIfUnique(e,{layer:b,text:b.copyright})});this._itemsChanged(this.items,e)&&(this.items.removeAll(),this.items.addMany(e))};d.prototype._itemsChanged=function(a,e){return a.length!==e.length||a.some(function(a,b){return a.text!==e[b].text})};d.prototype._inProgress=function(a){return a&&!a.isFulfilled()};d.prototype._getActiveLayerViews=function(){return this.get("view.allLayerViews").filter(function(a){return!a.suspended&&
a.get("layer.attributionVisible")})};d.prototype._addIfUnique=function(a,e){var c=e.layer,b=e.text;b&&c&&(w.find(a,function(a){return a.layer===c&&a.text===b})||a.push({text:b,layer:c}))};d.prototype._isBingLayer=function(a){return"bing-maps"===a.type};d.prototype._createContributionIndex=function(a,e){a=a.contributors;var c={};if(!a)return c;for(var b=0;b<a.length;b++){var d=a[b],h=d.coverageAreas;if(!h)return;for(var n=0;n<h.length;n++)for(var g=h[n],f=g.bbox,l=g.zoomMin-(e&&g.zoomMin?1:0),k=g.zoomMax-
(e&&g.zoomMax?1:0),g={extent:q.geographicToWebMercator({xmin:f[1],ymin:f[0],xmax:f[3],ymax:f[2],spatialReference:u.SpatialReference.WGS84}),attribution:d.attribution||"",score:null!=g.score?g.score:100,id:b};l<=k;l++)c[l]=c[l]||[],c[l].push(g)}c.maxKey=Math.max.apply(null,Object.keys(c));return c};d.prototype._getDynamicAttribution=function(a,d,c){var b=d.extent;c=c.tileInfo.scaleToZoom(d.scale);c=Math.min(a.maxKey,Math.round(c));if(!b||null==c||-1>=c)return"";a=a[c];var e=q.project(b.center.clone().normalize(),
d.spatialReference),f={};return a.filter(function(a){var b=!f[a.id]&&e&&y.extentContainsPoint(a.extent,e);b&&(f[a.id]=!0);return b}).sort(function(a,b){return b.score-a.score||a.objectId-b.objectId}).map(function(a){return a.attribution}).join(", ")};k([f.property({readOnly:!0,type:p})],d.prototype,"items",void 0);k([f.property({dependsOn:["view.ready"],readOnly:!0})],d.prototype,"state",null);k([f.property()],d.prototype,"view",void 0);return d=k([f.subclass("esri.widgets.Attribution.AttributionViewModel")],
d)}(f.declared(v))});