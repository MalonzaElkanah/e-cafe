// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../Graphic ../../../../core/Error ../../../../core/Handles ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/fieldUtils ../../statistics/support/utils ./FeatureLayerAdapter ./LayerAdapter ./support/utils ../../../../tasks/support/FeatureSet".split(" "),function(D,E,t,y,p,v,g,z,e,m,r,A,B,
C,l,w){return function(x){function b(a){a=x.call(this,a)||this;a._handles=new z;return a}y(b,x);Object.defineProperty(b.prototype,"outFields",{get:function(){return this.layer.fields.map(function(a){return a.name})},enumerable:!0,configurable:!0});b.prototype._hasCachedStatistics=function(a){return this.layer.hasCachedStatistics(a)};b.prototype._fetchFeaturesFromMemory=function(a){var c=this;return a?a.whenLayerView(this.layer).then(function(a){var d=e.create(function(d,f){var k=a.watch("updating",
function(){c._handles.remove("layerViewUpdate");a.queryFeatures().then(function(a){"esri.tasks.support.FeatureSet"===a.declaredClass?d(a.features):d(a)}).catch(function(a){f(a)})});c._handles.add(k,"layerViewUpdate")});e.timeout(d,1E4,null);return d}):e.reject(new g("scene-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))};b.prototype._generateFeatureSetForCachedHistogram=function(a,c,d,f){void 0===c&&(c=a.minimum);void 0===d&&(d=a.maximum);for(var k=[],b=
0;b<f;b++)k[b]=0;for(var n=a.counts.length,e=a.minimum,g=a.maximum,b=0;b<n;b++){var h=(b+.5)/n,h=((1-h)*e+h*g-c)/(d-c)*f;0<=h&&h<=f&&(k[h===f?f-1:Math.floor(h)]+=a.counts[b])}var l=[];k.forEach(function(a,d){var c=new v({attributes:{}});c.attributes.EXPR_1=d+1;c.attributes.countOFExpr=a;l.push(c)});a=new w;a.features=l;return a};b.prototype._getCachedStatistics=function(a,c){var d=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.minValue||a.maxValue?e.reject(new g("scene-layer-adapter:not-supported",
"This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression', 'sqlWhere', 'minValue' or 'maxValue' is specified")):d.queryCachedStatistics(c&&c.name).then(function(a){var c=a.stats;a=c.min;var d=c.max,b=c.avg,f=c.stddev,e=c.sum,h=c.variance,c=c.count;if(0!==a||0!==d)b=0===b?null:b,e=0===e?null:e,f=0===f?null:f,h=0===h?null:h,c=0===c?null:c;null==c&&null!=e&&null!=b&&(c=Math.round(e/b));return{avg:b,count:c,max:d,min:a,stddev:f,sum:e,variance:h}})};b.prototype._getSummaryStatisticsFromMemory=
function(a,c){return(a.features?e.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(d){if(!d||!d.length)return e.reject(new g("scene-layer-adapter:insufficient-data","No features are available to calculate statistics"));var b=r.isDateField(c),k=t({},a);if("percent-of-total"===k.normalizationType){var q=l.calculateStatsFromMemory({field:k.field},d).sum;if(null==q)return e.reject(new g("scene-layer-adapter:invalid","invalid normalizationTotal"));k.normalizationTotal=q}d=l.calculateStatsFromMemory(k,
d,b);return l.processSummaryStatisticsResult(d)})};b.prototype._getCachedStatisticsForUniqueValues=function(a,c){var d=this,b=this.layer,k=c&&c.name,q=c&&this.getFieldDomain(a.field);return a.valueExpression||a.sqlExpression||a.sqlWhere?e.reject(new g("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression' or 'sqlWhere' is specified")):b.queryCachedStatistics(k).then(function(f){var e=f.stats;f=f.labels&&f.labels.labels;var g=
{},h=[];if(e.mostFrequentValues){var n="countOF"+k;e.mostFrequentValues.forEach(function(a){var d=new v({attributes:{}});d.attributes[k]=c&&c.name!==b.objectIdField&&(r.isNumericField(c)||r.isDateField(c))?Number(a.value):a.value;d.attributes[n]=a.count;h.push(d)});f&&f.forEach(function(a){g[a.value]=a.label})}e=new w;e.features=h;return l.getUniqueValuesFromFeatureSet(e,d,a.field,g)}).then(function(c){return l.createUVResult(c,"service-cached-query",q,a.returnAllCodedValues)})};b.prototype._getUniqueValuesFromMemory=
function(a,c){var d=c&&this.getFieldDomain(a.field);return(a.features?e.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(c){return l.calculateUniqueValuesFromMemory(a,c,d)})};b.prototype._getCachedStatisticsForHistogram=function(a,c){var d=this,b=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.normalizationType?e.reject(new g("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression' or 'sqlExpression' or 'sqlWhere' or 'normalizationType' is specified")):
b.queryCachedStatistics(c&&c.name).then(function(c){c=c.stats;var b=a.minValue,f=a.maxValue,b=null!=b?b:c.min,f=null!=f?f:c.max,e=a.numBins||10;c=d._generateFeatureSetForCachedHistogram(c.histogram,b,f,e);return l.getHistogramFromFeatureSet(c,b,f,e)})};b.prototype._getClassBreaksFromMemory=function(a){return(a.features?e.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(c){if(!c||!c.length)return e.reject(new g("scene-layer-adapter:insufficient-data","No features are available to calculate statistics"));
var d=t({},a);if("percent-of-total"===d.normalizationType){var b=l.calculateStatsFromMemory({field:d.field},c).sum;if(null==b)return e.reject(new g("scene-layer-adapter:invalid","invalid normalizationTotal"));d.normalizationTotal=b}return l.calculateClassBreaksFromMemory(d,c)})};b.prototype._getHistogramFromMemory=function(a){var c=this;return(a.features?e.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(d){if(!d||!d.length)return e.reject(new g("scene-layer-adapter:insufficient-data",
"No features are available to calculate histogram"));var b=a.field,k=a.normalizationType,q=a.valueExpression,n=a.classificationMethod,m=a.minValue,p=a.maxValue,h=a.view,r=null!=m&&null!=p,u=null;n&&"equal-interval"!==n||k?(b=t({},a),b.features=d,u=c._getBinParamsFromMemory(b)):u=r?e.resolve({min:m,max:p}):c.summaryStatistics({field:b,valueExpression:q,features:d,view:h}).then(function(a){return a.count?{min:a.min,max:a.max}:e.reject(new g("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});
return u.then(function(c){return l.calculateHistogramFromMemory(a,c,d)})})};b.prototype._getBinParamsFromMemory=function(a){var c=a.field,b=a.normalizationType,e=a.normalizationField;return this._getClassBreaksFromMemory({field:c,valueExpression:a.valueExpression,normalizationType:b,normalizationField:e,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,minValue:a.minValue,maxValue:a.maxValue,numClasses:a.numBins,features:a.features,view:a.view}).then(function(a){var d=
a.normalizationTotal;a=a.classBreakInfos;var f=A.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:e});return l.generateBinParams({field:c,normalizationType:b,normalizationField:e,normalizationTotal:d,classBreaks:a,where:f})})};b.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};b.prototype.getFieldUsageInfo=function(a){a=this.getField(a);if(!a)return null;a=this.layer.getFieldUsageInfo(a.name);return{supportsLabelingInfo:a.supportsLabelingInfo,
supportsPopupTemplate:a.supportsPopupTemplate,supportsRenderer:a.supportsRenderer,supportsLayerQuery:a.supportsLayerQuery,supportsStatistics:!0}};b.prototype.getFieldDomain=function(a,c){return this._featureLayerAdapter?this._featureLayerAdapter.getFieldDomain(a,c):null};b.prototype.summaryStatistics=function(a){var c=this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.summaryStatistics(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatistics(a,b).catch(function(d){return c._getSummaryStatisticsFromMemory(a,
b)}):this._getSummaryStatisticsFromMemory(a,b)};b.prototype.uniqueValues=function(a){var c=this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.uniqueValues(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatisticsForUniqueValues(a,b).catch(function(d){return c._getUniqueValuesFromMemory(a,b)}):this._getUniqueValuesFromMemory(a,b)};b.prototype.histogram=function(a){var c=this,b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.histogram(a):
this._hasCachedStatistics(b&&b.name)?this._getCachedStatisticsForHistogram(a,b).catch(function(b){return c._getHistogramFromMemory(a)}):this._getHistogramFromMemory(a)};b.prototype.classBreaks=function(a){var c=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.classBreaks(a):this._hasCachedStatistics(c&&c.name)?e.reject(new g("scene-layer-adapter:not-supported","Cached stats not supported")):this._getClassBreaksFromMemory(a)};b.prototype.queryFeatureCount=function(a){return this._featureLayerAdapter?
this._featureLayerAdapter.queryFeatureCount(a):e.reject(new g("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support count query"))};b.prototype.generateRenderer=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.generateRenderer(a):e.reject(new g("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support generateRenderer operation"))};b.prototype.heatmapStatistics=function(a){return this._featureLayerAdapter?
this._featureLayerAdapter.heatmapStatistics(a):e.reject(new g("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support heatmapStatistics operation"))};b.prototype.getPredominantCategories=function(a,c){return this._featureLayerAdapter?this._featureLayerAdapter.getPredominantCategories(a,c):e.reject(new g("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support getPredominantCategories"))};b.prototype.load=function(){var a=
this,c=this.layer,b=c.load().then(function(){var b=c.associatedLayer;a.geometryType=c.geometryType;if(b)return a._featureLayerAdapter=new B({layer:b}),a._featureLayerAdapter.load().then(function(){a.objectIdField=a._featureLayerAdapter.objectIdField;a.supportsSQLExpression=a._featureLayerAdapter.supportsSQLExpression});a.objectIdField=c.objectIdField;a.supportsSQLExpression=!1;a.hasQueryEngine=!1});this.addResolvingPromise(b);return this.when()};p([m.property({constructOnly:!0})],b.prototype,"layer",
void 0);p([m.property()],b.prototype,"outFields",null);return b=p([m.subclass()],b)}(m.declared(C))});