// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/promiseUtils ../../utils ../../../../support/heatmapUtils ../../../../../support/arcadeUtils ../../../../../tasks/support/ClassBreaksDefinition ../../../../../tasks/support/generateRendererUtils".split(" "),function(T,h,K,L,F,t,M,N){function B(a,c,b){c=null==c?-Infinity:c;b=null==b?Infinity:b;return a.filter(function(a){if(null!=a&&n(a)&&a>=c&&a<=b)return a})}function q(a,c){var b=a.field,d="function"===typeof b,e=a.valueExpression,f=t.createFunction(e),
g=a.normalizationType,m=a.normalizationField,k=a.normalizationTotal,r=[],h=(a=a.view)&&t.getViewInfo({viewingMode:"2d"===a.type?"map":a.viewingMode,scale:a.scale,spatialReference:a.spatialReference});if(!c)return r;c.forEach(function(a){var c=a.attributes,l;e?(l=t.createExecContext(a,h),l=t.executeFunction(f,l)):d?l=b.call(null,a):c&&(l=c[b]);g&&null!=l&&n(l)&&(c=c&&parseFloat(c[m]),"log"===g&&0!==l?l=Math.log(l)*Math.LOG10E:"percent-of-total"===g&&n(k)&&0!==k?l=l/k*100:"field"===g&&n(c)&&0!==c&&
(l/=c));r.push(l)});return r}function O(a,c){for(var b=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,e=null,f=null,g=null,m=null,k=0;k<a.length;k++)var r=a[k],e=e+r,b=Math.min(b,r),d=Math.max(d,r);if(k=a.length){f=e/k;for(m=g=0;m<a.length;m++)r=a[m],g+=Math.pow(r-f,2);m=c?1<k?g/(k-1):0:0<k?g/k:0;g=Math.sqrt(m)}else d=b=null;return{avg:f,count:k,max:d,min:b,stddev:g,sum:e,variance:m}}function C(a){var c=a.field,b=a.classificationMethod||"equal-interval",d=a.normalizationType,e=a.normalizationField,
f=new M;f.classificationField=c;f.breakCount=a.breakCount;f.classificationMethod=b;f.standardDeviationInterval="standard-deviation"===b?a.standardDeviationInterval||1:void 0;f.normalizationType=d;f.normalizationField="field"===d?e:void 0;return f}function G(a,c){var b=c.classBreaks,d=b[0].minValue,e=b[b.length-1].maxValue,f="standard-deviation"===a.classificationMethod,g=P,b=b.map(function(a){var b=a.label;a={minValue:a.minValue,maxValue:a.maxValue,label:b};if(f&&b){var c=b.match(g).map(function(a){return+a.trim()});
2===c.length?(a.minStdDev=c[0],a.maxStdDev=c[1],0>c[0]&&0<c[1]&&(a.hasAvg=!0)):1===c.length&&(-1<b.indexOf("\x3c")?(a.minStdDev=null,a.maxStdDev=c[0]):-1<b.indexOf("\x3e")&&(a.minStdDev=c[0],a.maxStdDev=null))}return a});return{minValue:d,maxValue:e,classBreakInfos:b,normalizationTotal:c.normalizationTotal}}function u(a,c,b){c=(c-a)/b;for(var d=[],e,f=1;f<=b;f++)e=a+c,e=Number(e.toFixed(16)),d.push([a,e]),a=e;return d}function H(a){var c=a.field,b=a.normalizationType,d=a.normalizationField;a=a.normalizationTotal;
var e=c;"percent-of-total"===b?e="(("+c+" / "+a+") * 100)":"log"===b?e="(log("+c+") * "+Q+")":"field"===b&&(e="("+c+" / "+d+")");return e}function R(a,c){for(var b=-1,d=a.length-1;0<=d;d--)if(c>=a[d][0]){b=d;break}return b}function I(a,c){var b;c=c.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()!==c){b=a[d];break}return b}function v(a,c){var b;c=c.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()===c){b=a[d];break}return b}function x(a,c){if(c)for(var b in a)a[b].label=c[b];return{count:a}}
function J(a,c,b,d){var e=a.count;a=[];d&&b&&"coded-value"===b.type&&b.codedValues.forEach(function(a){a=a.code;e.hasOwnProperty(a)||(e[a]={data:a,count:0})});for(var f in e)b=e[f],a.push({value:b.data,count:b.count,label:b.label});return{uniqueValueInfos:a}}function n(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a}Object.defineProperty(h,"__esModule",{value:!0});var S=/_value$/i,P=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,Q=Math.LOG10E;h.statisticTypes="min max avg stddev count sum variance".split(" ");
h.getSummaryStatisticsFromFeatureSet=function(a,c){a=(a=a&&a.features)&&a[0]&&a[0].attributes;var b={},d;for(d in a)b[d.replace(S,"").toLowerCase()]=a[d];b.min===b.max&&null!=b.min&&null==b.stddev&&(b.stddev=b.variance=0);c&&("min max avg stddev sum variance".split(" ").forEach(function(a){null!=b[a]&&(b[a]=Math.ceil(b[a]))}),b.min===b.max&&null!=b.min&&(b.avg=b.min,b.stddev=b.variance=0));return b};h.calculateStatsFromMemory=function(a,c,b){c=q(a,c);c=B(c,a.minValue,a.maxValue);var d=O(c,!a.normalizationType);
b&&["avg","stddev","variance"].forEach(function(a){null!=d[a]&&(d[a]=Math.ceil(d[a]))});return d};h.getDataValues=q;h.processSummaryStatisticsResult=function(a){for(var c in a)-1<h.statisticTypes.indexOf(c)&&(n(a[c])||(a[c]=null));return a};h.createCBDefn=C;h.calculateHeatmapStats=function(a,c,b,d,e,f){void 0===c&&(c=10);var g=new Float64Array(e*f),m=F.createKernel(c);c=Math.round(4.5*c);var k=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,n=null,p=0,q=0,l=0,t=0,y=0;b=F.createValueFunction(d,
b);for(d=0;d<a.length;d++)for(var D=a[d],w=D.geometry,u=w.x-c,v=w.y-c,x=Math.max(0,u),p=Math.max(0,v),B=Math.min(f,w.y+c),w=Math.min(e,w.x+c),D=+b(D.attributes),z=p;z<B;z++)for(var C=m[z-v],A=x;A<w;A++){p=g[z*e+A]+=C*m[A-u]*D;n||(n=p);var E=p-n,q=q+p,l=l+E,t=t+E*E;p<k&&(k=p);p>h&&(h=p);y++}return y?{mean:q/y,stdDev:Math.sqrt((t-l*l/y)/y),min:k,max:h,mid:(h-k)/2}:{mean:0,stddev:0,min:0,max:0,mid:0}};h.calculateClassBreaksFromMemory=function(a,c){var b=a.normalizationTotal,d=C({field:a.field,normalizationType:a.normalizationType,
normalizationField:a.normalizationField,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5});c=q(a,c);c=B(c,a.minValue,a.maxValue);b=N.createGenerateRendererClassBreaks({definition:d,values:c,normalizationTotal:b});return G(a,b)};h.resolveCBResult=G;h.getEqualIntervalBins=u;h.generateBinParams=function(a){var c=[],b=a.classBreaks,d=b[0].minValue,e=b[b.length-1].maxValue;b.forEach(function(a){c.push([a.minValue,a.maxValue])});
return{min:d,max:e,intervals:c,sqlExpr:H({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};h.getFieldExpr=H;h.calculateHistogramFromMemory=function(a,c,b){var d=c.min,e=c.max,f=c.normTotal,g=a.numBins||10,m=c.intervals||u(d,e,g);c=m.map(function(a,b){return{minValue:m[b][0],maxValue:m[b][1],count:0}});g=0;for(a=q(a,b);g<a.length;g++)b=a[g],null!=b&&b>=d&&b<=
e&&(b=R(m,b),-1<b&&c[b].count++);return{bins:c,minValue:d,maxValue:e,normalizationTotal:f}};h.getHistogramFromFeatureSet=function(a,c,b,d,e){var f={};a&&a.features&&a.features.forEach(function(a){var b=a.attributes;a=I(b,"countOFExpr");b=v(b,"countOFExpr");0!==a&&(f[a]=b)});var g=[];u(c,b,d).forEach(function(a,b){b=(b+1).toString();g.push({minValue:a[0],maxValue:a[1],count:f.hasOwnProperty(b)?f[b]:0})});return{bins:g,minValue:c,maxValue:b,normalizationTotal:e}};h.getUniqueValuesFromFeatureSet=function(a,
c,b,d){var e="countOF"+(b||"Expr"),f={},g=!1;(a&&a.features).forEach(function(a){var c=a.attributes;a=v(c,e);c=b?v(c,b):I(c,e);null===c&&0===a&&(g=!0);if(null==c||"string"===typeof c&&""===c.trim())c=null;null==f[c]?f[c]={count:a,data:c}:f[c].count+=a});return b&&g?c.queryFeatureCount(b+" is NULL").then(function(a){f["null"].count+=a||0;return x(f,d)}).catch(function(){return x(f,d)}):K.resolve(x(f,d))};h.createUVResult=J;h.calculateUniqueValuesFromMemory=function(a,c,b){var d=a.features?"features":
"features-in-memory",e={},f=0;for(c=q(a,c);f<c.length;f++){var g=c[f];if(null==g||"string"===typeof g&&""===g.trim())g=null;null==e[g]?e[g]={count:1,data:g}:e[g].count++}return J({count:e},d,b,a.returnAllCodedValues)};h.msSinceUnixEpochSQL=function(a,c){return L.getDateDiffSQL(a,new Date(0),c,"milliseconds").sqlExpression};h.isValidNumber=n});