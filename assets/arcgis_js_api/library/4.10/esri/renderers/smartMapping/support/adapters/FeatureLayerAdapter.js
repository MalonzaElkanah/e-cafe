// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../geometry ../../../../core/Error ../../../../core/Handles ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/quantizationUtils ../../../../layers/support/arcgisLayerUrl ../../../../layers/support/fieldUtils ../../statistics/support/utils ../utils ./LayerAdapter ./support/predominanceUtils ./support/utils ../../../../tasks/GenerateRendererTask ../../../../tasks/support/GenerateRendererParameters ../../../../tasks/support/QuantizationParameters ../../../../tasks/support/Query ../../../../tasks/support/StatisticDefinition ../../../../tasks/support/UniqueValueDefinition".split(" "),
function(O,P,q,E,w,F,m,G,g,u,r,C,H,y,l,I,J,z,k,K,A,L,M,B,N){return function(D){function d(a){a=D.call(this,a)||this;a._handles=new G;return a}E(d,D);d.prototype.destroy=function(){this._handles.destroy();this._hasLocalSource=this._handles=null};Object.defineProperty(d.prototype,"outFields",{get:function(){return this.layer.outFields},enumerable:!0,configurable:!0});d.prototype._isStatsSupportedOnService=function(){var a=this.layer;return!a.get("capabilities.query.supportsStatistics")||"multipatch"===
this.geometryType&&!H.isHostedAgolService(a.url)&&10.5>a.version?g.reject(new m("feature-layer-adapter:not-supported","Layer does not support statistics query")):g.resolve()};d.prototype._fetchFeaturesFromMemory=function(a,c){var b=this.layer;return this._hasLocalSource?g.resolve(b.source):a?a.whenLayerView(b).then(function(a){var b=u.whenFalseOnce(a,"updating").then(function(){return a.queryFeatures(c)}).then(function(a){return a.features});g.timeout(b,1E4,null);return b}):g.reject(new m("feature-layer-adapter:insufficient-data",
"view is required to fetch the features from layerView"))};d.prototype._fetchFeaturesForStats=function(a){var c=this,b=this.layer,e=I.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),b=b.createQuery();b.returnGeometry=!1;b.outFields=e;return this.layer.queryFeatures(b).then(function(a){return a&&a.features}).catch(function(b){return c._fetchFeaturesFromMemory(a.view)})};d.prototype._summaryStatsFromGenRend=function(a){var c=a.normalizationType,
b=a.normalizationField;return this.classBreaks({field:a.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:c,normalizationField:"field"===c?b:void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(a){var b,c,e;a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(e=b.maxValue-b.minValue,c=b.minValue+e/2,e*=4);return k.processSummaryStatisticsResult({min:a.minValue,max:a.maxValue,avg:c,stddev:e})})};d.prototype._getSummaryStatsQuery=
function(a,c){var b=a.field,e=(c=this.supportsSQLExpression&&c?k.msSinceUnixEpochSQL(this,b):a.sqlExpression)||b,b=e?l.getRangeExpr(e,a.minValue,a.maxValue):null;a=l.mergeWhereClauses(a.sqlWhere,b);b=this.layer.createQuery();b.where=l.mergeWhereClauses(b.where,a);b.sqlFormat=c?"standard":null;b.outStatistics=k.statisticTypes.map(function(a){var b=new B;b.statisticType="variance"===a?"var":a;b.onStatisticField=e;b.outStatisticFieldName=a+"_value";return b});return b};d.prototype._summaryStatsFromServiceQuery=
function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getSummaryStatsQuery(a,c))}).then(function(a){return k.getSummaryStatisticsFromFeatureSet(a,c)}).then(k.processSummaryStatisticsResult)};d.prototype._summaryStatsFromClientQuery=function(a,c){var b=this,e=a.view;return e?e.whenLayerView(this.layer).then(function(e){var f=u.whenFalseOnce(e,"updating").then(function(){return e.queryFeaturesJSON(b._getSummaryStatsQuery(a,c))}).then(function(a){return k.getSummaryStatisticsFromFeatureSet(a,
c)}).then(k.processSummaryStatisticsResult);g.timeout(f,1E4,null);return f}):g.reject(new m("feature-layer-adapter:insufficient-data","view is required to query stats from layerView"))};d.prototype._summaryStatsFromMemory=function(a,c){var b=a.field,e=a.valueExpression,f=(e||a.sqlExpression)&&!a.sqlExpression,h=a.view,e={field:b,valueExpression:e,normalizationField:a.normalizationField,view:h};return(this._hasLocalSource||a.features||"function"!==typeof b&&!f?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(h):
this._fetchFeaturesForStats(e)).then(function(e){if(!e||!e.length)return g.reject(new m("feature-layer-adapter:insufficient-data","No features are available to calculate statistics"));var f=q({},a);if("percent-of-total"===f.normalizationType){var h=k.calculateStatsFromMemory({field:b},e).sum;if(null==h)return g.reject(new m("feature-layer-adapter:invalid","invalid normalizationTotal"));f.normalizationTotal=h}e=k.calculateStatsFromMemory(f,e,c);return k.processSummaryStatisticsResult(e)})};d.prototype._uvFromGenRenderer=
function(a,c){var b=this,e=a.field,f=new N;f.attributeField=e;var h=new A;h.classificationDefinition=f;return this.generateRenderer(h).then(function(a){var c={},f=b.getField(e);a.uniqueValues.forEach(function(a){var b=a.value;if(null==b||""===b||"string"===typeof b&&(""===b.trim()||"\x3cnull\x3e"===b.toLowerCase()))b=null;null==c[b]?c[b]={count:a.count,data:y.isNumericField(f)&&b?Number(b):b}:c[b].count+=a.count});return{count:c}}).then(function(b){return k.createUVResult(b,"service-generate-renderer",
c,a.returnAllCodedValues)})};d.prototype._getUVQuery=function(a){var c=a.field,b=a.sqlExpression,e="countOF"+(c||"Expr"),f=new B;f.statisticType="count";f.onStatisticField=b?"1":c;f.outStatisticFieldName=e;e=this.layer.createQuery();e.where=l.mergeWhereClauses(e.where,a.sqlWhere);e.sqlFormat=b?"standard":null;e.outStatistics=[f];e.groupByFieldsForStatistics=[c||b];return e};d.prototype._uvFromServiceQuery=function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getUVQuery(a))}).then(function(c){return k.getUniqueValuesFromFeatureSet(c,
b,a.field)}).then(function(b){return k.createUVResult(b,"service-query",c,a.returnAllCodedValues)})};d.prototype._uvFromClientQuery=function(a,c){var b=this,e=a.view;return e?e.whenLayerView(this.layer).then(function(e){var f=u.whenFalseOnce(e,"updating").then(function(){return e.queryFeaturesJSON(b._getUVQuery(a))}).then(function(c){return k.getUniqueValuesFromFeatureSet(c,b,a.field)}).then(function(b){return k.createUVResult(b,"service-query",c,a.returnAllCodedValues)});g.timeout(f,1E4,null);return f}):
g.reject(new m("feature-layer-adapter:insufficient-data","view is required to query stats from layerView"))};d.prototype._uvFromMemory=function(a,c){var b=a.valueExpression,e=a.sqlExpression,f=a.view,h={field:a.field,valueExpression:b,view:f};return(this._hasLocalSource||a.features||!b||e?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(f):this._fetchFeaturesForStats(h)).then(function(b){return k.calculateUniqueValuesFromMemory(a,b,c)})};d.prototype._calcBinsSQL=function(a,c){var b=
[],e=c.length;c.forEach(function(c,h){c=l.mergeWhereClauses(a+" \x3e\x3d "+c[0],a+(h===e-1?" \x3c\x3d ":" \x3c ")+c[1]);b.push("WHEN ("+c+") THEN "+(h+1))});return["CASE",b.join(" "),"ELSE 0 END"].join(" ")};d.prototype._getNormalizationTotal=function(a,c){return a&&"percent-of-total"===c?this.summaryStatistics({field:a}).then(function(a){return a.sum}):g.resolve(null)};d.prototype._getQueryParamsForExpr=function(a,c){if(!a.valueExpression&&!a.sqlExpression){var b=a.field,e=b?this.getField(b):null,
e=y.isDateField(e);c={field:b,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:c};return{sqlExpression:e?k.msSinceUnixEpochSQL(this,b):k.getFieldExpr(c),sqlWhere:e?null:a.sqlWhere||l.getSQLFilterForNormalization(a)}}return{valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere}};d.prototype._getDataRange=function(a,c,b){return null!=c&&null!=b?g.resolve({min:c,max:b}):this.summaryStatistics(a).then(function(a){return{min:a.min,
max:a.max}})};d.prototype._histogramForExpr=function(a){var c=this;return this._getNormalizationTotal(a.field,a.normalizationType).then(function(b){var e=c._getQueryParamsForExpr(a,b);return c._getDataRange(e,a.minValue,a.maxValue).then(function(f){var h=f.min,d=f.max,p=a.numBins||10;f=k.getEqualIntervalBins(h,d,p);f=c._calcBinsSQL(e.sqlExpression,f);var g=new B({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),n=c.layer.createQuery();n.where=l.mergeWhereClauses(n.where,
e.sqlWhere);n.sqlFormat="standard";n.outStatistics=[g];n.groupByFieldsForStatistics=[f];n.orderByFields=[f];return c._isStatsSupportedOnService().then(function(){return c.layer.queryFeatures(n)}).then(function(a){return k.getHistogramFromFeatureSet(a,h,d,p,b)})})})};d.prototype._histogramForField=function(a){var c=this,b=null,b=null!=a.minValue&&null!=a.maxValue?g.resolve({min:a.minValue,max:a.maxValue}):this.summaryStatistics(a).then(function(a){return a.count?{min:a.min,max:a.max}:g.reject(new m("feature-layer-adapter:insufficient-data",
"Either the layer has no features or none of the features have data for the field"))});return b.then(function(b){return c._getBins({min:b.min,max:b.max},a.field,a.numBins)})};d.prototype._getBins=function(a,c,b){void 0===b&&(b=10);var e=a.min,f=a.max,h=a.normTotal,d=a.excludeZerosExpr,g=a.intervals||k.getEqualIntervalBins(e,f,b);return this._queryBins(g,a.sqlExpr||c,d).then(function(a){return{bins:a.map(function(a,b){return{minValue:g[b][0],maxValue:g[b][1],count:a.value}}),minValue:e,maxValue:f,
normalizationTotal:h}})};d.prototype._queryBins=function(a,c,b){for(var e=this,f=[],h=a.length,d=0;d<h;d++){var k=l.mergeWhereClauses(b,l.mergeWhereClauses(c+" \x3e\x3d "+a[d][0],null!==a[d][1]?c+(d===h-1?" \x3c\x3d ":" \x3c ")+a[d][1]:""));f.push(k)}return g.eachAlways(f.map(function(a){return e.queryFeatureCount(a)}))};d.prototype._binParamsFromGenRend=function(a,c){var b=a.field,e=a.normalizationType,f=a.normalizationField,h=l.getSQLFilterForNormalization({field:b,normalizationType:e,normalizationField:f});
a=new A({classificationDefinition:k.createCBDefn({field:b,normalizationType:e,normalizationField:f,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numBins||10}),where:l.mergeWhereClauses(h,c)});return this.generateRenderer(a).then(function(a){return k.generateBinParams({field:b,normalizationType:e,normalizationField:f,normalizationTotal:a.normalizationTotal,classBreaks:a.classBreaks,where:h})})};d.prototype._histogramFromMemory=function(a){var c=
this,b=a.field,e=a.normalizationType,f=a.valueExpression,h=a.classificationMethod,d=a.minValue,p=a.maxValue,l=a.view,n=f&&!a.sqlExpression,v={field:b,valueExpression:f,normalizationField:a.normalizationField,view:l};return(this._hasLocalSource||a.features||!n?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(l):this._fetchFeaturesForStats(v)).then(function(t){if(!t||!t.length)return g.reject(new m("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"));
var n=null!=d&&null!=p,x=null;h&&"equal-interval"!==h||e?(n=q({},a),n.features=t,x=c._getBinParamsFromMemory(n)):x=n?g.resolve({min:d,max:p,source:"parameters"}):c.summaryStatistics({field:b,valueExpression:f,features:t,view:l}).then(function(a){return a.count?{min:a.min,max:a.max}:g.reject(new m("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return x.then(function(b){return k.calculateHistogramFromMemory(a,b,t)})})};d.prototype._getBinParamsFromMemory=
function(a){var c=a.field,b=a.normalizationType,e=a.normalizationField;return this._classBreaksFromMemory({field:c,valueExpression:a.valueExpression,normalizationType:b,normalizationField:e,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,minValue:a.minValue,maxValue:a.maxValue,numClasses:a.numBins,features:a.features,view:a.view}).then(function(a){var f=a.normalizationTotal;a=a.classBreakInfos;var d=l.getSQLFilterForNormalization({field:c,normalizationType:b,
normalizationField:e});return k.generateBinParams({field:c,normalizationType:b,normalizationField:e,normalizationTotal:f,classBreaks:a,where:d})})};d.prototype._classBreaksFromGenRend=function(a){var c=a.field,b=a.normalizationType,e=a.normalizationField,f=a.normalizationTotal,h=l.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:e}),f=k.getFieldExpr({field:c,normalizationType:b,normalizationField:e,normalizationTotal:f}),f=l.getRangeExpr(f,a.minValue,a.maxValue),c=k.createCBDefn({field:c,
normalizationType:b,normalizationField:e,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),b=new A;b.classificationDefinition=c;b.where=l.mergeWhereClauses(h,f);return this.generateRenderer(b).then(function(b){return k.resolveCBResult(a,b)})};d.prototype._classBreaksFromInterpolation=function(a){for(var c=a.minValue,b=a.maxValue,e=a.numClasses||5,f=[],h=(b-c)/e,d=0;d<e;d++){var p=c+d*h;f.push({minValue:p,maxValue:p+h})}f[e-
1].maxValue=b;a=k.resolveCBResult(a,{classBreaks:f,normalizationTotal:a.normalizationTotal});return g.resolve(a)};d.prototype._classBreaksFromMemory=function(a){var c=a.field,b=a.valueExpression,e=a.view,f={field:c,valueExpression:b,normalizationField:a.normalizationField,view:e};return(this._hasLocalSource||a.features||!b?a.features?g.resolve(a.features):this._fetchFeaturesFromMemory(e):this._fetchFeaturesForStats(f)).then(function(b){if(!b||!b.length)return g.reject(new m("feature-layer-adapter:insufficient-data",
"No features are available to calculate statistics"));var e=q({},a);if("percent-of-total"===e.normalizationType){var f=k.calculateStatsFromMemory({field:c},b).sum;if(null==f)return g.reject(new m("feature-layer-adapter:invalid","invalid normalizationTotal"));e.normalizationTotal=f}return k.calculateClassBreaksFromMemory(e,b)})};d.prototype._heatmapStatsFromMemory=function(a,c){var b=a.blurRadius,e=a.field,f=a.view,h=f.state,d=h.width,p=h.height,h=new L.default({extent:f.extent,tolerance:h.resolution}),
l=new M({returnGeometry:!0,quantizationParameters:h});return(a.features?g.resolve(this._quantizeFeatures(a.features,h)):this._fetchFeaturesFromMemory(f,l)).then(function(a){if(!a||!a.length)return{count:0,min:null,max:null,avg:null,stddev:null};var f=k.calculateHeatmapStats(a,b,c,e,d,p);return f?{count:a.length,min:f.min,max:f.max,avg:f.mean,stddev:f.stdDev}:g.reject(new m("feature-layer-adapter:invalid","unable to calculate heatmap statistics"))})};d.prototype._quantizeFeatures=function(a,c){var b=
C.toTransform(c);return a.map(function(a){var c=new F.Point(a.geometry);C.quantizePoint(b,c,c,c.hasZ,c.hasM);a.geometry=c;return a})};d.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};d.prototype.getFieldUsageInfo=function(a){return this.getField(a)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null};d.prototype.getFieldDomain=function(a,c){return this.layer.getFieldDomain(a,c)};d.prototype.summaryStatistics=
function(a){var c=this,b=a.field,e=b?this.getField(b):null,f=y.isDateField(e),d=(e=a.valueExpression||a.sqlExpression)&&!a.sqlExpression,b="function"===typeof b||d,d=(d=a.view)&&"3d"===d.type;return this._hasLocalSource||a.features||b?b||a.features||d?this._summaryStatsFromMemory(a,f):this._summaryStatsFromClientQuery(a,f):this.supportsSQLExpression||!f&&!e?(a.normalizationType?this._summaryStatsFromGenRend(a):this._summaryStatsFromServiceQuery(a,f)).catch(function(b){return c._summaryStatsFromMemory(a,
f)}):g.reject(new m("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))};d.prototype.uniqueValues=function(a){var c=this,b=a.field,e=a.valueExpression,f=a.sqlExpression,d=(b?this.getField(b):null)&&this.getFieldDomain(b),g=e&&(!f||!this.supportsSQLExpression),k=(b=a.view)&&"3d"===b.type;return this._hasLocalSource||a.features||g?g||a.features||k?this._uvFromMemory(a,d):this._uvFromClientQuery(a,d):this._uvFromServiceQuery(a,d).catch(function(b){return a.field?
c._uvFromGenRenderer(a,d):b}).catch(function(b){return g||a.features||k?c._uvFromMemory(a,d):c._uvFromClientQuery(a,d)})};d.prototype.histogram=function(a){var c=this,b=a.field,e=a.normalizationType,f=a.normalizationField,d=a.classificationMethod,t=b?this.getField(b):null,t=y.isDateField(t),p=a.valueExpression||a.sqlExpression,x=p&&!a.sqlExpression,n=this.supportsSQLExpression,v=!d||"equal-interval"===d,q=a.minValue,r=a.maxValue,w=null!=q&&null!=r,u=a.numBins||10;return this._hasLocalSource||a.features||
x?this._histogramFromMemory(a):(p||n)&&v?p&&!n?g.reject(new m("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):this._histogramForExpr(a):t&&v?g.reject(new m("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):e||!v?this._binParamsFromGenRend(a).then(function(d){if(!w)return c._getBins(d,b,u);if(q>d.max||r<d.min)return g.reject(new m("histogram:insufficient-data",
"Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field"));if(v)return c._getBins({min:q,max:r,sqlExpr:d.sqlExpr,excludeZerosExpr:d.excludeZerosExpr},b,u);d=k.getFieldExpr({field:b,normalizationType:e,normalizationField:f,normalizationTotal:d.normTotal});d=l.getRangeExpr(d,q,r);return c._binParamsFromGenRend(a,d).then(function(a){return c._getBins(a,b,u)})}):this._histogramForField(a)};d.prototype.classBreaks=function(a){var c=this,b=!1!==a.analyzeData,e=this._hasLocalSource||
a.features||a.valueExpression;return b&&e?this._classBreaksFromMemory(a):(b?this._classBreaksFromGenRend(a):this._classBreaksFromInterpolation(a)).catch(function(b){return c._classBreaksFromMemory(a)})};d.prototype.queryFeatureCount=function(a){if(this._hasLocalSource)return g.reject(new m("feature-layer-adapter:not-supported","Layer does not support count query"));var c=this.layer,b=c.createQuery();b.where=l.mergeWhereClauses(b.where,a);return c.queryFeatureCount(b)};d.prototype.generateRenderer=
function(a){var c=this.layer;if(this._hasLocalSource||10.1>c.version)return g.reject(new m("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var b=new K({url:c.parsedUrl.path,source:c.dynamicDataSource,gdbVersion:c.gdbVersion}),c=c.createQuery();a.where=l.mergeWhereClauses(a.where,c.where);return b.execute(a)};d.prototype.heatmapStatistics=function(a){var c=this,b=a.field,e=a.fieldOffset;return(b&&null==e?this.summaryStatistics({field:b}):
g.resolve(null)).then(function(b){var d=e||0;if(b){var f=b.min,g=b.max;b.count?f===g&&0===f?d=1:0>=g?d="abs":0>f&&(d=-1.01*f):d=1}return c._heatmapStatsFromMemory(a,d).then(function(a){return q({},a,{summaryStatistics:b,fieldOffset:d})})})};d.prototype.getPredominantCategories=function(a,c){if(!this._hasLocalSource&&!this.supportsSQLExpression)return g.reject(new m("feature-layer-adapter:not-supported","Layer does not support advanced SQL expressions and standardized queries"));var b=z.getArcadeForPredominantCategory(a),
e=z.getSQLForPredominantCategoryName(a),d=c&&"3d"===c.type;return(this._hasLocalSource?d?this._uvFromMemory({valueExpression:b,view:c}):this._uvFromClientQuery({valueExpression:b,view:c}):this._uvFromServiceQuery({sqlExpression:e.expression,valueExpression:b})).then(function(b){b=b.uniqueValueInfos;for(var c=b.map(function(a){return a.value}),d=0,e=a.filter(function(a){return-1===c.indexOf(a)});d<e.length;d++)b.push({value:e[d],count:0});b.sort(function(b,c){return a.indexOf(b.value)-a.indexOf(c.value)});
for(d=0;d<b.length;d++)e=b[d],e.value===z.noDominantCategoryField&&(e.value=null);return{predominantCategoryInfos:b}})};d.prototype.load=function(){var a=this,c=this.layer,b=c.load().then(function(){a.geometryType=c.geometryType;a.objectIdField=c.objectIdField;a.supportsSQLExpression=c.get("capabilities.query.supportsSqlExpression");a._hasLocalSource=!c.url&&!!c.source;a.hasQueryEngine=a._hasLocalSource});this.addResolvingPromise(b);return this.when()};w([r.property({constructOnly:!0})],d.prototype,
"layer",void 0);w([r.property()],d.prototype,"outFields",null);return d=w([r.subclass()],d)}(r.declared(J))});