// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/extendsHelper ../core/tsSupport/assignHelper ../request ./featureSetCollection ./featureset/polyfill/FeatureLayerAndTable ./featureset/sources/FeatureLayerDynamic ./featureset/sources/FeatureLayerMemory ./featureset/support/cache ./featureset/support/FeatureSet ../core/promiseUtils ../layers/FeatureLayer ../portal/PortalItem ./featureset/actions/OrderBy ./featureset/actions/Top ./featureset/actions/SpatialFilter ./featureset/actions/AttributeFilter".split(" "),
function(F,m,t,u,x,v,n,y,z,f,A,l,w,B){function p(d,c){if(f.applicationCache){var b=f.applicationCache.getLayerInfo(d);if(b)return b.then(function(a){return l.resolve(new n({url:d,outFields:c,resourceInfo:a}))});var e=new n({url:d,outFields:c}),a=l.create(function(b,c){f.applicationCache&&f.applicationCache.setLayerInfo(d,a);e.load().then(function(){b(e.resourceInfo)},function(a){f.applicationCache&&f.applicationCache.clearLayerInfo(d);c(a)})});return a.then(function(a){return l.resolve(e)})}return l.resolve(new n({url:d,
outFields:c}))}function q(d,c,b,e,a){void 0===c&&(c=null);void 0===b&&(b=null);void 0===e&&(e=!0);void 0===a&&(a=null);return!0===d._hasMemorySource()?new z({layer:d,spatialReference:c,outFields:b,includeGeometry:e,lrucache:a}):new y({layer:d,spatialReference:c,outFields:b,includeGeometry:e,lrucache:a})}Object.defineProperty(m,"__esModule",{value:!0});m.initialiseMetaDataCache=function(){null===f.applicationCache&&(f.applicationCache=new f)};m.constructFeatureSetFromUrl=function(d,c,b,e,a){return p(d,
["*"]).then(function(h){return l.resolve(q(h,c,b,e,a))})};m.constructFeatureSet=q;A._polyfill.table=n;var C=function(d){function c(b,e,a){void 0===e&&(e=null);void 0===a&&(a=null);var h=d.call(this)||this;h._map=b;h._overridespref=e;h.lrucache=a;h._instantLayers=[];return h}t(c,d);c.prototype.makeAndAddFeatureSet=function(b,e,a){void 0===e&&(e=!0);void 0===a&&(a=null);var h=q(b,this._overridespref,null===a?["*"]:a,e,this.lrucache);this._instantLayers.push({featureset:h,opitem:b,includeGeometry:e,
outFields:JSON.stringify(a)});return h};c.prototype.featureSetByName=function(b,e,a){var h=this;void 0===e&&(e=!0);void 0===a&&(a=null);if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return h.featureSetByName(b,e,a)}catch(r){return l.reject(r)}});null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var c=JSON.stringify(a),d=0;d<this._instantLayers.length;d++){var f=this._instantLayers[d];if(f.opitem.title===b&&f.includeGeometry===
e&&f.outFields===c)return this.resolvePromise(this._instantLayers[d].featureset)}if(c=this._map.layers.find(function(a){return a instanceof w&&a.title===b?!0:!1}))return this.resolvePromise(this.makeAndAddFeatureSet(c,e,a));if(this._map.tables){var g=this._map.tables.find(function(a){return a.title&&a.title===b||a.title&&a.title===b?!0:!1});if(g)return g._materializedTable||(c=g.outFields?g:u({},g,{outFields:["*"]}),g._materializedTable=new n(c)),g._materializedTable.load().then(function(){return h.resolvePromise(h.makeAndAddFeatureSet(g._materializedTable,
e,a))})}return this.resolvePromise(null)};c.prototype.featureSetById=function(b,e,a){var c=this;void 0===e&&(e=!0);void 0===a&&(a=["*"]);if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return c.featureSetById(b,e,a)}catch(r){return l.reject(r)}});null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var d=JSON.stringify(a),f=0;f<this._instantLayers.length;f++){var k=this._instantLayers[f];if(k.opitem.id===b&&k.includeGeometry===e&&
k.outFields===d)return this.resolvePromise(this._instantLayers[f].featureset)}if(d=this._map.layers.find(function(a){return a instanceof w&&a.id===b?!0:!1}))return this.resolvePromise(this.makeAndAddFeatureSet(d,e,a));if(this._map.tables){var g=this._map.tables.find(function(a){return a.id===b?!0:!1});if(g)return g._materializedTable||(d=u({},g,{outFields:["*"]}),g._materializedTable=new n(d)),g._materializedTable.load().then(function(){return c.resolvePromise(c.makeAndAddFeatureSet(g._materializedTable,
e,a))})}return this.resolvePromise(null)};return c}(v),E=function(d){function c(b,e,a){void 0===e&&(e=null);void 0===a&&(a=null);var c=d.call(this)||this;c._url=b;c._overridespref=e;c.lrucache=a;c.metadata=null;c._instantLayers=[];return c}t(c,d);Object.defineProperty(c.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0});c.prototype.makeAndAddFeatureSet=function(b,e,a){void 0===e&&(e=!0);void 0===a&&(a=null);var c=q(b,this._overridespref,null===a?["*"]:a,e,this.lrucache);
this._instantLayers.push({featureset:c,opitem:b,includeGeometry:e,outFields:JSON.stringify(a)});return c};c.prototype._loadMetaData=function(){var b=this;if(null!==f.applicationCache){var e=f.applicationCache.getLayerInfo(this._url);if(null!==e)return e.then(function(a){b.metadata=a;return l.resolve(b.metadata)})}e=x(this._url,{responseType:"json",query:{f:"json"}}).then(function(a){b.metadata=a.data?{layers:a.data.layers?a.data.layers:[],tables:a.data.tables?a.data.tables:[]}:{layers:[],tables:[]};
return l.resolve(b.metadata)},function(a){f.applicationCache&&f.applicationCache.clearLayerInfo(b._url);return l.reject(a)});null!==f.applicationCache&&f.applicationCache.setLayerInfo(this._url,e);return e};c.prototype.load=function(){return this._loadMetaData()};c.prototype.clone=function(){return new c(this._url,this._overridespref,this.lrucache)};c.prototype.featureSetByName=function(b,e,a){var c=this;void 0===e&&(e=!0);void 0===a&&(a=null);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var d=
JSON.stringify(a),f=0;f<this._instantLayers.length;f++){var k=this._instantLayers[f];if(k.opitem.title===b&&k.includeGeometry===e&&k.outFields===d)return this.resolvePromise(this._instantLayers[f].featureset)}return this._loadMetaData().then(function(d){for(var f=null,g=0,h=d.layers?d.layers:[];g<h.length;g++){var k=h[g];k.name===b&&(f=k)}if(!f)for(g=0,d=d.tables?d.tables:[];g<d.length;g++)k=d[g],k.name===b&&(f=k);return f?p(c._url+"/"+f.id,["*"]).then(function(b){return c.makeAndAddFeatureSet(b,
e,a)}):c.resolvePromise(null)})};c.prototype.featureSetById=function(b,e,a){var c=this;void 0===e&&(e=!0);void 0===a&&(a=["*"]);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();var d=JSON.stringify(a);b=null!==b&&void 0!==b?b.toString():"";for(var f=0;f<this._instantLayers.length;f++){var k=this._instantLayers[f];if(k.opitem.id===b&&k.includeGeometry===e&&k.outFields===d)return this.resolvePromise(this._instantLayers[f].featureset)}return this._loadMetaData().then(function(d){for(var f=null,g=0,k=d.layers?
d.layers:[];g<k.length;g++){var h=k[g];null!==h.id&&void 0!==h.id&&h.id.toString()===b&&(f=h)}if(!f)for(g=0,d=d.tables?d.tables:[];g<d.length;g++)h=d[g],null!==h.id&&void 0!==h.id&&h.id.toString()===b&&(f=h);return f?p(c._url+"/"+f.id,["*"]).then(function(b){return c.makeAndAddFeatureSet(b,e,a)}):c.resolvePromise(null)})};return c}(v);m.createFeatureSetCollectionFromMap=function(d,c,b){void 0===b&&(b=null);return new C(d,c,b)};m.createFeatureSetCollectionFromService=function(d,c,b){void 0===b&&(b=
null);return new E(d,c,b)};m.constructFeatureSetFromPortalItem=function(d,c,b,e,a,h,m){if(f.applicationCache){var p=f.applicationCache.getLayerInfo(d+":"+h.url);if(p)return p.then(function(d){try{var f=new n({url:d.url+"/"+c,outFields:["*"]});return l.resolve(q(f,b,e,a,m))}catch(r){return l.reject(r)}},function(a){return l.reject(a)})}return l.create(function(k,g){var l=(new B({id:d,portal:h})).load();f.applicationCache&&f.applicationCache.setLayerInfo(d+":"+h.url,l);l.then(function(d){try{var f=
new n({url:d.url+"/"+c,outFields:["*"]});k(q(f,b,e,a,m))}catch(D){g(D)}},function(a){f.applicationCache&&f.applicationCache.clearLayerInfo(d+":"+h.url);g(a)})})}});