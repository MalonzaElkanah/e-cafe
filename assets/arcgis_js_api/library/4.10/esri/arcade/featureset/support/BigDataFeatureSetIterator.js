// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper dojo/Deferred ../../../Graphic ../support/shared ./FeatureSetIterator ../../../geometry/support/jsonUtils".split(" "),function(p,q,l,g,h,f,m,n){return function(k){function e(a,b){a=k.call(this,a,b)||this;a._currentPage=null;a._iteratorStarted=!1;a._indexInCurrentPage=0;a._noMorePages=!1;a._script=null;a._featuresetMoniker="";return a}l(e,k);e.prototype.reset=function(){this._currentPage=null;this._iteratorStarted=!1;this._indexInCurrentPage=
0;this._featuresetMoniker=""};e.prototype.next=function(){var a=this,b=new g;!1===this._iteratorStarted?this.requestFirstPage().then(f.callback(function(){a.handleFeatureFromPage(b)},b),function(a){b.reject(a)}):this.handleFeatureFromPage(b);return b.promise};e.prototype.handleFeatureFromPage=function(a){var b=this;null===this._currentPage&&a.resolve(null);if(this._indexInCurrentPage<this._currentPage.length){this._indexInCurrentPage++;var c=this._currentPage[this._indexInCurrentPage-1];if(null!==
c&&!(c instanceof h)){var d=null;null!==c.geometry&&(d=this._script.spatialReference,d.toJSON?d=d.toJSON():d.toJson&&(d=d.toJson()),c.geometry.spatialReference=d,d=n.fromJSON(c.geometry));c=new h({geometry:d,attributes:c.attributes});this._currentPage[this._indexInCurrentPage-1]=c}a.resolve(c)}else 0===this._currentPage.length?(this._noMorePages=!0,this._currentPage=null,this._indexInCurrentPage=0,a.resolve(null)):this.requestNextPage().then(f.callback(function(){b.handleFeatureFromPage(a)},a),function(b){a.reject(b)})};
e.prototype.requestFirstPage=function(){var a=this,b=new g;this._indexInCurrentPage=0;this._currentPage=[];this._parent.top(1E3).expressAsArcadeScript().then(f.callback(function(c){c.script+="\n return "+c.featuresetIdentifier+";\n";a._script=c;c=a._parent.sourceGeoAnalyticsProvider();null===c?b.reject(Error("No Big Data Provider")):c.executeFeatureSetPageRequest(a._script.script,a._script.globals,a._script.spatialReference,"").then(function(c){a._featuresetMoniker=c.moniker;a._currentPage=c.records;
a._iteratorStarted=!0;b.resolve(!0)},function(a){b.reject(a)})},b),function(a){b.reject(a)});return b.promise};e.prototype.requestNextPage=function(){var a=this,b=new g;this._indexInCurrentPage=0;this._currentPage=[];var c=this._parent.sourceGeoAnalyticsProvider();null===c?b.reject(Error("No Big Data Provider")):c.executeFeatureSetPageRequest(this._script.script,this._script.globals,this._script.spatialReference,this._featuresetMoniker).then(function(c){a._currentPage=c.records;b.resolve(!0)},function(a){b.reject(a)});
return b.promise};e.prototype.count=function(){var a=this,b=new g;-1!==this._parent._totalCount?b.resolve(this._parent._totalCount):this._parent.count().then(f.callback(function(c){a._parent._totalCount=c;b.resolve(a._parent._totalCount)},b),f.errback(b));return b.promise};return e}(m)});