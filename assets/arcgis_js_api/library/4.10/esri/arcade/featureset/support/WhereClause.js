// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports dojo/Deferred dojo/promise/all ../../../moment ./shared ./StandardizedFunctions ../../../core/sql/WhereGrammar ../../../geometry/geometryEngineAsync".split(" "),function(J,K,n,C,u,f,l,G,v){function r(c){if(c){for(var a="",b=0;b<c.length;b++){var d=c[b];""!==d&&(a=""===a?d:D[a]<D[d]?d:a)}return a}return""}function w(c){return u(c,["YYYY-M-D H:m:s","YYYY-M-D H:mZ","YYYY-M-D H:m:sZ","YYYY-M-D H:m","YYYY-m-d"]).toDate()}function x(c){return u(c,["YYYY-M-D"]).toDate()}function y(c){return Array.isArray(c)?
c:[c]}function p(c){return null!==c?!0!==c:null}function E(c,a){return null!=c&&null!=a?!0===c&&!0===a:!1===c||!1===a?!1:null}function F(c,a){return null!=c&&null!=a?!0===c||!0===a:!0===c||!0===a?!0:null}function q(c,a){if(null==c)return null;for(var b=!1,d=0;d<a.length;d++){var e=a[d];if(null==e)b=null;else if(c===e){b=!0;break}}return b}function t(c,a,b){if(null==c)return null;for(var d="",e=0,g=0;g<a.length;g++){var h=a.charAt(g);switch(e){case 0:h===b?e=1:d=0<="-[]/{}()*+?.\\^$|".indexOf(h)?d+
("\\"+h):"%"===h?d+".*":"_"===h?d+".":d+h;break;case 1:d=0<="-[]/{}()*+?.\\^$|".indexOf(h)?d+("\\"+h):d+h,e=0}}return(new RegExp("^"+d+"$")).test(c)}function m(c){return c instanceof Date?c.valueOf():c}function z(c,a,b){if(null==a||null==b)return null;a=m(a);b=m(b);switch(c){case "\x3c\x3e":return a!==b;case "\x3d":return a===b;case "\x3e":return a>b;case "\x3c":return a<b;case "\x3e\x3d":return a>=b;case "\x3c\x3d":return a<=b}}function A(c){for(var a=[],b={},d=0;d<c.length;d++){var e=c[d],g=e.toLowerCase();
void 0===b[g]&&(a.push(e),b[g]=1)}return a}var D={boolean:1,string:2,integer:3,double:4,date:5},H=function(){function c(){}c.makeBool=function(a){return!0===a};c.featureValue=function(a,b){var d=a.attributes[b];if(void 0!==d)return d;for(var e in a.attributes)if(b.toLowerCase()===e.toLowerCase())return a.attributes[e];return null};c.equalsNull=function(a){return null===a};c.applyLike=function(a,b,d){return t(a,b,d)};c.ensureArray=function(a){return y(a)};c.applyIn=function(a,b){return q(a,b)};c.currentDate=
function(){var a=new Date;a.setHours(0,0,0,0);return a};c.currentTimestamp=function(){return new Date};c.compare=function(a,b,d){return z(a,b,d)};c.makeComparable=function(a){return m(a)};c.evaluateFunction=function(a,b){return l.evaluateFunction(a,b)};c.lookup=function(a,b){a=b[a];return void 0===a?null:a};c.between=function(a,b){return null==a||null==b[0]||null==b[1]?null:a>=b[0]&&a<=b[1]};c.notbetween=function(a,b){return null==a||null==b[0]||null==b[1]?null:a<b[0]||a>b[1]};return c}();return function(){function c(){this.parameters=
this.parseTree=null}c.create=function(a){var b=new c;b.parseTree=G.WhereGrammar.parse(a);return b};c.prototype.isStandardized=function(){var a=!0;this.visitAll(this.parseTree,function(b){a&&"function"===b.type&&(a=l.isStandardized(b.name,b.args.value.length))});return a};c.prototype.setVariablesDictionary=function(a){this.parameters=a};c.prototype.testFeature=function(a){return!!this.evaluateNode(this.parseTree,a)};c.prototype.testFeatureCompiled=function(a){void 0===this.parseTree._compiledVersion&&
this._compileMe();return!!this.parseTree._compiledVersion(a,this.parameters)};c.prototype._compileMe=function(){var a="return "+this.evaluateNodeToJavaScript(this.parseTree);this.parseTree._compiledVersion=(new Function("feature","lookups",a)).bind(H)};c.prototype.evaluateNodeToJavaScript=function(a){switch(a.type){case "case_expression":var b="";if("simple"===a.format)for(var d="this.makeComparable("+this.evaluateNodeToJavaScript(a.operand)+")",b="( ",e=0;e<a.clauses.length;e++)b+=" ("+d+" \x3d\x3d\x3d this.makeComparable("+
this.evaluateNodeToJavaScript(a.clauses[e].operand)+")) ? ("+this.evaluateNodeToJavaScript(a.clauses[e].value)+") : ";else for(b="( ",e=0;e<a.clauses.length;e++)b+=" this.makeBool("+this.evaluateNodeToJavaScript(a.clauses[e].operand)+")\x3d\x3d\x3dtrue ? ("+this.evaluateNodeToJavaScript(a.clauses[e].value)+") : ";b=null!==a.else?b+this.evaluateNodeToJavaScript(a.else):b+"null";return b+" )";case "param":return"this.lookup("+JSON.stringify(a.value.toLowerCase())+",lookups)";case "expr_list":b="[";
d=0;for(a=a.value;d<a.length;d++)e=a[d],"["!==b&&(b+=","),b+=this.evaluateNodeToJavaScript(e);return b+"]";case "unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(a.expr)+")";case "binary_expr":switch(a.operator){case "AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+" )";case "OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+" )";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");
return"this.equalsNull("+this.evaluateNodeToJavaScript(a.left)+")";case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(a.left)+")))";case "IN":return"this.applyIn("+this.evaluateNodeToJavaScript(a.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(a.right)+"))";case "NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(a.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(a.right)+")))";
case "BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")";case "NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")";case "LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+","+JSON.stringify(a.escape)+")";case "NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+
","+JSON.stringify(a.escape)+"))";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"this.compare("+JSON.stringify(a.operator)+","+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")";case "*":return"("+this.evaluateNodeToJavaScript(a.left)+" * "+this.evaluateNodeToJavaScript(a.right)+")";case "-":return"("+this.evaluateNodeToJavaScript(a.left)+" - "+this.evaluateNodeToJavaScript(a.right)+")";case "+":return"("+this.evaluateNodeToJavaScript(a.left)+
" + "+this.evaluateNodeToJavaScript(a.right)+")";case "/":return"("+this.evaluateNodeToJavaScript(a.left)+" / "+this.evaluateNodeToJavaScript(a.right)+")"}throw Error("Not Supported Operator "+a.operator);case "null":case "bool":case "string":case "number":return JSON.stringify(a.value);case "date":return"(new Date("+x(a.value).getTime().toString()+"))";case "timestamp":return"(new Date("+w(a.value).getTime().toString()+"))";case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?"this.currentDate()":
"CURRENT_TIMESTAMP"===a.column.toUpperCase()?"this.currentTimestamp()":"this.featureValue(feature,"+JSON.stringify(a.column)+")";case "function":return"this.evaluateFunction("+JSON.stringify(a.name)+","+this.evaluateNodeToJavaScript(a.args)+")"}throw Error("Unsupported sql syntax "+a.type);};c.prototype.calculateValue=function(a){return this.evaluateNode(this.parseTree,a)};c.prototype.predictType=function(a,b){void 0===b&&(b={});for(var d={},e={},g={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",
esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"},c=0;c<a.length;c++){var f=a[c],k=g[f.type];d[f.name.toLowerCase()]=void 0===k?"":k}for(f in b)k=g[b[f]],e[f.toLowerCase()]=void 0===k?"":k;switch(this.evaluateType(d,this.parseTree,e)){case "double":return"double";case "integer":return"integer";
case "double":return"double";case "date":return"date";case "string":return"string"}return""};c.prototype.evaluateType=function(a,b,d){switch(b.type){case "case_expression":var e=[];if("simple"===b.format)for(var c=0;c<b.clauses.length;c++)e.push(this.evaluateType(a,b.clauses[c].value,d));else for(c=0;c<b.clauses.length;c++)e.push(this.evaluateType(a,b.else,d));null!==b.else&&e.push(this.evaluateType(a,b.else,d));return r(e);case "param":a=d[b.value.toLowerCase()];if(void 0===a&&this.parameters){b=
this.parameters[b.value.toLowerCase()];if(void 0===b||null===b)return"";if("string"===typeof b||b instanceof String)return"string";if("boolean"===typeof b)return"boolean";if(b instanceof Date)return"date";if("number"===typeof b)return 0===b%1?"integer":"double"}return void 0===a?"":a;case "expr_list":e=[];c=0;for(b=b.value;c<b.length;c++)e.push(this.evaluateType(a,b[c],d));return e;case "unary_expr":return"boolean";case "binary_expr":switch(b.operator){case "AND":return"boolean";case "OR":return"boolean";
case "IS":if("null"!==b.right.type)throw Error("Unsupported RHS for IS");return"boolean";case "ISNOT":if("null"!==b.right.type)throw Error("Unsupported RHS for IS");return"boolean";case "IN":return"boolean";case "NOT IN":return"boolean";case "BETWEEN":return"boolean";case "NOTBETWEEN":return"boolean";case "LIKE":return"boolean";case "NOT LIKE":return"boolean";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"boolean";case "*":case "-":case "+":case "/":return r([this.evaluateType(a,
b.left,d),this.evaluateType(a,b.right,d)])}throw Error("Not Supported Operator "+b.operator);case "null":return"";case "bool":return"boolean";case "string":return"string";case "number":return null===b.value?"":0===b.value%1?"integer":"double";case "date":return"date";case "timestamp":return"date";case "column_ref":if("CURRENT_DATE"===b.column.toUpperCase()||"CURRENT_TIMESTAMP"===b.column.toUpperCase())return"date";a=a[b.column.toLowerCase()];return void 0===a?"":a;case "function":switch(b.name.toLowerCase()){case "position":case "extract":case "char_length":return"integer";
case "round":a=this.evaluateType(a,b.args,d);if(a instanceof Array){if(0<a.length)return a[0];break}return a;case "sign":return a=this.evaluateType(a,b.args,d),a instanceof Array&&(a=r(a)),"integer"===a||"double"===a?a:"double";case "ceiling":case "floor":case "abs":return a=this.evaluateType(a,b.args,d),a instanceof Array?r(a):a;case "area":case "length":case "log":case "log10":case "sin":case "cos":case "tan":case "asin":case "acos":case "atan":case "power":return"double";case "substring":case "trim":case "concat":case "lower":case "upper":return"string";
case "truncate":return"double";case "round":if(a=this.evaluateType(a,b.args,d),a instanceof Array){if(0<a.length)return a[0]}else return a}return""}throw Error("Unsupported sql syntax "+b.type);};c.prototype.calculateValueCompiled=function(a){void 0===this.parseTree._compiledVersion&&this._compileMe();return this.parseTree._compiledVersion(a,this.parameters)};c.prototype.getFunctions=function(){var a=[];this.visitAll(this.parseTree,function(b){"function"===b.type&&a.push(b.name.toLowerCase())});return A(a)};
c.prototype.getFields=function(){var a=[];this.visitAll(this.parseTree,function(b){"column_ref"===b.type&&a.push(b.column)});return A(a)};c.prototype.getVariables=function(){var a=[];this.visitAll(this.parseTree,function(b){"param"===b.type&&a.push(b.value.toLowerCase())});return A(a)};c.prototype.featureValue=function(a,b,d){var e=a.attributes[b];if(void 0!==e)return e;for(var c in a.attributes)if(b.toLowerCase()===c.toLowerCase())return d.column=c,a.attributes[c];return null};c.prototype.visitAll=
function(a,b){if(null!=a)switch(b(a),a.type){case "when_clause":this.visitAll(a.operand,b);this.visitAll(a.value,b);break;case "case_expression":for(var d=0,e=a.clauses;d<e.length;d++){var c=e[d];this.visitAll(c,b)}"simple"===a.format&&this.visitAll(a.operand,b);null!==a.else&&this.visitAll(a.else,b);break;case "expr_list":d=0;for(a=a.value;d<a.length;d++)c=a[d],this.visitAll(c,b);break;case "unary_expr":this.visitAll(a.expr,b);break;case "binary_expr":this.visitAll(a.left,b);this.visitAll(a.right,
b);break;case "function":this.visitAll(a.args,b)}};c.prototype.toWhereClause=function(a){return this.evaluateNodeToWhereClause(this.parseTree,a)};c.prototype.reformulateWithoutField=function(a,b){return c.create(this.evaluateNodeToWhereClause(this.parseTree,f.FeatureServiceDatabaseType.Standardised,a,b))};c.prototype.statisticFunction=function(){if("function"===this.parseTree.type){if(0===this.parseTree.args.value.length)return{name:this.parseTree.name,expr:null};if(1<this.parseTree.args.value.length)throw Error("Statistic does not have 1 or 0 Parameters");
var a=new c;a.parseTree=this.parseTree.args.value[0];return{name:this.parseTree.name,expr:a}}return null};c.prototype.testFeatureDeferred=function(a){var b=new n;this.evaluateNodeDeferred(this.parseTree,a).then(f.callback(function(a){b.resolve(a)},b),f.errback(b));return b.promise};c.prototype.calculateValueDeferred=function(a){var b=new n;this.evaluateNodeDeferred(this.parseTree,a).then(f.callback(function(a){b.resolve(a)},b),f.errback(b));return b.promise};c.prototype.scanForField=function(a){return this.findField(this.parseTree,
a)};c.combine=function(a,b,d){void 0===d&&(d="AND");return c.create("(("+a.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+")"+d+"("+b.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+"))")};c.prototype.isSingleField=function(){return"column_ref"===this.parseTree.type?!0:!1};c.prototype.findField=function(a,b){if(null===a||void 0===a)return!1;switch(a.type){case "when_clause":return this.findField(a.operand,b)||this.findField(a.value,b);case "case_expression":for(var d=0,e=a.clauses;d<
e.length;d++){var c=e[d];if(this.findField(c,b))return!0}if("simple"===a.format&&this.findField(a.operand,b)||null!==a.else&&this.findField(a.else,b))return!0;break;case "expr_list":d=0;for(a=a.value;d<a.length;d++)if(c=a[d],this.findField(c,b))return!0;break;case "unary_expr":return this.findField(a.expr,b);case "binary_expr":return this.findField(a.left,b)||this.findField(a.right,b);case "column_ref":return b.toLowerCase()===a.column.toLowerCase();case "function":return this.findField(a.args,b)}return!1};
c.prototype.evaluateNode=function(a,b){switch(a.type){case "case_expression":if("simple"===a.format)for(var d=m(this.evaluateNode(a.operand,b)),e=0;e<a.clauses.length;e++){if(d===m(this.evaluateNode(a.clauses[e].operand,b)))return this.evaluateNode(a.clauses[e].value,b)}else for(e=0;e<a.clauses.length;e++)if(!0===this.evaluateNode(a.clauses[e].operand,b))return this.evaluateNode(a.clauses[e].value,b);return null!==a.else?this.evaluateNode(a.else,b):null;case "param":return this.parameters[a.value.toLowerCase()];
case "expr_list":d=[];e=0;for(a=a.value;e<a.length;e++){var c=a[e];d.push(this.evaluateNode(c,b))}return d;case "unary_expr":return p(this.evaluateNode(a.expr,b));case "binary_expr":switch(a.operator){case "AND":return E(this.evaluateNode(a.left,b),this.evaluateNode(a.right,b));case "OR":return F(this.evaluateNode(a.left,b),this.evaluateNode(a.right,b));case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return null===this.evaluateNode(a.left,b);case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");
return null!==this.evaluateNode(a.left,b);case "IN":return d=y(this.evaluateNode(a.right,b)),q(this.evaluateNode(a.left,b),d);case "NOT IN":return d=y(this.evaluateNode(a.right,b)),p(q(this.evaluateNode(a.left,b),d));case "BETWEEN":return d=this.evaluateNode(a.left,b),b=this.evaluateNode(a.right,b),null==d||null==b[0]||null==b[1]?null:d>=b[0]&&d<=b[1];case "NOTBETWEEN":return d=this.evaluateNode(a.left,b),b=this.evaluateNode(a.right,b),null==d||null==b[0]||null==b[1]?null:d<b[0]||d>b[1];case "LIKE":return t(this.evaluateNode(a.left,
b),this.evaluateNode(a.right,b),a.escape);case "NOT LIKE":return p(t(this.evaluateNode(a.left,b),this.evaluateNode(a.right,b),a.escape));case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return z(a.operator,this.evaluateNode(a.left,b),this.evaluateNode(a.right,b));case "*":return this.evaluateNode(a.left,b)*this.evaluateNode(a.right,b);case "-":return this.evaluateNode(a.left,b)-this.evaluateNode(a.right,b);case "+":return this.evaluateNode(a.left,b)+this.evaluateNode(a.right,
b);case "/":return this.evaluateNode(a.left,b)/this.evaluateNode(a.right,b)}throw Error("Not Supported Operator "+a.operator);case "null":case "bool":case "string":case "number":return a.value;case "date":return x(a.value);case "timestamp":return w(a.value);case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?(c=new Date,c.setHours(0,0,0,0),c):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?new Date:this.featureValue(b,a.column,a);case "function":return b=this.evaluateNode(a.args,b),l.evaluateFunction(a.name,
b)}throw Error("Unsupported sql syntax "+a.type);};c.prototype._makeDateString=function(a,b){a=u(a);var d=0===a.minute()&&0===a.hour()&&0===a.second()&&0===a.millisecond();switch(b){case f.FeatureServiceDatabaseType.FILEGDB:case f.FeatureServiceDatabaseType.Standardised:return d?"date '"+a.format("YYYY-MM-DD")+"'":"date '"+a.format("YYYY-MM-DD HH:mm:ss")+"'";case f.FeatureServiceDatabaseType.Oracle:return d?"TO_DATE('"+a.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+a.format("YYYY-MM-DD HH:mm:ss")+
"','YYYY-MM-DD HH24:MI:SS')";case f.FeatureServiceDatabaseType.SqlServer:return"'"+a.format(d?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case f.FeatureServiceDatabaseType.PGDB:return"#"+a.format(d?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case f.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+a.format(d?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+a.format("YYYY-MM-DD HH:mm:ss")+"'"}};c.prototype._makeToday=function(a,b){switch(b){case f.FeatureServiceDatabaseType.FILEGDB:case f.FeatureServiceDatabaseType.Standardised:return a?
"CURRENT_DATE":"CURRENT_TIMESTAMP";case f.FeatureServiceDatabaseType.Oracle:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";case f.FeatureServiceDatabaseType.SqlServer:return a?"CAST(GETDATE() AS DATE)":"GETDATE()";case f.FeatureServiceDatabaseType.PGDB:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";case f.FeatureServiceDatabaseType.Postgres:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";default:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP"}};c.prototype.evaluateNodeToWhereClause=function(a,b,d,e){void 0===d&&
(d=null);void 0===e&&(e=null);var c;switch(a.type){case "case_expression":var f=" CASE ";"simple"===a.format&&(f+=this.evaluateNodeToWhereClause(a.operand,b,d,e));for(c=0;c<a.clauses.length;c++)f+=" WHEN "+this.evaluateNodeToWhereClause(a.clauses[c].operand,b,d,e)+" THEN "+this.evaluateNodeToWhereClause(a.clauses[c].value,b,d,e);null!==a.else&&(f+=" ELSE "+this.evaluateNodeToWhereClause(a.else,b,d,e));return f+" END ";case "param":d=this.parameters[a.value.toLowerCase()];if("string"===typeof d)return"'"+
this.parameters[a.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(d instanceof Date)return this._makeDateString(d,b);if(d instanceof Array){a=[];for(c=0;c<d.length;c++)"string"===typeof d[c]?a.push("'"+d[c].toString().replace(/'/g,"''")+"'"):d[c]instanceof Date?a.push(this._makeDateString(d[c],b)):a.push(d[c].toString());return a}return d.toString();case "expr_list":c=[];f=0;for(a=a.value;f<a.length;f++)c.push(this.evaluateNodeToWhereClause(a[f],b,d,e));return c;case "unary_expr":return" ( NOT "+
this.evaluateNodeToWhereClause(a.expr,b,d,e)+" ) ";case "binary_expr":switch(a.operator){case "AND":return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" AND "+this.evaluateNodeToWhereClause(a.right,b,d,e)+") ";case "OR":return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" OR "+this.evaluateNodeToWhereClause(a.right,b,d,e)+") ";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" IS NULL )";case "ISNOT":if("null"!==
a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" IS NOT NULL )";case "IN":c=[];if("expr_list"===a.right.type)return c=this.evaluateNodeToWhereClause(a.right,b,d,e)," ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" IN ("+c.join(",")+")) ";c=this.evaluateNodeToWhereClause(a.right,b,d,e);return c instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" IN ("+c.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" IN ("+
c+")) ";case "NOT IN":c=[];if("expr_list"===a.right.type)return c=this.evaluateNodeToWhereClause(a.right,b,d,e)," ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" NOT IN ("+c.join(",")+")) ";c=this.evaluateNodeToWhereClause(a.right,b,d,e);return c instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" NOT IN ("+c.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" NOT IN ("+c+")) ";case "BETWEEN":return c=this.evaluateNodeToWhereClause(a.right,b,d,e)," ("+this.evaluateNodeToWhereClause(a.left,
b,d,e)+" BETWEEN "+c[0]+" AND "+c[1]+" ) ";case "NOTBETWEEN":return c=this.evaluateNodeToWhereClause(a.right,b,d,e)," ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" NOT BETWEEN "+c[0]+" AND "+c[1]+" ) ";case "LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,d,e)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,d,e)+") ";case "NOT LIKE":return""!==
a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,d,e)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,d,e)+") ";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,b,d,e)+") "}throw Error("Not Supported Operator "+
a.operator);case "null":return"null";case "bool":return!0===a.value?"1":"0";case "string":return"'"+a.value.toString().replace(/'/g,"''")+"'";case "timestamp":return this._makeDateString(a.value,b);case "date":return this._makeDateString(a.value,b);case "number":return a.value.toString();case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?this._makeToday(!0,b):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?this._makeToday(!1,b):d?d.toLowerCase()===a.column.toLowerCase()?"("+e+")":a.column:
a.column;case "function":return d=this.evaluateNodeToWhereClause(a.args,b,d,e),this._translateFunctionToDatabaseSpecific(a.name,d,b)}throw Error("Unsupported sql syntax "+a.type);};c.prototype._translateFunctionToDatabaseSpecific=function(a,b,d){switch(a.toLowerCase().trim()){case "abs":if(1!==b.length)throw Error("Invalid Parameter for call to ABS");return"abs("+b[0]+")";case "ceiling":case "ceil":if(1!==b.length)throw Error("Invalid Parameter for call to CEILING");switch(d){case f.FeatureServiceDatabaseType.Standardised:return"CEILING("+
b[0]+")";default:return"CEILING("+b[0]+")"}case "floor":if(1!==b.length)throw Error("Invalid Parameter for call to Floor");return"FLOOR("+b[0]+")";case "log":if(1!==b.length)throw Error("Invalid Parameter for call to LOG");return"LOG("+b[0]+")";case "log10":if(1!==b.length)throw Error("Invalid Parameter for call to LOG10");return"LOG10("+b[0]+")";case "power":if(2!==b.length)throw Error("Invalid Parameter for call to POWER");return"POWER("+b[0]+","+b[1]+")";case "round":if(2===b.length)return"ROUND("+
b[0]+","+b[1]+")";if(1===b.length)return"ROUND("+b[0]+")";throw Error("Invalid Parameter for call to ROUND");case "truncate":if(1>b.length||2<b.length)throw Error("Invalid Parameter for TRUNCATE function");switch(d){case f.FeatureServiceDatabaseType.SqlServer:return"ROUND("+b[0]+(1===b.length?"0":","+b[1])+",1)";default:return"TRUNCATE("+b[0]+(1===b.length?")":","+b[1]+")")}case "char_length":case "len":if(1!==b.length)throw Error("Invalid Parameter for CHAR_LENGTH function");switch(d){case f.FeatureServiceDatabaseType.SqlServer:return"LEN("+
b[0]+")";case f.FeatureServiceDatabaseType.Oracle:return"LENGTH("+b[0]+")";default:return"CHAR_LENGTH("+b[0]+")"}case "concat":if(1>b.length)throw Error("Invalid Parameter for CONCAT function");d="CONCAT(";for(a=0;a<b.length;a++)0!==a&&(d+=","),d+=b[a];return d+")";case "lower":case "lcase":if(1!==b.length)throw Error("Invalid Parameter for Lower function");return"LOWER("+b[0]+")";case "upper":case "ucase":if(1!==b.length)throw Error("Invalid Parameter for Upper function");return"UPPER("+b[0]+")";
case "substring":switch(a="",d){case f.FeatureServiceDatabaseType.Oracle:return a="SUBSTR("+b[0]+","+b[1],3===b.length&&(a+=","+b[2]),a+")";case f.FeatureServiceDatabaseType.SqlServer:return a=3===b.length?"SUBSTRING("+b[0]+","+b[1]+","+b[2]+")":"SUBSTRING("+b[0]+",  "+b[1]+", LEN("+b[0]+") - "+b[1]+")";default:return a="SUBSTRING("+b[0]+" FROM "+b[1],3===b.length&&(a+=" FOR "+b[2]),a+")"}case "extract":return"EXTRACT("+b[0].replace(/\'/g,"")+" FROM "+b[1]+")"}throw Error("Function Not Recognised");
};c.prototype.evaluateWhereClausesSimpleDeferred=function(a,b,d,e,c){var f=this,g=new n;try{b>=a.length?null===d?g.resolve(null):this.evaluateNodeDeferred(d,c).then(function(a){g.resolve(a)},function(a){g.reject(a)}):this.evaluateNodeDeferred(a[b],c).then(function(h){try{e===m(h)?f.evaluateNodeDeferred(a[b].value,c).then(function(a){g.resolve(a)},function(a){g.reject(a)}):f.evaluateWhereClausesSimpleDeferred(a,b+1,d,e,c).then(function(a){g.resolve(a)},function(a){g.reject(a)})}catch(B){g.reject(B)}},
function(a){g.reject(a)})}catch(k){g.reject(k)}return g.promise};c.prototype.evaluateWhereClausesDeferred=function(a,b,d,e){var c=this,f=new n;try{b>=a.length?null===d?f.resolve(null):this.evaluateNodeDeferred(d,e).then(function(a){f.resolve(a)},function(a){f.reject(a)}):this.evaluateNodeDeferred(a[b].operand,e).then(function(g){try{!0===g?c.evaluateNodeDeferred(a[b].value,e).then(function(a){f.resolve(a)},function(a){f.reject(a)}):c.evaluateWhereClausesDeferred(a,b+1,d,e).then(function(a){f.resolve(a)},
function(a){f.reject(a)})}catch(k){f.reject(k)}},function(a){f.reject(a)})}catch(I){f.reject(I)}return f.promise};c.prototype.evaluateNodeDeferred=function(a,b){var d=this,e=new n,c;try{var h=void 0;switch(a.type){case "case_expression":"simple"===a.format?this.evaluateNodeDeferred(a.operand,b).then(function(c){c=m(c);d.evaluateWhereClausesSimpleDeferred(a.clauses,0,a.else,c,b).then(function(a){e.resolve(a)},function(a){e.reject(a)})},function(a){e.reject(a)}):this.evaluateWhereClausesDeferred(a.clauses,
0,a.else,b).then(function(a){e.resolve(a)},function(a){e.reject(a)});break;case "param":e.resolve(this.parameters[a.value.toLowerCase()]);break;case "expr_list":h=[];c=0;for(var l=a.value;c<l.length;c++){var k=l[c];h.push(this.evaluateNodeDeferred(k,b))}C(h).then(f.callback(function(a){e.resolve(a)},e),f.errback(e));break;case "unary_expr":this.evaluateNodeDeferred(a.value,b).then(f.callback(function(a){e.resolve(p(a))},e),f.errback(e));break;case "binary_expr":switch(a.operator){case "IS":"null"!==
a.right.type?e.reject(Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(a.left,b).then(f.callback(function(a){e.resolve(null===a)},e),f.errback(e));break;case "ISNOT":"null"!==a.right.type?e.reject(Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(a.left,b).then(f.callback(function(a){e.resolve(null!==a)},e),f.errback(e));break;case "LIKE":case "NOT LIKE":case "BETWEEN":case "NOTBETWEEN":case "IN":case "NOT IN":case "AND":case "OR":case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":c=
[this.evaluateNodeDeferred(a.left,b),this.evaluateNodeDeferred(a.right,b)];C(c).then(f.callback(function(b){switch(a.operator){case "LIKE":case "NOT LIKE":b=t(b[0],b[0],a.escape);e.resolve("LIKE"===a.operator?b:p(b));break;case "BETWEEN":var d=b[0];b=b[1];e.resolve(null==d||null==b[0]||null==b[1]?null:d>=b[0]&&d<=b[1]);break;case "NOTBETWEEN":d=b[0];b=b[1];e.resolve(null==d||null==b[0]||null==b[1]?null:d<b[0]||d>b[1]);break;case "IN":case "NOT IN":d=b[1]instanceof Array?b[1]:[null];"IN"===a.operator?
e.resolve(q(b[0],d)):"NOT IN"===a.operator&&e.resolve(p(q(b[0],d)));break;case "AND":e.resolve(E(b[0],b[1]));break;case "OR":e.resolve(F(b[0],b[1]));break;case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":e.resolve(z(a.operator,b[0],b[1]));break;case "*":e.resolve(b[0]*b[1]);break;case "-":e.resolve(b[0]-b[1]);break;case "+":e.resolve(b[0]+b[1]);break;case "/":e.resolve(b[0]/b[1]);break;default:e.reject(Error("Unrecognised operator"))}},e),f.errback(e));break;default:e.reject(Error("Not Supported Operator "+
a.operator))}break;case "null":case "bool":case "string":case "number":e.resolve(a.value);break;case "date":e.resolve(x(a.value));break;case "timestamp":e.resolve(w(a.value));break;case "column_ref":"CURRENT_DATE"===a.column.toUpperCase()?(k=new Date,k.setHours(0,0,0,0),e.resolve(k)):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?e.resolve(new Date):e.resolve(this.featureValue(b,a.column,a));break;case "function":this.evaluateNodeDeferred(a.args,b).then(f.callback(function(c){d.executeFunctionDeferred(a.name,
b,c).then(f.callback(function(a){e.resolve(a)},e),f.errback(e))},e),f.errback(e));break;default:e.reject(Error("Malformed Where Clause"))}}catch(B){e.reject(B)}return e.promise};c.prototype.executeFunctionDeferred=function(a,b,d){var c=new n,g=0;try{if(l.isStandardized(a,d.length))c.resolve(l.evaluateFunction(a,d));else switch(a.toLowerCase().trim()){case "area":g=f.convertSquareUnitsToCode(d[0]);a=!1;void 0===d[1]||null===d[1]||"1"!==d[1].toString()&&"true"!==d[1].toString().toLowerCase()&&"geodesic"!==
d[1].toString().toLowerCase()||(a=!0);null===b.geometry?c.resolve(0):a?v.geodesicArea(b.geometry,g).then(f.callback(function(a){c.resolve(a)},c),f.errback(c)):v.planarArea(b.geometry,g).then(f.callback(function(a){c.resolve(a)},c),f.errback(c));break;case "length":g=f.convertLinearUnitsToCode(d[0]);void 0===d[1]||null===d[1]||"1"!==d[1].toString()&&"true"!==d[1].toString().toLowerCase()&&"geodesic"!==d[1].toString().toLowerCase()||(a=!0);null===b.geometry?c.resolve(0):v.planarLength(b.geometry,g).then(f.callback(function(a){c.resolve(a)},
c),f.errback(c));break;default:c.reject(Error("Function Not Recognised"))}}catch(h){c.reject(h)}return c.promise};return c}()});