// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports dojo/Deferred dojo/promise/Promise ../support/FeatureSetIterator ../support/IdSet ../support/shared ../support/WhereClause ./ArcadeExporter ./BigDataFeatureSetIterator ./cache ./Guid ./stats ../../../geometry/geometryEngineAsync ../../../geometry/SpatialReference".split(" "),function(E,F,k,v,x,y,f,p,z,A,r,B,q,t,C){var w=0;return function(){function c(a){this._bigdCacheId=B.raw();this.recentlyUsedQueries=null;this._idstates=[];this._mainSetInUse=this._wset=this._parent=null;
this._maxProcessing=200;this._maxQuery=500;this._totalCount=-1;this._databaseType=f.FeatureServiceDatabaseType.NotEvaluated;this._databaseTypeProbed=null;this.declaredRootClass="esri.arcade.featureset.support.FeatureSet";this._featureCache=[];this.fields=this.types=null;this.objectIdField=this.geometryType="";this.spatialReference=null;this.loaded=this._transparent=this.hasZ=this.hasM=!1;this._loadPromise=null;a&&a.lrucache&&(this.recentlyUsedQueries=a.lrucache)}c.prototype.optimisePagingFeatureQueries=
function(a){this._parent&&this._parent.optimisePagingFeatureQueries(a)};c.prototype._hasMemorySource=function(){return!0};c.prototype.prop=function(a,b){if(void 0===b)return this[a];void 0!==this[a]&&(this[a]=b);return this};c.prototype.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent};c.prototype._ensureLoaded=function(){return this.load()};c.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=new k);null!==this._parent&&
(!0===this._parent.loaded?!1===this._loadPromise.isFulfilled()&&(this._initialiseFeatureSet(),this._loadPromise.resolve(this)):this._parent.load().then(function(){try{a._initialiseFeatureSet(),a._loadPromise.resolve(a)}catch(b){a._loadPromise.reject(b)}}));return this._loadPromise.promise};c.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.spatialReference=
this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.objectIdField=this.typeIdField="",this.spatialReference=new C({wkid:4326}),this.geometryType=f.layerGeometryEsriConstants.point)};c.prototype.getField=function(a,b){var d;if(b=b||this.fields)a=a.toLowerCase(),b.some(function(b){b&&b.name.toLowerCase()===a&&(d=b);return!!d});return d};c.prototype._maxProcessingRate=function(){return null!==
this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())};c.prototype._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery};c.prototype._checkCancelled=function(a){if(null!==a&&a.isCanceled())throw Error("Operation has been cancelled.");};c.prototype._canDoAggregates=function(a,b,d,e,g){var c=new k;if(null===this._parent)c.resolve(!1);else return this._parent._canDoAggregates(a,
b,d,e,g);return c.promise};c.prototype._getAggregatePagesDataSourceDefinition=function(a,b,d,e,g,c,f){var h=new k;if(null===this._parent)h.reject(Error("Should never be called"));else return this._parent._getAggregatePagesDataSourceDefinition(a,b,d,e,g,c,f);return h.promise};c.prototype._getAgregagtePhysicalPage=function(a,b,d){var e=new k;if(null===this._parent)e.reject(Error("Should never be called"));else return this._parent._getAgregagtePhysicalPage(a,b,d);return e.promise};c.prototype.databaseType=
function(){var a=this,b=new k;if(this._databaseType===f.FeatureServiceDatabaseType.NotEvaluated){if(null!==r.applicationCache){var d=r.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==d)return d}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed.then(f.callback(function(a){b.resolve(a)},b),f.errback(b)),b.promise;d=[{thetype:f.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) \x3d CAST( '2015-01-01' as DATETIME)) AND OBJECTID\x3c0"},
{thetype:f.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') \x3d TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID\x3c0"},{thetype:f.FeatureServiceDatabaseType.Standardised,testwhere:"(date '2015-01-01 10:10:10' \x3d date '2015-01-01 10:10:10') AND OBJECTID\x3c0"}];this._databaseTypeProbed=b;null!==r.applicationCache&&r.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),b.promise);this._getDatabaseTypeImpl(d,0).then(f.callback(function(d){a._databaseType=
d;b.resolve(a._databaseType)},b),function(d){null!==r.applicationCache&&r.applicationCache.clearDatabaseType(a._cacheableFeatureSetSourceKey());b.reject(d)})}else b.resolve(this._databaseType);return b.promise};c.prototype._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"};c.prototype._getDatabaseTypeImpl=function(a,b){var d=this,e=new k;b>=a.length?e.resolve(f.FeatureServiceDatabaseType.Standardised):this._runDatabaseProbe(a[b].testwhere).then(f.callback(function(g){!0===g?e.resolve(a[b].thetype):
d._getDatabaseTypeImpl(a,b+1).then(f.callback(function(a){e.resolve(a)},e),f.errback(e))},e),f.errback(e));return e.promise};c.prototype._runDatabaseProbe=function(a){a=new k;a.reject(Error("Not Implemented"));return a.promise};c.prototype._featureFromCache=function(a){if(void 0!==this._featureCache[a])return this._featureCache[a]};c.prototype._isInFeatureSet=function(a){return f.IdState.Unknown};c.prototype._getSet=function(a){return(new k).promise};c.prototype._getFeature=function(a,b,d){var e=
this,g=new k;try{this._checkCancelled(d),void 0!==this._featureFromCache(b)?g.resolve(this._featureFromCache(b)):this._getFeatures(a,b,this._maxProcessingRate(),d).then(f.callback(function(){e._checkCancelled(d);void 0!==e._featureFromCache(b)?g.resolve(e._featureFromCache(b)):g.reject(Error("Feature Not Found"))},g),f.errback(g))}catch(h){g.reject(h)}return g.promise};c.prototype._getFeatures=function(a,b,d,e){a=new k;a.resolve("success");return a.promise};c.prototype._getFilteredSet=function(a,
b,d,e,g){return(new k).promise};c.prototype._refineSetBlock=function(a,b,d){var e=this,g=new k;try{if(!0===this._checkIfNeedToExpandCandidatePage(a,this._maxQueryRate(),d))return this._expandPagedSet(a,this._maxQueryRate(),0,0,d).then(f.callback(function(){e._refineSetBlock(a,b,d).then(f.callback(function(a){g.resolve(a)},g),f.errback(g))},g),f.errback(g)),g.promise;this._checkCancelled(d);var c=a._candidates.length;this._refineKnowns(a,b);var l=c-a._candidates.length;0===a._candidates.length?g.resolve(a):
l>=b?g.resolve(a):this._refineIfParentKnown(a,b-l,d).then(f.callback(function(){e._checkCancelled(d);e._refineKnowns(a,b-l);l=c-a._candidates.length;if(l<b&&0<a._candidates.length){var h=b-l,k=e._prepareFetchAndRefineSet(a._candidates,e._maxQueryRate());e._fetchAndRefineFeatures(k,k.length>h?h:a._candidates.length,d).then(f.callback(function(){e._checkCancelled(d);e._refineKnowns(a,b-l);g.resolve(a)},g),f.errback(g))}else g.resolve(a)},g),f.errback(g))}catch(n){g.reject(n)}return g.promise};c.prototype._fetchAndRefineFeatures=
function(a,b,d){return null};c.prototype._prepareFetchAndRefineSet=function(a,b){b=[];for(var d=0;d<a.length;d++)this._isPhysicalFeature(a[d])&&b.push(a[d]);return b};c.prototype._isPhysicalFeature=function(a){return null===this._parent?!0:this._parent._isPhysicalFeature(a)};c.prototype._refineKnowns=function(a,b){var d=0,e=null,g=[];b=this._maxQueryRate();for(var c=0;c<a._candidates.length&&"GETPAGES"!==a._candidates[c];c++){var l=!1,k=this._candidateIdTransform(a._candidates[c]);k!==a._candidates[c]&&
(l=!0);var m=this._isInFeatureSet(k);if(m===f.IdState.InFeatureSet)!0===l?0>a._known.indexOf(k)&&(a._known.push(k),d+=1):(a._known.push(a._candidates[c]),d+=1),null===e?e={start:c,end:c}:e.end===c-1?e.end=c:(g.push(e),e={start:c,end:c});else if(m===f.IdState.NotInFeatureSet)null===e?e={start:c,end:c}:e.end===c-1?e.end=c:(g.push(e),e={start:c,end:c}),d+=1;else if(m===f.IdState.Unknown&&(d+=1,!0===a._ordered))break;if(d>=b)break}null!==e&&g.push(e);for(b=g.length-1;0<=b;b--)a._candidates.splice(g[b].start,
g[b].end-g[b].start+1)};c.prototype._refineIfParentKnown=function(a,b,d){var e=this,c=new k,h=new y([],[],a._ordered,null);h._candidates=a._candidates.slice(0);this._parent._refineSetBlock(h,b,d).then(f.callback(function(b){e._parent._transformSetWithIdChanges(a);c.resolve(b)},c),f.errback(c));return c.promise};c.prototype._candidateIdTransform=function(a){return this._parent._candidateIdTransform(a)};c.prototype._transformSetWithIdChanges=function(a){this._parent._transformSetWithIdChanges(a)};c.prototype._checkIfNeedToExpandKnownPage=
function(a,b,d){if(null===a.pagesDefinition)return!1;d=0;for(var e=a._lastFetchedIndex;e<a._known.length;e++){if("GETPAGES"===a._known[e])return!0;if(void 0===this._featureCache[a._known[e]]&&(d+=1,d>=b))break}return!1};c.prototype._checkIfNeedToExpandCandidatePage=function(a,b,d){if(null===a.pagesDefinition)return!1;for(var e=d=0;e<a._candidates.length;e++){if("GETPAGES"===a._candidates[e])return!0;d+=1;if(d>=b)break}return!1};c.prototype._expandPagedSet=function(a,b,d,e,c){return null===this._parent?
(a=new k,a.reject(Error("Parent Paging not implemented")),a.promise):this._parent._expandPagedSet(a,b,d,e,c)};c.prototype._expandPagedSetFeatureSet=function(a,b,d,e,c){var g=this,l=new k;0<a._known.length&&"GETPAGES"===a._known[a._known.length-1]&&(e=1);0===e&&0<a._candidates.length&&"GETPAGES"===a._candidates[a._candidates.length-1]&&(e=2);0===e?l.resolve("finished"):this._getPage(a,e,c).then(f.callback(function(e){d+e<b?g._expandPagedSet(a,b,d+e,0,c).then(f.callback(function(a){l.resolve(a)},l),
f.errback(l)):l.resolve("success")},l),f.errback(l));return l.promise};c.prototype._getPage=function(a,b,d){var e=this,c=new k,h=1===b?a._known:a._candidates;if(a.pagesDefinition.internal.set.length>a.pagesDefinition.resultOffset||!0===a.pagesDefinition.internal.fullyResolved){--h.length;for(var l=0,n=0;n<a.pagesDefinition.resultRecordCount&&!(a.pagesDefinition.resultOffset+n>=a.pagesDefinition.internal.set.length);n++)h[h.length]=a.pagesDefinition.internal.set[a.pagesDefinition.resultOffset+n],l++;
a.pagesDefinition.resultOffset+=a.pagesDefinition.resultRecordCount;n=!1;!0===a.pagesDefinition.internal.fullyResolved&&a.pagesDefinition.internal.set.length<=a.pagesDefinition.resultOffset&&(n=!0);!1===n&&h.push("GETPAGES");c.resolve(l)}else this._getPhysicalPage(a,b,d).then(f.callback(function(){e._getPage(a,b,d).then(f.callback(function(a){c.resolve(a)},c),f.errback(c))},c),f.errback(c));return c.promise};c.prototype._getPhysicalPage=function(a,b,d){return null};c.prototype._clonePageDefinition=
function(a){return null===this._parent?null:this._parent._clonePageDefinition(a)};c.prototype._first=function(a){var b=this,d=new k;this.shouldBeResolvedAsBigData()?this.expressAsArcadeScript().then(function(a){try{a.script+="\n return first("+a.featuresetIdentifier+")";var c=b.sourceGeoAnalyticsProvider();null===c?d.reject(Error("No Big Data Provider")):c.executeScript(a.script,a.globals,a.spatialReference).then(function(a){d.resolve(a)},function(a){d.reject(a)})}catch(h){d.reject(h)}},function(a){d.reject(a)}):
this.iterator(a).next().then(function(a){d.resolve(a)},function(a){d.reject(a)});return d.promise};c.prototype.first=function(){var a=new k;this._first(a.promise).then(function(b){a.resolve(b)},function(b){a.reject(b)});return a.promise};c.prototype._qStat=function(a,b,d,c){var e=this,h=new k;if(this.shouldBeResolvedAsBigData())return this._qBigDataStat(a,b,d,c);this._ensureLoaded().then(f.callback(function(){e._stat(a,b,"",null,null,d,c).then(f.callback(function(g){!1===g.calculated?e._manualStat(a,
b,d,c).then(f.callback(function(a){h.resolve(a.result)},h),f.errback(h)):h.resolve(g.result)},h),f.errback(h))},h),f.errback(h));return h.promise};c.prototype._manualStat=function(a,b,d,c){var e=new k;switch(a.toLowerCase()){case "count":q.count(this,c).then(f.callback(function(a){e.resolve({calculated:!0,result:a})},e),f.errback(e));break;case "distinct":q.distinct(this,b,d).then(f.callback(function(a){e.resolve({calculated:!0,result:a})},e),f.errback(e));break;case "avg":case "mean":q.mean(this,
b,c).then(f.callback(function(a){e.resolve({calculated:!0,result:a})},e),f.errback(e));break;case "stdev":q.stdev(this,b,c).then(f.callback(function(a){e.resolve({calculated:!0,result:a})},e),f.errback(e));break;case "variance":q.variance(this,b,c).then(f.callback(function(a){e.resolve({calculated:!0,result:a})},e),f.errback(e));break;case "sum":q.sum(this,b,c).then(f.callback(function(a){e.resolve({calculated:!0,result:a})},e),f.errback(e));break;case "min":q.min(this,b,c).then(f.callback(function(a){e.resolve({calculated:!0,
result:a})},e),f.errback(e));break;case "max":q.max(this,b,c).then(f.callback(function(a){e.resolve({calculated:!0,result:a})},e),f.errback(e));break;default:e.resolve({calculated:!0,result:0})}return e.promise};c.prototype._stat=function(a,b,d,c,g,h,l){var e=this,m=new k;this._parent._stat(a,b,d,c,g,h,l).then(f.callback(function(k){!1===k.calculated?null===g&&""===d&&null===c?e._manualStat(a,b,h,l).then(f.callback(function(a){m.resolve(a)},m),f.errback(m)):m.resolve({calculated:!1}):m.resolve(k)},
m),f.errback(m));return m.promise};c.prototype._unionAllGeomSelf=function(){var a=new k;if(this.shouldBeResolvedAsBigData())return this._qBigDataStat("geometryunion",null,-1,null);var b=this.iterator(a.promise);this._unionShapeInBatches([],b,f.callback(function(b){a.resolve(b)},a),f.errback(a));return a.promise};c.prototype._unionAllGeom=function(a){var b=new k;a=this.iterator(a);this._unionShapeInBatches([],a,f.callback(function(a){b.resolve(a)},b),f.errback(b));return b.promise};c.prototype._unionShapeInBatches=
function(a,b,d,c){var e=this,f=new k;b.next().then(function(f){try{null!==f&&null!==f.geometry&&a.push(f.geometry),30<a.length||null===f&&1<a.length?t.union(a).then(function(l){try{null===f?d(l):(a=[l],e._unionShapeInBatches(a,b,d,c))}catch(m){c(m)}},c):null===f?1===a.length?d(a[0]):d(null):e._unionShapeInBatches(a,b,d,c)}catch(n){c(n)}},c);return f.promise};c.prototype.iterator=function(a){return this.shouldBeResolvedAsBigData()?new A(this,a):new x(this,a)};c.prototype.intersection=function(a,b){void 0===
b&&(b=!1);return c._featuresetFunctions.intersection.bind(this)(a,b)};c.prototype.difference=function(a,b,d){void 0===b&&(b=!1);void 0===d&&(d=!0);return c._featuresetFunctions.difference.bind(this)(a,b,d)};c.prototype.symmetricDifference=function(a,b,d){void 0===b&&(b=!1);void 0===d&&(d=!0);return c._featuresetFunctions.symmetricDifference.bind(this)(a,b,d)};c.prototype.morphShape=function(a,b,d,e){void 0===d&&(d="unknown");void 0===e&&(e=null);return c._featuresetFunctions.morphShape.bind(this)(a,
b,d,e)};c.prototype.morphShapeAndAttributes=function(a,b,d){void 0===d&&(d="unknown");return c._featuresetFunctions.morphShapeAndAttributes.bind(this)(a,b,d)};c.prototype.union=function(a,b){void 0===b&&(b=!1);return c._featuresetFunctions.union.bind(this)(a,b)};c.prototype.intersects=function(a){return c._featuresetFunctions.intersects.bind(this)(a)};c.prototype.envelopeIntersects=function(a){return c._featuresetFunctions.envelopeIntersects.bind(this)(a)};c.prototype.contains=function(a){return c._featuresetFunctions.contains.bind(this)(a)};
c.prototype.overlaps=function(a){return c._featuresetFunctions.overlaps.bind(this)(a)};c.prototype.relate=function(a,b){return c._featuresetFunctions.relate.bind(this)(a,b)};c.prototype.within=function(a){return c._featuresetFunctions.within.bind(this)(a)};c.prototype.touches=function(a){return c._featuresetFunctions.touches.bind(this)(a)};c.prototype.top=function(a){return c._featuresetFunctions.top.bind(this)(a)};c.prototype.crosses=function(a){return c._featuresetFunctions.crosses.bind(this)(a)};
c.prototype.buffer=function(a,b,d,e){void 0===e&&(e=!0);return c._featuresetFunctions.buffer.bind(this)(a,b,d,e)};c.prototype.filter=function(a,b){void 0===b&&(b=null);return c._featuresetFunctions.filter.bind(this)(a,b)};c.prototype.orderBy=function(a){return c._featuresetFunctions.orderBy.bind(this)(a)};c.prototype.dissolve=function(a,b){return c._featuresetFunctions.dissolve.bind(this)(a,b)};c.prototype.summarize=function(a,b){return c._featuresetFunctions.summarize.bind(this)(a,b)};c.prototype.summarizeBins=
function(a,b,d,e){return c._featuresetFunctions.summarizeBins.bind(this)(a,b,d,e)};c.prototype.aggregate=function(a,b){return c._featuresetFunctions.aggregate.bind(this)(a,b)};c.prototype.reduce=function(a,b){void 0===b&&(b=null);var d=new k;this._reduceImpl(this.iterator(d.promise),a,b,0,f.callback(function(a){d.resolve(a)},d),f.errback(d),0);return d.promise};c.prototype._reduceImpl=function(a,b,d,c,f,h,l){var e=this;try{l++,1E3<l?setTimeout(function(){l=0;e._reduceImpl(a,b,d,c,f,h,l)}):a.next().then(function(g){try{if(null===
g)f(d);else{var k=b(d,g,c,e);k instanceof v?k.then(function(d){e._reduceImpl(a,b,d,c+1,f,h,l)},h):e._reduceImpl(a,b,k,c+1,f,h,l)}}catch(D){h(D)}},h)}catch(m){h(m)}};c.prototype.removeField=function(a){return c._featuresetFunctions.removeField.bind(this)(a)};c.prototype.addField=function(a,b,d){void 0===d&&(d=null);return c._featuresetFunctions.addField.bind(this)(a,b,d)};c.prototype.sumArea=function(a,b){void 0===b&&(b=!1);var d=f.convertSquareUnitsToCode(a);return this.shouldBeResolvedAsBigData()?
this._qBigDataStat(b?"sumareageodesic":"sumarea",null,d,null):this.reduce(function(a,c){if(null===c.geometry)return 0;var e=new k;b?t.geodesicArea(c.geometry,d).then(f.callback(function(b){e.resolve(a+b)},e),f.errback(e)):t.planarArea(c.geometry,d).then(f.callback(function(b){e.resolve(a+b)},e),f.errback(e));return e.promise},0)};c.prototype.sumLength=function(a,b){void 0===b&&(b=!1);var d=f.convertLinearUnitsToCode(a);return this.shouldBeResolvedAsBigData()?this._qBigDataStat(b?"sumlengthgeodesic":
"sumlength",null,d,null):this.reduce(function(a,c){if(null===c.geometry)return 0;var e=new k;b?t.geodesicLength(c.geometry,d).then(f.callback(function(b){e.resolve(a+b)},e),f.errback(e)):t.planarLength(c.geometry,d).then(f.callback(function(b){e.resolve(a+b)},e),f.errback(e));return e.promise},0)};c.prototype._substituteVars=function(a,b){if(null!==b){var d={},c;for(c in b)d[c.toLowerCase()]=b[c];a.setVariablesDictionary(d)}};c.prototype.distinct=function(a,b,d){void 0===b&&(b=1E3);void 0===d&&(d=
null);a=p.create(a);this._substituteVars(a,d);var c=new k;this._qStat("distinct",a,b,c.promise).then(f.callback(function(a){c.resolve(a)},c),f.errback(c));return c.promise};c.prototype.min=function(a,b){void 0===b&&(b=null);a=p.create(a);this._substituteVars(a,b);var d=new k;this._qStat("min",a,-1,d.promise).then(f.callback(function(a){d.resolve(a)},d),f.errback(d));return d.promise};c.prototype.max=function(a,b){void 0===b&&(b=null);a=p.create(a);this._substituteVars(a,b);var d=new k;this._qStat("max",
a,-1,d.promise).then(f.callback(function(a){d.resolve(a)},d),f.errback(d));return d.promise};c.prototype.avg=function(a,b){void 0===b&&(b=null);a=p.create(a);this._substituteVars(a,b);var d=new k;this._qStat("avg",a,-1,d.promise).then(f.callback(function(a){d.resolve(a)},d),f.errback(d));return d.promise};c.prototype.sum=function(a,b){void 0===b&&(b=null);a=p.create(a);this._substituteVars(a,b);var d=new k;this._qStat("sum",a,-1,d.promise).then(f.callback(function(a){d.resolve(a)},d),f.errback(d));
return d.promise};c.prototype.stdev=function(a,b){void 0===b&&(b=null);a=p.create(a);this._substituteVars(a,b);var d=new k;this._qStat("stdev",a,-1,d.promise).then(f.callback(function(a){d.resolve(a)},d),f.errback(d));return d.promise};c.prototype.variance=function(a,b){void 0===b&&(b=null);a=p.create(a);this._substituteVars(a,b);var d=new k;this._qStat("variance",a,-1,d.promise).then(f.callback(function(a){d.resolve(a)},d),f.errback(d));return d.promise};c.prototype.count=function(){var a=new k;
this._qStat("count",p.create("1"),-1,a.promise).then(f.callback(function(b){a.resolve(b)},a),f.errback(a));return a.promise};c.prototype.forEach=function(a){var b=new k;this._forEachImpl(this.iterator(b.promise),a,this,f.callback(function(a){b.resolve(a)},b),f.errback(b),0);return b.promise};c.prototype._forEachImpl=function(a,b,d,c,f,h){var e=this;try{h++,1E3<h?setTimeout(function(){h=0;e._forEachImpl(a,b,d,c,f,h)},0):a.next().then(function(l){try{if(null===l)c(d);else{var g=b(l);void 0===g||null===
g?e._forEachImpl(a,b,d,c,f,h):g instanceof v?g.then(function(){try{e._forEachImpl(a,b,d,c,f,h)}catch(u){f(u)}},f):e._forEachImpl(a,b,d,c,f,h)}}catch(u){f(u)}},f)}catch(n){f(n)}};c.prototype.convertToJSON=function(){for(var a=new k,b={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}},d=0;d<this.fields.length;d++)b.layerDefinition.fields.push(f.esriFieldToJson(this.fields[d]));this.reduce(function(a){var d={geometry:a.geometry&&a.geometry.toJSON(),
attributes:{}},c;for(c in a.attributes)d.attributes[c]=a.attributes[c];b.featureSet.features.push(d);return 1},0).then(function(){a.resolve(b)},function(b){a.reject(b)});return a.promise};c.prototype.canBeBigDataFeatureSet=function(){return this._parent.canBeBigDataFeatureSet()};c.prototype.shouldBeResolvedAsBigData=function(){return this._parent.shouldBeResolvedAsBigData()};c.prototype.expressAsArcadeScript=function(){var a=this,b=new k;this._ensureLoaded().then(function(){try{var d={featuresetIdentifier:"",
script:"",spatialReference:a.spatialReference,globals:{},functions:{stack:[],lkp:{}},symbols:{syms:{},featuresetsyms:[],symc:0}};d.script=a.expressAsArcadeScriptImpl(d.functions,d.globals,d.symbols);for(var c="",f=0,h=d.functions.stack;f<h.length;f++)c+="\n"+h[f].script;d.script=c+d.script;d.featuresetIdentifier=d.symbols.featuresetsyms[d.symbols.featuresetsyms.length-1];b.resolve(d)}catch(l){b.reject(l)}},function(a){b.reject(a)});return b.promise};c.prototype.expressAsArcadeScriptImpl=function(a,
b,d){return this._parent.expressAsArcadeScriptImpl(a,b,d)+"\n"+this.arcadeScriptStep(a,b,d)};c.prototype.arcadeScriptStep=function(a,b,d){return""};c.prototype.arcadeAssignNextGlobalIdentifier=function(a){for(var b=!1,d="";!1===b;)w++,d="$g_"+w.toString(),void 0===a.syms[d]&&(b=!0);return d};c.prototype.arcadeAssignNextScriptStepIdentifiers=function(a){for(var b=0===a.featuresetsyms.length?"":a.featuresetsyms[a.featuresetsyms.length-1],d=!1,c="";!1===d;)a.symc++,c="$$c_"+a.symc.toString(),void 0===
a.syms[c]&&(d=!0);a.featuresetsyms.push(c);a.syms[c]=c;return{currentFeatureSet:b,newFeatureSet:c}};c.prototype.exportArcadeFunctionAndDependencies=function(a,b,c,e){return z.exportFunctionAsArcade(a,b,c,e)};c.prototype.constructArcadeGeom=function(a,b,c){c=this.arcadeAssignNextGlobalIdentifier(c);b[c]={name:c,type:"geometry",params:{value:a}};return c};c.prototype._qBigDataStat=function(a,b,c,e){var d=this;void 0===c&&(c=-1);var h=new k;this.expressAsArcadeScript().then(function(e){try{switch(a.toLowerCase()){case "sumlength":e.script+=
"\n return length("+e.featuresetIdentifier+","+c.toString()+")";break;case "sumlengthgeodesic":e.script+="\n return lengthgeodetic("+e.featuresetIdentifier+","+c.toString()+")";break;case "sumarea":e.script+="\n return area("+e.featuresetIdentifier+","+c.toString()+")";break;case "sumareageodesic":e.script+="\n return areageodetic("+e.featuresetIdentifier+","+c.toString()+")";break;case "geometryunion":e.script+="\n return union("+e.featuresetIdentifier+")";break;case "count":e.script+="\n return Count("+
e.featuresetIdentifier+")";break;case "distinct":e.script+="\n return Distinct("+e.featuresetIdentifier+',"'+b.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+'");';break;case "avg":case "mean":e.script+="\n return Average("+e.featuresetIdentifier+',"'+b.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+'");';break;case "stdev":e.script+="\n return Stdev("+e.featuresetIdentifier+',"'+b.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+'");';break;case "variance":e.script+="\n return Variance("+
e.featuresetIdentifier+',"'+b.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+'");';break;case "sum":e.script+="\n return Sum("+e.featuresetIdentifier+',"'+b.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+'");';break;case "min":e.script+="\n return Min("+e.featuresetIdentifier+',"'+b.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+'");';break;case "max":e.script+="\n return Max("+e.featuresetIdentifier+',"'+b.toWhereClause(f.FeatureServiceDatabaseType.Standardised)+'");';
break;default:e.script="BADSTAT"}var g=d.sourceGeoAnalyticsProvider();"BADSTAT"===e.script?h.reject(Error("Stat not supported")):null===g?h.reject(Error("No Big Data Provider")):g.executeScript(e.script,e.globals,e.spatialReference).then(function(a){h.resolve(a)},function(a){h.reject(a)})}catch(m){h.reject(m)}},function(a){h.reject(a)});return h.promise};c.prototype.sourceGeoAnalyticsProvider=function(){return this._parent.sourceGeoAnalyticsProvider()};c.prototype.bigDataCachePipeline=function(a){return"ga_pipeline("+
a+",'"+this._bigdCacheId+"')"};c.prototype.castToText=function(){return"object, FeatureSet"};c.prototype.schema=function(){for(var a=[],b=0,c=this.fields;b<c.length;b++)a.push(f.esriFieldToJson(c[b]));return{objectIdField:this.objectIdField,typeIdField:this.typeIdField,geometryType:void 0===f.layerGeometryEsriConstants[this.geometryType]?"":f.layerGeometryEsriConstants[this.geometryType],hasZ:this.hasZ,hasM:this.hasM,fields:a}};c.prototype.convertToText=function(a){var b=this,c=new k;"schema"===a?
this._ensureLoaded().then(function(){c.resolve(JSON.stringify(b.schema))},function(a){c.reject(a)}):"featureset"===a?this._ensureLoaded().then(function(){var a=[];b.reduce(function(b){b=b.toJson();null!==b.geometry&&b.geometry.spatialReference&&delete b.geometry.spatialReference;a.push(b);return 1},0).then(function(){var d=b.schema();d.features=a;d.spatialReference=b.spatialReference.toJSON();c.resolve(JSON.stringify(b.schema))},function(a){c.reject(a)})},function(a){c.reject(a)}):c.resolve(this.castToText());
return c.promise};c._featuresetFunctions={};c._polyfill={table:null};return c}()});