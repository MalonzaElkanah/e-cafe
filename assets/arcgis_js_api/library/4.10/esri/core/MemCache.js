// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define(["require","exports","./iteratorUtils","./lang","./PooledArray"],function(e,m,k,f,l){e=function(){function a(a,g,b){this._namespace=a;this._storage=g;this._removeFunc=!1;this._miss=this._hit=0;this._storage.register(this);this._namespace+=":";b&&(this._storage.registerRemoveFunc(this._namespace,b),this._removeFunc=!0)}Object.defineProperty(a.prototype,"namespace",{get:function(){return this._namespace.slice(0,-1)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hitRate",
{get:function(){return this._hit/(this._hit+this._miss)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"size",{get:function(){return this._storage.size},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSize",{get:function(){return this._storage.maxSize},enumerable:!0,configurable:!0});a.prototype.resetHitRate=function(){this._hit=this._miss=0};a.prototype.destroy=function(){this._storage.clear(this._namespace);this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace);
this._storage.deregister(this)};a.prototype.put=function(a,g,b){this._storage.put(this._namespace+a,g,b)};a.prototype.get=function(a){a=this._storage.get(this._namespace+a);void 0===a?++this._miss:++this._hit;return a};a.prototype.pop=function(a){a=this._storage.pop(this._namespace+a);void 0===a?++this._miss:++this._hit;return a};a.prototype.clear=function(){this._storage.clear(this._namespace)};a.prototype.clearAll=function(){this._storage.clearAll()};a.prototype.getStats=function(){return this._storage.getStats()};
a.prototype.resetStats=function(){this._storage.resetStats()};return a}();(function(a){var e=function(){function a(b){void 0===b&&(b=10485760);this._maxSize=b;this._db=new Map;this._miss=this._hit=this._size=0;this._removeFuncs=[];this._users=new l}a.prototype.register=function(b){this._users.push(b)};a.prototype.deregister=function(b){this._users.removeUnordered(b)};a.prototype.registerRemoveFunc=function(b,a){this._removeFuncs.push([b,a])};a.prototype.deregisterRemoveFunc=function(b){this._removeFuncs=
this._removeFuncs.filter(function(a){return a[0]!==b})};Object.defineProperty(a.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSize",{get:function(){return this._maxSize},set:function(a){this._maxSize=Math.max(a,0);this._size>this._maxSize&&this._removeEntries()},enumerable:!0,configurable:!0});a.prototype.put=function(a,d,c){if(this._db.has(a)){var b=this._db.get(a);this._size-=b.size;this._db.delete(a);this._notifyRemoved(a,
b.entry)}c>this._maxSize?this._notifyRemoved(a,d):void 0===d?console.warn("Refusing to cache undefined entry "):!c||0>c?console.warn("Refusing to cache entry with invalid size "+c):(this._db.set(a,{entry:d,size:c}),this._size+=c,this._size>this._maxSize&&this._removeEntries())};a.prototype.pop=function(a){if(this._db.has(a)){var b=this._db.get(a);this._size-=b.size;this._db.delete(a);++this._hit;return b.entry}++this._miss};a.prototype.get=function(a){var b=this._db.get(a);if(void 0===b)++this._miss;
else return this._db.delete(a),this._db.set(a,b),++this._hit,b.entry};a.prototype.getStats=function(){var a=this,d={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},c={};this._db.forEach(function(b,d){a._users.forEach(function(a){a=a.namespace;if(f.startsWith(d,a))return c[a]=(c[a]||0)+b.size,!1})});var h={};this._users.forEach(function(a){var b=a.namespace;!isNaN(a.hitRate)&&0<a.hitRate?
(c[b]=c[b]||0,h[b]=Math.round(100*a.hitRate)+"%"):h[b]="0%"});var e=Object.keys(c);e.forEach(function(b){return c[b]=c[b]/a._size*100});e.sort(function(a,b){return c[b]-c[a]});e.forEach(function(a){return d[a]=Math.round(c[a])+"% / "+h[a]});return d};a.prototype.resetStats=function(){this._hit=this._miss=0;this._users.forEach(function(a){return a.resetHitRate()})};a.prototype.clear=function(a){var b=this;this._db.forEach(function(c,d){f.startsWith(d,a)&&(b._size-=c.size,b._db.delete(d),b._notifyRemoved(d,
c.entry))})};a.prototype.clearAll=function(){var a=this;this._db.forEach(function(b,c){a._notifyRemoved(c,b.entry)});this._size=0;this._db.clear()};a.prototype._getHitRate=function(){return this._hit/(this._hit+this._miss)};a.prototype._notifyRemoved=function(a,d){this._removeFuncs.forEach(function(b){if(f.startsWith(a,b[0]))b[1](d)})};a.prototype._removeEntries=function(){var a=this;k.everyMap(this._db,function(b,c){a._size-=b.size;a._db.delete(c);a._notifyRemoved(c,b.entry);return a._size>.9*a.maxSize})};
return a}();a.Storage=e})(e||(e={}));return e});