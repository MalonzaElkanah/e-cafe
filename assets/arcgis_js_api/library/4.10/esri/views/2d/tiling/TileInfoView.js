// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../geometry/support/spatialReferenceUtils ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(z,A,u,v,w,x,r){var d=new x("0/0/0/0"),y=function(){function d(b,a,c,d,k,e,q,g){this.x=b;this.ymin=a;this.ymax=c;this.invM=d;this.leftAdjust=k;this.rightAdjust=e;this.leftBound=q;this.rightBound=g}d.create=function(b,a){var c;b[1]>a[1]&&(c=[a,b],b=c[0],a=c[1]);c=b[0];b=b[1];var t=a[0];a=a[1];var k=t-c,e=a-b,e=0!==e?k/e:0,q=(Math.ceil(b)-b)*e,g=(Math.floor(b)-b)*
e;return new d(c,Math.floor(b),Math.ceil(a),e,0>k?q:g,0>k?g:q,0>k?t:c,0>k?c:t)};d.prototype.incrRow=function(){this.x+=this.invM};d.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};d.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return d}(),h=[[0,0],[0,0],[0,0],[0,0]];return function(){function f(b,a){var c=this;this.tileInfo=b;this.fullExtent=a;this.scales=[];this._lodInfos=null;this._infoByScale={};this._infoByLevel=
{};var d=b.lods.slice();d.sort(function(a,b){return b.scale-a.scale});var k=this._lodInfos=d.map(function(c){return v.create(b,c,a)});d.forEach(function(a,b){c._infoByLevel[a.level]=k[b];c._infoByScale[a.scale]=k[b];c.scales[b]=a.scale},this);this._wrap=b.isWrappable}Object.defineProperty(f.prototype,"spatialReference",{get:function(){return this.tileInfo.spatialReference},enumerable:!0,configurable:!0});f.prototype.getLODInfoAt=function(b){return this._infoByLevel["number"===typeof b?b:b.level]};
f.prototype.getTileBounds=function(b,a,c){void 0===c&&(c=!1);d.set(a);return(a=this._infoByLevel[d.level])?a.getTileBounds(b,d,c):b};f.prototype.getTileCoords=function(b,a,c){void 0===c&&(c=!1);d.set(a);return(a=this._infoByLevel[d.level])?a.getTileCoords(b,d,c):b};f.prototype.getTileCoverage=function(b,a,c){void 0===a&&(a=192);void 0===c&&(c="closest");c="closest"===c?this.getClosestInfoForScale(b.scale):this.getSmallestInfoForScale(b.scale);var d=w.pool.acquire(c),k=this._wrap,e;e=Infinity;var f=
-Infinity,g,m,p=d.spans;h[0][0]=h[0][1]=h[1][1]=h[3][0]=-a;h[1][0]=h[2][0]=b.size[0]+a;h[2][1]=h[3][1]=b.size[1]+a;for(a=0;a<h.length;a++){var l=h[a];b.toMap(l,l);l[0]=c.getColumnForX(l[0]);l[1]=c.getRowForY(l[1])}b=[];l=3;for(a=0;4>a;a++){if(h[a][1]!==h[l][1]){var n=y.create(h[a],h[l]);e=Math.min(n.ymin,e);f=Math.max(n.ymax,f);void 0===b[n.ymin]&&(b[n.ymin]=[]);b[n.ymin].push(n)}l=a}if(null==e||null==f||100<f-e)return null;for(l=[];e<f;){null!=b[e]&&(l=l.concat(b[e]));g=Infinity;m=-Infinity;for(a=
l.length-1;0<=a;a--)n=l[a],g=Math.min(g,n.getLeftCol()),m=Math.max(m,n.getRightCol());g=Math.floor(g);m=Math.floor(m);if(e>=c.first[1]&&e<=c.last[1])if(k)if(c.size[0]<c.worldSize[0])for(n=Math.floor(m/c.worldSize[0]),a=Math.floor(g/c.worldSize[0]);a<=n;a++)p.push(new r(e,Math.max(c.getFirstColumnForWorld(a),g),Math.min(c.getLastColumnForWorld(a),m)));else p.push(new r(e,g,m));else g>c.last[0]||m<c.first[0]||(g=Math.max(g,c.first[0]),m=Math.min(m,c.last[0]),p.push(new r(e,g,m)));e+=1;for(a=l.length-
1;0<=a;a--)n=l[a],n.ymax>=e?n.incrRow():l.splice(a,1)}return d};f.prototype.getTileParentId=function(b){d.set(b);b=this._lodInfos.indexOf(this._infoByLevel[d.level])-1;if(0>b)return null;this._getTileIdAtLOD(d,this._lodInfos[b],d);return d.id};f.prototype.getTileResolution=function(b){return(b=this._infoByLevel["object"===typeof b?b.level:b])?b.resolution:-1};f.prototype.getTileScale=function(b){return(b=this._infoByLevel[b.level])?b.scale:-1};f.prototype.intersects=function(b,a){d.set(a);a=this._infoByLevel[d.level];
var c=b.lodInfo;if(c.resolution>a.resolution){this._getTileIdAtLOD(d,c,d);for(var f=c.denormalizeCol(d.col,d.world),k=0,e=b.spans;k<e.length;k++){var h=e[k];if(h.row===d.row&&h.colFrom<=f&&h.colTo>=f)return!0}}if(c.resolution<a.resolution){e=b.spans.reduce(function(a,b){a[0]=Math.min(a[0],b.row);a[1]=Math.max(a[1],b.row);a[2]=Math.min(a[2],b.colFrom);a[3]=Math.max(a[3],b.colTo);return a},[Infinity,-Infinity,Infinity,-Infinity]);b=e[0];var f=e[1],k=e[2],e=e[3],g=a.denormalizeCol(d.col,d.world),h=c.getColumnForX(a.getXForColumn(g)),
m=c.getRowForY(a.getYForRow(d.row)),g=c.getColumnForX(a.getXForColumn(g+1))-1;a=c.getRowForY(a.getYForRow(d.row+1))-1;return!(h>e||g<k||m>f||a<b)}var p=c.denormalizeCol(d.col,d.world);return b.spans.some(function(a){return a.row===d.row&&a.colFrom<=p&&a.colTo>=p})};f.prototype.normalizeBounds=function(b,a,c){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];this._wrap&&(a=u.getInfo(this.tileInfo.spatialReference),c=-c*(a.valid[1]-a.valid[0]),b[0]+=c,b[2]+=c);return b};f.prototype.getSmallestInfoForScale=function(b){var a=
this.scales;if(this._infoByScale[b])return this._infoByScale[b];if(b>a[0])return this._infoByScale[a[0]];for(var c=1;c<a.length-1;c++)if(b>a[c])return this._infoByScale[a[c-1]];return this._infoByScale[a[a.length-1]]};f.prototype.getClosestInfoForScale=function(b){var a=this.scales;this._infoByScale[b]||(b=a.reduce(function(a,d,f,e){return Math.abs(d-b)<Math.abs(a-b)?d:a},a[0]));return this._infoByScale[b]};f.prototype.scaleToLevel=function(b){var a=this.scales;if(this._infoByScale[b])return this._infoByScale[b].level;
for(var c=a.length-1;0<=c;c--)if(b<a[c])return c===a.length-1?this._infoByScale[a[a.length-1]].level:this._infoByScale[a[c]].level+(a[c]-b)/(a[c]-a[c+1]);return this._infoByScale[a[0]].level};f.prototype.scaleToZoom=function(b){return this.tileInfo.scaleToZoom(b)};f.prototype._getTileIdAtLOD=function(b,a,c){var d=this._infoByLevel[c.level];b.set(c);if(a.resolution<d.resolution)return null;if(a.resolution===d.resolution)return b;b.level=a.level;b.col=Math.floor(c.col*d.resolution/a.resolution+.01);
b.row=Math.floor(c.row*d.resolution/a.resolution+.01);return b};return f}()});