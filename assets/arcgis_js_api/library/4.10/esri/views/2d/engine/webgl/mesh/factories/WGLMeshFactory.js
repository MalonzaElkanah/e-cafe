// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../geometry/support/jsonUtils ../../../../../../symbols/SimpleLineSymbol ../../definitions ../../enums ../../WGLDisplayObject ../../collisions/LayerCollisionInfo ../MeshData ../VertexVector ./VVFactory ../templates/WGLLabelTemplate ../templates/WGLLineTemplate ../templates/WGLMarkerTemplate ../../util/vvFlagUtils".split(" "),function(u,v,K,w,z,A,B,x,g,C,
D,E,k,F,G,H,I,l){Object.defineProperty(v,"__esModule",{value:!0});var q=z.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),J={esriGeometryPoint:"above-right above-center above-left center-center center-left center-right below-center below-left below-right".split(" "),esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null,esriGeometryEnvelope:null};u=function(){function a(c,b,e,m,h,d,r,y,f,a){var g=this;this._labelsDebugVVEval=this._labelsDebugTemplate=
null;this._materials=r;this._geometryType=c;this._idField=b;this._pixelRatio=h;this._vvFlags=l.getVVFlags(e);this._vvFactory=new F.default(e,m);this._vvBuf=new ArrayBuffer(16);this._vvBufU32=new Uint32Array(this._vvBuf);this._vvBufF32=new Float32Array(this._vvBuf);this._templateStore=y;if(f)if(x.DEBUG_LABELS&&(this._labelsDebugVVEval=e&&D.createLabelVVEvaluator(e)),this._validateLabelingInfo(f)){var n=l.getLabelVVFlags(this._vvFlags);this._labelTemplates=f.map(function(b){return G.default.fromLabelClass(g._materials,
n,b,h,a)})}else q.error(new w("mapview-labeling:unsupported-geometry","LabelingInfo failed validation - unable to create labels for layer."))}Object.defineProperty(a.prototype,"materials",{get:function(){return this._materials},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"templates",{get:function(){return this._templateStore},enumerable:!0,configurable:!0});a.prototype.createMeshData=function(c){var b=Array(5),e=!!l.getMarkerVVFlags(this._vvFlags),m=!!l.getFillVVFlags(this._vvFlags),
h=!!l.getLineVVFlags(this._vvFlags,"esriGeometryPolyline"!==this._geometryType),d=!!l.getTextVVFlags(this._vvFlags),a="esriGeometryPolyline"===this._geometryType?x.HEURISTIC_GLYPHS_PER_LINE:x.HEURISTIC_GLYPHS_PER_FEATURE;b[g.WGLGeometryType.MARKER]=new k.VertexVectors(g.WGLGeometryType.MARKER,e,c);b[g.WGLGeometryType.FILL]=new k.VertexVectors(g.WGLGeometryType.FILL,m,c);b[g.WGLGeometryType.LINE]=new k.VertexVectors(g.WGLGeometryType.LINE,h,c);b[g.WGLGeometryType.TEXT]=new k.VertexVectors(g.WGLGeometryType.TEXT,
d,c);b[g.WGLGeometryType.LABEL]=new k.VertexVectors(g.WGLGeometryType.LABEL,!1,this._labelTemplates&&0<this._labelTemplates.length?a:0);return new E.default([],b,this._materials)};a.prototype.analyze=function(c,b,e,m){for(var h=0;h<c.length;h++){var d=c[h],a=-1;null!=d.symbol?a=this._templateStore.createTemplateGroup(d.symbol,null,this._materials,0):b&&(a=b.match(d,e,m));d.groupId=a}return this._templateStore.finalize().then(function(){return c})};a.prototype.write=function(c,b,e,a,h,d,g){var m=this._templateStore.getTemplateGroup(b.groupId),
f=b.attributes[this._idField],n=new C(f),l=!!d&&!!this._labelTemplates&&d.has(f);if(m&&(b.geometry||b.centroid)){this._vvFactory.computeVV(this._vvBufF32,b,e,a);a=n.displayRecords;e=b.insertAfter;void 0!==e&&(n.insertAfter=e);(e=this._geometryType)||(e=null!=b.centroid?"esriGeometryPolygon":A.getJsonType(b.geometry));for(var r=0;r<m.length;r++){var k=m[r],t=c.get(k.geometryType);k.writeMesh(a,t,e,f,b,this._pixelRatio,this._vvBufU32)}l&&(m=this._getLabelReference(m),d=d.get(f),this._writeLabelMesh(n,
c,f,b,g,d,m,h,e));c.pushDisplayObject(n)}};a.prototype._hasBadLabelClass=function(c,b){var e=c.labelPlacement,a=J[b];if(!a)return q.error(new w("mapview-labeling:unsupported-geometry-type","Unable to create labels for WebGL Feature Layer, "+b+" is not supported")),!0;a.some(function(b){return b===e})||(a=a[0],e&&q.warn("Found invalid label placement type "+e+" for "+b+". Defaulting to "+a),c.labelPlacement=a);return!1};a.prototype._validateLabelingInfo=function(c){var b=this;return!c.some(function(c){return b._hasBadLabelClass(c,
b._geometryType)})};a.prototype._getLabelReference=function(c){for(var b=0;b<c.length;b++){var a=c[b];if(a instanceof I.default)return a}return null};a.prototype._writeLabelMesh=function(c,b,a,m,h,d,g,k,f){for(var e=c.displayRecords,l=[],r=this._pixelRatio,y=this._vvBufU32,t=0;t<d.length;t++){var p=d[t],q=p.text,u=p.rtl,p=this._labelTemplates[p.id],v=b.get(p.geometryType),w=h.get(p.symbolId).glyphMosaicItems;p.bindReferenceTemplate(g);p.bindTextInfo(w,q,u);p.writeMesh(e,v,f,a,m,r,y,k,l)}c.metrics=
l;x.DEBUG_LABELS&&this._debugLabels(c,b)};a.prototype._debugLabels=function(a,b){var c=a.displayRecords,g=a.id,h=0;for(a=a.metrics;h<a.length;h++){var d=a[h],l=d.boxes?d.boxes.concat([d.bounds]):[d.bounds];this._labelsDebugVVEval&&d.computeOffset(this._labelsDebugVVEval);for(var k=0;k<l.length;k++){var f=l[k],f={geometry:{paths:[[[d.anchor[0]+d.offsetX+f.center[0]-f.width/2,d.anchor[1]+d.offsetY+f.center[1]+f.height/2],[0,-f.height],[f.width,0],[0,f.height],[-f.width,0]]]},attributes:{}},n=this._getLabelDebugTemplate(),
q=b.get(n.geometryType);n.writeMesh(c,q,"esriGeometryPolyline",g,f,this._pixelRatio,null)}}};a.prototype._getLabelDebugTemplate=function(){this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate());return this._labelsDebugTemplate};a.prototype._createLabelsDebugTemplate=function(){var a=new B({style:"solid",width:1,color:[255,0,0,1]});return H.default.fromSimpleLine(this._materials,0,a,null,this._pixelRatio)};return a}();v.default=u});