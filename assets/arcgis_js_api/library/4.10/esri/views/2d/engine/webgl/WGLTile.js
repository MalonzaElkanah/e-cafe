// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/libs/gl-matrix-2/gl-matrix ../DisplayObject ./definitions ./DirtyMap ./DisplayRecordStore ./enums ./Fader ./number ./Utils ./WGLBuffers ./WGLDisplayList ../../tiling/TileKey".split(" "),function(H,I,z,l,A,u,w,x,p,B,C,t,D,E,F){function G(l,b){return l.sortKey-b.sortKey}var v=new Set;return function(y){function b(a,k,g){void 0===g&&(g=!1);var d=y.call(this)||this;d._data=null;d.hlDisplayList=null;d._displayList=null;d._wglBuffers=
null;d._dirtyMap=new w.default;d.coords=[0,0];d.bounds=[0,0,0,0];d.tileTransform={transform:l.mat4f32.create(),screenTransform:l.mat2df32.create(),displayCoord:l.vec2f32.create(),screenCoord:l.vec2f32.create()};d.dvsMat3=l.mat3f32.create();d.tileMat3=l.mat3f32.create();d.labelMat2d=l.mat2df32.create();d._labelIndex=null;d._dirty=!0;d.fader=new B.default;d.key=F.pool.acquire(a);d.coords[0]=k[0];d.coords[1]=k[3];d.bounds=k;d._ensureCorrectZOrder=g;return d}z(b,y);Object.defineProperty(b.prototype,"iconGeometry",
{get:function(){return this.getGeometry(p.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"textGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fillGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.FILL)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"lineGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.LINE)},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.LABEL)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"canDisplay",{get:function(){return!!this.attached},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isDirty",{get:function(){return this._dirty},
set:function(a){(this._dirty=a)||this.isReady||this.ready();this.requestRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasData",{get:function(){return!!this._data},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0});b.prototype.getGeometry=function(a){return this._wglBuffers&&this._wglBuffers.has(a)?this._wglBuffers.get(a):null};b.prototype.getDisplayList=function(a){switch(a){case p.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;
default:return this._data&&this._displayList}};Object.defineProperty(b.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0});b.prototype.setData=function(a,k,g){var d=a.addOrUpdate,e=a.remove;this.fader.reset();!a.clear&&this.hasData||a.addOrUpdate?!a.clear&&this.hasData||!a.addOrUpdate?this.hasData&&this._doPatchData({addOrUpdate:d,remove:e},k,g):(d.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new w.default,this._dispRecStore=x.default.fromTileData(d,
this._dirtyMap),this._data=d,this._readyTileIfNoLabels(k,g),this._dirtyMap.markAllDirty(),this._displayList||(this._displayList=d.tileDisplayData.displayList.clone())):(this.clear(),this.ready())};b.prototype.commitChanges=function(a){this.isDirty&&this._wglBuffers||(this._wglBuffers||(this._wglBuffers=new D.default(this.stage.context)),this._displayList=this._data.tileDisplayData.displayList.clone(),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())};
b.prototype.resetVisibility=function(a){var k=this,g=[],d=Array(1);a.forEach(function(a){d[0]=a;k.setVisibility(g,d)})};b.prototype.setVisibility=function(a,k){for(var g=this._data.tileBufferData.geometries.map(t.geometryToMappedGeometry),d=0;d<a.length;d++){var e=this._data.tileDisplayData.displayObjectRegistry.get(a[d]);if(e)for(var b=0,q=e.displayRecords;b<q.length;b++){var f=q[b],c=g[f.geometryType];if(e=c.geometry.vertexBuffer[t.C_VBO_VISIBILITY]){c.vertexFrom=null==c.vertexFrom?f.vertexFrom:
Math.min(c.vertexFrom,f.vertexFrom);c.vertexTo=null==c.vertexTo?f.vertexFrom+f.vertexCount:Math.max(c.vertexTo,f.vertexFrom+f.vertexCount);for(var c=f.vertexFrom,f=f.vertexCount,h=0;h<f;++h)e.data[c+h]=255}}}for(a=0;a<k.length;a++)if(e=this._data.tileDisplayData.displayObjectRegistry.get(k[a]))for(d=0,b=e.displayRecords;d<b.length;d++)if(f=b[d],c=g[f.geometryType],e=c.geometry.vertexBuffer[t.C_VBO_VISIBILITY])for(c.vertexFrom=null==c.vertexFrom?f.vertexFrom:Math.min(c.vertexFrom,f.vertexFrom),c.vertexTo=
null==c.vertexTo?f.vertexFrom+f.vertexCount:Math.max(c.vertexTo,f.vertexFrom+f.vertexCount),c=f.vertexFrom,f=f.vertexCount,h=0;h<f;++h)e.data[c+h]=0;k=!1;for(e=0;e<g.length;++e)c=g[e],null!=c.vertexFrom&&null!=c.vertexTo&&(this._dirtyMap.markDirtyVertices(e,t.C_VBO_VISIBILITY,c.vertexFrom,c.vertexTo?c.vertexTo-c.vertexFrom:0),k=!0);k&&this.requestRender()};b.prototype.setVisibilityRange=function(a,k,g,d){a=this._data.tileDisplayData.displayObjectRegistry.get(a);for(var e=this._data.tileBufferData.geometries[p.WGLGeometryType.LABEL].vertexBuffer[t.C_VBO_VISIBILITY_RANGE],
b=Infinity,q=0,f=k;f<k+g;++f){for(var c=a.displayRecords[f],h=Math.max(c.minZoom,d),m=c.maxZoom,h=C.i8888to32(h,m,h,m),m=c.vertexFrom*e.stride/4,l=c.vertexCount*e.stride/4,r=m;r<m+l;++r)e.data[r]=h;b=Math.min(b,c.vertexFrom);q=Math.max(q,c.vertexFrom+c.vertexCount)}this._dirtyMap.markDirtyVertices(p.WGLGeometryType.LABEL,t.C_VBO_VISIBILITY_RANGE,b,q-b)};b.prototype.setTransform=function(a,k){var g=this.tileMat3,d=a.toScreenNoRotation([0,0],this.coords);l.mat3.set(this.tileMat3,k,0,0,0,k,0,d[0],d[1],
1);l.mat3.multiply(this.dvsMat3,a.displayViewMat3,g)};b.prototype.setLabelTransform=function(a,k){var g=this.labelMat2d;k=a.getScreenTransform(g,k);var d=l.vec2f32.create();l.vec2.transformMat2d(d,this.coords,k);l.mat2d.identity(g);l.mat2d.translate(g,g,d);l.mat2d.multiply(g,a.viewMat2d,g)};b.prototype.clear=function(){this._dispRecStore=this._displayList=this._data=null;this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null);this.hlDisplayList&&(this.hlDisplayList=null)};b.prototype.attach=
function(){return!0};b.prototype.dispose=function(){this.clear()};b.prototype.doRender=function(a){if(this.isReady&&this.hasData){this.commitChanges(a);this.stage.context.setStencilFunction(514,this.stencilRef,255);if(a.drawPhase===p.WGLDrawPhase.MAP||a.drawPhase===p.WGLDrawPhase.LABEL||a.drawPhase===p.WGLDrawPhase.LABEL_ALPHA)this._displayList.replay(a,this);else for(var k=0,g=this.stage.painter.getBrushes(a.drawPhase);k<g.length;k++)g[k].draw(a,this);this.fader.step()||this.requestRender()}};b.prototype.buildHLList=
function(a){var k=this;this.hlDisplayList=new E;a.forEach(function(a){k._addToHLDisplayList(k.hlDisplayList,a)})};b.prototype._addToHLDisplayList=function(a,k){if(this._data){var b=this._data.tileDisplayData.displayObjectRegistry.get(k);if(b){k=[];for(var d=0,b=b.displayRecords;d<b.length;d++){var e=b[d].copy();e.meshData=null;e.symbolLevel=0;e.zOrder=0;k.push(e)}k.sort(G);a.addToList(k)}}};b.prototype._readyTileIfNoLabels=function(a,b){a?(b||(this.isDirty=!1),this._rebuildLabelIndex(),this.isDirty=
!0):this.isDirty=!1};b.prototype._doPatchData=function(a,b,g){this._patchData(a)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=x.default.fromTileData(this._data,this._dirtyMap));this._readyTileIfNoLabels(b,g);this.requestRender()};b.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var a=0,b=this.displayObjects;a<b.length;a++)for(var g=0,d=b[a].metrics;g<d.length;g++)this._insertIntoLabelIndex(d[g])};b.prototype._insertIntoLabelIndex=function(a){-1!==
a.xBucket&&this.labelIndex[a.yBucket][a.xBucket].push(a)};b.prototype._initLabelIndex=function(){for(var a=[],b=0;b<u.TILE_SIZE/u.COLLISION_BUCKET_SIZE;b++){a.push([]);for(var g=0;g<u.TILE_SIZE/u.COLLISION_BUCKET_SIZE;g++)a[b].push([])}return a};b.prototype._patchData=function(a){for(var b=!0,g=a.addOrUpdate&&a.addOrUpdate.tileDisplayData&&a.addOrUpdate.tileDisplayData.displayObjects||[],d=(a.remove||[]).slice(),e=0;e<g.length;e++){var n=g[e];null!=n.insertAfter&&d.push(n.id)}for(n=0;n<d.length;n++){var q=
d[n];if(e=this._data.tileDisplayData.displayObjectRegistry.get(q)){this._data.tileDisplayData.displayList.removeFromList(e.displayRecords);for(var f=0,c=e.displayRecords;f<c.length;f++)this._dispRecStore.delete(c[f]);this._data.tileDisplayData.displayObjectRegistry.delete(q);e=this._data.tileDisplayData.displayObjects.indexOf(e);this._data.tileDisplayData.displayObjects.splice(e,1)}}for(d=0;d<g.length;d++){n=g[d];e=this._data.tileDisplayData.displayObjectRegistry.get(n.id);q=void 0;if(e){f=e.displayRecords;
e.set(n);e.displayRecords=f;f=e.displayRecords.length;for(c=0;c<f;++c){var h=e.displayRecords[c],m=n.displayRecords[c];if(c>=n.displayRecords.length||h.geometryType!==m.geometryType||h.symbolLevel!==m.symbolLevel||h.zOrder!==m.zOrder||h.materialInfo.materialKey!==m.materialInfo.materialKey)this._dispRecStore.delete(e.displayRecords[c]),c<n.displayRecords.length&&(e.displayRecords[c]=void 0)}e.displayRecords.length=n.displayRecords.length;e.metrics=n.metrics}else if(e=n.copy(),e.displayRecords=[],
this._data.tileDisplayData.displayObjectRegistry.set(n.id,e),c=void 0,h=this._data.tileDisplayData.displayObjects,null!=e.insertAfter?(q={},0<=e.insertAfter?(f=this._data.tileDisplayData.displayObjectRegistry.get(e.insertAfter))?(c=h.indexOf(f)+1,c<h.length?h.splice(c,0,e):(h.push(e),c=h.length)):(h.push(e),c=h.length):(h.unshift(e),c=0)):(h.push(e),c=h.length),q){m=void 0;if(this._data.tileDisplayData.displayList.unified)m=0<n.displayRecords.length?1:0;else{v.clear();for(var m=0,l=n.displayRecords;m<
l.length;m++)f=this._data.tileDisplayData.displayList.getDPInfoType(l[m].geometryType),v.add(f);m=v.size}l=0;for(--c;0<=c&&l<m;--c)for(var r=h[c].displayRecords.length-1;0<=r&&l<m;--r){var p=h[c].displayRecords[r],f=this._data.tileDisplayData.displayList.getDPInfoType(p.geometryType);q[f]||(q[f]=p,++l)}}l=n.displayRecords.length;for(c=0;c<l;++c){m=n.displayRecords[c];(h=e.displayRecords[c])?(h.meshData=m.meshData,h.materialInfo=m.materialInfo):(h=m.copy(),h.vertexFrom=void 0,h.indexFrom=void 0,e.displayRecords[c]=
h);var r=m.geometryType,f=this._data.tileDisplayData.displayList.getDPInfoType(r),p=a.addOrUpdate.tileBufferData.geometries[r],r=p.vertexBuffer,p=p.indexBuffer,t=void 0;q&&(t=q[f]?this._data.tileDisplayData.displayList.splitAfter(q[f]):-1);b=this._dispRecStore.setMeshData(h,m,r,p,t)&&b;q&&null!=h.indexFrom&&null!=h.indexFrom&&(q[f]=h)}}return b};return b}(A.DisplayObject)});