// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Logger ../../../../../../core/screenUtils ../../color ../../definitions ../../enums ../../enums ../../LineTess ../../number ../../TileClipper ../../Utils ../../WGLDisplayRecord ./WGLMeshTemplate".split(" "),function(D,K,Q,R,L,S,M,r,T,k,C,U,N,V,W){Object.defineProperty(K,"__esModule",{value:!0});var I=R.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate"),F=k.allocTriangles(20),J=k.allocTriangles(20),G=
[k.allocExtrudeVectors(),k.allocExtrudeVectors()],O=k.allocExtrudeVectors(),H=M.TILE_SIZE+8,f=new k.Tessellator({distanceAlongCorrection:!0}),E=new U.TileClipper(0,0,0,1,8);E.setExtent(M.TILE_SIZE);D=function(D){function q(c,b,a,d,e,h,g,l,k,f,m,y){var n=D.call(this)||this;n.capType=h;n.joinType=g;n.fillColor=l;n.tl=k;n.br=f;n.hasPattern=m;n.isDashed=y;n.geometryType=r.WGLGeometryType.LINE;n.halfWidth=0<d?.5*(d+1/e):0;n._materialStore=c;n.vvFlags=b;n.materialId=n._materialStore.createSpriteMaterial(a,
n.geometryType,b);return n}Q(q,D);q.fromSimpleLine=function(c,b,a,d,e){var h=a.color,g="solid"!==a.style&&"none"!==a.style,l=N.getCapType(a.cap||"round",g),k=N.getJoinType(a.join||"round"),h=h&&"none"!==a.style&&S.premultiplyAlphaRGBA(h)||0;"none"===a.style&&(h=0);if(!d)return new q(c,b,d,L.pt2px(a.width),e,l,k,h,0,0,!1,g);var f=d.rect,m=f.x+1+d.width,y=f.y+1+d.height,f=C.i1616to32(f.x+1,f.y+1),m=C.i1616to32(m,y);return new q(c,b,d,L.pt2px(a.width),e,l,k,h,f,m,!0,g)};q.fromPictureLineSymbol=function(c,
b,a,d){I.error("PictureLineSymbol support does not exist!");return null};q.prototype.writeMesh=function(c,b,a,d,e,h,g){if(this.vvFlags&T.WGLVVFlag.COLOR||0!==this.fillColor){h=this._materialStore.get(this.materialId);var l=b.indexVector,k=b.get("geometry");b=b.get("visibility");var f=this.halfWidth,m=new V(d,this.geometryType,this.materialId),y=this._getOffset(k,h);m.vertexFrom=y;m.indexFrom=l.length;switch(a){case "esriGeometryPolyline":a=this._clipLines(e.geometry.paths);if(0===a.length)break;this._write(m,
l,k,b,y,d,f,a,h,g);c.push(m);break;case "esriGeometryPolygon":a=this._clipLines(e.geometry.rings);if(0===a.length)break;this._write(m,l,k,b,y,d,f,a,h,g);c.push(m);break;default:I.error("Unable to handle geometryType: "+a)}}};q.prototype._clipLines=function(c){for(var b=[],a=!1,d=0;d<c.length;){var e=[],h=c[d];E.reset(2);var g=h[0],l=g[0],g=g[1];if(a)E.moveTo(l,g);else{if(-8>l||l>H||-8>g||g>H){a=!0;continue}e.push({x:l,y:g})}for(var k=!1,f=h.length,m=1;m<f;++m)if(l+=h[m][0],g+=h[m][1],a)E.lineTo(l,
g);else{if(-8>l||l>H||-8>g||g>H){k=!0;break}e.push({x:l,y:g})}if(k)a=!0;else{if(a){if(e=E.resultWithStarts())for(a=0;a<e.length;a++)b.push(e[a])}else b.push({line:e,start:0});d++;a=!1}}return b};q.prototype._getOffset=function(c,b){b=b.materialKeyInfo.hasVV()?11:8;return c.length/b};q.prototype._write=function(c,b,a,d,e,h,g,l,q,r){for(var m=0,y=0;y<l.length;y++){var n=l[y],w=n.line;if(!(2>w.length))for(var p=w[0],t=w[w.length-1],B=t.x-p.x,p=t.y-p.y,B=1E-6>B*B+p*p,z=n.start%65535,n=G[1],p=0;p<w.length;p++){var x=
w[p],t=n===G[p%2]?G[(p+1)%2]:G[p%2],u=0===p,v=p===w.length-1;v&&B&&!this.hasPattern?k.copyExtrudeVectors(t,O):(this._computeExtrudeVectors(t,p,w,B),m+=this._writeVertices(a,d,h,g,x.x,x.y,t,z,m,q,r),null==t.capCenter||B&&v||this._writePieIndices(c,b,e,t),B&&u&&!this.hasPattern&&k.copyExtrudeVectors(O,t));u||this._writeBridgeIndices(c,b,e,n,t);if(!v){var v=w[p+1],u=[v.x-x.x,v.y-x.y],A=k.length(u),u=[u[0]/A,u[1]/A],A=z+A;if(65535<A){var P=(65535-z)/(A-z),z=x.x+(v.x-x.x)*P,x=x.y+(v.y-x.y)*P,v=n;f.buttCap(v,
u,u);m+=this._writeVertices(a,d,h,g,z,x,v,65535,m,q,r);f.bridge(F,t,v);this._writeBridgeIndices(c,b,e,t,v);f.buttCap(v,u,u);z=A-65535}else z=A,n=t}}}c.vertexCount=m};q.prototype._writeVertices=function(c,b,a,d,e,k,g,l,f,q,m){var h=0,n=C.i1616to32(e,k),w=g.vectors;g=w.items;for(w=w.count;h<w;++h){var p=g[h].vector,t=p[0],p=p[1],r=g[h].texCoords,z=r[0],x=r[1],u=g[h].direction,r=u[0],v=u[1],u=C.i1616to32(l,31*d),t=C.i8888to32(Math.round(31*t),Math.round(31*p),Math.round(31*z),Math.round(31*x)),p=C.i8888to32(Math.round(31*
r),Math.round(31*v),0,0);c.push(n);c.push(a);c.push(this.fillColor);c.push(t);c.push(u);c.push(this.tl);c.push(this.br);c.push(p);this._writeVV(c,m,q);b.push(255);g[h].base={index:f+h,point:[e,k]}}return h};q.prototype._writeVV=function(c,b,a){a.materialKeyInfo.hasVV()&&(c.push(b[r.VVType.SIZE]),c.push(b[r.VVType.COLOR]),c.push(b[r.VVType.OPACITY]))};q.prototype._writeBridgeIndices=function(c,b,a,d,e){f.bridge(F,d,e);for(d=0;d<F.count;++d)e=F.items[d],b.push(a+e.v1.base.index),b.push(a+e.v2.base.index),
b.push(a+e.v3.base.index),c.indexCount+=3};q.prototype._writePieIndices=function(c,b,a,d){f.pie(J,d);for(d=0;d<J.count;++d){var e=J.items[d];b.push(a+e.v1.base.index);b.push(a+e.v2.base.index);b.push(a+e.v3.base.index);c.indexCount+=3}};q.prototype._computeExtrudeVectors=function(c,b,a,d){var e=a[b],h=[void 0,void 0],g=[void 0,void 0];if(0<b&&b<a.length-1){var l=a[(b+a.length-1)%a.length],f=a[(b+1)%a.length];k.normalize(h,[e.x-l.x,e.y-l.y]);k.normalize(g,[f.x-e.x,f.y-e.y])}else if(0===b)f=a[(b+1)%
a.length],k.normalize(g,[f.x-e.x,f.y-e.y]),d?(l=a[a.length-2],k.normalize(h,[e.x-l.x,e.y-l.y])):h=g;else if(b===a.length-1)l=a[(b+a.length-1)%a.length],k.normalize(h,[e.x-l.x,e.y-l.y]),d?(l=a[1],k.normalize(g,[l.x-e.x,l.y-e.y])):g=h;else{console.error("Vertex index 'i' out of range.");return}d||0!==b?d||b!==a.length-1?this._computeJoinExtrudeVectors(c,h,g):this._computeCapExtrudeVectors(c,h,g,k.CapPosition.END):this._computeCapExtrudeVectors(c,h,g,k.CapPosition.START)};q.prototype._computeCapExtrudeVectors=
function(c,b,a,d){switch(this.capType){case r.CapType.BUTT:f.buttCap(c,b,a);break;case r.CapType.ROUND:var e=k.getNumberOfSlices(Math.PI);f.roundCap(c,b,a,d,e,d===k.CapPosition.START?-1:1);break;case r.CapType.SQUARE:this.isDashed?f.squareCapForDashedLines(c,b,a,d):f.squareCap(c,b,a,d);break;default:I.error("Encountered unknown cap type: "+this.capType+", defaulting to BUTT"),f.buttCap(c,b,a)}};q.prototype._computeJoinExtrudeVectors=function(c,b,a){var d=k.getRads(b,a);if(d>Math.PI-.05)f.rectJoin(c,
b,a);else if(this.joinType===r.JoinType.MITER||.1>d).05>d?f.fastMiterJoin(c,b,a):d<k.MITER_SAFE_RADS?f.miterJoin(c,b,a):f.bevelJoin(c,b,a,k.SYSTEM_MAG_LIMIT);else if(this.joinType===r.JoinType.BEVEL)f.bevelJoin(c,b,a,1);else if(this.joinType===r.JoinType.ROUND){var e=k.getNumberOfSlices(d);2.3>d?2>e||.5>d?f.bevelJoin(c,b,a,1):f.roundJoin(c,b,a,e):f.unitRoundJoin(c,b,a,e)}};return q}(W.default);K.default=D});