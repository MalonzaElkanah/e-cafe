// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports @dojo/framework/shim/array @dojo/framework/shim/Map ../definitions ./CollisionBucket ./LayerCollisionInfo ../util/iterator ../../../../3d/support/mathUtils".split(" "),function(w,x,z,y,p,A,r,B,q){Object.defineProperty(x,"__esModule",{value:!0});var t=p.TILE_SIZE/p.COLLISION_BUCKET_SIZE;w=function(){function c(a){this._layers=new y.default;this._collisionBuckets=new y.default;this._tilingScheme=a}Object.defineProperty(c.prototype,"collisionInfos",{get:function(){var a=[];B.forEachIter(this._layers.values(),
function(b){return a.push(b)});return a},enumerable:!0,configurable:!0});c.prototype.registerLayer=function(a,b){if(a&&!this._layers.has(a.uid)){var e=r.default.create(a,b,this.collisionInfos,this._tilingScheme);this._layers.set(a.uid,e);this._collisionBuckets.forEach(function(a){return a.onRegisterLayer(e.index)})}};c.prototype.unregisterLayer=function(a){var b=this;if(a&&this._layers.has(a.uid)){var e=this._layers.get(a.uid);r.default.delete(e.index,this.collisionInfos);this._layers.delete(a.uid);
this._collisionBuckets.forEach(function(a,f){var d=a.getTile(e.index);d&&(d.dirty=!1,a.onUnregisterLayer(e.index),a.canDelete()&&b._collisionBuckets.delete(f))})}};c.prototype.addTile=function(a,b){var e=b.key.id;this._layers.has(a)&&(this._collisionBuckets.has(e)||this._collisionBuckets.set(e,new A.default(b.key,this._layers.size)),this._collisionBuckets.get(e).getTile(this._getIndex(a)).reference=b)};c.prototype.removeTile=function(a,b){this._layers.has(a)&&this._collisionBuckets.has(b)&&(this._collisionBuckets.get(b).getTile(this._getIndex(a)).reference=
null)};c.prototype.run=function(a,b){for(var e=z.from(this._collisionBuckets.values()).filter(function(a){return a.key.level===b}).sort(function(a,b){return a.key.compareRowMajor(b.key)}),d=this._checkRotation(a.rotation),f=0;f<e.length;f++)for(var k=e[f],d=d||k.isDirty,c=0;c<this._layers.size;c++){var l=r.default.find(c,this.collisionInfos);k.computeNeighbors(this._collisionBuckets);k.reset(a,d,l)}for(a=0;a<this._layers.size;a++)for(l=r.default.find(a,this.collisionInfos),d=0,f=e;d<f.length;d++)k=
f[d],this._run(k,l,b);for(l=0;l<e.length;l++)k=e[l],k.ready()};c.prototype._run=function(a,b,e){var d=a.getReference(b.index);d&&d.isDirty&&d.hasData&&this._runVisibility(a,d,b,e)};c.prototype._runVisibility=function(a,b,e,d){for(var f=0,c=b.displayObjects;f<c.length;f++){for(var n=c[f],l=0,g=0;g<n.metrics.length;g++)var h=n.metrics[g],h=this._computeLabelVisibility(n,h,e.index,a,b,h.baseZoom,d),l=Math.max(h,l);for(var g=0,m=n.metrics;g<m.length;g++)h=m[g],b.setVisibilityRange(n.id,h.range.from,h.range.count,
l),h.minZoom=l}};c.prototype._computeLabelVisibility=function(a,b,e,d,c,k,n){for(var f=b.xBucket,g=b.yBucket,h=b.xOverflow,m=b.yOverflow,r=f-h,f=f+h+1,h=g+m+1,g=g-m;g<h;g++)for(m=r;m<f;m++)if(!(m<-t||g<-t||m>t||g>t))for(var p=0;p<=e;p++){var q=this._getRelativeSubBucket(p,d,c,m,g);if(q)for(var v=0;v<q.length;v++){var u=q[v];u.id!==a.id&&(u=this._compareLabels(b,u,k,n),k=Math.max(u,k))}}return k};c.prototype._compareLabels=function(a,b,e,d){var c=10*(d+p.COLLISION_MAX_ZOOM_DELTA);if(-1===b.minZoom||
b.minZoom>c||b.minZoom>Math.floor(10*d))return e;a=a.findCollisionDelta(b);d=q.clamp(Math.floor(10*(a+d)),0,255);return b.minZoom>=d?e:Math.max(e,d)};c.prototype._getNeighboringTile=function(a,b,e,d,c){return(b=b.neighbors[3*(1+c)+(1+d)])&&b.getTile(a)};c.prototype._getRelativeSubBucket=function(a,b,e,d,c){var f=q.sign(Math.floor(d/4)),n=q.sign(Math.floor(c/4));return(a=this._getNeighboringTile(a,b,e,f,n))&&a.reference&&a.index&&a.reference.hasData?a.index[c-4*n][d-4*f]:null};c.prototype._checkRotation=
function(a){if(!this._lastRotation)return this._lastRotation=a,!1;var b=a!==this._lastRotation;this._lastRotation=a;return b};c.prototype._getIndex=function(a){return this._layers.get(a).index};return c}();x.default=w});