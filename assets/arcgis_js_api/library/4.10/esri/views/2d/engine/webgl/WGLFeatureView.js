// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/promiseUtils ../../../../core/promiseUtils ../../../../geometry/Point ../Container ../../engine/webgl/TileData ./enums ./Utils ./WGLRendererInfo".split(" "),function(l,m,n,q,h,r,t,u,v,k,p,w){Object.defineProperty(m,"__esModule",{value:!0});l=function(g){function c(a){var b=g.call(this)||this;b._rendererInfo=new w;b._pointToCallbacks=new Map;b._highlightIDs=new Set;b._invisibleFeatures=
new Set;b._displayWidth=0;b._displayHeight=0;b._highlightOptionsUpToDate=!1;b.layer=null;b.highlightOptions=a.highlightOptions;b.tileInfoView=a.tileInfoView;b.layer=a.layer;b._layerView=a.layerView;return b}q(c,g);c.prototype.dispose=function(){this.removeAllChildren();for(var a=0,b=this.children;a<b.length;a++)b[a].dispose()};c.prototype.disposeWebGLResources=function(){for(var a=0,b=this.children;a<b.length;a++)b[a].clear()};c.prototype.displayWidth=function(){return this._displayWidth};Object.defineProperty(c.prototype,
"displayHeight",{get:function(){return this._displayHeight},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"highlightOptions",{get:function(){return this._highlightOptions},set:function(a){this._highlightOptions=a;this._highlightOptionsUpToDate=!1},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"visualVariablesInfo",{get:function(){return this._visualVariablesInfo},set:function(a){this._visualVariablesInfo=a;this.requestRender()},enumerable:!0,configurable:!0});
c.prototype.hitTest=function(a,b){var e=this,d=[a,b];return h.create(function(a,b){e._pointToCallbacks.set(d,{resolve:a,reject:b});e.requestRender()},function(){e._pointToCallbacks.has(d)&&e._pointToCallbacks.delete(d)})};c.prototype.highlight=function(a){var b=this;b.addHighlight(a);return{remove:function(){b.removeHighlight(a)}}};c.prototype.setHighlight=function(a){this._highlightIDs.clear();this.addHighlight(a)};c.prototype.setVisibility=function(a,b){a||(a=[]);b||(b=[]);for(var e=this._invisibleFeatures,
d=0,c=a;d<c.length;d++){var f=c[d];e.has(f)&&e.delete(f)}d=0;for(c=b;d<c.length;d++)e.add(c[d]);e=0;for(d=this.children;e<d.length;e++)c=d[e],c.data&&c.setVisibility(a,b)};c.prototype.addHighlight=function(a){for(var b=0;b<a.length;b++)this._highlightIDs.add(a[b]);this._buildHLList()};c.prototype.removeHighlight=function(a){for(var b=0;b<a.length;b++)this._highlightIDs.delete(a[b]);this._buildHLList()};c.prototype.whenAttached=function(){var a=this;return this.attached?h.resolve():h.create(function(b){return a.once("attached",
function(){return b()})})};c.prototype.getMaterialItems=function(a){var b=this;return this.whenAttached().then(function(){if(b.stage&&a&&0!==a.length){for(var e=[],d=b.stage.painter.textureManager,c=0;c<a.length;c++){var f=a[c];e.push(d.rasterizeItem(f.symbol,f.glyphIds))}return r.all(e).then(function(a){return a.map(function(a,b){return{id:b,mosaicItem:a}})})}})};c.prototype.onTileData=function(a,b){var e=!(!this.layer.labelingInfo||!this.layer.labelingInfo.length),c=b.addOrUpdate&&v.decode(b.addOrUpdate);
b=n({},b,{addOrUpdate:c});a.setData(b,e,this.layer.labelsVisible);a.resetVisibility(this._invisibleFeatures);a.buildHLList(this._highlightIDs);this.contains(a)||this.addChild(a);this.requestRender();this._layerView&&this._layerView.view.labelManager.requestUpdate()};c.prototype.onTileError=function(a){a.clear();a.buildHLList(this._highlightIDs);this.contains(a)||this.addChild(a);this.requestRender()};c.prototype.addChild=function(a){var b=g.prototype.addChild.call(this,a);this.layer.labelingInfo&&
this._layerView&&this._layerView.view.labelManager.addTile(this.layer.uid,a);this._buildHLList();return b};c.prototype.removeChild=function(a){var b=g.prototype.removeChild.call(this,a);this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.removeTile(this.layer.uid,a.key.id);this._buildHLList();return b};c.prototype.renderChildren=function(a){var b=this,c=this.stage.painter;this._updateTilesTransform(a.state,this.tileInfoView.getClosestInfoForScale(a.state.scale).level);this._updateHighlightOptions();
this._rendererInfo.updateVisualVariables(this._visualVariablesInfo.vvRanges,a.state);var d=this.tileInfoView.getClosestInfoForScale(a.state.scale).level,x=this.tileInfoView.tileInfo.scaleToZoom(a.state.scale),f=n({},a,{rendererInfo:this._rendererInfo,requiredLevel:d,displayLevel:x,context:this.stage.context,painter:this.stage.painter});this._rendererInfo.updateVisualVariables(this._visualVariablesInfo.vvRanges,f.state);this.sortChildren(function(a,b){return 0!==a.key.level-b.key.level?a.key.level-
b.key.level:0!==a.key.row-b.key.row?a.key.row-b.key.row:a.key.col-b.key.col});a=f.drawPhase;if(a&(k.WGLDrawPhase.LABEL|k.WGLDrawPhase.LABEL_ALPHA)){d=this.layer;if(!(d.labelsVisible&&d.labelingInfo&&0<d.labelingInfo.length))return;this._updateTilesTransform(f.state,f.requiredLevel)}c.draw(f,this.children,a,this._painterOptions);0<this._highlightIDs.size&&c.highlight(f,this.children);0!==this._pointToCallbacks.size&&(this._pointToCallbacks.forEach(function(a,c){a.resolve(b._hitTest(f,c[0],c[1]))}),
this._pointToCallbacks.clear())};c.prototype._hitTest=function(a,b,c){var d=this.stage,e=d.painter,d=d.context,f=a.requiredLevel,g=[0,0];a.state.toMap(g,[b,c]);b=a.state.clone();c=b.viewpoint.clone();c.targetGeometry=new t(g[0],g[1],a.state.spatialReference);b.viewpoint=c;b.size=[p.C_HITTEST_SEARCH_SIZE,p.C_HITTEST_SEARCH_SIZE];this._updateTilesTransform(b,f);return e.hitTest({globalOpacity:1,painter:e,context:d,drawPhase:k.WGLDrawPhase.HITTEST,pixelRatio:a.pixelRatio,displayLevel:a.displayLevel,
rendererInfo:this._rendererInfo,requiredLevel:f,state:b,stationary:a.stationary},this.children)};c.prototype._updateTilesTransform=function(a,b){b=0;for(var c=this.children;b<c.length;b++){var d=c[b],g=this.tileInfoView.tileInfo.lods[d.key.level].resolution;d.setTransform(a,g/(a.resolution*a.pixelRatio));d.setLabelTransform(a,g)}};c.prototype._updateHighlightOptions=function(){if(!this._highlightOptionsUpToDate&&this.parent){var a=this.stage.painter,b=this._highlightOptions;if(a){var c=b.color.toRgba();
c[0]/=255;c[1]/=255;c[2]/=255;var d=c.slice();c[3]*=b.fillOpacity;d[3]*=b.haloOpacity;a.setHighlightOptions({fillColor:c,outlineColor:d,outlineWidth:2,outerHaloWidth:.3,innerHaloWidth:.3,outlinePosition:0});this._highlightOptionsUpToDate=!0}}};c.prototype._buildHLList=function(){for(var a=0,b=this.children;a<b.length;a++)b[a].buildHLList(this._highlightIDs);this.requestRender()};return c}(u.Container);m.default=l});