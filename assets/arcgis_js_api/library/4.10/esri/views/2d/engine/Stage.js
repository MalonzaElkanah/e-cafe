// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/assignHelper ../../../core/promiseUtils ../../../core/scheduling ../../../core/libs/gl-matrix-2/gl-matrix ./Container ./webgl/BitBlitRenderer ./webgl/enums ./webgl/Painter ./webgl/shaders/StencilPrograms ../../support/screenshotUtils ../../webgl/BufferObject ../../webgl/context-util ../../webgl/FramebufferObject ../../webgl/programUtils ../../webgl/RenderingContext ../../webgl/VertexArrayObject".split(" "),function(v,
w,z,A,B,C,g,D,E,p,F,x,l,y,G,q,H,I,J){Object.defineProperty(w,"__esModule",{value:!0});v=function(u){function h(a,c){var b=u.call(this)||this;b._renderParameters={drawPhase:0,state:b.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1};b._renderRequested=!1;b._clipData=new Float32Array(8);b._upperLeft=g.vec2f64.create();b._upperRight=g.vec2f64.create();b._lowerLeft=g.vec2f64.create();b._lowerRight=g.vec2f64.create();b._mat2=g.mat2df64.create();b._clipRendererInitialized=!1;b._supersampleScreenshots=
!0;b.stage=b;b._stationary=!0;b.attached=!0;c=A({alpha:!0,stencil:!0,renderContext:"webgl"},c);b._canvas=document.createElement("canvas");b._canvas.setAttribute("style","width: 100%; height:100%; display:block;");a.appendChild(b._canvas);a=G.createContextOrErrorHTML(b._canvas,{alpha:c.alpha,antialias:!1,depth:!0,stencil:c.stencil},c.renderContext);b.context=new I(a);b.painter=new F.default(b.context);b._taskHandle=C.addFrameTask({render:function(){return b.renderFrame()}});b._taskHandle.pause();b._supersampleScreenshots=
c.hasOwnProperty("supersampleScreenshots")?c.supersampleScreenshots:!0;return b}z(h,u);h.prototype.destroy=function(){this.removeAllChildren();this.renderFrame();this._taskHandle.remove();this._boundFBO=this._taskHandle=null;this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null);this._labelsFBO1&&(this._labelsFBO1.dispose(),this._labelsFBO1=null);this._labelsFBO2&&(this._labelsFBO2.dispose(),this._labelsFBO2=null);this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null);this._clipVAO&&
(this._clipVAO.dispose(),this._clipVBO=this._clipVAO=null);this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null);this.painter.dispose();this.context.dispose();this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas);this._canvas=null};Object.defineProperty(h.prototype,"state",{get:function(){return this._state},set:function(a){this._state=a;this.requestRender()},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"stationary",
{get:function(){return this._stationary},set:function(a){this._stationary!==a&&(this._stationary=a,this.requestRender())},enumerable:!0,configurable:!0});h.prototype.requestRender=function(){this._renderRequested=!0;this._taskHandle&&this._taskHandle.resume()};h.prototype.renderFrame=function(){this._renderRequested&&(this._renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=
1,this.processRender(this._renderParameters));this._renderRequested||this._taskHandle.pause()};h.prototype.renderChildren=function(a){var c=this.context,b=this.children;this.beforeRenderChildren(a);a.drawPhase=p.WGLDrawPhase.MAP;for(var b=a.children?a.children:b,f=b.length,d=0;d<f;d++){var e=b[d];e.attached&&e.processRender(a)}var g=c.getBoundFramebufferObject();c.bindFramebuffer(this._labelsFBO2);d=a.stationary;c.setClearColor(0,0,0,d?0:1);c.clear(c.gl.COLOR_BUFFER_BIT);if(d)for(a.drawPhase=p.WGLDrawPhase.LABEL_ALPHA,
a.labelFBO=this._labelsFBO1,d=0;d<f;d++)e=b[d],e.attached&&e.processRender(a);c.bindFramebuffer(g);a.labelFBO=this._labelsFBO2;a.drawPhase=p.WGLDrawPhase.LABEL;for(d=0;d<f;d++)e=b[d],e.attached&&e.processRender(a);a=this._labelsFBO2;this._labelsFBO2=this._labelsFBO1;this._labelsFBO1=a;this.afterRenderChildren()};h.prototype.beforeRenderChildren=function(a){var c=this.context,b=a.state,f=a.pixelRatio;if(this.painter){c.enforceState();var d=b.size;a=b.rotation;var e=Math.round(d[0]*f),d=Math.round(d[1]*
f);this._boundFBO=c.getBoundFramebufferObject();this._labelsFBO1&&this._labelsFBO1.width===e&&this._labelsFBO1.height===d||(this._labelsFBO1&&(this._labelsFBO1.dispose(),this._labelsFBO2.dispose()),this._labelsFBO1=q.createWithAttachments(c,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:d},{colorTarget:0,depthStencilTarget:0}),c.bindFramebuffer(this._labelsFBO1),c.setDepthWriteEnabled(!0),c.setStencilWriteMask(255),c.setClearColor(0,
0,0,0),c.setClearDepth(1),c.setClearStencil(0),c.clear(c.gl.COLOR_BUFFER_BIT|c.gl.DEPTH_BUFFER_BIT|c.gl.STENCIL_BUFFER_BIT),c.setDepthWriteEnabled(!1),c.bindFramebuffer(this._boundFBO),this._labelsFBO2=q.createWithAttachments(c,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:d},{colorTarget:0,depthStencilTarget:0}));if(b.spatialReference&&(b.spatialReference._isWrappable?b.spatialReference._isWrappable():b.spatialReference.isWrappable)){var h=
g.common.toRadian(a),m=Math.abs(Math.cos(h)),k=Math.abs(Math.sin(h)),n=Math.round(b.worldScreenWidth);if(Math.round(e*m+d*k)<=n)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===e&&this._clipFBO.height===d||(this._clipFBO=new q(c,{colorTarget:0,depthStencilTarget:3,width:e,height:d}));var l=.5*e,p=.5*d,b=1/e,r=1/d,f=.5*n*f,t=.5*(e*k+d*m),e=this._upperLeft,m=this._upperRight,k=this._lowerLeft,n=this._lowerRight;g.vec2.set(e,-f,-t);g.vec2.set(m,f,-t);g.vec2.set(k,-f,t);g.vec2.set(n,f,t);
g.mat2d.identity(this._mat2);g.mat2d.translate(this._mat2,this._mat2,[l,p]);0!==a&&g.mat2d.rotate(this._mat2,this._mat2,h);g.vec2.transformMat2d(e,e,this._mat2);g.vec2.transformMat2d(m,m,this._mat2);g.vec2.transformMat2d(k,k,this._mat2);g.vec2.transformMat2d(n,n,this._mat2);a=this._clipData;a.set([2*k[0]*b-1,2*(d-k[1])*r-1,2*n[0]*b-1,2*(d-n[1])*r-1,2*e[0]*b-1,2*(d-e[1])*r-1,2*m[0]*b-1,2*(d-m[1])*r-1]);this._clipRendererInitialized||this._initializeClipRenderer(c);this._clipVBO.setData(a);this._boundFBO=
c.getBoundFramebufferObject();c.bindFramebuffer(this._clipFBO);c.setDepthWriteEnabled(!0);c.setStencilWriteMask(255);c.setClearColor(0,0,0,0);c.setClearDepth(1);c.setClearStencil(0);c.clear(c.gl.COLOR_BUFFER_BIT|c.gl.DEPTH_BUFFER_BIT|c.gl.STENCIL_BUFFER_BIT);c.setDepthWriteEnabled(!1);this._clipFrame=!0}}else this._clipFrame=!1}};h.prototype.afterRenderChildren=function(){var a=this.context;a.logIno();this._clipFrame&&this._clipRendererInitialized&&(a.bindFramebuffer(this._boundFBO),this._boundFBO=
null,a.bindVAO(this._clipVAO),a.bindProgram(this._clipStencilProgram),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!0),a.setBlendingEnabled(!1),a.setColorMask(!1,!1,!1,!1),a.setStencilOp(7680,7680,7681),a.setStencilWriteMask(255),a.setStencilFunction(519,1,255),a.drawElements(4,6,5123,0),a.bindVAO(),a.setColorMask(!0,!0,!0,!0),a.setBlendingEnabled(!0),a.setStencilFunction(514,1,255),this._blitRenderer.render(a,this._clipFBO.colorTexture,9728,1),a.setStencilTestEnabled(!1))};
h.prototype.doRender=function(a){var c=this.context,b=a.state,f=a.pixelRatio;this._resizeCanvas(a);this.context.enforceState();c.setViewport(0,0,f*b.size[0],f*b.size[1]);c.setDepthWriteEnabled(!0);c.setStencilWriteMask(255);c.setClearColor(0,0,0,0);c.setClearDepth(1);c.setClearStencil(0);c.clear(c.gl.COLOR_BUFFER_BIT|c.gl.DEPTH_BUFFER_BIT|c.gl.STENCIL_BUFFER_BIT);c.setDepthWriteEnabled(!1);u.prototype.doRender.call(this,a)};h.prototype.takeScreenshot=function(a,c){var b=l.screenshotSuperSampleSettings(a,
this._supersampleScreenshots),f=b.framebufferWidth,d=b.framebufferHeight,e=this.context,h=a.layers,g={drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:b.pixelRatio};if(null!=a.rotation){var k=g.state.viewpoint;k.rotation=a.rotation;g.state.viewpoint=k}0<h.length&&(g.children=[],h.forEach(function(a){var b=c.find(function(b){return b.layer.id===a.id});b&&b.container&&b.attached&&g.children.push(b.container)}));k=q.create(e,{colorTarget:0,depthStencilTarget:3,
width:f,height:d});h=e.getBoundFramebufferObject();e.bindFramebuffer(k);e.setViewport(0,0,f,d);f=e.gl;e.setClearColor(0,0,0,0);e.setClearDepth(1);e.setClearStencil(0);e.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT|f.STENCIL_BUFFER_BIT);this.renderChildren(g);b=this._readbackScreenshot(b);e.bindFramebuffer(h);e=this._ensureScreenshotEncodeCanvas();a=l.encodeResult(b,a,e,{flipY:!0,premultipliedAlpha:!0});return B.resolve(a)};h.prototype._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||
(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};h.prototype._readbackScreenshot=function(a){var c=a.framebufferWidth,b=a.framebufferHeight,f=a.region;a=a.resample;var d=this.context.gl;if(a){var e=l.createEmptyImageData(c,b,this._ensureScreenshotEncodeCanvas());d.readPixels(0,0,c,b,6408,5121,new Uint8Array(e.data.buffer));c=l.createEmptyImageData(f.width,f.height,this._ensureScreenshotEncodeCanvas());return l.resampleHermite(e,c,!0,a.region.x,b-
(a.region.y+a.region.height),a.region.width,a.region.height)}e=l.createEmptyImageData(f.width,f.height,this._ensureScreenshotEncodeCanvas());d.readPixels(f.x,b-(f.y+f.height),f.width,f.height,6408,5121,new Uint8Array(e.data.buffer));return e};h.prototype._resizeCanvas=function(a){var c=this._canvas,b=c.style,f=a.state.size,d=a.pixelRatio;a=f[0];var f=f[1],e=Math.round(a*d),d=Math.round(f*d);if(c.width!==e||c.height!==d)c.width=e,c.height=d;b.width=a+"px";b.height=f+"px"};h.prototype._initializeClipRenderer=
function(a){if(this._clipRendererInitialized)return!0;this._blitRenderer=new E;var c=x.stencil.attributes,b=H.createProgram(a,x.stencil);if(!b)return!1;var f=y.createVertex(a,35040,32),d=new Uint16Array([0,1,2,2,1,3]),d=y.createIndex(a,35044,d);a=new J(a,c,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:f},d);this._clipStencilProgram=b;this._clipVBO=f;this._clipVAO=a;return this._clipRendererInitialized=!0};return h}(D.Container);w.Stage=v});