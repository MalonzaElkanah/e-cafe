// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/scheduling"],function(h,l,m){Object.defineProperty(l,"__esModule",{value:!0});h=function(){function d(a){var c=this;this.view=a;this._frameTaskHandle=null;this.updateEnabled=this.stationary=!0;this.prepare=function(){c._updateParameters.state=c.view.state;c._updateParameters.stationary=c.view.stationary;c._updateParameters.pixelRatio=window.devicePixelRatio};this.update=function(){if(c.updateEnabled){for(var b=c.view,a=b.labelManager,e=c.graphicsView,d=b.allLayerViews.toArray().filter(function(a){return a.isFulfilled()&&
null==a.layerViews}),f=d.length,g=b.state,k=0;k<d.length;k++)if(b=d[k],b.attached){var h=b.lastUpdateId;if(null==h||!c.stationary&&!b.moving)b.moving=!0,b.moveStart();h!==g.id&&b.viewChange();c.stationary&&b.moving&&(b.moving=!1,b.moveEnd());b.lastUpdateId=g.id}a&&a.lastUpdateId!==g.id&&(a.viewChange(),a.lastUpdateId=g.id);e&&e.lastUpdateId!==g.id&&(e.viewChange(),e.lastUpdateId=g.id);a=c._layerViewsTrash;for(e=0;e<a.length;e++)b=a[e],c._detachLayerView(b);for(e=a.length=0;e<f;e++)b=d[e],b.isFulfilled()&&
!b.attached&&c._attachLayerView(b);d=c._updateParameters;f=c._layerViewsToUpdate;b=f.slice();e=f.length=0;for(g=b;e<g.length;e++)b=g[e],!("attached"in b)||"attached"in b&&b.attached?b.processUpdate(d):f.push(b);f=c._updatablesToUpdate;b=f.slice();for(f=f.length=0;f<b.length;f++)b[f].processUpdate(d);0===c._layerViewsToUpdate.length&&0===c._updatablesToUpdate.length&&0===a.length&&c._frameTaskHandle.pause()}}}d.prototype.destroy=function(){this.stop()};d.prototype.start=function(){var a=this;this._updateParameters=
{state:this.view.state,pixelRatio:window.devicePixelRatio,stationary:!0};this._layerViewsTrash=[];this._layerViewsToUpdate=[];this._updatablesToUpdate=[];this._allLayerViewsChangeHandle=this.view.allLayerViews.on("change",function(c){Array.prototype.push.apply(a._layerViewsTrash,c.removed);a.requestFrame()});this._stationaryHandle=this.view.watch("stationary",function(c){a.stationary=c;a.requestFrame()});this._frameTaskHandle=m.addFrameTask(this)};d.prototype.stop=function(){var a=this;this._frameTaskHandle&&
(this.view.allLayerViews.forEach(function(c){return a._detachLayerView(c)}),this._stationaryHandle.remove(),this._allLayerViewsChangeHandle.remove(),this._frameTaskHandle.remove(),this._updateParameters=this._stationaryHandle=this._allLayerViewsChangeHandle=this._frameTaskHandle=this._layerViewsTrash=this._layerViewsToUpdate=null,this.stationary=!0)};d.prototype.requestLayerViewUpdate=function(a){this._layerViewsToUpdate.push(a);this.requestFrame()};d.prototype.requestUpdate=function(a){this._updatablesToUpdate.push(a);
this.requestFrame()};d.prototype.requestFrame=function(){this._frameTaskHandle&&this._frameTaskHandle.resume()};d.prototype._attachLayerView=function(a){a.attached||(a.attached=!0,a.attach(),this._updateParameters.stationary?a.moving=!1:(a.moving=!0,a.moveStart()))};d.prototype._detachLayerView=function(a){a.attached&&(a.detach(),a.attached=!1,a.moving=!1)};return d}();l.default=h});