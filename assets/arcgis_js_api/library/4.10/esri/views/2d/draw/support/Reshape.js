// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../geometry ../../../../Graphic ../../../../core/Accessor ../../../../core/Evented ../../../../core/Handles ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/coordsUtils ../../../../symbols/SimpleMarkerSymbol ./drawUtils ./GraphicMover".split(" "),function(O,P,x,n,r,p,y,z,w,t,h,v,u,A,B){var C=function(){return function(d,b,a){this.graphic=
d;this.mover=b;this.selected=a;this.type="reshape-start"}}(),D=function(){return function(d,b,a){this.graphic=d;this.mover=b;this.selected=a;this.type="reshape"}}(),E=function(){return function(d,b,a){this.graphic=d;this.mover=b;this.selected=a;this.type="reshape-stop"}}(),F=function(){return function(d,b,a){this.mover=d;this.dx=b;this.dy=a;this.type="move-start"}}(),G=function(){return function(d,b,a){this.mover=d;this.dx=b;this.dy=a;this.type="move"}}(),H=function(){return function(d,b,a){this.mover=
d;this.dx=b;this.dy=a;this.type="move-stop"}}(),I=function(){return function(d){this.added=d;this.type="vertex-select"}}(),J=function(){return function(d){this.removed=d;this.type="vertex-deselect"}}(),K=function(){return function(d,b,a){this.added=d;this.graphic=b;this.oldGraphic=a;this.type="vertex-add"}}(),L=function(){return function(d,b,a){this.removed=d;this.graphic=b;this.oldGraphic=a;this.type="vertex-remove"}}(),M=["Backspace","Delete"];return function(d){function b(a){a=d.call(this,a)||
this;a._handles=new w;a._mover=null;a._viewHandles=new w;a._totalDx=0;a._totalDy=0;a.callbacks={onReshapeStart:function(a){},onReshape:function(a){},onReshapeStop:function(a){},onMoveStart:function(a){},onMove:function(a){},onMoveStop:function(a){}};a.graphic=null;a.handleGraphics=[];a.handleHoverSymbol=new u({style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}});a.handleSelectionSymbol=new u({style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}});a.handleSymbol=
new u({style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}});a.layer=null;a.midpointGraphics=[];a.midpointSymbol=new u({style:"circle",size:6,color:[200,200,200],outline:{color:[100,100,100],width:1}});a.enableMidpoints=!0;a.selectedHandles=[];a.view=null;return a}x(b,d);b.prototype.initialize=function(){var a=this;this._setup();this._handles.add([t.whenOnce(this,"view.ready",function(){a.view&&a.view.map&&a.view.map.add(a.layer);a._viewHandles.add([a.view.on("key-down",function(c){return a._keyDownHandler(c)})])}),
t.pausable(this,"graphic",function(){return a.refresh()}),t.pausable(this,"layer",function(c,b){b&&(a._clearSelection(),a._resetGraphics(b));a.refresh()}),t.pausable(this,"enableMidpoints",function(){a.refresh()})])};b.prototype.destroy=function(){this._reset();this._mover&&this._mover.destroy();this._mover=null;this._handles.removeAll();this._handles=null;this._viewHandles.removeAll();this._viewHandles=null};Object.defineProperty(b.prototype,"state",{get:function(){var a=!!this.get("view.ready"),
c=!(!this.get("graphic")||!this.get("layer"));return a&&c?"active":a?"ready":"disabled"},enumerable:!0,configurable:!0});b.prototype.isUIGraphic=function(a){var c=[];this.graphic&&c.push(this.graphic);c.concat(this.handleGraphics,this.midpointGraphics);return c.length&&-1<c.indexOf(a)};b.prototype.refresh=function(){this._reset();this._setup()};b.prototype.reset=function(){this.graphic=null};b.prototype.clearSelection=function(){this._clearSelection()};b.prototype.removeSelectedHandles=function(){this.selectedHandles.length&&
this._removeVertex(this.selectedHandles)};b.prototype._setup=function(){this.graphic&&this.layer&&(this._setupGraphics(),this._setupMover())};b.prototype._reset=function(){this._clearSelection();this._resetGraphicStateVars();this._resetGraphics();this._mover&&this._mover.destroy();this._mover=null;this.view.container.style.cursor="default"};b.prototype._resetGraphicStateVars=function(){this._totalDy=this._totalDx=0};b.prototype._resetGraphics=function(a){if(a=a||this.layer)a.removeMany(this.handleGraphics),
a.removeMany(this.midpointGraphics);this.handleGraphics.forEach(function(a){return a.destroy()});this.midpointGraphics.forEach(function(a){return a.destroy()});this._set("handleGraphics",[]);this._set("midpointGraphics",[]);this._set("selectedHandles",[])};b.prototype._setupGraphics=function(){var a=this.graphic.geometry,c=v.geometryToCoordinates(a.clone());if("polygon"===a.type)for(a=0;a<c.length;a++){var b=c[a],l=b[b.length-1];b[0][0]===l[0]&&b[0][1]===l[1]&&2<b.length&&b.pop()}this._set("handleGraphics",
this._createHandleGraphics(c));this.enableMidpoints&&this._set("midpointGraphics",this._createMidpointGraphics(c));this._saveRelatedIndices(this.handleGraphics);this.layer.addMany(this.midpointGraphics);this.layer.addMany(this.handleGraphics)};b.prototype._createHandleGraphics=function(a){for(var c=[],b=0;b<a.length;b++)for(var l=a[b],f=a.indexOf(l),g=0,e=l;g<e.length;g++){var k=e[g],q=l.indexOf(k);c.push(new p({geometry:new r.Point({x:k[0],y:k[1],spatialReference:this.view.spatialReference}),symbol:this.handleSymbol,
attributes:{pathIndex:f,pointIndex:q}}))}return c};b.prototype._createMidpointGraphics=function(a){for(var c=[],b=0;b<a.length;b++)for(var l=a[b],f=a.indexOf(l),g=0,e=l;g<e.length;g++){var k=e[g],q=l.indexOf(k),m=k[0],d=k[1],k=l[q+1]?q+1:0;if("polyline"!==this.graphic.geometry.type||0!==k){var h=l[k],m=v.getMidpoint([m,d],[h[0],h[1]]);c.push(new p({geometry:new r.Point({x:m[0],y:m[1],spatialReference:this.view.spatialReference}),symbol:this.midpointSymbol,attributes:{pathIndex:f,pointIndexStart:q,
pointIndexEnd:k}}))}}return c};b.prototype._saveRelatedIndices=function(a){for(var c=0;c<a.length;c++){for(var b=a[c],l=a.indexOf(b),f=[],g=b.geometry,e=g.x,g=g.y,k=0,q=a;k<q.length;k++){var m=q[k],d=a.indexOf(m);if(l!==d){var m=m.geometry,h=m.y;e===m.x&&g===h&&f.push(d)}}b.attributes.relatedGraphicIndices=f}};b.prototype._setupMover=function(){var a=this;this._mover=new B({enableMoveAllGraphics:!1,graphics:[].concat(this.handleGraphics,this.graphic,this.midpointGraphics),view:this.view,callbacks:{onGraphicClick:function(c){return a._onGraphicClickCallback(c)},
onGraphicMoveStart:function(c){return a._onGraphicMoveStartCallback(c)},onGraphicMove:function(c){return a._onGraphicMoveCallback(c)},onGraphicMoveStop:function(c){return a._onGraphicMoveStopCallback(c)},onGraphicPointerOver:function(c){return a._onGraphicPointerOverCallback(c)},onGraphicPointerOut:function(c){return a._onGraphicPointerOutCallback(c)}}})};b.prototype._onGraphicClickCallback=function(a){var c=a.graphic;c===this.graphic?this.clearSelection():-1<this.midpointGraphics.indexOf(c)?(a.viewEvent.stopPropagation(),
2!==a.viewEvent.button&&(a=this.graphic.clone(),this._createHandleFromMidpoint(c),this.refresh(),this._emitVertexAddEvent([c],a))):-1<this.handleGraphics.indexOf(c)&&(a.viewEvent.stopPropagation(),2===a.viewEvent.button?this._removeVertex(c):(a.viewEvent.native.ctrlKey||this._clearSelection(),-1===this.selectedHandles.indexOf(c)?this._addToSelection(c):this._removeFromSelection(c,!0)))};b.prototype._onGraphicMoveStartCallback=function(a){var c=a.graphic;this._resetGraphicStateVars();c===this.graphic?
(c=a.dx,a=a.dy,this.handleGraphics.forEach(function(a){return a.visible=!1}),this.midpointGraphics.forEach(function(a){return a.visible=!1}),this._clearSelection(),this._emitMoveStartEvent(c,a)):(-1<this.midpointGraphics.indexOf(c)?(this._clearSelection(),this._createHandleFromMidpoint(c),this._addToSelection(c)):-1===this.selectedHandles.indexOf(c)&&(this._clearSelection(),this._addToSelection(c)),this._emitReshapeStartEvent(c))};b.prototype._onGraphicMoveCallback=function(a){var c=a.graphic,b=a.dx;
a=a.dy;this._totalDx+=b;this._totalDy+=a;c===this.graphic?this._emitMoveEvent(b,a):(this._syncGeometryAfterHandleMove(c,b,a),this._emitReshapeEvent(c))};b.prototype._onGraphicMoveStopCallback=function(a){var c=a.graphic,b=a.dx;a=a.dy;this._totalDx+=b;this._totalDy+=a;if(c===this.graphic){c=0;for(b=[].concat(this.handleGraphics,this.midpointGraphics);c<b.length;c++)b[c].visible=!0;this._syncGraphicsWithGeometry();this._emitMoveStopEvent()}else this._syncGeometryAfterHandleMove(c,b,a),-1<this.midpointGraphics.indexOf(c)&&
this.refresh(),this._emitReshapeStopEvent(c);this._resetGraphicStateVars()};b.prototype._syncGraphicsWithGeometry=function(){var a=this.graphic.geometry,a="polyline"===a.type?a.paths:a.rings;this._updateHandleGraphicLocations(a);this._updateMidpointGraphicLocations(a)};b.prototype._updateHandleGraphicLocations=function(a){for(var c=0,b=this.handleGraphics;c<b.length;c++){var l=b[c],f=l.attributes,f=a[f.pathIndex][f.pointIndex];l.set("geometry",new r.Point(f[0],f[1],this.view.spatialReference))}};
b.prototype._updateMidpointGraphicLocations=function(a){for(var c=0,b=this.midpointGraphics;c<b.length;c++){var l=b[c],f=l.attributes,g=f.pathIndex,e=a[g][f.pointIndexStart],f=a[g][f.pointIndexEnd],e=v.getMidpoint([e[0],e[1]],[f[0],f[1]]);l.geometry=new r.Point({x:e[0],y:e[1],spatialReference:this.view.spatialReference})}};b.prototype._syncGeometryAfterHandleMove=function(a,b,N){var c=this.graphic.geometry.clone(),f="polyline"===c.type?c.paths:c.rings,g=a.attributes,e=g.pathIndex,k=g.pointIndex,d=
a.geometry,g=d.x,d=d.y,m=f[e].length-1;f[e][k]=[g,d];"polygon"===c.type&&(0===k?f[e][m]=[g,d]:k===m&&(f[e][0]=[g,d]));if(-1<this.handleGraphics.indexOf(a)){e=0;for(m=a.attributes.relatedGraphicIndices;e<m.length;e++){var k=m[e],k=this.handleGraphics[k],h=k.attributes;f[h.pathIndex][h.pointIndex]=[g,d];k.geometry=a.geometry}g=0;for(d=this.selectedHandles;g<d.length;g++)if(k=d[g],k!==a){var e=k.attributes,m=e.pathIndex,h=e.pointIndex,n=e.relatedGraphicIndices,e=A.move(k.geometry,b,N,this.view),p=f[m].length-
1;f[m][h]=[e.x,e.y];k.geometry=e;"polygon"===c.type&&(0===h?f[m][p]=[e.x,e.y]:h===p&&(f[m][0]=[e.x,e.y]));m=0;for(h=n;m<h.length;m++)k=h[m],k=this.handleGraphics[k],n=k.attributes,f[n.pathIndex][n.pointIndex]=[e.x,e.y],k.geometry=e}this._updateMidpointGraphicLocations(f)}this.graphic.geometry=c};b.prototype._onGraphicPointerOverCallback=function(a){a=a.graphic;-1<this.handleGraphics.indexOf(a)&&-1===this.selectedHandles.indexOf(a)&&(a.symbol=this.handleHoverSymbol);"pointer"!==this.view.container.style.cursor&&
(this.view.container.style.cursor="pointer")};b.prototype._onGraphicPointerOutCallback=function(a){a=a.graphic;-1<this.handleGraphics.indexOf(a)&&-1===this.selectedHandles.indexOf(a)&&(a.symbol=this.handleSymbol);"default"!==this.view.container.style.cursor&&(this.view.container.style.cursor="default")};b.prototype._createHandleFromMidpoint=function(a){var c=this.graphic.geometry.clone(),b=a.attributes,d=b.pathIndex,f=b.pointIndexStart,g=b.pointIndexEnd,b=a.geometry,f=0===g?f+1:g;("polyline"===c.type?
c.paths:c.rings)[d].splice(f,0,[b.x,b.y]);a.attributes={pathIndex:d,pointIndex:f,relatedGraphicIndices:[]};this.graphic.geometry=c};b.prototype._removeHandles=function(a){var b=this.graphic.geometry.clone(),d="polygon"===b.type?b.rings:b.paths;a instanceof p&&(a=[a]);for(var l=0,f=a;l<f.length;l++){var g=f[l].geometry;a=g.x;var g=g.y,e;for(e in d){var k=d[e],h;for(h in k){var m=k[h],n=m[1];a===m[0]&&g===n&&d[e].splice(Number(h),1)}}}if("polygon"===b.type)for(l=0;l<d.length;l++)e=d[l],g=e[0],a=g[0],
g=g[1],f=e[e.length-1],h=f[0],f=f[1],(1===e.length||3>e.length&&a===h&&g===f)&&d.splice(d.indexOf(e),1),2<e.length&&(a!==h||g!==f)&&e.push(e[0]);else for(a=0;a<d.length;a++)g=d[a],1===g.length&&d.splice(d.indexOf(g),1);this.graphic.geometry=b};b.prototype._addToSelection=function(a){a instanceof p&&(a=[a]);for(var b=0,d=a;b<d.length;b++)d[b].symbol=this.handleSelectionSymbol;this._set("selectedHandles",this.selectedHandles.concat(a));this._emitSelectEvent(a)};b.prototype._removeFromSelection=function(a,
b){b=b?this.handleHoverSymbol:this.handleSymbol;a instanceof p&&(a=[a]);for(var c=0,d=a;c<d.length;c++){var f=d[c];this.selectedHandles.splice(this.selectedHandles.indexOf(f),1);f.symbol=b}this._emitDeselectEvent(a)};b.prototype._clearSelection=function(){if(this.selectedHandles.length){for(var a=this.selectedHandles,b=0,d=this.selectedHandles;b<d.length;b++){var h=d[b];h&&(h.symbol=this.handleSymbol)}this._set("selectedHandles",[]);this._emitDeselectEvent(a)}};b.prototype._keyDownHandler=function(a){-1<
M.indexOf(a.key)&&!a.repeat&&this.selectedHandles.length&&this._removeVertex(this.selectedHandles)};b.prototype._removeVertex=function(a){if(!("polygon"===this.graphic.geometry.type&&4>this.handleGraphics.length||3>this.handleGraphics.length)){var b=this.graphic.clone();a instanceof p&&(a=[a]);this._removeHandles(a);this.refresh();this._emitVertexRemoveEvent(a,b)}};b.prototype._emitMoveStartEvent=function(a,b){a=new F(this.graphic,a,b);this.emit("move-start",a);if(this.callbacks.onMoveStart)this.callbacks.onMoveStart(a)};
b.prototype._emitMoveEvent=function(a,b){a=new G(this.graphic,a,b);this.emit("move",a);if(this.callbacks.onMove)this.callbacks.onMove(a)};b.prototype._emitMoveStopEvent=function(){var a=new H(this.graphic,this._totalDx,this._totalDy);this.emit("move-stop",a);if(this.callbacks.onMoveStop)this.callbacks.onMoveStop(a)};b.prototype._emitReshapeStartEvent=function(a){a=new C(this.graphic,a,this.selectedHandles);this.emit("reshape-start",a);if(this.callbacks.onReshapeStart)this.callbacks.onReshapeStart(a)};
b.prototype._emitReshapeEvent=function(a){a=new D(this.graphic,a,this.selectedHandles);this.emit("reshape",a);if(this.callbacks.onReshape)this.callbacks.onReshape(a)};b.prototype._emitReshapeStopEvent=function(a){a=new E(this.graphic,a,this.selectedHandles);this.emit("reshape-stop",a);if(this.callbacks.onReshapeStop)this.callbacks.onReshapeStop(a)};b.prototype._emitSelectEvent=function(a){a=new I(a);this.emit("select",a);if(this.callbacks.onVertexSelect)this.callbacks.onVertexSelect(a)};b.prototype._emitDeselectEvent=
function(a){a=new J(a);this.emit("deselect",a);if(this.callbacks.onVertexDeselect)this.callbacks.onVertexDeselect(a)};b.prototype._emitVertexAddEvent=function(a,b){a=new K(a,this.graphic,b);this.emit("vertex-add",a);if(this.callbacks.onVertexAdd)this.callbacks.onVertexAdd(a)};b.prototype._emitVertexRemoveEvent=function(a,b){a=new L(a,this.graphic,b);this.emit("vertex-remove",a);if(this.callbacks.onVertexRemove)this.callbacks.onVertexRemove(a)};n([h.property()],b.prototype,"callbacks",void 0);n([h.property()],
b.prototype,"graphic",void 0);n([h.property({readOnly:!0})],b.prototype,"handleGraphics",void 0);n([h.property()],b.prototype,"handleHoverSymbol",void 0);n([h.property()],b.prototype,"handleSelectionSymbol",void 0);n([h.property()],b.prototype,"handleSymbol",void 0);n([h.property()],b.prototype,"layer",void 0);n([h.property({readOnly:!0})],b.prototype,"midpointGraphics",void 0);n([h.property()],b.prototype,"midpointSymbol",void 0);n([h.property()],b.prototype,"enableMidpoints",void 0);n([h.property({readOnly:!0})],
b.prototype,"selectedHandles",void 0);n([h.property({dependsOn:["view.ready","graphic","layer"],readOnly:!0})],b.prototype,"state",null);n([h.property()],b.prototype,"view",void 0);return b=n([h.subclass("esri.views.2d.draw.support.Reshape")],b)}(h.declared(y,z))});