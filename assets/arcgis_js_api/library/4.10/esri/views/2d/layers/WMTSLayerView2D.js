// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Handles ../../../core/accessorSupport/decorators ../../../geometry/support/webMercatorUtils ../engine/BitmapContainer ./LayerView2D ./support/BitmapTile ../tiling/TileInfoView ../tiling/TileQueue ../tiling/TileStrategy ../../layers/RefreshableLayerView".split(" "),function(x,y,k,f,l,e,m,n,p,q,r,t,u,v){var w=[102113,102100,3857,3785,900913];return function(g){function a(){var b=
null!==g&&g.apply(this,arguments)||this;b._handles=new l;b._tileStrategy=null;b._tileInfoView=null;b._fetchQueue=null;b._tileRequests=new Map;b.container=new n.BitmapContainer;b.layer=null;return b}k(a,g);Object.defineProperty(a.prototype,"tileMatrixSet",{get:function(){if(this.layer.activeLayer.tileMatrixSetId)return this.layer.activeLayer.tileMatrixSet;var b=this._getTileMatrixSetBySpatialReference(this.layer.activeLayer);if(!b)return null;this.layer.activeLayer.tileMatrixSetId=b.id;return b},enumerable:!0,
configurable:!0});a.prototype.hitTest=function(b,d){return null};a.prototype.update=function(b){this._fetchQueue.pause();this._fetchQueue.state=b.state;this._tileStrategy.update(b);this._fetchQueue.resume();this.notifyChange("updating")};a.prototype.attach=function(){var b=this,d=this.layer.activeLayer,a=this.tileMatrixSet;if(a){var h=a.tileInfo.spatialReference,d=d.fullExtent&&d.fullExtent.clone();h.isWebMercator?d=m.geographicToWebMercator(d):h.isWGS84||(d=a.fullExtent);this._tileInfoView=new r(a.tileInfo,
d);this._fetchQueue=new t({tileInfoView:this._tileInfoView,process:function(a){return b.fetchTile(a)}});this._tileStrategy=new u({cachePolicy:"keep",acquireTile:function(a){return b.acquireTile(a)},releaseTile:function(a){return b.releaseTile(a)},tileInfoView:this._tileInfoView});this._handles.add(this.watch("layer.activeLayer.styleId, tileMatrixSet",function(){return b._refresh()}))}};a.prototype.detach=function(){this._handles.removeAll();this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeAllChildren();
this._fetchQueue=this._tileStrategy=this._tileInfoView=this.container=null};a.prototype.moveStart=function(){this.requestUpdate()};a.prototype.viewChange=function(){this.requestUpdate()};a.prototype.moveEnd=function(){this.requestUpdate()};a.prototype.doRefresh=function(){this.updateRequested||this.suspended||this._refresh()};a.prototype.isUpdating=function(){var b=!0;this._tileRequests.forEach(function(a){b=b&&a.isFulfilled()});return!b};a.prototype.acquireTile=function(b){var a=this,c=q.default.pool.acquire();
c.key.set(b);c.resolution=this._tileInfoView.getTileResolution(c.key);this._tileInfoView.getTileCoords(c,c.key);b=this._fetchQueue.push(c.key).then(function(b){c.source=b;c.once("attach",function(){return a.requestUpdate()});a.container.addChild(c)});this._tileRequests.set(c,b);this.requestUpdate();return c};a.prototype.releaseTile=function(b){var a=this._tileRequests.get(b);a.isFulfilled()||a.cancel();this._tileRequests.delete(b);this.container.removeChild(b);this.requestUpdate()};a.prototype.fetchTile=
function(b){return this.layer.fetchTile(b.level,b.row,b.col)};a.prototype.canResume=function(){var b=this.inherited(arguments);return b?null!==this.tileMatrixSet:b};a.prototype._refresh=function(){var b=this;this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(a){if(a.source){a.source=null;var c=b._fetchQueue.push(a.key).then(function(c){a.source=c;a.requestRender();b.notifyChange("updating")});b._tileRequests.set(a,c)}});this.notifyChange("updating")};a.prototype._getTileMatrixSetBySpatialReference=
function(b){var a=this.view.spatialReference,c=b.tileMatrixSets.find(function(b){return b.tileInfo.spatialReference.wkid===a.wkid});!c&&a.isWebMercator&&(c=b.tileMatrixSets.find(function(a){return-1<w.indexOf(a.tileInfo.spatialReference.wkid)}));return c};f([e.property({dependsOn:["tileMatrixSet"]})],a.prototype,"suspended",void 0);f([e.property({readOnly:!0,dependsOn:["view.spatialReference","layer.activeLayer"]})],a.prototype,"tileMatrixSet",null);f([e.property({dependsOn:["updateRequested","attached"]})],
a.prototype,"updating",void 0);return a=f([e.subclass("esri.views.2d.layers.WMTSLayerView2D")],a)}(e.declared(p,v))});