// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../geometry ../../../../../core/Error ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../core/workers ../../../../../core/accessorSupport/decorators ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/support/FeatureProcessing ../../../../../tasks/support/QuantizationParameters ../../../../../tasks/support/Query ../../../engine/webgl/Utils ./BaseController ../support/TileUpdateQueue".split(" "),
function(n,p,v,l,q,r,w,x,t,y,g,u,z,A,B,C,D,E){Object.defineProperty(p,"__esModule",{value:!0});var F=x.getLogger("esri.views.2d.layers.features.controllers.MemoryController");n=function(m){function b(){var a=null!==m&&m.apply(this,arguments)||this;a.type="memory";a._processingInMainThread=!1;return a}v(b,m);b.prototype.initialize=function(){var a=this;this._tileQueue=new E.default({tileInfoView:this.tileStore.tileScheme,process:function(c,h){return a._fetchFeatureSet(c,h)}});this._memorySource=y.open(this.service.source,
{client:this});this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))};b.prototype.destroy=function(){this._tileQueue.clear();this._tileQueue.pause()};Object.defineProperty(b.prototype,"processing",{get:function(){return z.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return this._tileQueue.updating},enumerable:!0,configurable:!0});b.prototype.onEdits=function(a){this.refresh()};b.prototype.queryFeatures=
function(a){return this._memorySource.invoke("queryFeatures",a)};b.prototype.queryFeatureCount=function(a){return this._memorySource.invoke("queryFeatureCount",a)};b.prototype.queryObjectIds=function(a){return this._memorySource.invoke("queryObjectIds",a)};b.prototype.queryExtent=function(a){return this._memorySource.invoke("queryExtent",a)};b.prototype.redraw=function(){this.refresh()};b.prototype.refresh=function(){this._tileQueue.refresh();for(var a=0,c=this.tileStore.tiles;a<c.length;a++){var h=
c[a];this._tileQueue.push(h.id,h.updateTimestamp)}};b.prototype.setViewState=function(a){this._tileQueue.state=a};b.prototype.onTileUpdate=function(a){this._tileQueue.pause();for(var c=0,h=a.removed;c<h.length;c++){var d=h[c];this._tileQueue.cancel(d.id)}c=0;for(a=a.added;c<a.length;c++)d=a[c],this._tileQueue.push(d.id,d.updateTimestamp);this.processor&&this._tileQueue.resume()};b.prototype._switchProcessor=function(a,c){this.refresh();a&&this._tileQueue.resume()};b.prototype._fetchFeatureSet=function(a,
c){var h=this,d=this.tileStore.get(a),b=this.processor.queryInfo;return this._query(d,b).then(function(a){return h._wrapPoints(a,b)}).then(function(a){return h._sortFeatures(a,b)}).then(function(a){return a.features.length?a:null}).then(function(a){d.updateTimestamp=c;return h.processor.onTileData(d,{addOrUpdate:a&&a.features,clear:!0,transformParams:a&&C.getTransformParams(a)})}).catch(function(a){d.updateTimestamp=c;"cancel"!==a.dojoType&&(h.processor.onTileError(d,a.message),F.error("query-error",
{error:a}));return t.reject(a)})};b.prototype._query=function(a,c){var b=this,d=new B,f=this._getQuantizationParameters(a),k=c.pixelBuffer*a.resolution;a=a.bounds.slice();a[0]-=k;a[1]-=k;a[2]+=k;a[3]+=k;d.outFields=this.processor.queryInfo.outFields;d.where=this.processor.queryInfo.definitionExpression||"1\x3d1";d.geometry=new r.Extent({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:this.spatialReference});this.service.capabilities.query.supportsQuantization?(d.quantizationParameters=f,
"esriGeometryPolyline"===this.service.geometryType&&(d.maxAllowableOffset=f.tolerance)):d.maxAllowableOffset=f.tolerance;d.resultType="tile";d.returnExceededLimitFeatures=!1;d.returnGeometry=!0;d.returnCentroid=c.returnCentroid;d.orderByFields=c.orderByFields;return this.queryFeatures(d.toJSON()).then(function(a){return b._applyProcessing(a)})};b.prototype._applyProcessing=function(a){var c=this.processing;if(!c)return a;if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",
{featureSet:a});try{var b=c.process(a,c.options);return b?b:t.reject(new w("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(d){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:a})}};b.prototype._getQuantizationParameters=function(a){return new A.default({mode:"view",originPosition:"lower-left",tolerance:a.resolution,extent:new r.Extent({xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference})})};
b.prototype._wrapPoints=function(a,c){if(0===a.features.length)return a;var b=c.returnCentroid;c=c.pixelBuffer;var d=a.geometryType,f=a.spatialReference,k=a.transform;if("esriGeometryPoint"!==d&&"esriGeometryMultipoint"!==d&&!b||!u.isWrappable(f))return a;b=a.features;f=u.getInfo(f);k=Math.round((f.valid[1]-f.valid[0])/k.scale[0]);if(512===k){f=[];for(d=0;d<b.length;d++){var g=b[d],e=g.geometry,g=g.attributes;e&&(e.x<c?(e={geometry:q({},e),attributes:g},e.geometry.x+=k,f.push(e)):e.x>512-c&&(e={geometry:q({},
e),attributes:g},e.geometry.x-=k,f.push(e)))}b.push.apply(b,f)}else for(f=0;f<b.length;f++)if(e=b[f].geometry)e.x<-c?e.x+=k:e.x>512+c&&(e.x-=k);return a};b.prototype._sortFeatures=function(a,b){if(b=b.orderByFields){b=b[0].split(" ");var c=b[0];"DESC"===b[1]&&a.features.sort(function(a,b){return b.attributes[c]-a.attributes[c]})}return a};l([g.property()],b.prototype,"_tileQueue",void 0);l([g.property()],b.prototype,"configuration",void 0);l([g.property({readOnly:!0,dependsOn:["configuration"]})],
b.prototype,"processing",null);l([g.property({dependsOn:["_tileQueue.updating"]})],b.prototype,"updating",null);return b=l([g.subclass()],b)}(g.declared(D.default));p.default=n});