// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../Graphic ../../../../core/Collection ../../../../core/HandleOwner ../../../../core/Identifiable ../../../../core/MapPool ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Point ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/jsonUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/graphics/data/projectionSupport ../../engine/webgl/GraphicContainer ../../engine/webgl/TileData ../../engine/webgl/WGLTile ../../engine/webgl/mesh/factories/matcherUtils ../../engine/webgl/mesh/factories/MaterialStore ../../engine/webgl/mesh/factories/WGLMeshFactory ../../engine/webgl/mesh/templates/WGLTemplateStore ../features/support/TileStore ../graphics/GraphicProcessingQueue ../graphics/GraphicStore ../graphics/graphicsUtils ../../../layers/GraphicsView".split(" "),
function(p,u,B,n,C,D,E,F,v,h,k,G,H,l,q,w,x,I,J,K,y,L,M,N,O,P,Q,z,R){Object.defineProperty(u,"__esModule",{value:!0});var A=new G,r=new Set,t=[];p=function(p){function d(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];a=p.apply(this,a)||this;a._hiddenGraphics=[];a._tiles=new Map;a._graphicStoreUpdate=!1;a._highlightIDs=new Set;a._graphicsSet=new Set;a._matcher=null;a._tileUpdateSet=new Set;a.lastUpdateId=-1;a.updateRequested=!1;a.graphicUpdateHandler=a.graphicUpdateHandler.bind(a);a._addOrUpdateGraphic=
a._addOrUpdateGraphic.bind(a);a._processAnalyzedGraphics=a._processAnalyzedGraphics.bind(a);a._graphicsChangeHandler=a._graphicsChangeHandler.bind(a);return a}B(d,p);d.prototype.initialize=function(){var a=this;this._tileStore=new O.default(this.view.featuresTilingScheme);this.container=new I.default({tileInfoView:this.view.featuresTilingScheme,highlightOptions:this.view.highlightOptions,highlightIDs:this._highlightIDs});this._graphicStore=new Q.default(this.view.featuresTilingScheme,this.view.state.scale,
this.uid,this.renderer,this.graphics);this._graphicProcessingQueue=new P.default({process:this._addOrUpdateGraphic});var b=new L.default,c=new N.default(this.container.getMaterialItems,devicePixelRatio);this.renderer&&(this._matcher=y.createMatcher(this.renderer,b,c,null));this._meshFactory=new M.default(null,this.uid,null,null,this.view.state.pixelRatio,this.view.spatialReference,b,c,null,this._tileStore.tileScheme.tileInfo);this.watch("renderer",function(m){if(a._graphicStore.renderer=m)a._matcher=
y.createMatcher(a.renderer,b,c,null)});this._tileStore.on("update",this._onTileUpdate.bind(this));this.view.watch("highlightOptions.color,highlightOptions.fillOpacity,highlightOptions.haloOpacity",function(){a.container.requestRender()});this.container.on("attach",function(){var b=a.graphics.toArray();b.sort(function(b,c){return a.graphics.indexOf(c)-a.graphics.indexOf(b)});for(var c=0;c<b.length;c++)a._add(b[c]);a.handles.add(a.graphics.on("change",a._graphicsChangeHandler),"graphics")})};d.prototype.destroy=
function(){this._graphicStore.clear();this._tileStore.destroy()};Object.defineProperty(d.prototype,"updating",{get:function(){return this._graphicProcessingQueue.updating||0<this._tileUpdateSet.size},enumerable:!0,configurable:!0});d.prototype.install=function(a){a.addChild(this.container)};d.prototype.uninstall=function(a){a.removeChild(this.container)};d.prototype.addHighlight=function(a){for(var b=0;b<a.length;b++)this._highlightIDs.add(a[b]);this._buildHLList()};d.prototype.highlight=function(a){var b=
this;b.addHighlight(a);return{remove:function(){b.removeHighlight(a)}}};d.prototype.hitTest=function(a,b){if(!this.view||!this.view.position)return h.resolve();this.view.toMap(a,b,A);return this.searchFeatures(A).then(function(a){return a&&a.length?a[0]:null})};d.prototype.searchFeatures=function(a,b){var c=this;void 0===b&&(b=2);return h.create(function(m){m(c._graphicStore.hitTest(a.x,a.y,b,c.view.state.resolution,c.view.state.rotation))})};d.prototype.removeHighlight=function(a){for(var b=0;b<
a.length;b++)this._highlightIDs.delete(a[b]);this._buildHLList()};d.prototype.setHighlight=function(a){this._highlightIDs.clear();this.addHighlight(a)};d.prototype.update=function(a){a=a.state;var b=this.view.featuresTilingScheme.getClosestInfoForScale(a.scale).level;this._graphicStore.updateLevel(b);this._tileStore.setViewState(a);this._graphicStoreUpdate=!0;this.updateRequested=!1};d.prototype.viewChange=function(){this.requestUpdate()};d.prototype.requestUpdate=function(){this.updateRequested||
(this.updateRequested=!0,this.view.requestUpdate(this))};d.prototype.processUpdate=function(a){this.updateRequested&&(this.updateRequested=!1,this.update(a))};d.prototype.graphicUpdateHandler=function(a){var b=a.graphic,c=a.newValue;switch(a.property){case "geometry":case "symbol":this._graphicProcessingQueue.push(b,"update");break;case "visible":this._setVisible(b.uid,c)}};d.prototype._graphicsChangeHandler=function(a){if(!this._graphicStoreUpdate){var b=this.view.state,c=this.view.featuresTilingScheme.getClosestInfoForScale(b.scale).level;
this._graphicStore.updateLevel(c);this._tileStore.setViewState(b)}var c=a.added,b=a.moved,m=0;for(a=a.removed;m<a.length;m++)this._remove(a[m]);for(a=0;a<c.length;a++)this._add(c[a]);for(a=0;a<b.length;a++)this._reorder(b[a])};d.prototype._buildHLList=function(){for(var a=0,b=this.container.children;a<b.length;a++)b[a].buildHLList(this._highlightIDs);this.container.requestRender()};d.prototype._getSymbolResources=function(a){var b=a.symbol;!b&&this.renderer&&(b=this.renderer.getSymbol(a,{scale:this.view.scale}));
if(!b||b&&"text"!==b.type)return h.resolve(null);r.clear();a=b;for(var b=a.text,c=0;c<b.length;c++)r.add(b.charCodeAt(c));t.length=0;r.forEach(function(a){return t.push(a)});b=[];b.push({symbol:a.toJSON(),id:0,glyphIds:t});return this.container.getMaterialItems(b).then(function(a){return 0<a.length?a[0].mosaicItem:null})};d.prototype._projectAndNormalizeGeometry=function(a){var b=this;if(!a.geometry)return h.resolve(null);var c=a.geometry;q.isPolygon(c)?c.rings=c.rings:q.isPolyline(c)?c.paths=c.paths:
q.isExtent(c)&&(c=H.fromExtent(c));return x.checkProjectionSupport(c.spatialReference,this.view.spatialReference).then(function(){return z.normalizeCentralMeridian(c)}).then(function(a){return x.project(a.toJSON(),a.spatialReference,b.view.spatialReference)}).then(function(a){z.ensureClosedRings(a);return a})};d.prototype._onTileUpdate=function(a){var b=this,c=w.getInfo(this.view.spatialReference);if(a.added&&0<a.added.length)for(var d=function(a){var d=e._graphicStore.queryTileData(a);if(c)for(var m=
Math.round((c.valid[1]-c.valid[0])/a.resolution),f=0;f<d.length;f++){var g=d[f];g.geometry&&q.isPoint(g.geometry)&&e._wrapPoints(g,m)}e._tileUpdateSet.add(a.key);e.notifyChange("updating");e._processGraphics(a.key,d).then(function(c){b._addTile(a.key,c);b._tileUpdateSet.delete(a.key);b.notifyChange("updating")}).catch(function(){b._tileUpdateSet.delete(a.key);b.notifyChange("updating")})},e=this,f=0,g=a.added;f<g.length;f++)d(g[f]);if(a.removed&&0<a.removed.length)for(d=0,a=a.removed;d<a.length;d++)this._removeTile(a[d].key)};
d.prototype._add=function(a){this.container.attached&&(this._graphicsSet.add(a),this._graphicProcessingQueue.has(a)&&this._graphicProcessingQueue.cancel(a),this._graphicProcessingQueue.push(a,"add"))};d.prototype._addOrUpdateGraphic=function(a,b){var c=this;return this._projectAndNormalizeGeometry(a).then(function(d){return c._getSymbolResources(a).then(function(e){return"add"===b?c._addProjectedGraphic(a,e,d):c._updateGraphic(a,e,d)})})};d.prototype._addProjectedGraphic=function(a,b,c){var d=this;
if(!this._graphicsSet.has(a))return h.resolve();var e=this._graphicStore.add(a,b,c);if(!e||0===l.width(e)&&0===l.height(e))return h.resolve();a.visible||this._hiddenGraphics.push(a.uid);var f=[];b=function(b){var c=g._getGraphicData(b,a),c=g._processGraphics(b.key,c).then(function(a){d._patchTile(b.key,{addOrUpdate:a,remove:null})});f.push(c)};var g=this;c=0;for(e=this._tileStore.boundsIntersections(e);c<e.length;c++)b(e[c]);return h.all(f)};d.prototype._remove=function(a){this._graphicsSet.has(a)&&
this._graphicsSet.delete(a);this._graphicProcessingQueue.has(a)&&this._graphicProcessingQueue.cancel(a);var b=this._graphicStore.getBounds(a);if(b){this._graphicStore.remove(a);for(var c=0,b=this._tileStore.boundsIntersections(b);c<b.length;c++)this._patchTile(b[c].key,{addOrUpdate:null,remove:[a.uid]})}};d.prototype._reorder=function(a){var b=this;this._graphicStore.reorder(a);var c=this._graphicStore.getBounds(a);if(0===l.width(c)&&0===l.height(c))return h.resolve();for(var d=[],e=function(c){var e=
f._getGraphicData(c,a),e=f._processGraphics(c.key,e).then(function(a){b._patchTile(c.key,{addOrUpdate:a,remove:[]})});d.push(e)},f=this,g=0,c=this._tileStore.boundsIntersections(c);g<c.length;g++)e(c[g]);return h.all(d)};d.prototype._updateGraphic=function(a,b,c){var d=this;if(!this._graphicStore.has(a))return h.resolve();c=this._graphicStore.update(a,b,c);b=c.oldBounds;c=c.newBounds;var e=0===l.width(b)&&0===l.height(b),f=0===l.width(c)&&0===l.height(c),e=e?[]:this._tileStore.boundsIntersections(b);
b=f?[]:this._tileStore.boundsIntersections(c);c=v.acquire();for(var g=0;g<e.length;g++)f=e[g],c.set(f.key,{addOrUpdate:null,remove:[a.uid]});for(e=0;e<b.length;e++)f=b[e],g=this._getGraphicData(f,a),c.has(f.key)?(f=c.get(f.key),f.remove.length=0,f.addOrUpdate=g):c.set(f.key,{addOrUpdate:g,remove:null});var k=[];c.forEach(function(a,b){var c=d._processGraphics(b,a.addOrUpdate).then(function(c){d._patchTile(b,{addOrUpdate:c,remove:a.remove})});k.push(c)});v.release(c);return h.all(k)};d.prototype._addTile=
function(a,b){var c=l.create();this.view.featuresTilingScheme.getTileBounds(c,a);c=new K(a,c,!0);c.setData({clear:!0,addOrUpdate:b,remove:[]},!1,!1);c.buildHLList(this._highlightIDs);0<this._hiddenGraphics.length&&c.setVisibility([],this._hiddenGraphics);this._tiles.set(a,c);this.container.addChild(c)};d.prototype._removeTile=function(a){this._tiles.has(a)&&(a=this._tiles.get(a),this.container.removeChild(a))};d.prototype._patchTile=function(a,b){this._tiles.has(a)&&(a=this._tiles.get(a),a.setData(b,
!1,!1),a.buildHLList(this._highlightIDs),0<this._hiddenGraphics.length&&a.setVisibility([],this._hiddenGraphics),this.container.requestRender())};d.prototype._setVisible=function(a,b){var c=[],d=[],e=this._hiddenGraphics.indexOf(a);if(b){if(-1!==e)this._hiddenGraphics.splice(e,1);else return;c.push(a)}else{if(-1===e)this._hiddenGraphics.push(a);else return;d.push(a)}a=0;for(b=this.container.children;a<b.length;a++)e=b[a],e.data&&e.setVisibility(c,d)};d.prototype._getGraphicData=function(a,b){b=this._graphicStore.getGraphicData(a,
b);var c=[b],d=w.getInfo(this.view.spatialReference);d&&(a=Math.round((d.valid[1]-d.valid[0])/a.resolution),b.geometry&&q.isPoint(b.geometry)&&this._wrapPoints(b,a));return c};d.prototype._wrapPoints=function(a,b){var c=a.geometry;512===b?20>c.x?a.geometry={points:[[c.x,c.y],[b,0]]}:492<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]}):-20>c.x?a.geometry={points:[[c.x,c.y],[b,0]]}:532<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]})};d.prototype._processGraphics=function(a,b){var c=this;return b&&b.length&&
this._meshFactory?this._meshFactory.analyze(b,this._matcher).then(function(b){return c._processAnalyzedGraphics(a,b)}):h.resolve(null)};d.prototype._processAnalyzedGraphics=function(a,b){for(var c=this._meshFactory,d=c.createMeshData(b.length),e=0;e<b.length;e++)c.write(d,b[e],null,null,a.level);return J.fromMeshData(d)};n([k.property()],d.prototype,"_graphicProcessingQueue",void 0);n([k.property(),k.cast(D.ofType(C))],d.prototype,"graphics",void 0);n([k.property({dependsOn:["_graphicProcessingQueue.updating"]})],
d.prototype,"updating",null);n([k.property()],d.prototype,"view",void 0);n([k.property()],d.prototype,"updateRequested",void 0);return d=n([k.subclass("esri.views.2d.layers.support.GraphicsView2D")],d)}(k.declared(R,E,F.Identifiable));u.default=p});