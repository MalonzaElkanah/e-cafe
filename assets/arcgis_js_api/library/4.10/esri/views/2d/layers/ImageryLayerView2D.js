// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Graphic ../../../core/Handles ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../engine/BitmapContainer ./LayerView2D ./support/ExportStrategy ../../layers/ImageryLayerView".split(" "),function(u,v,h,k,l,m,f,n,g,p,q,r,t){return function(e){function b(){var a=null!==e&&e.apply(this,arguments)||this;a._handles=new m;a.container=new p.BitmapContainer;
return a}h(b,e);b.prototype.hitTest=function(a,d){if(this.suspended)return f.resolve(null);a=this.view.toMap(a,d);return f.resolve(new l({attributes:{},geometry:a}))};b.prototype.update=function(a){this.strategy.update(a);this.notifyChange("updating")};b.prototype.attach=function(){var a=this;this.strategy=new r({container:this.container,fetchSource:this.fetchImage.bind(this),requestUpdate:function(){return a.requestUpdate()}});this._handles.add([n.watch(this,"layer.exportImageServiceParameters.version",
function(d){a._exportImageVersion!==d&&(a._exportImageVersion=d,a.requestUpdate())}),this.layer.on("redraw",function(){a.strategy.updateExports(function(d){d=d.source.getContext("2d");a.pixelData=a.layer.applyFilter(a._rawPixelData);a._drawPixelData(d,a.pixelData,0,0);return null})})])};b.prototype.detach=function(){this.strategy.destroy();this._handles.removeAll();this.container.removeAllChildren()};b.prototype.moveStart=function(){};b.prototype.viewChange=function(){};b.prototype.moveEnd=function(){this.requestUpdate()};
b.prototype.doRefresh=function(){this.requestUpdate()};b.prototype.isUpdating=function(){return this.attached&&(this.strategy.updating||this.updateRequested)};b.prototype.fetchImage=function(a,d,b,e){var c=this;this._exportImageVersion=this.get("layer.exportImageServiceParameters.version");return this.layer.fetchImage(a,d,b,e).then(function(a){c._rawPixelData=a.pixelData;c.pixelData=c.layer.applyFilter(c._rawPixelData);a=document.createElement("canvas");a.width=d;a.height=b;var e=a.getContext("2d");
c._drawPixelData(e,c.pixelData,0,0);c.notifyChange("updating");return a})};b.prototype._drawPixelData=function(a,b,e,f){if(b.pixelBlock){var c=b.pixelBlock;b=a.createImageData(c.width,c.height);c=c.getAsRGBA();b.data.set(c);a.putImageData(b,e,f)}};return b=k([g.subclass("esri.views.2d.layers.ImageryLayerView2D")],b)}(g.declared(q,t))});