// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/Accessor ../../../../../core/scheduling ../../../../../core/accessorSupport/decorators ../../../../../core/libs/gl-matrix-2/gl-matrix ../../../tiling".split(" "),function(c,l,p,e,q,r,f,m,n){Object.defineProperty(l,"__esModule",{value:!0});var k=[0,0];c=function(c){function b(a){a=c.call(this,a)||this;a._queue=new Map;a._onGoingTile=null;a._onGoingPromise=null;
a._isPaused=!1;a._scheduledNextHandle=null;a._timestamp=Date.now();a.tileInfoView=null;a._next=a._next.bind(a);a._finalize=a._finalize.bind(a);return a}p(b,c);Object.defineProperty(b.prototype,"length",{get:function(){return this._queue.size},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this._queue.size||null!=this._onGoingPromise},enumerable:!0,configurable:!0});b.prototype.cancel=function(a){this._onGoingTile&&this._onGoingTile.tileId===a&&
(this._onGoingPromise.cancel(),this._onGoingTile=this._onGoingPromise=null);this._queue.delete(a);this._scheduleNext();this.notifyChange("updating")};b.prototype.clear=function(){this._queue.clear();this._onGoingPromise&&(this._onGoingPromise.cancel(),this._onGoingTile=this._onGoingPromise=null);this._cancelNext();this.notifyChange("updating")};b.prototype.has=function(a){return this._queue.has(a)};b.prototype.isOngoing=function(a){return this._onGoingTile&&this._onGoingTile.tileId===a};b.prototype.pause=
function(){this._isPaused||(this._isPaused=!0,this._cancelNext())};b.prototype.push=function(a,b){this._queue.has(a)||(this._queue.set(a,{tileId:a,key:n.TileKey.pool.acquire(a),timestamp:b||this._timestamp}),this._scheduleNext(),this.notifyChange("updating"))};b.prototype.refresh=function(){this._timestamp=Date.now();this.reset()};b.prototype.reset=function(){var a=this._onGoingTile;a&&this.push(a.tileId,this._timestamp);this.notifyChange("updating")};b.prototype.resume=function(){this._isPaused&&
(this._isPaused=!1,this._scheduleNext());this.notifyChange("updating")};b.prototype._finalize=function(){this._onGoingPromise=this._onGoingTile=null;this.notifyChange("updating");this._scheduleNext()};b.prototype._cancelNext=function(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)};b.prototype._scheduleNext=function(){this._isPaused||this._scheduledNextHandle||0===this._queue.size||null!=this._onGoingTile||(this._scheduledNextHandle=r.schedule(this._next))};
b.prototype._next=function(){if(null==this._scheduledNextHandle||0===this._queue.size||this._onGoingTile)this._scheduledNextHandle=null;else{this._scheduledNextHandle=null;var a=this._peek(),b=a.tileId;n.TileKey.pool.release(a.key);this._queue.delete(b);this._onGoingTile=a;(a=this._onGoingPromise=this.process(b,this._timestamp))&&"function"===typeof a.then?this._onGoingPromise.then(this._finalize,this._finalize):this._finalize();this.notifyChange("updating")}};b.prototype._peek=function(){var a=this;
if(!this.state)throw Error("state not set");var b=this.tileInfoView,f=this.state.center,e=Number.NEGATIVE_INFINITY,c=Number.POSITIVE_INFINITY,h=null;this._queue.forEach(function(g,d){b.getTileCoords(k,g.key);d=a._timestamp-g.timestamp;isNaN(d)?(d=m.vec2.distance(k,f),d<c&&(c=d,h=g)):d===e?(d=m.vec2.distance(k,f),d<c&&(c=d,h=g)):d>e&&(e=d,c=Number.POSITIVE_INFINITY,h=g)});return h};e([f.property({readOnly:!0})],b.prototype,"length",null);e([f.property({constructOnly:!0})],b.prototype,"process",void 0);
e([f.property()],b.prototype,"state",void 0);e([f.property({constructOnly:!0})],b.prototype,"tileInfoView",void 0);e([f.property({readOnly:!0})],b.prototype,"updating",null);return b=e([f.subclass()],b)}(f.declared(q));l.default=c});