// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper dojo/Deferred ../core/Accessor ../core/Collection ../core/Error ../core/Logger ../core/promiseUtils ../core/watchUtils ../core/accessorSupport/decorators".split(" "),function(v,w,l,g,m,n,p,k,q,r,t,f){var u=q.getLogger("esri.views.LayerViewFactory");return function(h){function a(){var b=null!==h&&h.apply(this,arguments)||this;b.creationRequests=new p;b.paused=!0;return b}l(a,h);a.prototype.initialize=function(){var b=
this;t.whenFalse(this,"paused",function(){b.creationRequests.toArray().forEach(b._processRequest,b)},!0)};a.prototype.destroy=function(){this.creationRequests.drain(function(b){return b.deferred.cancel(void 0)})};Object.defineProperty(a.prototype,"working",{get:function(){return 0<this.creationRequests.length},enumerable:!0,configurable:!0});a.prototype.create=function(b,a){var d=this.getLayerViewPromise(a);if(d)return d;var c=this.creationRequests,e={deferred:new m(function(){var b=new k("cancelled:layerview-create",
"layerview creation cancelled",{layer:a});c.remove(e);e.creationPromise&&e.creationPromise.cancel(b);return b}),view:b,layer:a,started:!1,creationPromise:null};c.push(e);this.paused?a.load():this._processRequest(e);return e.deferred.promise};a.prototype.dispose=function(b){b.layer.destroyLayerView(b)};a.prototype.getLayerViewPromise=function(b){var a=this.creationRequests&&this.creationRequests.find(function(a){return a.layer===b});return a&&a.deferred.promise};a.prototype._processRequest=function(b){var a=
this;if(!b.started){b.started=!0;var d=b.deferred,c=b.layer,e=b.view;c&&"importLayerViewModule"in c&&c.importLayerViewModule(e);c.load().then(function(a){if(!d.isCanceled())return b.creationPromise=a.createLayerView(e),b.creationPromise}).then(function(a){return d.isCanceled()?a:b.creationPromise=r.when(a.when())}).catch(function(a){d.isCanceled()||(u.error("Failed to create view for layer '"+c.title+", id:"+c.id+"' of type '"+c.type+"'.",{error:a}),d.reject(new k("layerview:create-error","layerview creation failed",
{layer:c,error:a})))}).then(function(c){a.creationRequests&&a.creationRequests.remove(b);d.isFulfilled()?c&&a.dispose(c):d.resolve(c);return c})}};g([f.property()],a.prototype,"creationRequests",void 0);g([f.property()],a.prototype,"paused",void 0);g([f.property()],a.prototype,"view",void 0);g([f.property({dependsOn:["paused","creationRequests.length"],readOnly:!0})],a.prototype,"working",null);return a=g([f.subclass("esri.views.LayerViewFactory")],a)}(f.declared(n))});