// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/arrayUtils ../../core/Error ../../core/Logger ../../core/promiseUtils ../../core/accessorSupport/decorators ../../renderers/support/clickToleranceUtils ../../support/arcadeUtils ../../support/graphicUtils ./RefreshableLayerView ./support/popupUtils".split(" "),function(z,A,p,e,q,m,r,h,d,t,u,v,w,x){var y=r.getLogger("esri.views.layers.FeatureLayerView");return function(n){function b(a){a=
n.call(this,a)||this;a.layer=null;return a}p(b,n);Object.defineProperty(b.prototype,"maximumNumberOfFeatures",{get:function(){return 0},set:function(a){y.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!1},enumerable:!0,configurable:!0});b.prototype.highlight=function(a,b){return this.inherited(arguments)};b.prototype.queryFeatures=
function(a){return this.inherited(arguments)};b.prototype.queryObjectIds=function(a){return this.inherited(arguments)};b.prototype.queryFeatureCount=function(a){return this.inherited(arguments)};b.prototype.queryExtent=function(a){return this.inherited(arguments)};b.prototype.fetchPopupFeatures=function(a,b){var c=this._validateFetchPopupFeatures();if(c)return h.reject(c);c=this._fetchClientPopupFeatures(b);if(!a)return c;a=this._fetchServicePopupFeatures(a,b);return h.eachAlwaysValues([c,a]).then(q.concatAll)};
b.prototype._validateFetchPopupFeatures=function(){var a=this.layer,b=a.popupTemplate;if(!a.popupEnabled)return new m("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if(!b)return new m("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})};b.prototype._fetchClientPopupFeatures=function(a){if(!a||0===a.length)return h.resolve([]);for(var b=[],c=[],k=this.layer,d=u.hasGeometryOperations(k.popupTemplate),f=this._createPopupQuery(),g=0;g<a.length;g++){var l=
a[g];d||!v.hasRequiredFields(l,f.outFields)?c.push(l):b.push(l)}if(0===c.length)return h.resolve(b);f.objectIds=c.map(function(a){return a.attributes[k.objectIdField]});return k.queryFeatures(f).then(function(a){return b.concat(a.features)}).catch(function(){return c})};b.prototype._fetchServicePopupFeatures=function(a,b){var c=this._createPopupQuery(),d=this.layer,e=t.calculateTolerance(d.renderer);c.geometry=this.createFetchPopupFeaturesQueryGeometry(a,e);var f=new Set,g=d.objectIdField;for(a=0;a<
b.length;a++)f.add(b[a].attributes[g]);return d.queryFeatures(c).then(function(a){return a.features.filter(function(a){return!f.has(a.attributes[g])})})};b.prototype._createPopupQuery=function(){var a=this.layer.createQuery();a.returnGeometry=!0;a.returnZ=!0;a.returnM=!0;a.outFields=x.getRequiredFields(this.layer);a.outSpatialReference=this.getViewSpatialReference();return a};e([d.property()],b.prototype,"layer",void 0);e([d.property({type:Number})],b.prototype,"maximumNumberOfFeatures",null);e([d.property({readOnly:!0,
type:Boolean})],b.prototype,"maximumNumberOfFeaturesExceeded",null);return b=e([d.subclass("esri.views.layers.FeatureLayerView")],b)}(d.declared(w))});