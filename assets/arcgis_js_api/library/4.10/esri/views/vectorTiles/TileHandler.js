// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../request ../../core/has ../../core/ItemCache ../../core/promiseUtils ../../core/requireUtils ../../core/workers ../2d/tiling/TileKey ./GeometryUtils ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./SpriteSource ./TileIndex ./VectorTileDisplayObject module".split(" "),function(q,D,r,E,t,f,u,v,w,m,x,y,z,A,h,B,C){var n=new t(10),g=new Map;return function(){function b(a,d,e,c){this.devicePixelRatio=d;this.allowUpdates=e;this._tileIndex=this._connection=this._glyphMosaic=this._spriteMosaic=
null;this._updateQueue=new Map;this._ongoingRequests=new Map;this._vectorTileLayer=a;this._container=c}b.prototype.destroy=function(){this.stop();this._vectorTileLayer=null;this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)};Object.defineProperty(b.prototype,"initialized",{get:function(){return this._broadcastPromise&&this._broadcastPromise.isFulfilled()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"spriteMosaic",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"ongoingRequestCount",{get:function(){return this._ongoingRequests.size},enumerable:!0,configurable:!0});b.prototype.start=function(){var a=this;this.stop();var d=this._vectorTileLayer.styleRepository,e=new A(d.sprite,this.devicePixelRatio),c=e.load().then(function(){a._spriteMosaic=
new z(1024,1024,250);a._spriteMosaic.setSpriteSource(e)}),k=new y(d.glyphs);this._glyphMosaic=new x(1024,1024,k);var b=this._fetchTileMap(this._vectorTileLayer.tileIndexUrl),l=v.open(u.getAbsMid("./WorkerTileHandler",q,C),{client:this}).then(function(c){a._connection=c}),p,k=f.create(function(a){p=a},function(a){c.isFulfilled()||c.cancel();b.isFulfilled()||b.cancel();l.isFulfilled()||l.cancel()});f.all([c,l]).then(function(){var c=a._connection.broadcast("setLayers",d.styleJSON);c.push(b);f.all(c).then(function(){p()})});
return this._broadcastPromise=k};b.prototype.stop=function(){this._broadcastPromise&&!this._broadcastPromise.isFulfilled()&&this._broadcastPromise.cancel();this._updateQueue.forEach(function(a){return a.cancel()});this._ongoingRequests.forEach(function(a){return a.cancel()});this._connection&&(this._connection.close(),this._connection=null)};b.prototype.updateStyle=function(){this._updateQueue.forEach(function(a){return a.cancel()});this._updateQueue.clear();this._ongoingRequests.forEach(function(a){return a.cancel()});
this._ongoingRequests.clear();var a=this._vectorTileLayer.styleRepository,d,e=f.create(function(a){d=a});f.all(this._connection.broadcast("updateStyle",a.styleJSON)).then(function(){return d()});return this._broadcastPromise=e};b.prototype.updateTile=function(a,d){var e=this;if(!this.allowUpdates)return f.resolve(null);if(!this._broadcastPromise.isFulfilled()||!this._connection)return f.reject(Error("no connection"));d=Math.round(m.degToByte(d.state.rotation));if(a.rotation===d)return f.resolve(null);
var c,b=a.key;this._updateQueue.has(b.id)&&(c=this._updateQueue.get(b.id),c.cancel(),this._updateQueue["delete"](b.id));a.rotation=d;c=a.client.invoke("updateSymbols",{key:a.id,rotation:d}).then(function(c){e._updateQueue["delete"](b.id);a.updateSymbolData(c);return c}).catch(function(a){if("cancel"!==a.dojoType)e._updateQueue["delete"](b.id)});this._updateQueue.set(a.id,c);return c};b.prototype.updateTileData=function(a){for(var d=a.tileId,b=this._container.children,c,f=0;f<b.length;f++)if(c=b[f],
c.id===d){c.updateTileData(a.tileData);break}};b.prototype.getVectorTile=function(a,b,e,c){var d=this;void 0===c&&(c=0);var f=new w(a,b,e,0);return this.getRefKey(f).then(function(a){var b=new B(f,a,d._vectorTileLayer.tileInfo,d._vectorTileLayer.styleRepository,0);if(a)return d.getTileData(b.key,0).then(function(a){b.setData(a.tileData,a.client);return b});b.setData(null,null);return b})};b.prototype.getTileData=function(a,b){var d=this;return this._broadcastPromise.isFulfilled()&&this._connection?
this.getRefKey(a).then(function(c){if(!c)return f.resolve(null);var e=Math.round(m.degToByte(b));return d._getTileData(d._connection,a,c,e).then(function(a){return a&&a.tileData?a:f.reject(null)})}):f.reject(Error("no connection"))};b.prototype.getRefKey=function(a){return this._tileIndex?this._tileIndex.dataKey(a):f.resolve(a)};b.prototype.getSprites=function(a){return this._spriteMosaic.getSpriteItems(a)};b.prototype.getGlyphs=function(a){return this._glyphMosaic.getGlyphItems(a.tileID,a.font,a.codePoints)};
b.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository};b.prototype.getTileIndex=function(){return this._tileIndex};b.prototype._getTileData=function(a,b,e,c){var d=this;if(a=this._ongoingRequests.get(b.id))return a;a=this._vectorTileLayer.getTileUrl(e.level,e.row,e.col);var g=this._connection.getAvailableClient();a=g.invoke("getTile",{key:b.id,refKey:e.id,url:a,rotation:c,cacheTile:this.allowUpdates}).then(function(a){d._ongoingRequests.delete(b.id);return{tileData:a,
client:g}}).catch(function(a){d._ongoingRequests.delete(b.id);g.invoke("destructTileData",b.id);return f.reject(a)});this._ongoingRequests.set(b.id,a);return a};b.prototype._fetchTileMap=function(a){var b=this;if(this._vectorTileLayer.capabilities.operations.supportsTileMap&&this._vectorTileLayer.tilemapCache)return this._tileIndex=new h(this._vectorTileLayer.tilemapCache),f.resolve();if(!a)return f.resolve();var e=n.get(a);if(void 0!==e)return this._tileIndex=e,f.resolve();if(g.has(a))return g.get(a).then(function(a){b._tileIndex=
new h(a.data)});e=r(a,{responseType:"json"});e.then(function(c){b._tileIndex=new h(c.data);g["delete"](a);n.put(a,b._tileIndex)});g.set(a,e);return e};return b}()});