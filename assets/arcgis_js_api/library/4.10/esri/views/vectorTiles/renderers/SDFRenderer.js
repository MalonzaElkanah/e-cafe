// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/has ../../../core/libs/gl-matrix-2/gl-matrix ../GeometryUtils ./rendererUtils ../../webgl/VertexArrayObject".split(" "),function(I,J,C,h,y,D,u){var E=1/65536;return function(){function c(m){this._viewProjMat=h.mat4f32.create();this._offsetVector=h.vec3f32.create();this._extrudeMat=h.mat4f32.create();this._scaleVec=h.vec3f32.create();this._haloColor=h.vec4f32.create();this._sdfColor=h.vec4f32.create();this._initialized=!1;this._programOptions={id:!1,dd:!1};this._programCache=
m}c.prototype.dispose=function(){};c.prototype.render=function(m,b,a,g,k,e,r,d,w,c,p,x,u){var F=this;if(!C("esri-vector-tiles-avoid-text")){this._initialized||this._initialize(m);var G=y.degToByte(k),v=d.getLayoutValue("text-rotation-alignment",a);2===v&&(v=1===d.getLayoutValue("symbol-placement",a)?0:1);var z=0===v,v=d.getLayoutValue("text-keep-upright",a)&&z;g=3===g;x=.8*3/x;var H=d.hasDataDrivenTextSize?1:d.getLayoutValue("text-size",a),n=d.hasDataDrivenTextColor?[1,1,1,1]:d.getPaintValue("text-color",
a),A=d.hasDataDrivenTextOpacity?1:d.getPaintValue("text-opacity",a),l=n[3]*A*u;this._sdfColor[0]=l*n[0];this._sdfColor[1]=l*n[1];this._sdfColor[2]=l*n[2];this._sdfColor[3]=l;this._glyphTextureSize||(this._glyphTextureSize=h.vec2f32.fromValues(w.width/4,w.height/4));n=r.tileTransform.transform;l=d.getPaintValue("text-translate",a);if(0!==l[0]||0!==l[1]){h.mat4.copy(this._viewProjMat,r.tileTransform.transform);var n=l[0],l=l[1],t=0,q=0,q=(1<<r.key.level)/Math.pow(2,a)*(r.coordRange/512);if(1===d.getPaintValue("text-translate-anchor",
a)){t=-y.C_DEG_TO_RAD*k;k=Math.sin(t);var B=Math.cos(t),t=q*(n*B-l*k),q=q*(n*k+l*B)}else t=q*n,q*=l;this._offsetVector[0]=t;this._offsetVector[1]=q;this._offsetVector[2]=0;h.mat4.translate(this._viewProjMat,this._viewProjMat,this._offsetVector);n=this._viewProjMat}z?h.mat4.copy(this._extrudeMat,c):h.mat4.copy(this._extrudeMat,p);this._scaleVec[0]=1/24;this._scaleVec[1]=1/24;this._scaleVec[2]=1;h.mat4.scale(this._extrudeMat,this._extrudeMat,this._scaleVec);c=d.hasDataDrivenText;if(p=this._getSDFVAO(m,
r,c)){m.bindVAO(p);p=this._programOptions;p.id=g;p.dd=c;var f=this._programCache.getProgram(6,(g?1:0)<<1|(c?1:0),p);m.bindProgram(f);f.setUniformMatrix4fv("u_transformMatrix",n);f.setUniformMatrix4fv("u_extrudeMatrix",this._extrudeMat);f.setUniform2fv("u_normalized_origin",r.tileTransform.displayCoord);f.setUniform1f("u_depth",d.z+E);f.setUniform2fv("u_mosaicSize",this._glyphTextureSize);f.setUniform1f("u_mapRotation",G);f.setUniform1f("u_keepUpright",v?1:0);f.setUniform1f("u_level",10*a);f.setUniform1f("u_fadeSpeed",
10*e.fadeSpeed);f.setUniform1f("u_minfadeLevel",10*e.minfadeLevel);f.setUniform1f("u_maxfadeLevel",10*e.maxfadeLevel);f.setUniform1f("u_fadeChange",10*(a+e.fadeChange));f.setUniform1i("u_texture",6);f.setUniform1f("u_size",H);f.setUniform1f("u_antialiasingWidth",x);g&&(e=D.int32To4Bytes(b.layerID),f.setUniform4f("u_id",e[0],e[1],e[2],e[3]));b.glyphPerPageElementsMap.forEach(function(b,e){F._renderGlyphRange(m,b,e,d,w,f,a,A*u,3)});m.bindVAO()}}};c.prototype._renderGlyphRange=function(m,b,a,g,k,e,h,
d,c){k.bind(m,9729,a,6);k=g.getPaintValue("text-halo-color",h);a=g.getPaintValue("text-halo-width",h);0<k[3]&&0<a&&(d*=k[3],this._haloColor[0]=d*k[0],this._haloColor[1]=d*k[1],this._haloColor[2]=d*k[2],this._haloColor[3]=d,g=g.getPaintValue("text-halo-blur",h)*c,c*=a,e.setUniform4fv("u_color",this._haloColor),e.setUniform1f("u_halo",1),e.setUniform1f("u_edgeDistance",c),e.setUniform1f("u_edgeBlur",g),m.drawElements(4,b[1],5125,12*b[0]));0<this._sdfColor[3]&&(e.setUniform4fv("u_color",this._sdfColor),
e.setUniform1f("u_halo",0),e.setUniform1f("u_edgeDistance",0),e.setUniform1f("u_edgeBlur",0),m.drawElements(4,b[1],5125,12*b[0]))};c.prototype._initialize=function(c){if(this._initialized)return!0;this._vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,
offset:12,stride:16,normalized:!1,divisor:0}]};this._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:24,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,
type:5126,offset:20,stride:24,normalized:!1,divisor:0}]};return this._initialized=!0};c.prototype._getSDFVAO=function(c,b,a){if(a){if(b.textDDVertexArrayObject)return b.textDDVertexArrayObject;a=b.textDDVertexBuffer;var g=b.textIndexBuffer;if(!a||!g)return null;b.textDDVertexArrayObject=new u(c,this._programCache.getProgramAttributes(6),this._vertexAttributesDD,{geometry:a},g);return b.textDDVertexArrayObject}if(b.textVertexArrayObject)return b.textVertexArrayObject;a=b.textVertexBuffer;g=b.textIndexBuffer;
if(!a||!g)return null;b.textVertexArrayObject=new u(c,this._programCache.getProgramAttributes(6),this._vertexAttributes,{geometry:a},g);return b.textVertexArrayObject};return c}()});