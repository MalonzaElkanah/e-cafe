// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/Handles ../../../../../core/libs/gl-matrix-2/gl-matrix ../directLineMeasurement3D/LaserLineRenderer ../support/Label ../support/LabelSegment ../support/labelUtils ../support/PathSegmentInterpolator ../support/viewUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryData ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Layer ../../../webgl-engine/lib/Object3D ../../../webgl-engine/lib/Selector ../../../webgl-engine/materials/CheckerBoardMaterial ../../../webgl-engine/materials/DefaultMaterial ../../../webgl-engine/materials/RibbonLineMaterial ../../../webgl-engine/parts/Model".split(" "),
function(u,N,O,P,F,f,G,p,v,w,E,n,x,C,H,D,I,q,J,K,L,r,g){var t;(function(b){b[b.Small=12]="Small";b[b.Large=16]="Large"})(t||(t={}));var M={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:1,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25,pathLineColor:[1,.5,0,1],pathLineWidth:3,intersectingLineColor:[1,.2,0,1],perimeterLineColor:[1,.5,0,
1],perimeterLineWidth:2,projectionLineColor:[1,.5,0,1],projectionLineWidth:2,projectionLineStippleSize:5,areaColor1:[1,.5,0,.5],areaColor2:[1,1,1,.5],fillColor:[1,.5,0,.5],lineSubdivisions:64,labelDistance:25};u=function(){function b(a,c){void 0===c&&(c={});this._visible=!1;this._laserLineRenderer=null;this._pathSegmentObjects=[];this._perimeterSegmentObjects=[];this._vertexHandleObjects=[];this._projectionLineObjects=[];this._areaLabel=new p(t.Large);this._pathLengthLabel=new p(t.Small);this._cursorSegmentLengthLabel=
new p(t.Small);this._perimeterLengthLabel=new p(t.Small);this._pathLabelSegments=[];this._perimeterLabelSegments=[];this._cursorSegmentLengthLabelSegment=new v;this._listenerHandles=null;this._origin=f.vec3f64.create();this._originTransform=f.mat4f64.create();this._tempStartPosition=f.vec3f64.create();this._tempEndPosition=f.vec3f64.create();this._tempHandlePosition=f.vec3f64.create();this._tempMat4=f.mat4f64.create();this._model=a;this._sceneView=a.sceneView;this._params=n.copyParameter(M,c);this._layer=
new I("path-measurement-tool",{isPickable:!1},"path-measurement-tool");this._createMaterials();this._createObjects();this._selector=new J(this._sceneView.viewingMode)}b.prototype.destroy=function(){this.hide()};Object.defineProperty(b.prototype,"requiresCursorPoint",{get:function(){return("initial"===this._model.state||"drawing"===this._model.state)&&this._model.active},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"visible",{get:function(){return this._visible},set:function(a){a?
this.show():this.hide()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"testData",{get:function(){return{labels:{area:this._areaLabel,pathLength:this._pathLengthLabel,cursorSegmentLength:this._cursorSegmentLengthLabel,perimeterLength:this._perimeterLengthLabel},laserLineRenderer:this._laserLineRenderer}},enumerable:!0,configurable:!0});b.prototype.show=function(){if(!this._visible){this._visible=!0;var a=this._sceneView._stage;this._laserLineRenderer=new G(this._sceneView.renderCoordsHelper,
{glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,globalAlpha:this._params.laserLineGlobalAlpha});a.addRenderPlugin(this._laserLineRenderer.renderSlots,this._laserLineRenderer);this._addToStage(a);this._areaLabel.addToView(this._sceneView);this._pathLengthLabel.addToView(this._sceneView);this._cursorSegmentLengthLabel.addToView(this._sceneView);this._perimeterLengthLabel.addToView(this._sceneView);
this._initializeListeners();this._updateAll(this._model.viewData)}};b.prototype.hide=function(){if(this._visible){this._visible=!1;var a=this._sceneView._stage;a.removeRenderPlugin(this._laserLineRenderer);this._laserLineRenderer=null;this._destroyListeners();this._updatePathLength(0);this._removeFromStage(a);this._areaLabel.removeFromView(this._sceneView);this._pathLengthLabel.removeFromView(this._sceneView);this._cursorSegmentLengthLabel.removeFromView(this._sceneView);this._perimeterLengthLabel.removeFromView(this._sceneView);
this._sceneView.cursor=null}};b.prototype.vertexHandleAt=function(a,c){a=f.vec2f64.fromValues(a.x,a.y);c="touch"===c?this._params.handleRadiusTouch:this._params.handleRadiusMouse;for(var h=this._model.path,b=0;b<h.length;++b)if(n.pointToScreenPositionDistance(h.vertex(b),a,this._sceneView)<c)return b;return null};b.prototype.pick=function(a){var c=this._sceneView.spatialReference;a=f.vec2f64.fromValues(a.screenPoint.x,this._sceneView.height-a.screenPoint.y);a=this._sceneView.sceneIntersectionHelper.intersectToolSelectorScreen(a,
this._selector).minResult;var h=f.vec3f64.create();if(!a.getIntersectionPoint(h))return new b.PickResult;c=this._sceneView.renderCoordsHelper.fromRenderCoords(h,c);return new b.PickResult("TerrainRenderer"===a.intersector?"surface":"feature",h,c)};b.prototype.overlappingHandles=function(a,c){return n.pointToPointScreenDistance(a,c,this._sceneView)<=this._params.handleRadius};b.prototype.overlapsAnyHandles=function(a,c){void 0===c&&(c=[]);for(var h=this._model.path,b=0;b<h.length;++b)if(!(0<=c.indexOf(b))&&
this.overlappingHandles(a,h.vertex(b)))return!0;return!1};b.prototype._createMaterials=function(){var a=1!==this._params.handleOpacity;this._handleMaterial=new L({diffuse:this._params.handleColor,transparent:a,writeDepth:!a,cullFace:"back",opacity:this._params.handleOpacity,castShadows:!1},"handle");this._handleMaterial.renderOccluded=!0;this._pathLineMaterial=new r({width:this._params.pathLineWidth,color:this._params.pathLineColor,polygonOffset:!0},"path-line");this._pathLineMaterial.renderOccluded=
!0;this._intersectingPathLineMaterial=new r({width:this._params.pathLineWidth,color:this._params.intersectingLineColor,polygonOffset:!0},"intersecting-path-line");this._intersectingPathLineMaterial.renderOccluded=!0;this._perimeterLineMaterial=new r({width:this._params.perimeterLineWidth,color:this._params.perimeterLineColor,polygonOffset:!0},"perimeter-line");this._perimeterLineMaterial.renderOccluded=!0;this._intersectingPerimeterLineMaterial=new r({width:this._params.perimeterLineWidth,color:this._params.intersectingLineColor,
polygonOffset:!0},"intersecting-perimeter-line");this._intersectingPerimeterLineMaterial.renderOccluded=!0;this._projectionLineMaterial=new r({width:this._params.projectionLineWidth,color:this._params.projectionLineColor,polygonOffset:!0,stippleLength:0},"projection-line");this._projectionLineMaterial.renderOccluded=!0;this._checkerBoardMaterial=new K({color1:this._params.areaColor1,color2:this._params.areaColor2,transparent:!0,writeDepth:!1,polygonOffset:!0},"checker-board");this._checkerBoardMaterial.renderOccluded=
!0};b.prototype._createObjects=function(){this._cursorHandleObject=new q;this._cursorSegmentObject=new q;this._areaObject=new q};b.prototype._addToStage=function(a){a.add(g.ContentType.LAYER,this._layer);a.add(g.ContentType.MATERIAL,this._handleMaterial);a.add(g.ContentType.MATERIAL,this._pathLineMaterial);a.add(g.ContentType.MATERIAL,this._intersectingPathLineMaterial);a.add(g.ContentType.MATERIAL,this._perimeterLineMaterial);a.add(g.ContentType.MATERIAL,this._intersectingPerimeterLineMaterial);
a.add(g.ContentType.MATERIAL,this._projectionLineMaterial);a.add(g.ContentType.MATERIAL,this._checkerBoardMaterial);a.addToViewContent([this._layer.id])};b.prototype._removeFromStage=function(a){a.removeFromViewContent([this._layer.id]);a.remove(g.ContentType.LAYER,this._layer.id);a.remove(g.ContentType.MATERIAL,this._handleMaterial.id);a.remove(g.ContentType.MATERIAL,this._pathLineMaterial.id);a.remove(g.ContentType.MATERIAL,this._intersectingPathLineMaterial.id);a.remove(g.ContentType.MATERIAL,
this._perimeterLineMaterial.id);a.remove(g.ContentType.MATERIAL,this._intersectingPerimeterLineMaterial.id);a.remove(g.ContentType.MATERIAL,this._projectionLineMaterial.id);a.remove(g.ContentType.MATERIAL,this._checkerBoardMaterial.id)};b.prototype._syncViewData=function(a){var c=this,h=a.pathChanges;"full"===h.change?this._updateAll(a):"incremental"===h.change&&(h.updatedVertices.forEach(function(h){var b=(h-1+c._model.path.length)%c._model.path.length;c._updatePathSegment(a,h);c._updatePathSegment(a,
b);c._updateVertexHandle(a,h);c._updateArea(a);c._updatePerimeterSegments(a);c._updateProjectionLines(a);c._updateLaserLine();c._updateLabels(a)}),h.updatedVertices.has(this._model.path.length-1)&&this._updateCursorSegment(a));var b=h.change;h.clear();return b};b.prototype._updateAfterSyncViewData=function(a){var c=this._model.viewData;"full"!==this._syncViewData(c)&&a&&a(c)};b.prototype._updateOrigin=function(a){n.midpoint(a.positionsRenderCoords,this._origin);f.mat4.identity(this._originTransform);
f.mat4.translate(this._originTransform,this._originTransform,this._origin)};b.prototype._updateAll=function(a){this._updateOrigin(a);this._updatePathLength(a.path.length);this._updatePathSegments(a);this._updatePerimeterSegments(a);this._updateHandles(a);this._updateArea(a);this._updateProjectionLines(a);this._updateLabels(a);this._updateLaserLine()};b.prototype._updateCameraDependent=function(a){this._updateHandles(a);this._updateProjectionLines(a);this._updateLabels(a)};b.prototype._updatePathLength=
function(a){this._resizeObject3DArray(this._pathSegmentObjects,a);this._resizeObject3DArray(this._perimeterSegmentObjects,a);this._resizeObject3DArray(this._vertexHandleObjects,a);n.resizeArray(this._pathLabelSegments,a,function(){return new v});n.resizeArray(this._perimeterLabelSegments,a,function(){return new v})};b.prototype._updatePathSegments=function(a){for(var c=0;c<this._pathSegmentObjects.length;++c)this._updatePathSegment(a,c);this._updateCursorSegment(a)};b.prototype._updatePathSegment=
function(a,c){var h=a.path,b=this._pathSegmentObjects[c];a.validMeasurement||c<h.length-1?(this._updatePathSegmentObject(b,a.positionsRenderCoords[c],a.positionsRenderCoords[(c+1)%h.length],this._origin,this._originTransform,a.intersectingSegments.has(c),this._pathLabelSegments[c],a.validMeasurement?"center":"end"),this._addObject3D(b)):(b.removeAllGeometries(),this._removeObject3D(b))};b.prototype._updateCursorSegment=function(a){a=this._sceneView.renderCoordsHelper;var c=this._model.path,b=this._cursorSegmentObject;
0<c.length&&"drawing"===this._model.state&&this._model.cursorPoint?(a.toRenderCoords(c.back,this._tempStartPosition),a.toRenderCoords(this._model.cursorPoint,this._tempEndPosition),this._updatePathSegmentObject(b,this._tempStartPosition,this._tempEndPosition,this._origin,this._originTransform,!1,this._cursorSegmentLengthLabelSegment,"end"),this._addObject3D(b)):(b.removeAllGeometries(),this._removeObject3D(b))};b.prototype._updatePathSegmentObject=function(a,c,b,d,e,f,g,m){this._createInterpolatedLineGeometry(a,
f?this._intersectingPathLineMaterial:this._pathLineMaterial,"path-segment",c,b,d,e,this._model.measurementMode,g,m)};b.prototype._updatePerimeterSegments=function(a){for(var c=0;c<this._perimeterSegmentObjects.length;++c)this._updatePerimeterSegment(a,c)};b.prototype._updatePerimeterSegment=function(a,c){var b=a.path,d=this._perimeterSegmentObjects[c];a.validMeasurement&&"geodesic"!==this._model.measurementMode?(this._updatePerimeterSegmentObject(d,a.positionsFittedRenderCoords[c],a.positionsFittedRenderCoords[(c+
1)%b.length],this._origin,this._originTransform,a.intersectingSegments.has(c),this._perimeterLabelSegments[c]),this._addObject3D(d)):(d.removeAllGeometries(),this._removeObject3D(d))};b.prototype._updatePerimeterSegmentObject=function(a,c,b,d,e,f,g){this._createInterpolatedLineGeometry(a,f?this._intersectingPerimeterLineMaterial:this._perimeterLineMaterial,"perimeter-segment",c,b,d,e,this._model.measurementMode,g)};b.prototype._updateHandles=function(a){for(var c=0;c<this._vertexHandleObjects.length;++c)this._updateVertexHandle(a,
c);this._updateCursorHandle(a)};b.prototype._updateVertexHandle=function(a,c){var b=this._sceneView._stage.getCamera(),d=this._vertexHandleObjects[c];this._updateHandleObject(d,a.positionsRenderCoords[c],!0,this._model.hoveredVertexHandle===c,this._model.draggedVertices.includes(c),b);this._addObject3D(d)};b.prototype._updateCursorHandle=function(a){a=this._cursorHandleObject;if("drawing"===this._model.state&&this._model.cursorPoint){var c=this._sceneView._stage.getCamera(),b=this._tempHandlePosition;
this._sceneView.renderCoordsHelper.toRenderCoords(this._model.cursorPoint,b);this._updateHandleObject(a,b,!0,!1,!1,c);this._addObject3D(a)}else a.removeAllGeometries(),this._removeObject3D(a)};b.prototype._updateHandleObject=function(a,c,h,d,e,f){a.removeAllGeometries();h&&!e&&this._model.editable&&(n.scaleTranslateMatrix((d?this._params.handleRadiusHovered:this._params.handleRadius)*f.computePixelSizeAt(c),c,this._tempMat4),a.addGeometry(b._handleGeometry,this._handleMaterial,this._tempMat4))};b.prototype._updateArea=
function(a){switch(this._model.measurementMode){case "euclidean":this._updateAreaEuclidean(a);break;case "geodesic":this._updateAreaGeodesic(a)}};b.prototype._updateAreaEuclidean=function(a){var c=this,b=this._areaObject;if(a.validMeasurement&&0===a.intersectingSegments.size&&a.triangleIndices){var d=[],e=f.vec3f64.create();a.positionsFittedRenderCoords.forEach(function(a){f.vec3.subtract(e,a,c._origin);d.push(e[0],e[1],e[2])});var g=[];a.positionsProjected.forEach(function(a){g.push(a[0],a[1])});
var y=new H({position:{size:3,data:d},uv0:{size:2,data:g}},{position:a.triangleIndices,uv0:a.triangleIndices}),y=new C(y,"area");b.removeAllGeometries();b.addGeometry(y,this._checkerBoardMaterial,this._originTransform);this._addObject3D(b);this._checkerBoardMaterial.setParameterValues({size:[a.checkerSize,a.checkerSize]})}else b.removeAllGeometries(),this._removeObject3D(b)};b.prototype._updateAreaGeodesic=function(a){a=this._areaObject;a.removeAllGeometries();this._removeObject3D(a)};b.prototype._updateProjectionLines=
function(a){var c=a.path;this._resizeObject3DArray(this._projectionLineObjects,c.length);for(var b=0;b<c.length;++b)this._updateProjectionLine(a,b);for(var d=Infinity,b=0;b<c.length;++b)d=Math.max(this._sceneView._stage.getCamera().computePixelSizeAt(a.positionsRenderCoords[b])),d=Math.max(this._sceneView._stage.getCamera().computePixelSizeAt(a.positionsFittedRenderCoords[b]));this._projectionLineMaterial.setParameterValues({stippleLength:this._params.projectionLineStippleSize*d})};b.prototype._updateProjectionLine=
function(a,c){var b=this._projectionLineObjects[c];b.removeAllGeometries();if(a.validMeasurement&&"euclidean"===this._model.measurementMode){a=f.vec3f64.create();f.vec3.subtract(a,this._model.viewData.positionsRenderCoords[c],this._origin);var d=f.vec3f64.create();f.vec3.subtract(d,this._model.viewData.positionsFittedRenderCoords[c],this._origin);c=new C(D.createPolylineGeometry([a,d]),"projected-line");b.addGeometry(c,this._projectionLineMaterial,this._originTransform);this._addObject3D(b)}else this._removeObject3D(b)};
b.prototype._updateLabels=function(a){var c=this,b=this._sceneView._stage.getCamera(),d=this._params.labelDistance,e=this._model,g="geodesic"===e.measurementMode,f="drawing"===e.state,m=function(a,b){return a.visible&&b.visible&&c._sceneView.overlay.overlaps(a.textItem,b.textItem)},k=this._areaLabel,l=w.positionLabelOnPoint(k,a.areaCentroid,b);k.text=e.areaLabel;k.visible=l&&a.validMeasurement&&0===a.intersectingSegments.size&&null!=e.areaLabel;k=this._pathLengthLabel;l=w.positionLabelOnCorner(k,
this._pathLabelSegments[a.pathLengthLabelSegmentIndex],this._cursorSegmentLengthLabelSegment,d,b);k.text=e.pathLengthLabel;k.visible=l&&f&&0<e.path.length;k=this._cursorSegmentLengthLabel;l=this._cursorSegmentLengthLabelSegment;l=w.positionLabelOnSegment(k,l,d,"bottom",b);k.text=e.cursorSegmentLengthLabel;k.visible=l&&f&&e.cursorSegmentLength&&0!==e.cursorSegmentLength.value;m(this._cursorSegmentLengthLabel,this._pathLengthLabel)&&(this._cursorSegmentLengthLabel.visible=!1);m(this._pathLengthLabel,
this._areaLabel)&&(this._pathLengthLabel.visible=!1);k=this._perimeterLengthLabel;if(e.validMeasurement&&0===a.intersectingSegments.size)for(f=0;f<a.path.length;++f)if(l=(a.perimeterLengthLabelSegmentIndex+f)%a.path.length,l=g?this._pathLabelSegments[l]:this._perimeterLabelSegments[l],l=w.positionLabelOnSegment(k,l,d,"top",b),k.text=e.perimeterLengthLabel,k.visible=l,m(k,this._areaLabel))k.visible=!1;else break;else k.visible=!1};b.prototype._lastAddedDraggedVertex=function(){var a=this._model.draggedVertices;
return 0<a.length?a.items[a.length-1]:null};b.prototype._getFocusPoint=function(){var a=this._model,b=this._lastAddedDraggedVertex();switch(a.state){case "drawing":return a.cursorPoint?a.cursorPoint:a.path.vertex(null!=b?b:a.path.length-1);case "editing":return null!=b?a.path.vertex(b):null;default:return a.cursorPoint}};b.prototype._updateLaserLine=function(){var a=this._model,b=this._params.laserLineEnabled&&"measured"!==a.state&&a.active;this._laserLineRenderer.focusSphereActive=!1;this._laserLineRenderer.segmentActive=
!1;a=this._getFocusPoint();b&&a?(b=this._tempHandlePosition,this._sceneView.renderCoordsHelper.toRenderCoords(a,b),this._laserLineRenderer.focusPosition=b,this._laserLineRenderer.focusPlaneActive=!0):this._laserLineRenderer.focusPlaneActive=!1};b.prototype._addObject3D=function(a){a.parentLayer||(this._layer.addObject(a),this._sceneView._stage.add(g.ContentType.OBJECT,a))};b.prototype._removeObject3D=function(a){a.parentLayer&&(this._layer.removeObject(a),this._sceneView._stage.remove(g.ContentType.OBJECT,
a.id))};b.prototype._resizeObject3DArray=function(a,b){var c=this;n.resizeArray(a,b,function(){return new q},function(a){c._removeObject3D(a)})};b.prototype._createInterpolatedLineGeometry=function(a,b,h,d,e,g,t,m,k,l){var c=this._sceneView.renderCoordsHelper,r=[],u=[],p=function(a,b){var c=x.sv3d.get();f.vec3.subtract(c,a,g);r.push(c);u.push(b)};if("euclidean"===m){var z=x.sv3d.get();n.midpoint([d,e],z);m=x.sv3d.get();c.worldUpAtPosition(z,m);p(d,m);p(e,m);k&&k.update(d,e,l)}else{d=this._getSegmentInterpolator(d,
e);e=this._params.lineSubdivisions+1&-2;var w=z=null,q=e/2-1,v=e/2;"start"===l?(q=0,v=1):"end"===l&&(q=e-2,v=e-1);for(var A=0;A<e;++A){var y=A/(e-1),B=x.sv3d.get();m=x.sv3d.get();d.eval(y,B);c.worldUpAtPosition(B,m);A===q&&(z=B);A===v&&(w=B);p(B,m)}k&&k.update(z,w,l)}h=new C(D.createPolylineGeometry(r,u),h);a.removeAllGeometries();a.addGeometry(h,b,t)};b.prototype._getSegmentInterpolator=function(a,b){var c=this._sceneView.spatialReference,d=this._sceneView.renderCoordsHelper.spatialReference;return c.isWebMercator||
c.isWGS84?new E.Spherical(a,b,d,d):new E.Linear(a,b)};b.prototype._initializeListeners=function(){var a=this;this._listenerHandles=new F;this._listenerHandles.add([this._model.watch("state",function(){a._updateLaserLine()}),this._model.draggedVertices.on("change",function(){a._updateLaserLine()}),this._model.watch("hoveredVertexHandle",function(){a._updateAfterSyncViewData(function(b){a._updateHandles(b)})}),this._model.draggedVertices.on("change",function(){a._updateAfterSyncViewData(function(b){a._updateHandles(a._model.viewData)})}),
this._model.watch("cursorPoint",function(){a._updateAfterSyncViewData(function(b){a._updateCursorSegment(b);a._updateCursorHandle(b);"drawing"===a._model.state&&a._updateLabels(b);a._updateLaserLine()})}),this._sceneView.state.watch("camera",function(){a._updateAfterSyncViewData(function(b){a._updateCameraDependent(a._model.viewData)})}),this._model.watch(["unit","measurementMode"],function(){a._updateAll(a._model.viewData)}),this._model.watch(["active","editable"],function(){a._updateLaserLine();
a._updateAfterSyncViewData(function(b){a._updateHandles(b)})}),this._model.watch("viewData",function(b){a._syncViewData(b)})])};b.prototype._destroyListeners=function(){this._listenerHandles.destroy();this._listenerHandles=null};b._handleGeometry=new C(D.createSphereGeometry(1,32,32),"handle");return b}();(function(b){var a=function(){return function(){}}();b.PickRequest=a;a=function(){return function(a,b,d){void 0===a&&(a=null);void 0===b&&(b=null);void 0===d&&(d=null);this.type=a;this.scenePoint=
b;this.mapPoint=d}}();b.PickResult=a})(u||(u={}));return u});