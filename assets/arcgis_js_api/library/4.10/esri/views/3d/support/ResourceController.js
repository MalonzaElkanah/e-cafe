// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/Handles ../../../core/now ../../../core/scheduling ./MemoryController ./StreamDataLoader ./StreamDataSupplier ../webgl-engine/lib/Util".split(" "),function(r,t,h,k,l,m,n,p,g){function q(){var a={},b;for(b in e.ClientType)a[e.ClientType[b]]=0;a[e.ClientType.TERRAIN]=15;a[e.ClientType.SCENE]=20;a[e.ClientType.SYMBOLOGY]=5;return new n(a)}var e=function(){function a(b,c,f){void 0===c&&(c=l);void 0===f&&(f=k);var d=this;this._view=b;this._memoryController=this._budget=
null;this._streamDataLoader=q();this._frameWorkers=[];this._nextFrameWorker=0;this._idleWorkers=[];this._nextIdleWorker=0;this._forceFrameWorker=this._idleUpdatesStartFired=!1;this._lastTargetChangeTime=0;this._handles=new h;this._frameTask=null;this.idleTimeout=300;this.idleBudget=100;this._budget=new a.Budget(f);this._lastTargetChangeTime=f();this._memoryController=new m(this._view);this._debug={memoryController:this._memoryController,idleOff:!1};this._handles.add(this._view.watch("state.camera",
function(){return d.cameraChangedHandler()},!0));this._frameTask=c.addFrameTask({update:function(b){return d.frameUpdate(b)}})}a.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this._handles.remove();this._streamDataLoader&&(this._streamDataLoader.destroy(),this._streamDataLoader=null)};Object.defineProperty(a.prototype,"enableBudget",{set:function(b){this._budget.enabled=b},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"updating",
{get:function(){return this._memoryController.updating},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxGpuMemory",{set:function(b){this._memoryController.setMaxGpuMemory(b)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"additionalCacheMemory",{set:function(b){this._memoryController.setAdditionalCacheMemory(b)},enumerable:!0,configurable:!0});a.prototype.setMemoryDirty=function(){this._memoryController.setDirty()};Object.defineProperty(a.prototype,"memoryFactor",
{get:function(){return this._memoryController.getMemoryFactor()},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"usedMemory",{get:function(){return this._memoryController.getUsedMemory()},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"memoryEvents",{get:function(){return this._memoryController.events},enumerable:!0,configurable:!0});a.prototype.getMemCache=function(b,c){return this._memoryController.getMemCache(b,c)};a.prototype.getStreamDataSupplier=function(b,
c){return new p(b,this._streamDataLoader,c)};a.prototype.registerIdleFrameWorker=function(b){var c=this;g.assert(!b.idleFrame||b.needsUpdate,"needsUpdate has to be specified if idleFrame is specified");var a={callbacks:b};this.addIdleFrameWorker(a);return{remove:function(){c.removeIdleFrameWorker(a)}}};a.prototype.registerFrameWorker=function(b,c){var a=this,d={callback:b,needsUpdate:c||function(){return!0}};this.addFrameWorker(d);return{remove:function(){return a.removeFrameWorker(d)}}};a.prototype.addIdleFrameWorker=
function(b){this._idleWorkers.push(b);this.isIdle()&&this._idleUpdatesStartFired&&b.callbacks.idleBegin&&b.callbacks.idleBegin()};a.prototype.removeIdleFrameWorker=function(b){var c=this._idleWorkers,a=c.indexOf(b);g.assert(0<=a,"worker not registered");this._idleUpdatesStartFired&&b.callbacks.idleEnd&&b.callbacks.idleEnd();c.splice(a,1);this._nextIdleWorker>=c.length&&(this._nextIdleWorker=0)};a.prototype.addFrameWorker=function(b){this._frameWorkers.push(b)};a.prototype.removeFrameWorker=function(b){var c=
this._frameWorkers;b=c.indexOf(b);g.assert(0<=b,"worker not registerted");c.splice(b,1);this._nextFrameWorker>=this._frameWorkers.length&&(this._nextFrameWorker=0)};a.prototype.cameraChangedHandler=function(){this._lastTargetChangeTime=this._budget.now();this.setMemoryDirty();this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this.callIdleFrameWorkersEnd())};a.prototype.frameUpdate=function(b){var c=b.frameDuration>1.5*b.tickTime?b.tickTime:5,c=this.isIdle()?0:c,a=b.frameDuration-b.elapsedFrameTime-
c,d=this.idleBudget-b.elapsedFrameTime;this._debug.idleOff&&(d=a);a=Math.max(this.isIdle()?d:a,5);this._budget.reset(a);this._view.stateManager&&this._view.stateManager.step(b.deltaTime/1E3);if(a<c&&!this._forceFrameWorker)this._forceFrameWorker=!0;else{this._forceFrameWorker=!1;this._memoryController.update();b=!1;for(a=0;a<this._frameWorkers.length;++a){d=(this._nextFrameWorker+a)%this._frameWorkers.length;if(b&&this._budget.remaining()<c){this._nextFrameWorker=d%this._frameWorkers.length;return}d=
this._frameWorkers[d];this._budget.resetProgress();d.needsUpdate(this._budget)&&(b=!0,d.callback(this._budget))}this.isIdle()&&!this._budget.done()&&(this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this.callIdleFrameWorkersBegin()),this.callIdleFrameWorkers())}};a.prototype.isIdle=function(){return this._budget.now()-this._lastTargetChangeTime>this.idleTimeout};a.prototype.callIdleFrameWorkersBegin=function(){this._idleWorkers.forEach(function(b){b.callbacks.idleBegin&&b.callbacks.idleBegin()})};
a.prototype.callIdleFrameWorkersEnd=function(){this._idleWorkers.forEach(function(b){b.callbacks.idleEnd&&b.callbacks.idleEnd()})};a.prototype.callIdleFrameWorkers=function(){for(var b=0;b<this._idleWorkers.length;++b){var a=(this._nextIdleWorker+b)%this._idleWorkers.length;if(this._budget.done()){this._nextIdleWorker=a;break}a=this._idleWorkers[a];a.callbacks.needsUpdate&&a.callbacks.needsUpdate()&&(this._budget.resetProgress(),a.callbacks.idleFrame(this._budget))}};Object.defineProperty(a.prototype,
"debug",{get:function(){return this._debug},enumerable:!0,configurable:!0});return a}();(function(a){(function(a){a.TERRAIN="terrain";a.SCENE="scene";a.SYMBOLOGY="symbology"})(a.ClientType||(a.ClientType={}));var b=function(){function a(a){this._nowFunc=a;this.enabled=!0;this.budget=this.begin=0;this._didWork=!1}a.prototype.now=function(){return this._nowFunc()};a.prototype.reset=function(a){this.begin=this.now();this.budget=this.enabled?a:Number.MAX_VALUE;this._didWork=!1};a.prototype.done=function(){return this.enabled&&
this.elapsed()>=this.budget};a.prototype.doneWithProgress=function(){return this.done()&&this._didWork};a.prototype.remaining=function(){return this.enabled?Math.max(this.budget-this.elapsed(),0):Number.POSITIVE_INFINITY};a.prototype.elapsed=function(){return this.now()-this.begin};a.prototype.run=function(a){if(this.done())return!1;a();return!0};a.prototype.runWithProgress=function(a){if(this.doneWithProgress())return!1;!0===a()&&(this._didWork=!0);return!0};a.prototype.resetProgress=function(){this._didWork=
!1};a.prototype.madeProgress=function(){this._didWork=!0};Object.defineProperty(a.prototype,"hasProgressed",{get:function(){return this._didWork},enumerable:!0,configurable:!0});return a}();a.Budget=b})(e||(e={}));return e});