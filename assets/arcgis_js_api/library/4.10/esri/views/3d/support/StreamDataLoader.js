// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../request ../../../core/arrayUtils ../../../core/lang ./AsyncQuotaRoundRobinQueue ./PromiseLightweight ../webgl-engine/lib/Performance ../webgl-engine/lib/Util".split(" "),function(t,u,l,m,n,p,q,k,r){var f;(function(a){a[a.QUEUED=1]="QUEUED";a[a.DOWNLOADING=2]="DOWNLOADING";a[a.CANCELLED=4]="CANCELLED"})(f||(f={}));return function(){function a(b){this.tasks=new Map;this.clientPromiseToTask=new Map;this.loadQueue=new p(this.startLoading.bind(this),this.doneLoadingCallback,
this,b)}a.prototype.destroy=function(){var b=this;this.tasks.forEach(function(c){for(var g=0,a=c.clientPromises;g<a.length;g++){var d=a[g];d.isRejected()||d.reject(c.url,null);b.cancelTask(d)}});this.loadQueue.clear();this.clientPromiseToTask=this.tasks=this.loadQueue=null};a.prototype.request=function(b,c,a){var g=this,d=new q.Promise(function(){g.cancel(d)});this.createOrUpdateTask(b,c,a,d);return d};a.prototype.createTask=function(b,c,a,e,d){b={url:b,docType:c,clientType:a,key:e,result:null,status:f.QUEUED,
clientPromises:[],downloadObj:null,_cancelledInQueue:!1,startTime:0,duration:0,size:0};this.updateTask(b,d);this.tasks.set(e,b);this.loadQueue.push(b)};a.prototype.cancel=function(b){this.cancelTask(b)};a.prototype.hasPendingDownloads=function(){return 0<this.tasks.size};Object.defineProperty(a.prototype,"tests",{get:function(){return{loadQueue:this.loadQueue}},enumerable:!0,configurable:!0});a.prototype.taskKey=function(b,c,a){return b+":"+c+":"+a};a.prototype.updateTask=function(b,c){this.clientPromiseToTask.set(c,
b);b.clientPromises.push(c)};a.prototype.createOrUpdateTask=function(b,c,a,e){var d=this.taskKey(b,c,a),g=this.tasks.get(d);g?this.updateTask(g,e):this.createTask(b,c,a,d,e)};a.prototype.cancelTask=function(b){var a=this.clientPromiseToTask.get(b);a&&(m.removeUnordered(a.clientPromises,b),this.clientPromiseToTask.delete(b),0===a.clientPromises.length&&(a.status===f.DOWNLOADING&&(this.loadQueue.workerCancelled(a),a.status=f.CANCELLED,a.downloadObj.cancel(),a.downloadObj=null),a.status=f.CANCELLED,
this.tasks.delete(a.key)))};a.prototype.doneLoadingCallback=function(b,a){r.assert(b.status===f.DOWNLOADING);for(var c=b.result,e=0,d=b.clientPromises;e<d.length;e++){var h=d[e];this.clientPromiseToTask.delete(h);a?h.isRejected()||h.reject(b.url,a):(c||(c=n.clone(b.result)),h.done(b.url,c),c instanceof HTMLImageElement||(c=null))}this.tasks.delete(b.key)};a.prototype.startLoading=function(b,a){if(b.status===f.CANCELLED)return!1;b.status=f.DOWNLOADING;var c,e;switch(b.docType){case "binary":e="array-buffer";
c=0;break;case "image":e="image";break;default:e="json"}b.startTime=k.now();b.downloadObj=l(b.url,{responseType:e,timeout:c});b.downloadObj.then(function(c){b.duration=k.now()-b.startTime;b.size="binary"===b.docType?c.data.byteLength:0;b.result=c.data;a(b)},function(c){b.downloadObj.isCanceled()||a(b,c)});return!0};return a}()});