// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/libs/gl-matrix-2/gl-matrix ./TerrainConst ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../webgl-engine/shaders/MiscPrograms ../../vectorTiles/tileRendererHelper3D ../../vectorTiles/VectorTileDisplayObject ../../webgl/BufferObject ../../webgl/FramebufferObject ../../webgl/Texture ../../webgl/Util ../../webgl/VertexArrayObject".split(" "),function(J,K,r,w,B,C,t,D,E,F,G,H,v,z,I){function x(g){return g instanceof
HTMLImageElement||g instanceof HTMLCanvasElement}var A=Array(20),y=[0,0];return function(){function g(a,c,b,d,f){this._blackTex=this._backgroundTex=null;this.tileSize=256;this._context=a;this.tileSize=c;this._resourceCounter=d;this._setNeedsRender=f;a.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,a.parameters.maxMaxAnisotropy));c=new Float32Array(20);c[0]=-1;c[1]=-1;c[2]=0;c[3]=0;c[4]=0;c[5]=1;c[6]=-1;c[7]=0;c[8]=1;c[9]=0;c[10]=-1;c[11]=1;c[12]=0;c[13]=0;c[14]=1;c[15]=1;c[16]=
1;c[17]=0;c[18]=1;c[19]=1;this._vaoQuad=new I(a,B.Default3D,{geometry:C.Pos3Tex},{geometry:G.createVertex(a,35044,c)});this._blendLayersProgram=b.getProgram(D.blendLayers);this._blackTex=t.createColorTexture(this._context,[0,0,0,1])}g.prototype.dispose=function(){this._fbo&&(this._fbo.dispose(),this._fbo=null);this._vtFBO&&(this._vtFBO.dispose(),this._vtFBO=null);this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null);this._backgroundTex&&(this._backgroundTex.dispose(),this._backgroundTex=null);
this._blackTex&&(this._blackTex.dispose(),this._blackTex=null);this._blendLayersProgram&&(this._blendLayersProgram.dispose(),this._blendLayersProgram=null);this._context&&(this._context=null)};g.prototype.updateTileTexture=function(a){for(var c=w.LayerClass.MAP,b=a.layerInfo[c],d=0;d<b.length;d++)b[d].pendingUpdates&=~w.TileUpdateTypes.UPDATE_TEXTURE;if(a.renderData){for(var d=a.renderData,f=a.parentSurface,g=f.baseOpacity,n=0,l=!1,e=b.length-1,p=b.length,m=0;m<b.length;m++){var k=b[m],h=f.layerViewByIndex(m,
c),u=h.fullOpacity;A[m]=u;this._isBaseLayer(h.layer)&&p>=b.length&&(p=m);if(k.data||k.upsampleFromTile)if(n++,h.isOpaque&&1===u){l=!0;e=m;break}}0===n&&this._backgroundTex?(d.opacity=g,d.textureReference=this._backgroundTex,r.vec4.set(d.texOffsetAndScale,0,0,1,1)):1===n&&l?(k=b[e],f=b=void 0,k.data?(b=k,r.vec4.set(d.texOffsetAndScale,0,0,1,1)):(f=k.upsampleFromTile,b=f.tile.layerInfo[c][e],r.vec4.set(d.texOffsetAndScale,f.offset[0],f.offset[1],f.scale,f.scale)),d.opacity=g,b&&(x(b.data)&&(b.data=
this._buildTexture(b.data),f?f.tile.updateMemoryUsed():a.updateMemoryUsed()),b.data instanceof v&&(d.textureReference=b.data))):(d.opacity=this._composeMapLayers(a,b,e,p,l,A),d.textureReference=null,r.vec4.set(d.texOffsetAndScale,0,0,1,1));this._setNeedsRender()}};g.prototype.setBackground=function(a){x(a)?this._backgroundTex=this._buildTexture(a):this._backgroundTex=t.createColorTexture(this._context,a||[0,0,0,0])};g.prototype._buildTexture=function(a){var c={target:3553,pixelFormat:6408,dataType:5121,
wrapMode:33071,samplingMode:9729,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},b=this._context,d;if(a)try{d=new v(b,c,a)}catch(f){d=t.createEmptyTexture(b),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}else c.width=c.height=this.tileSize,d=new v(b,c);b.bindTexture(d);d.generateMipmap();return d};g.prototype._bindFBO=function(a,c,b,d){a&&a.width===c&&a.height===b||(a&&a.dispose(),a=H.create(this._context,{colorTarget:0,depthStencilTarget:d?
1:0,width:c,height:b}));this._context.bindFramebuffer(a);return a};g.prototype._drawRasterData=function(a,c,b,d){void 0===d&&(d=1);var f=this._context,g=this._blendLayersProgram,n=this._vaoQuad;f.bindProgram(g);f.bindVAO(n);z.assertCompatibleVertexAttributeLocations(n,g);f.bindTexture(a,0);g.setUniform1i("tex",0);g.setUniform1f("scale",c);g.setUniform2f("offset",b[0],b[1]);g.setUniform1f("opacity",d);f.drawArrays(5,0,z.vertexCount(n,"geometry"))};g.prototype._composeMapLayers=function(a,c,b,d,f,g){a.renderData.texture||
(a.renderData.texture=this._buildTexture(),a.updateMemoryUsed());var n=w.LayerClass.MAP,l=a.renderData.texture,e=this._context;this._fbo=this._bindFBO(this._fbo,l.descriptor.width,l.descriptor.height,!1);var p=e.gl;e.setViewport(0,0,this.tileSize,this.tileSize);e.setClearColor(0,0,0,0);e.setClearDepth(1);e.clear(p.COLOR_BUFFER_BIT);e.setDepthTestEnabled(!1);e.setBlendFunction(1,771);e.setBlendEquation(32774);e.setBlendingEnabled(!0);!f&&this._backgroundTex&&this._drawRasterData(this._backgroundTex,
1,y);f=a.parentSurface.baseOpacity;for(var m=!1;0<=b;b--){var k=c[b],h=k,u=a.lij,r=y,q=1;!k.data&&k.upsampleFromTile&&(q=k.upsampleFromTile,u=q.tile.lij,h=q.tile.layerInfo[n][b],r=[q.offset[0],q.offset[1]],q=q.scale);if(h){b<d&&1>f&&!m&&(e.setBlendFunction(0,770),this._drawRasterData(this._blackTex,1,y,f),e.setBlendFunction(1,771),m=!0);if(h.data instanceof F){var t=a.parentSurface.layerViewByIndex(b,n);this._vtFBO=this._bindFBO(this._vtFBO,this.tileSize,this.tileSize,!0);e.setClearColor(1,1,1,0);
e.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);E(this._context,u,h.data,t.renderer,t.schemaHelper,l.descriptor.width,l.descriptor.height);h.data.dispose();h.data=this._buildTexture();e.bindTexture(h.data);p.copyTexImage2D(e.gl.TEXTURE_2D,0,h.data.descriptor.pixelFormat,0,0,this.tileSize,this.tileSize,0);h.data.generateMipmap();e.bindFramebuffer(this._fbo);h===k?a.updateMemoryUsed():k.upsampleFromTile.tile.updateMemoryUsed()}else x(h.data)&&(h.data=this._buildTexture(h.data),h===k?a.updateMemoryUsed():
k.upsampleFromTile.tile.updateMemoryUsed());h.data instanceof v&&this._drawRasterData(h.data,q,r,g[b])}}e.bindTexture(l);p.copyTexImage2D(e.gl.TEXTURE_2D,0,l.descriptor.pixelFormat,0,0,l.descriptor.width,l.descriptor.height,0);l.generateMipmap();e.bindFramebuffer(null);e.setBlendFunctionSeparate(770,771,1,771);e.setBlendingEnabled(!1);this._resourceCounter.incrementNumTileTexturesComposited();return m?1:f};g.prototype._isBaseLayer=function(a){return a.parent&&"esri.Basemap"===a.parent.declaredClass&&
-1<a.parent.baseLayers.indexOf(a)};return g}()});