// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../Color ../../../core/ObjectPool ../../../core/PooledArray ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/gl-matrix ../../../geometry/support/aaBoundingBox ../support/imageUtils ./ResourceCounter ./TerrainConst ./TileGeometryFactory ./TileRenderData ./TileRenderer ./tileUtils ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/tracer ../webgl-engine/lib/Util ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/TerrainRendererPrograms ../../webgl/BufferObject ../../webgl/Util ../../webgl/VertexArrayObject".split(" "),
function(K,ma,na,S,L,C,E,k,F,T,U,M,V,W,X,y,Y,Z,aa,ba,G,ca,z,m,N,O,da){function P(b){return function(a,d){a=a.screenDepth;d=d.screenDepth;return a<d?-b:a>d?b:0}}function ea(b){var a=P(b);return function(d,e){return 0===d.tiles.length?-b:0===e.tiles.length?b:a(d.tiles.data[0],e.tiles.data[0])}}var fa=ca.assert,H=k.mat4f64.create(),Q=k.vec3f64.create(),I=k.vec2f64.create(),J=F.create(),w=k.vec4f64.create(),B=k.vec4f64.create(),R=k.vec4f64.create(),ga=function(){return function(){this.extent=k.vec4f64.create();
this.maxLevel=this.minLevel=0;this.callback=null}}();K=function(){function b(a,d){this.initialized=!1;this.rctx=null;this.renderDataPool=new L(W.TileRenderData);this.perOriginTileData=new C({allocator:function(a){return a||{root:null,origin:null,tiles:new C}},deallocator:function(a){a.root=null;a.origin=null;a.tiles.clear();return a}});this.perOriginTileDataDirty=!0;this.tileIterator=new y.IteratorPreorder;this.highestVisibleLODTile=null;this.visible=!0;this.debugScreenSizePerspective=!1;this.wireframe=
z.copyParameters(ha);this._opaque=!0;this._skirtScale=1;this._cullBackFaces=this._disableRendering=this._drawBorders=!1;this._renderOrder=1;this._velvetOverground=!0;this._slicePlaneEnabled=this._hasOverlays=!1;this.castShadows=!0;this.receiveShadows=!1;this.backgroundPromise=this.tileRenderer=this.emptyTex=null;this.tileBackgroundInitialized=!1;this.stencilEnabledLayerExtents=[];this.numOriginsRendered=this.numTilesCulled=this.numTilesRendered=this.numTrianglesRendered=0;this.resourceCounter=new U;
this.loaded=this.clippingExtent=null;this._loaded=!1;this.needsRender=!0;this.needsHighlight=this.didRender=!1;this.visibleScaleRangeQueries=new C({initialSize:10});this.visibleScaleRangeQueriesInvPtr=0;this.visibleScaleRangeQueryQueue=new C({initialSize:30});this.visibleScaleRangeQueryPool=new L(ga,!1);this.manifold=a;this.tileSize=d||256}b.prototype.destroy=function(a){this.uninstall(a);this.backgroundPromise&&(this.backgroundPromise.cancel(),this.backgroundPromise=null)};b.prototype.install=function(a){a.addRenderPlugin([3,
8],this);this.drapedRenderer=a.getDrapedTextureRenderer()};b.prototype.uninstall=function(a){a.removeRenderPlugin(this)};Object.defineProperty(b.prototype,"disableRendering",{set:function(a){this._disableRendering=!!a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"opaque",{set:function(a){this._opaque=a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"skirtScale",{set:function(a){this._skirtScale=a;this.setNeedsRender()},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"drawBorders",{set:function(a){this._drawBorders!==a&&(this._drawBorders=a,this._updatePrograms())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"cullBackFaces",{set:function(a){this._cullBackFaces=a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderOrder",{set:function(a){this._renderOrder=a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"velvetOverground",{set:function(a){this._velvetOverground!==a&&(this._velvetOverground=a,this._updatePrograms())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._updatePrograms())},enumerable:!0,configurable:!0});b.prototype.setRootTiles=function(a){this.rootTiles=a;this.setNeedsRender()};b.prototype.setNeedsHighlight=function(a){this.needsHighlight=
a;this.setNeedsRender()};b.prototype.setStencilEnabledLayerExtents=function(a){this.stencilEnabledLayerExtents=a;this.setNeedsRender()};b.prototype.setTileSize=function(a){this.tileSize=a;this.tileRenderer&&(this.tileRenderer.tileSize=a);this.setNeedsRender()};b.prototype.loadTile=function(a){fa(null===a.renderData);a.renderData=this.renderDataPool.acquire();a.renderData.init();var d=this.getLocalOriginOfTile(a);a.createGeometry(a.renderData.updateGeometryState(a),d,"debug"===this.wireframe.mode);
a.renderData.localOrigin=d;this._updateTileGeometryBuffers(a);this.tileBackgroundInitialized&&this.tileRenderer.updateTileTexture(a)};b.prototype.queryVisibleLevelRange=function(a,d,e,c){var h=this.visibleScaleRangeQueryPool.acquire();k.vec4.copy(h.extent,a);h.minLevel=d?d:-Number.MAX_VALUE;h.maxLevel=null!=e?e:Number.MAX_VALUE;h.callback=c;this.visibleScaleRangeQueryQueue.push(h);this.setNeedsRender()};b.prototype.updateTileTexture=function(a){this.tileRenderer&&this.tileBackgroundInitialized&&this.tileRenderer.updateTileTexture(a)};
b.prototype.updateTileGeometry=function(a){a.renderData.updateGeometryState(a);for(var d=a.renderData.geometryState,e=a.layerInfo[M.LayerClass.ELEVATION],c=0;c<e.length;c++)e[c].pendingUpdates&=~M.TileUpdateTypes.UPDATE_GEOMETRY;return d.needsUpdate?(a.renderData.vao&&this._releaseTileGeometry(a),a.createGeometry(d,a.renderData.localOrigin,"debug"===this.wireframe.mode),this._updateTileGeometryBuffers(a),!0):!1};b.prototype.unloadTile=function(a){this._releaseTileGeometry(a);a.renderData.texture&&
a.renderData.texture.dispose();this.renderDataPool.release(a.renderData);a.renderData=null;a.updateMemoryUsed()};b.prototype.getLocalOriginOfTile=function(a){if(10<=a.lij[0]){for(;7<a.lij[0];)a=a.parent;return a.centerAtSeaLevel}if("spherical"===this.manifold)return Q;for(;a.parent;)a=a.parent;return a.centerAtSeaLevel};b.prototype.setVisibility=function(a){this.visible=a;this.setNeedsRender()};b.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,
numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}};b.prototype.getWireframeEnabled=function(){return"shader"===this.wireframe.mode};b.prototype.setDebugScreenSizePerspective=function(a){a!==this.debugScreenSizePerspective&&(this.debugScreenSizePerspective=a,this._updatePrograms())};b.prototype.setWireframe=function(a){var d=this;if(!1===a||!0===a)a={mode:a?"shader":"none"};var e=this.wireframe;if(void 0!==a.mode&&e.mode!==a.mode){var c="debug"===e.mode,h="debug"===
a.mode;e.mode=a.mode;this._updatePrograms();c!==h&&this.rootTiles&&y.traverseTilesPreorder(this.rootTiles,function(a){a.renderData&&(a.renderData.vao&&d._releaseTileGeometry(a),a.createGeometry(a.renderData.updateGeometryState(a),a.renderData.localOrigin,h),d._updateTileGeometryBuffers(a))})}for(var b in a)e.hasOwnProperty(b)&&(e[b]=a[b]),this.setNeedsRender();e.resolution&&(e.resolution=Math.min(e.resolution,this.tileSize),e.resolution=1<<Math.round(Math.log(e.resolution)/Math.LN2))};b.prototype.setNeedsRender=
function(){this.needsRender=!0;this.didRender=!1;this.perOriginTileDataDirty=!0};b.prototype.resetNeedsRender=function(){this.didRender&&(this.needsRender=0!==this.visibleScaleRangeQueryQueue.length,this.didRender=!1)};b.prototype.isOpaqueExcludingSlice=function(){var a=this.wireframe,a="shader"===a.mode&&(1>a.wireOpacity||1>a.surfaceOpacity);return this._opaque&&!a};b.prototype.isOpaque=function(){return this.isOpaqueExcludingSlice()&&!this._slicePlaneEnabled};b.prototype.updateTileBackground=function(a){this.backgroundPromise&&
this.backgroundPromise.cancel();this.backgroundPromise="string"===typeof a?T.requestImage(a).catch(function(){return null}):null!=a?E.resolve(S.toUnitRGBA(a)):E.resolve(null);this._renderTileBackground()};b.prototype.initializeRenderContext=function(a){var d=this,e=this.rctx=a.rctx;a=this.programRep=a.programRep;var c=function(a){E.when(a).then(function(){d.initialized=!0;d.setNeedsRender()}).catch(c)};c(this._renderTileBackground());this.programs={color:null,normal:null,depth:null,depthShadowMap:null,
highlight:null};this._updatePrograms();this.tileRenderer=new X(e,this.tileSize,a,this.resourceCounter,this.setNeedsRender.bind(this));this._renderTileBackground();this.emptyTex=aa.createEmptyTexture(e)};b.prototype.uninitializeRenderContext=function(a){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null);this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)};b.prototype.render=function(a){var d=a.rctx,e=d.gl;if(!this.initialized||this._disableRendering||!this.visible||
!this.rootTiles||!this.tileBackgroundInitialized)return!1;var c=this.isOpaque()?3:8;if(a.slot!==c)return!1;G.trace("# BEGIN RENDER TERRAIN");c=a.pass;d.setFaceCullingEnabled(this._cullBackFaces);var b=1===a.lightingData.helper.globalFactor;0===c?this._renderMaterialPass(a,this._updatePerOriginTileData()):3===c&&this.castShadows&&b?this._renderDepthPass(a,this.programs.depthShadowMap,this._updatePerOriginTileData()):1===c?this._renderDepthPass(a,this.programs.depth,this._updatePerOriginTileData()):
2===c?this._renderNormalPass(a,this._updatePerOriginTileData()):4===c&&this.needsHighlight&&(this._renderHighlightPass(a,this._updatePerOriginTileData()),d.clear(e.DEPTH_BUFFER_BIT));this._cullBackFaces&&d.setFaceCullingEnabled(!1);G.trace("# END RENDER TERRAIN");return!0};b.prototype.intersect=function(a,d,e,c,b){if(this.rootTiles&&(!a.isSelection||this.isOpaqueExcludingSlice())&&a.enableTerrain){var h=ia,g=ja;k.vec3.subtract(h,c,e);k.vec3.set(g,1/h[0],1/h[1],1/h[2]);var n=a.minResult,p=a.maxResult,
r=this.clippingExtent,v=this.tileIterator;v.reset(this.rootTiles);b=function(){var b=v.next();if(null===b.renderData)return"continue";if(a.enableInvisibleTerrain){if(!b.visible&&r&&!b.intersectsExtent(r))return"continue"}else if(!b.visible)return"continue";var f=b.renderData.geometryInfo,l=b.renderData.localOrigin,u=ka;k.vec3.subtract(u,e,l);var x=-q._skirtScale*f.skirtLength;if(0!==x){var A=b.tileUp;F.offset(f.boundingBox,x*A[0],x*A[1],x*A[2],J);F.expandWithBuffer(J,f.boundingBox,0,2)}if(!z.intersectAabbInvDir(0!==
x?J:f.boundingBox,u,g,a.tolerance))return"continue";var A=function(f,g,l){if(0<=f&&(a.enableBackfacesTerrain||0>k.vec3.dot(g,h))&&(a.enableInvisibleTerrain||!a.isSelection||null==d||d(e,c,f))){l=void 0;if(void 0===n.dist||f<n.dist)l=y.tile2str(b),n.set(void 0,l,f,g,H,void 0),n.setIntersector("TerrainRenderer");if(void 0===p.dist||f>p.dist)l=y.tile2str(b),p.set(void 0,l,f,g,H,void 0),p.setIntersector("TerrainRenderer")}},m=la;k.vec3.subtract(m,c,l);var l=f.indices,w={data:f.vertexAttributes,size:3,
offsetIdx:0,strideIdx:5},f=f.numWithoutSkirtIndices/3;z.intersectTriangles(u,m,0,f,l,w,null,A);0!==x&&y.intersectSkirts(u,m,f,l.length/3,l,w,null,"spherical"===q.manifold?function(a){return k.vec3.scale(a,a,x/k.vec3.length(a))}:function(a){return k.vec3.set(a,0,0,x)},A)};for(var q=this;!v.done;)b()}};b.prototype._renderTileBackground=function(){var a=this;if(this.rctx&&this.backgroundPromise&&this.tileRenderer)return this.backgroundPromise.then(function(d){a.tileRenderer&&(a.tileBackgroundInitialized=
!0,a.tileRenderer.setBackground(d),a.rootTiles&&y.traverseTilesPreorder(a.rootTiles,function(d){a.tileRenderer.updateTileTexture(d)}))})};b.prototype._updatePrograms=function(){var a="spherical"===this.manifold,d=a?"global":"local",e="shader"===this.wireframe.mode,c=this.programRep;this.programs.color=c.getProgram(m.colorPass,{viewingMode:d,mode:e||this._drawBorders?"wireframe":"normal",spherical:a,overlay:this._hasOverlays,atmosphere:a&&this._velvetOverground,wireframeTexture:e,tileBorders:this._drawBorders,
receiveShadows:this.receiveShadows,screenSizePerspective:this.debugScreenSizePerspective,slice:this._slicePlaneEnabled});this.programs.normal=c.getProgram(m.normalPass,{viewingMode:d,spherical:a,alphaZero:!0});this.programs.depth=c.getProgram(m.depthPass,{viewingMode:d,spherical:a,shadowMap:!1});this.programs.depthShadowMap=c.getProgram(m.depthPass,{viewingMode:d,spherical:a,shadowMap:!0});this.programs.highlight=c.getProgram(m.highlightPass,{viewingMode:d,spherical:a});this.setNeedsRender()};b.prototype._renderMaterialPass=
function(a,d){var e=this,c=a.shadowMap&&a.shadowMap.enabled,b=a.rctx;this.receiveShadows!==c&&(this.receiveShadows=c,this._updatePrograms());c=!this.drapedRenderer.isEmpty();c!==this._hasOverlays&&(this._hasOverlays=c,this._updatePrograms());c=a.camera;b.setDepthTestEnabled(!0);var f=this.wireframe,g=this.programs.color;b.bindProgram(g);if("shader"===f.mode||this._drawBorders)g.setUniform1f("wireframe.width",this.wireframe.width),g.setUniform1f("wireframe.falloff",Math.min(f.width,f.falloff)),g.setUniform1f("wireframe.wireOpacity",
f.wireOpacity),g.setUniform1f("wireframe.surfaceOpacity",f.surfaceOpacity),g.setUniform4fv("wireframe.color",f.color);a.shadowMap&&a.shadowMap.bind(g);a.ssaoHelper&&a.ssaoHelper.setUniforms(g);g.setUniform1i("tex",0);g.setUniform1i("overlay0Tex",1);g.setUniform1i("overlay1Tex",2);g.setUniformMatrix4fv("viewNormal",c.viewInverseTransposeMatrix);g.setUniformMatrix4fv("proj",c.projectionMatrix);a.lightingData.helper.setUniforms(g,!0);b=c.viewMatrix;k.vec3.set(D,b[12],b[13],b[14]);k.vec3.normalize(D,
D);g.setUniform3fv("viewDirection",D);this.numOriginsRendered=this.numTrianglesRendered=this.numTilesCulled=this.numTilesRendered=0;this._prepareScaleRangeQueries();this.isOpaque()?this._renderTiles(a,g,d):a.offscreenRenderingHelper.renderToTargets(function(){return e._renderTiles(a,g,d)},a.offscreenRenderingHelper.tmpColor,a.offscreenRenderingHelper.mainDepth,[0,0,0,0]);this._processScaleRangeQueries();0<this.numTilesRendered&&!this._loaded&&(this._loaded=!0,this.loaded&&this.loaded())};b.prototype._renderDepthPass=
function(a,d,b){var c=a.rctx,e=a.camera;c.bindProgram(d);c.setBlendingEnabled(!1);c.setDepthTestEnabled(!0);d.setUniformMatrix4fv("model",H);d.setUniformMatrix4fv("viewNormal",e.viewInverseTransposeMatrix);I[0]=e.near;I[1]=e.far;d.setUniform2fv("nearFar",I);this._renderTilesAuxiliary(a,d,b,!1)};b.prototype._renderNormalPass=function(a,d){var b=a.rctx,c=a.camera,h=this.programs.normal;b.bindProgram(h);b.setBlendingEnabled(!1);b.setDepthTestEnabled(!0);h.setUniformMatrix4fv("viewNormal",c.viewInverseTransposeMatrix);
this._renderTilesAuxiliary(a,h,d,!1)};b.prototype._renderHighlightPass=function(a,d){var b=a.rctx,c=this.programs.highlight;b.bindProgram(c);b.setBlendingEnabled(!1);b.setDepthTestEnabled(!0);var h=a.offscreenRenderingHelper;b.bindTexture(h.depthTexture,3);c.setUniform1i("depthTex",3);c.setUniform4f("highlightViewportPixelSz",0,0,1/h.width,1/h.height);this._renderTilesAuxiliary(a,c,d,!0)};b.prototype._updatePerOriginTileData=function(){var a=this.perOriginTileData;if(!this.perOriginTileDataDirty)return a;
this.highestVisibleLODTile=null;a.clear();this._renderCollectOrigins(a);if(0!==this._renderOrder){for(var d=P(this._renderOrder),b=0;b<a.length;b++)this._sortFrontToBack(a.data[b].tiles,d);d=ea(this._renderOrder);this._sortFrontToBack(a,d)}this.perOriginTileDataDirty=!1;return a};b.prototype._renderCollectOrigins=function(a){for(var d=this.rootTiles,b="spherical"===this.manifold,c=0;c<d.length;c++){var h=d[c],f=a.pushNew();f.root=h;f.origin=b?Q:h.centerAtSeaLevel;f.tiles.clear();this._renderCollectOriginsForRoot(a,
f)}};b.prototype._renderCollectOriginsForRoot=function(a,d){var b=this.tileIterator;for(b.resetOne(d.root);!b.done;){var c=b.next(),h=c.renderData;if(h&&!c.visible)this.numTilesCulled++,b.skipSubtree();else{var f=a.back();if(7===c.lij[0]){if(f===d||0!==f.tiles.length)f=a.pushNew(),f.tiles.clear();f.root=c;f.origin=c.centerAtSeaLevel}if(h){10<=c.lij[0]?a.back().tiles.push(c):d.tiles.push(c);if(!this.highestVisibleLODTile||c.vlevel>this.highestVisibleLODTile.vlevel)this.highestVisibleLODTile=c;b.skipSubtree()}}}};
b.prototype._sortFrontToBack=function(a,b){a.sort(b)};b.prototype._scaleQueriesForTile=function(a){var b=a.extent;a=a.lij[0];for(var e=0;e<this.visibleScaleRangeQueriesInvPtr;){var c=this.visibleScaleRangeQueries.data[e],h=c.extent;a>=c.minLevel&&a<=c.maxLevel&&h[0]<=b[2]&&h[2]>=b[0]&&h[1]<=b[3]&&h[3]>=b[1]?(this.visibleScaleRangeQueries.swapElements(e,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):e++}};b.prototype._updateStencilReadStateForTile=function(a,b){if(a.stencilRenderingHelper&&
a.stencilRenderingHelper.enabled){for(var d=this.stencilEnabledLayerExtents,c=!1,h=0;h<d.length;h++)if(b.intersectsExtent(d[h])){c=!0;break}c?a.stencilRenderingHelper.enableStencilRead():a.stencilRenderingHelper.disableStencilRead()}};b.prototype._renderTilesAuxiliary=function(a,b,e,c){var d=a.rctx,f=d.gl,g=a.camera,k=g.viewMatrix;b.setUniformMatrix4fv("proj",g.projectionMatrix);b.setUniform1f("skirtScale",this._skirtScale);c&&(b.setUniform1i("overlay0Tex",1),b.setUniform1i("overlay1Tex",2));for(g=
0;g<e.length;g++){var p=e.data[g];b.setUniform3fv("origin",p.origin);z.bindView(p.origin,k,b);for(var r=0;r<p.tiles.length;r++){var v=p.tiles.data[r],q=v.renderData;c&&(this._bindOverlayTextures(b,q.overlays,!0),b.setUniform1f("overlayOpacity",q.overlayOpacity));this._updateStencilReadStateForTile(a,v);d.bindVAO(q.vao);O.assertCompatibleVertexAttributeLocations(q.vao,b);d.drawElements(f.TRIANGLES,0!==this._skirtScale?q.vao.indexBuffer.size:q.geometryInfo.numWithoutSkirtIndices,q.vao.indexBuffer.indexType,
0)}}d.bindVAO(null);a.stencilRenderingHelper&&a.stencilRenderingHelper.disableStencilRead()};b.prototype._renderTiles=function(a,b,e){var c=a.rctx,d=c.gl,f=a.camera,g=f.viewMatrix;if(this.debugScreenSizePerspective&&this.pointsOfInterest){var n=ba.getSettings("spherical"===this.manifold?"global":"local");n.update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:f.fovY});z.bindScreenSizePerspective(n,a,b,"screenSizePerspective")}b.setUniform1f("skirtScale",this._skirtScale);for(f=
0;f<e.length;f++){n=e.data[f];b.setUniform3fv("origin",n.origin);z.bindView(n.origin,g,b);var p=a.sliceHelper&&a.sliceHelper.plane;p&&z.bindSlicePlane(n.origin,p,b);a.shadowMap&&a.shadowMap.bindView(b,n.origin);this.numOriginsRendered++;n=n.tiles;if(0!==n.length){var p="debug"===this.wireframe.mode?d.LINES:d.TRIANGLES,r=this.highestVisibleLODTile,v=void 0,q=void 0;r?(v=r.vlevel,q=this.tileSize/this.wireframe.resolution):(v=16,q=this.tileSize/64);for(r=0;r<n.length;r++){var m=n.data[r],t=m.renderData;
this._updateStencilReadStateForTile(a,m);G.trace("# RENDER TILE "+y.tile2str(m)+", screenDepth:"+m.screenDepth);var l=t.geometryInfo.uvOffsetAndScale,u=t.texOffsetAndScale;k.vec4.set(R,l[0]*u[2]+u[0],l[1]*u[3]+u[1],l[2]*u[2],l[3]*u[3]);b.setUniform4fv("texOffsetAndScale",R);c.bindTexture(t.textureReference||t.texture,0);b.setUniform1f("opacity",t.opacity);this._bindOverlayTextures(b,t.overlays,!1);b.setUniform1f("overlayOpacity",t.overlayOpacity);("shader"===this.wireframe.mode||this._drawBorders)&&
b.setUniform1f("wireframe.subdivision",q*(1<<v-m.vlevel));l=0!==this._skirtScale?t.vao.indexBuffer.size:t.geometryInfo.numWithoutSkirtIndices;c.bindVAO(t.vao);O.assertCompatibleVertexAttributeLocations(t.vao,b);c.drawElements(p,l,t.vao.indexBuffer.indexType,0);m.renderOrder=this.numTilesRendered;this.numTilesRendered++;this.numTrianglesRendered+=l/3;this._scaleQueriesForTile(m)}}}c.bindVAO(null);a.stencilRenderingHelper&&a.stencilRenderingHelper.disableStencilRead()};b.prototype._bindOverlayTextures=
function(a,b,e){for(var c=0;2>c;c++){var d=2*c,f=b[c],g=e?f.highlightRenderTargetId:f.renderTargetId;g?(g=this.drapedRenderer.getRenderTargetTexture(g),w[d]=f.texOffset[0],w[d+1]=f.texOffset[1],B[d]=f.texScale[0],B[d+1]=f.texScale[1],this.rctx.bindTexture(g,1+c)):(w[d]=0,w[d+1]=0,B[d]=0,B[d+1]=0,this.rctx.bindTexture(this.emptyTex,1+c))}a.setUniform4fv("overlayTexOffset",w);a.setUniform4fv("overlayTexScale",B)};b.prototype._updateTileGeometryBuffers=function(a){var b=this.rctx,e=b.gl;a=a.renderData;
var c=a.geometryInfo.indices;a.vao=new da(b,Y.Default3D,{geometry:Z.Pos3Tex},{geometry:N.createVertex(b,e.STATIC_DRAW,a.geometryInfo.vertexAttributes)},N.createIndex(b,e.STATIC_DRAW,c));this.setNeedsRender()};b.prototype._releaseTileGeometry=function(a){a=a.renderData;a.vao.dispose(!0);a.vao=null;V.releaseGeometry(a.geometryInfo);this.setNeedsRender()};b.prototype._prepareScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,b=this.visibleScaleRangeQueryQueue;a.length<a.data.length&&
0<b.length;){var e=b.pop();a.push(e)}this.visibleScaleRangeQueriesInvPtr=a.length};b.prototype._processScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,b=this.visibleScaleRangeQueryPool,e=0;e<a.length;e++){var c=a.data[e];b.release(c);c.callback(e>=this.visibleScaleRangeQueriesInvPtr);c.callback=null}a.clear()};return b}();var ha={mode:"none",width:1.5,falloff:1.5,wireOpacity:1,surfaceOpacity:0,color:[1,1,1,0],resolution:64},D=k.vec3f64.create(),ia=k.vec3f64.create(),ja=k.vec3f64.create(),
ka=k.vec3f64.create(),la=k.vec3f64.create();return K});