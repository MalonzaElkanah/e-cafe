// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/Handles ../../../core/Logger ../../../core/ObjectPool ../../../core/PooledArray ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/gl-matrix ../../../geometry/support/aaBoundingRect ../support/Evented ../support/geometryUtils ../support/mathUtils ../support/projectionUtils ../support/PromiseLightweight ../support/ResourceController ./OverlayManager ./PlanarTile ./SphericalTile ./SurfaceExtentHelper ./SurfaceTilingSchemeLogic ./TerrainConst ./TerrainRenderer ./terrainUtils ./TileGeometryFactory ./TilemapOnlyTile ./tileUtils ./tileUtils ../../vectorTiles/VectorTileDisplayObject ../../webgl/Texture".split(" "),
function(x,ma,N,m,O,P,B,Q,R,S,T,U,F,l,v,q,V,G,W,C,H,X,Y,Z,aa,I,ba,f,ca,n,da,ea,y,J,fa,ga){function K(f,c){return f[0]===c[0]&&f[1]===c[1]&&f[2]===c[2]}function L(f){return f&&("cancel"===f||"cancel"===f.dojoType)}function M(f,c){var a=!1;c=c||f;var b=0;for(f=f.children;b<f.length;b++){var d=f[b];if(d){for(var g in d.layerInfo)for(var k in d.layerInfo[g]){var e=d.layerInfo[g][k].upsampleFromTile;if(e&&e.tile===c)return!0}a=a||M(d,c)}}return a}var z=n.weakAssert,u=S.getLogger("esri.views.3d.terrain.TerrainSurface");
x=function(x){function c(a,b){a=x.call(this)||this;a.defaultTileBackground=f.DEFAULT_TILE_BACKGROUND;a.hideSkirtsDistanceFromExtentMargin=ha;a.hideSkirtsMinimumCameraTilt=ia;a.hideSkirtsMaximumCameraTilt=ja;a._clippingExtent=null;a._dataExtent=null;a._elevationBounds=[0,0];a._rootExtent=q.create();a._iteratorPool=new T(J.IteratorPreorder);a._postorderIterator=new J.IteratorPostorder;a.visible=!1;a.suspended=!1;a._pendingUpdates=!1;a._lvPendingUpdates=!1;a._updateNextFrame=0;a._vectorTileLayerRequests=
0;a._memoryUsed=0;a._overlayOpacity=1;a._eyePosRenderSR=v.vec3f64.create();a._eyePosSurfaceSR=v.vec3f64.create();a._splitLimits=[0,0,0,0,0,0];a._frustum=G.frustum.create();a._viewProjectionMatrix=v.mat4f64.create();a.tilemapStats={tilemapRequestsSent:0,tilemapRequestsPending:0,tilemapRequestErrors:0,fullTilemaps:0,emptyTilemaps:0,tilesRequested:0,tileRequestsSent:0,tileRequestErrors:0,tilesNotPresent:0};a._layerViews=[[],[]];a._layerIndexByLayerViewId=[{},{}];a._basemapLayerViewHandles={};a._handles=
new R;a._lowPrioUpdates=new U;a._topLevelTilemapOnlyTiles=Array(f.TILEMAP_SIZE_EXP+1);a._getElevationData={spatialReference:null,rootTiles:null};a.loaded=!1;a.maxTextureScale=1.2;a.rootTiles=null;a.backgroundImage=f.DEFAULT_TILE_BACKGROUND;a.backgroundColor=null;for(b=0;b<a._topLevelTilemapOnlyTiles.length;b++)a._topLevelTilemapOnlyTiles[b]=new ea([b-f.TILEMAP_SIZE_EXP,0,0]);return a}N(c,x);c.prototype.normalizeCtorArgs=function(a,b){this._view=a;this._stage=a._stage;this._set("manifold",b);return{}};
c.prototype.initialize=function(){var a=this;this.tilePool="planar"===this.manifold?Z.Pool:aa.Pool;this._renderer=new ca(this.manifold,null);this._renderer.loaded=this._setLoaded.bind(this);this._renderer.install(this._view._stage);F.init(this,"_background",function(){a._renderer.updateTileBackground(a._background)});this._handles.add(this._view.watch("pointsOfInterest",function(b){a._renderer.pointsOfInterest=b}));this._set("overlayManager",new Y({terrainSurface:this,view:this._view}));this._handles.add(this.watch("overlayManager.hasHighlights",
this._handleHasHighlights.bind(this)),"overlayManager");var b={layers:this._view.map.allLayers,layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference};this.extentHelper="spherical"===this.manifold?new I.SurfaceExtentHelperGlobal(b):new I.SurfaceExtentHelperLocal(b);this._handles.add(F.init(this.extentHelper,"stencilEnabledExtents",function(b){a._renderer.setStencilEnabledLayerExtents(b)}),"extentHelper");b=this._view.defaultsFromMap?new Q({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,
getChildrenFunction:function(a){return a.layers}}):this._view.map.allLayers;b=new ba({layers:b,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this._view.spatialReference});this._set("tilingSchemeLogic",b);this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",this._updateTilingSchemeAndExtent.bind(this),!0)],"tilingSchemeLogic");this._updateTilingSchemeAndExtent();this._streamDataSupplier=
this._view.resourceController.getStreamDataSupplier(X.ClientType.TERRAIN);this._handles.add(this._view.resourceController.registerFrameWorker(function(b){return a._frame(b)},function(){return a.ready}));this._handles.add(this._view.resourceController.registerIdleFrameWorker({needsUpdate:function(){return a._needsIdleUpdate()},idleFrame:function(){return a._idleUpdate()}}));this._viewChangeUpdate=this._viewChangeUpdate.bind(this);this._view.resourceController.memoryEvents.on("quality-changed",function(){return a._viewChangeUpdate()});
this._handles.add([this._view.on("resize",this._viewChangeUpdate),this._view.watch("state.camera",this._viewChangeUpdate,!0),this._view.watch("qualitySettings.tiledSurface.lodBias",this._viewChangeUpdate),this._view.watch("clippingArea",this._clippingChanged.bind(this))],"view");this._handles.add(this._view.allLayerViews.on("change",this._handleLayerViewChanges.bind(this)),"allLayerViews");this._handleLayerViewChanges({added:this._view.allLayerViews.toArray(),removed:[],moved:[],target:this._view.allLayerViews});
this._updateClippingExtent();this.notifyChange("extent")};c.prototype.destroy=function(){this._handles.destroy();this._removeAllTiles();this.tilingSchemeLogic.destroy();this._set("tilingSchemeLogic",null);this.extentHelper.destroy();this.extentHelper=null;for(var a in this._basemapLayerViewHandles)this._unregisterTiledLayerView(a);this._streamDataSupplier=null;this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null));this._renderer.destroy(this._stage);this._streamDataSupplier=
this._stage=this._view=this._renderer=null};Object.defineProperty(c.prototype,"renderer",{get:function(){return this._renderer},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"cullBackFaces",{set:function(a){this._renderer.cullBackFaces=a;this._set("cullBackFaces",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"baseOpacity",
{set:function(a){this._renderer.opaque=1<=a;this._set("baseOpacity",a);this._updateTileTextures(!0)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderOrder",{set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"skirtScale",{set:function(a){this._renderer.skirtScale=a;this._set("skirtScale",
a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"spatialReference",{get:function(){var a=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_background",{get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"slicePlaneEnabled",{set:function(a){this._renderer.slicePlaneEnabled=
a;this._set("slicePlaneEnabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"velvetOverground",{set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOverground=a);this._set("velvetOverground",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"wireframe",{set:function(a){this._renderer.setWireframe(a);this._set("wireframe",a);this._view._stage.setRenderParams({earlyOcclusionPixelDraw:a})},enumerable:!0,configurable:!0});c.prototype.setVisibility=
function(a){a!==this.visible&&(this.visible=a,this._renderer.setVisibility(a),this.setUpdatesDisabled(!a),a&&this._viewChangeUpdate())};c.prototype.isVisible=function(){return this.visible&&this.ready};c.prototype.isOpaque=function(){return this._renderer.isOpaque()};c.prototype.setUpdatesDisabled=function(a){(this.suspended=a)||this._viewChangeUpdate()};c.prototype.intersect=function(a,b,d,g){this._renderer.intersect(a,b,d,g,null)};c.prototype.getElevation=function(a){var b=this._getElevationData.rootTiles;
if(!b||!b.length||0===b[0].layerInfo[f.LayerClass.ELEVATION].length)return null;var d=A;if(Array.isArray(a))d=a;else if("point"===a.type&&!C.pointToVector(a,d,this._getElevationData.spatialReference))return u.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(var g=0;g<b.length;g++)if(a=b[g],y.isPosWithinTile(a,d)){for(;a&&!a.renderData;)b=0,d[0]>.5*(a.extent[0]+a.extent[2])&&(b+=1),d[1]<.5*(a.extent[1]+a.extent[3])&&(b+=2),a=a.children[b];
if(b=(b=a.renderData)&&b.geometryState?b.geometryState.samplerData:null)return da.elevationSampler(d[0],d[1],b);break}return null};c.prototype.getElevationBounds=function(){return this._elevationBounds};c.prototype.getScale=function(a){if(this.tilingScheme){if(!C.pointToVector(a,A,this.spatialReference))return u.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;if(this.rootTiles)for(var b=0;b<this.rootTiles.length;b++)if(a=this.rootTiles[b],
y.isPosWithinTile(a,A)){for(;a.children[0];)b=0,A[0]>a.children[0].extent[2]&&(b+=1),A[1]<a.children[0].extent[1]&&(b+=2),a=a.children[b];return this._getLodBiasCorrectedScale(a.lij[0])}}return 1E100};c.prototype.queryVisibleScaleRange=function(a,b,d,g){b=b?this.tilingScheme.levelAtScale(b):0;d=d?this.tilingScheme.levelAtScale(d):Infinity;var c=this._getLodBias();this._renderer.queryVisibleLevelRange(a,b+c,d+c,g)};c.prototype._setLoaded=function(){this.loaded||this._set("loaded",!0)};c.prototype._updateTilingSchemeAndExtent=
function(){var a=this.tilingSchemeLogic.extent,b=a&&!q.equals(a,this._dataExtent);b&&(this._dataExtent?q.set(this._dataExtent,a):this._dataExtent=q.create(a));var a=this.tilingSchemeLogic.tilingScheme,d=a!==this.tilingScheme;d&&(z(!!a,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize[0]),this.overlayManager.setSpatialReference(a.spatialReference,
"spherical"===this.manifold)));(b||d)&&this._updateRootTiles()};c.prototype._acquireTile=function(a,b,d,c){var g=this.tilePool.acquire();D[0]=a;D[1]=b;D[2]=d;g.init(D,c,this,this.tilingScheme);return g};c.prototype._releaseTile=function(a){a.dispose();a.parent=null;a.parentSurface=null;this.tilePool.release(a)};c.prototype._updateRootTiles=function(){var a=this,b=this._clippingExtent||this._dataExtent,d=this.tilingScheme;if(b&&d){var c=ka,k=d.rootTilesInExtent(b,c,Infinity);if(this.rootTiles){if(k.length>
f.MAX_ROOT_TILES){u.warn(f.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);return}var b=this.rootTiles.map(function(a){return a.lij}),e=B.difference(b,k,K);if(0<e.removed.length||0<e.added.length){var h=this.rootTiles.filter(function(b){return-1<B.findIndex(e.removed,K.bind(null,b.lij))?(a._purgeChildTiles(b),a._purgeTile(b),!1):!0});e.added.forEach(function(b){b=a._acquireTile(0,b[1],b[2],null);h.push(b);a._loadTile(b)});this._setRootTiles(h)}}else k.length>f.MAX_ROOT_TILES&&(u.warn(f.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),
k=d.rootTilesInExtent(b,c,f.MAX_ROOT_TILES)),this._setRootTiles(k.map(function(b){b=a._acquireTile(0,b[1],b[2],null);a._loadTile(b);return b}));B.equals(c,this._rootExtent)||(this._rootExtent=q.create(c),this._hasFixedExtent()||this.notifyChange("extent"));this.setVisibility(!0);this._viewChangeUpdate();this.overlayManager.setOverlayDirty();this.notifyChange("ready")}};c.prototype._setRootTiles=function(a){this._set("rootTiles",a);this._getElevationData.rootTiles=a;this._renderer.setRootTiles(this.rootTiles)};
c.prototype._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this.visible&&(this._updateViewDependentParameters(),this._updateSkirts(),this._updateOverlayOpacity(this._eyePosSurfaceSR[2]),this._updateTiles())};c.prototype._updateClippingStatus=function(a){a.updateClippingStatus(this._clippingExtent)&&a.pendingUpdates&f.TileUpdateTypes.UPDATE_GEOMETRY&&(this._updateTileGeometry(a),a.pendingUpdates&=~f.TileUpdateTypes.UPDATE_GEOMETRY)};c.prototype._updateTiles=function(a){void 0===
a&&(a=this.rootTiles);if(a){var b=this._iteratorPool.acquire();b.reset(a);var d=this._splitLimits,c=this._frustum,k;y.hasVisibleSiblings(a)?(a=this._elevationBounds[0],k=this._elevationBounds[1]):(a=Infinity,k=-Infinity);for(;!b.done;){var e=b.next();this._updateClippingStatus(e);if(e.updateVisibility(c)){e.updateScreenDepth(this._viewProjectionMatrix);e.renderData&&(a=Math.min(e.elevationBounds[0],a),k=Math.max(e.elevationBounds[1],k));var h=e.shouldSplit(d,this._eyePosRenderSR);if(h===f.TileUpdateTypes.SPLIT){e.pendingUpdates&=
~f.TileUpdateTypes.MERGE;e.renderData&&(e.pendingUpdates|=f.TileUpdateTypes.SPLIT,b.skipSubtree());this._pendingUpdates=this._pendingUpdates||0!==e.pendingUpdates;continue}e.pendingUpdates&=~f.TileUpdateTypes.SPLIT;h===f.TileUpdateTypes.VSPLITMERGE&&e.updateAgents(f.LayerClass.ELEVATION)}b.skipSubtree();if(!e.renderData){e.pendingUpdates|=f.TileUpdateTypes.MERGE;e.pendingUpdates&=~f.TileUpdateTypes.SPLIT;h=this._iteratorPool.acquire();for(h.resetOne(e);!h.done;){var r=h.next();this._updateClippingStatus(r);
r.updateVisibility(c);r.visible&&r.updateScreenDepth(this._viewProjectionMatrix)}this._iteratorPool.release(h)}this._pendingUpdates=this._pendingUpdates||0!==e.pendingUpdates}this._iteratorPool.release(b);isFinite(a)&&isFinite(k)&&(this._elevationBounds[0]!==a||this._elevationBounds[1]!==k)&&(this._elevationBounds[0]=a,this._elevationBounds[1]=k,this.emit("elevation-bounds-change",null))}};c.prototype._updateViewDependentParameters=function(){var a=this._view.state.camera,b=Math.tan(.5*a.fovX),d=
Math.tan(.5*a.fovY),c=this.tilingScheme.pixelSize,k=Math.pow(2,-this._getLodBias());this._splitLimits[0]=b;this._splitLimits[1]=c[0]/a.width*this.maxTextureScale*k;this._splitLimits[2]=d;this._splitLimits[3]=c[1]/a.height*this.maxTextureScale*k;this._splitLimits[4]=this.tilingScheme.getMaxLod();this._splitLimits[5]=this._view.qualitySettings.tiledSurface.angledSplitBias;G.frustum.copy(a.frustum,this._frustum);v.mat4.multiply(this._viewProjectionMatrix,a.projectionMatrix,a.viewMatrix);v.vec3.copy(this._eyePosRenderSR,
a.eye);C.vectorToVector(this._eyePosRenderSR,this._view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};c.prototype._updateSkirts=function(){n.autoUpdateSkirtsVisibility(this,this._eyePosSurfaceSR,this._view.state.camera.near)};c.prototype._setLayerViewsUpdating=function(){for(var a=0;a<f.LayerClass.COUNT;a++)for(var b=this._layerViews[a],d=0;d<b.length;d++)b[d].updatingChanged(this._pendingUpdates)};c.prototype._frameTraversal=function(a){if(this.suspended||!this._pendingUpdates)return!1;
this._lowPrioUpdates.clear();this._pendingUpdates=!1;var b=this._renderer.resourceCounter,d=b.numTileTexturesComposited,c=this._iteratorPool.acquire();c.reset(this.rootTiles);for(var k=!1,e=0;!(c.done||a.done()&&k)&&b.numTileTexturesComposited-d<la;){var h=c.next(),e=e+h.memoryUsed;h.pendingUpdates&f.TileUpdateTypes.MERGE?(this._mergeTile(h),h.pendingUpdates&=~f.TileUpdateTypes.MERGE,k=!0,c.skipSubtree()):h.pendingUpdates&f.TileUpdateTypes.SPLIT?(this._splitTile(h),h.pendingUpdates&=~f.TileUpdateTypes.SPLIT,
k=!0,c.skipSubtree()):0<h.pendingUpdates&&this._lowPrioUpdates.push(h);this._pendingUpdates=this._pendingUpdates||0!==h.pendingUpdates}c.done?this._memoryUsed=e:this._pendingUpdates=!0;this._iteratorPool.release(c);return k};c.prototype._updateTileGeometry=function(a){this._renderer.updateTileGeometry(a);this._elevationUpdate(a)};c.prototype._elevationUpdate=function(a){E.spatialReference=this.spatialReference;E.tile=a;E.extent=a.extent;this.emit("elevation-change",E);q.containsPoint(a.extent,this._eyePosSurfaceSR)&&
this._updateSkirts()};c.prototype._frame=function(a){for(var b=this._frameTraversal(a);(!a.done()||!b)&&0<this._lowPrioUpdates.length;){var d=this._lowPrioUpdates.pop();d.pendingUpdates&f.TileUpdateTypes.DECODE_ELEVATION&&(this._decodeElevation(d,a)&&(d.pendingUpdates&=~f.TileUpdateTypes.DECODE_ELEVATION),b=!0);a.done()&&b||!(d.pendingUpdates&f.TileUpdateTypes.UPDATE_GEOMETRY)||(this._updateTileGeometry(d),d.pendingUpdates&=~f.TileUpdateTypes.UPDATE_GEOMETRY,b=!0);a.done()&&b||!(d.pendingUpdates&
f.TileUpdateTypes.UPDATE_TEXTURE)||(this._renderer.updateTileTexture(d),d.pendingUpdates&=~f.TileUpdateTypes.UPDATE_TEXTURE,b=!0);this._pendingUpdates=this._pendingUpdates||0!==d.pendingUpdates}if(0<this._lowPrioUpdates.length||this._streamDataSupplier.hasPendingDownloads()||0!==this._vectorTileLayerRequests)this._pendingUpdates=!0;this._pendingUpdates===this._lvPendingUpdates||!this._pendingUpdates&&20!==++this._updateNextFrame||(this._setLayerViewsUpdating(),this._lvPendingUpdates=this._pendingUpdates,
this._updateNextFrame=0);b&&(this._memoryUsed=0)};c.prototype._needsIdleUpdate=function(){return this.isVisible()&&this.overlayManager&&this.overlayManager.overlaysNeedUpdate()};c.prototype._idleUpdate=function(){this.overlayManager.updateOverlays();this._updateOverlayOpacity(this._eyePosSurfaceSR[2])};c.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var a=q.create(),b=null;C.extentToBoundingRect(this._view.clippingArea,a,this.spatialReference)&&(b=a);if(B.equals(b,
this._clippingExtent))return!1;this._clippingExtent=b;this._renderer.clippingExtent=b;this.notifyChange("extent");this._updateTileOverlayParams();this.overlayManager.setOverlayDirty();return!0};c.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()};c.prototype._getLodBias=function(){return Math.round(this._view.qualitySettings.tiledSurface.lodBias+2*this._view.resourceController.memoryFactor-2)};c.prototype._getLodBiasCorrectedScale=function(a){var b=this.tilingScheme.levels;
a=W.clamp(a-this._getLodBias(),0,b.length-1);return b[a].scale};c.prototype._cancelTilemapRequests=function(a){for(var b=0;b<f.LayerClass.COUNT;b++){var d=a.layerInfo[b];if(d)for(var c=0;c<d.length;c++){var k=d[c];k.tilemapRequest&&(k.tilemapRequest.cancel(),k.tilemapRequest=null)}}};c.prototype._removeAllTiles=function(){var a=this;this.rootTiles&&(this.rootTiles.forEach(function(b){a._purgeChildTiles(b);a._purgeTile(b)}),this._setRootTiles(null),this.notifyChange("ready"));for(var b=0;b<this._topLevelTilemapOnlyTiles.length;b++)this._cancelTilemapRequests(this._topLevelTilemapOnlyTiles[b]);
this.setVisibility(!1)};c.prototype._purgeChildTiles=function(a){var b=this._postorderIterator;for(b.reset([a]);!b.done;){for(var c=b.next(),g=0;4>g;g++)c.children[g]=null;c!==a&&this._purgeTile(c)}};c.prototype._purgeTile=function(a){a.unload(this._renderer);this._cancelTilemapRequests(a);a.parent=null;this._releaseTile(a)};c.prototype._splitTile=function(a){var b=a.lij[0]+1,c=2*a.lij[1],g=2*a.lij[2];a.children[0]=this._createTile(b,c,g,a);a.children[1]=this._createTile(b,c,g+1,a);a.children[2]=
this._createTile(b,c+1,g,a);a.children[3]=this._createTile(b,c+1,g+1,a);a.unload(this._renderer);t.spatialReference=this.spatialReference;t.extent=a.extent;t.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",t)};c.prototype._createTile=function(a,b,c,g){z(!!g,"_createTile sanity check");a=this._acquireTile(a,b,c,g);a.updateClippingStatus(this._clippingExtent);a.updateVisibility(this._frustum);a.visible&&(a.updateScreenDepth(this._viewProjectionMatrix),a.shouldSplit(this._splitLimits,
this._eyePosRenderSR)===f.TileUpdateTypes.SPLIT&&(a.pendingUpdates|=f.TileUpdateTypes.SPLIT,this._pendingUpdates=!0));this._loadTile(a);return a};c.prototype._mergeTile=function(a){z(!a.renderData,"_mergeTile sanity check");this._loadTile(a);this._purgeChildTiles(a);t.spatialReference=this.spatialReference;t.extent=a.extent;t.scale=this._getLodBiasCorrectedScale(a.lij[0]);this.emit("scale-change",t)};c.prototype._loadTile=function(a){a.load(this._renderer);this.overlayManager&&this.overlayManager.hasOverlays()&&
this.overlayManager.setOverlayParamsOfTile(a,a.renderData,this._overlayOpacity);this._elevationUpdate(a)};c.prototype._handleHasHighlights=function(a){this._renderer.setNeedsHighlight(a)};c.prototype._decodeElevation=function(a,b){var c=a.layerInfo[f.LayerClass.ELEVATION];if(!c)return!0;for(var g=0;g<c.length;g++){var k=c[g];k.pendingUpdates&=~f.TileUpdateTypes.DECODE_ELEVATION;if(k.rawData){var e=a.decodeElevationData(k.rawData);k.rawData=null;if(e){k.data=e;var k=[a],h=a.lij[0],r=this._iteratorPool.acquire();
for(r.reset(k);!r.done;){var w=r.next();w.findElevationBoundsForLayer(g,h);w.computeElevationBounds()}this._iteratorPool.release(r);a.dataArrived(g,f.LayerClass.ELEVATION,e);this._updateTiles(k)}if(b.done())break}}return g===c.length};c.prototype._handleLayerViewChanges=function(a){var b=this,c=!1;a.added.forEach(function(a){var d=a.layer;n.isTiledLayerView(a)?(b._registerTiledLayer(a),d.loaded&&(c=!0)):a.supportsDraping&&b.overlayManager&&b.overlayManager.registerLayerView(a)});a.removed.forEach(function(a){n.isTiledLayerView(a)?
(c=!0,b._unregisterTiledLayerView(a.uid)):a.supportsDraping&&b.overlayManager&&b.overlayManager.unregisterLayerView(a)});(c=c||0<a.moved.filter(n.isTiledLayerView).length)&&this._updateTiledLayers()};c.prototype._registerTiledLayer=function(a){var b=this,c=[];c.push(a.watch("suspended",function(){b._updateTiledLayers()}));c.push(a.watch("fullOpacity",function(){return b._updateTileTextures()}));a.on("data-changed",function(){var c=n.isElevationLayerView(a)?f.LayerClass.ELEVATION:f.LayerClass.MAP,
d=b._layerIndexByLayerViewId[c][a.uid];null!=d&&b._invalidateLayerData(d,c)});this._basemapLayerViewHandles[a.uid]=c};c.prototype._unregisterTiledLayerView=function(a){var b=this._basemapLayerViewHandles[a];if(b){for(var c=0;c<b.length;c++)b[c].remove();delete this._basemapLayerViewHandles[a]}};c.prototype._updateTiledLayers=function(){var a=this;if(this.tilingScheme){var b=this._view.allLayerViews,c=[[],[]],g=null,k=q.empty();b.forEach(function(b){var d=b.layer;if(d&&!b.suspended&&n.isTiledLayerView(b)){var e=
b.fullExtent;e?a.tilingScheme.compatibleWith(b.tileInfo)?(q.expand(k,e),n.isElevationLayerView(b)?c[f.LayerClass.ELEVATION].push(b):(Infinity!==b.maxDataLevel&&(null===g||b.maxDataLevel>g)&&(g=b.maxDataLevel),c[f.LayerClass.MAP].push(b))):u.warn("Terrain: tiling scheme of layer "+d.id+" is incompatible with other tiled layers, will not be drawn"):u.warn("Terrain: Map or elevation layer does not have fullExtent: "+d.id)}},this);for(var b=function(a){var b=e._layerViews[a],d=c[a];d.reverse();var g=
d.length,k=b.length!==g,h=Array(g),r=Array(b.length);e._layerIndexByLayerViewId[a]={};for(var l=0;l<g;l++){e._layerIndexByLayerViewId[a][d[l].uid]=l;var m=b.indexOf(d[l]);h[l]=m;l!==m&&(k=!0);-1<m&&(r[m]=l)}if(k){e._topLevelTilemapOnlyTiles.forEach(function(b){return b.modifyLayers(r,h,a)});b=e._postorderIterator;for(b.reset(e.rootTiles);!b.done;)b.next().modifyLayers(r,h,a);e._layerViews[a]=d;for(b.reset(e.rootTiles);!b.done;)d=b.next(),d.restartAgents(a),a===f.LayerClass.ELEVATION&&d.computeElevationBounds();
e._updateTiles()}},e=this,h=0;h<f.LayerClass.COUNT;h++)b(h);this.tilingScheme.levels.length-1<g&&(this.tilingScheme.ensureMaxLod(g),this._viewChangeUpdate())}};c.prototype._hasFixedExtent=function(){return!!this._clippingExtent};c.prototype.layerViewByIndex=function(a,b){return this._layerViews[b][a]};c.prototype.numLayers=function(a){return this._layerViews[a].length};c.prototype._updateTileTextures=function(a){void 0===a&&(a=!1);var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;)b.next().updateTexture(a);
this._iteratorPool.release(b)};c.prototype._invalidateLayerData=function(a,b){var c=this._iteratorPool.acquire();for(c.reset(this.rootTiles);!c.done;)c.next().removeLayerAgent(a,b);for(c.reset(this.rootTiles);!c.done;)c.next().invalidateLayerData(a,b);this._iteratorPool.release(c)};c.prototype.setPendingUpdates=function(){this._pendingUpdates=!0};c.prototype.requestTileData=function(a,b,c){var d=this;this.tilemapStats.tilesRequested++;var k=this.layerViewByIndex(b,c),e=k.layer;if(e.tilemapCache&&
!n.isVectorTileLayerView(k)){var h=this.getTilemapTile(a),f=h.layerInfo[c][b];if(f.tilemap){if(!h.hasDataAvailable(a,b,c))return this.tilemapStats.tilesNotPresent++,this._dispatchDataEvent(a,"dataMissing",c,k,{notInTilemap:!0}),b=new H.Promise,b.reject(),b}else{f.tilemapRequest||(f.tilemapRequest=this.requestTilemap(h,b,c,k,e));var w,l=new H.Promise(function(){w&&w.cancel()});f.tilemapRequest.catch(function(){}).then(function(){f.tilemapRequest=null;if(!l.isCancelled()){var b=d._layerIndexByLayerViewId[c][k.uid];
null!=b&&(h.hasDataAvailable(a,b,c)?(w=d._requestTileData(a,b,c,k),w.then(function(){return l.resolve()})):(d.tilemapStats.tilesNotPresent++,d._dispatchDataEvent(a,"dataMissing",c,k,{notInTilemap:!0}),l.reject()))}});return l}}return this._requestTileData(a,b,c,k)};c.prototype._requestTileData=function(a,b,c,g){this.tilemapStats.tileRequestsSent++;return c===f.LayerClass.ELEVATION?this._requestElevationTileData(a,b,c,g):this._requestMapTileData(a,b,c,g)};c.prototype._requestElevationTileData=function(a,
b,c,g){var d=this;if(n.isElevationLayerView(g)){var e=function(b){var e=d._layerIndexByLayerViewId[c][g.uid];null!=e?(e=a.layerInfo[c][e],e.rawData=b,a.pendingUpdates|=f.TileUpdateTypes.DECODE_ELEVATION,e.pendingUpdates|=f.TileUpdateTypes.DECODE_ELEVATION,d._pendingUpdates=!0):u.warn("TerrainSurface: received data from unknown layer %d %s",c,a.lij.toString())};b=function(b){L(b)||(d.tilemapStats.tileRequestErrors++,d._dispatchDataEvent(a,"dataMissing",c,g,b))};var h=g.layer;if(n.useFetchTileForLayer(h))return h=
h.fetchTile(a.lij[0],a.lij[1],a.lij[2],f.ELEVATION_NODATA_VALUE),h.then(function(a){return e(a)},b),h;h=g.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);h=this._streamDataSupplier.request(h,"binary");h.then(function(a,b){b.url=a;e(b)},b);return h}z(!1,"_requestElevationTileData can only be called for elevation layer views")};c.prototype._requestMapTileData=function(a,b,c,g){var d=this,e=function(b){d._dispatchDataEvent(a,"dataArrived",c,g,b)};b=function(b){L(b)||(d._dispatchDataEvent(a,"dataMissing",c,g,
b),d.tilemapStats.tileRequestErrors++)};if(n.isVectorTileLayerView(g)){var h=g.tileHandler,f=g.schemaHelper.getLevelRowColumn(a.lij);++this._vectorTileLayerRequests;h=h.getVectorTile(f[0],f[1],f[2],0);h.then(e).catch(b).then(function(){return--d._vectorTileLayerRequests});return h}if(n.useFetchTileForLayer(g.layer)&&n.isTileLayerView(g))return h=g.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2]),h.then(e).catch(b),h;h=g.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);null!=g.refreshInterval&&g.refreshTimestamp&&
(h+=(-1<h.indexOf("?")?"\x26":"?")+"_ts\x3d"+g.refreshTimestamp);h=this._streamDataSupplier.request(h,"image");h.then(function(a,b){return e(b)},b);return h};c.prototype.requestTilemap=function(a,b,c,g,k){var d=this,h=a.lij[0]+f.TILEMAP_SIZE_EXP,l=a.lij[1]<<f.TILEMAP_SIZE_EXP,m=a.lij[2]<<f.TILEMAP_SIZE_EXP;this.tilemapStats.tilemapRequestsSent++;this.tilemapStats.tilemapRequestsPending++;return k.tilemapCache.fetchTilemap(h,l,m,{timeout:6E3}).then(function(e){d.tilemapStats.tilemapRequestsPending--;
b=d._layerIndexByLayerViewId[c][g.uid];null!=b&&(a.layerInfo[c][b].tilemap=e)}).catch(function(a){d.tilemapStats.tilemapRequestsPending--;d.tilemapStats.tilemapRequestErrors++})};c.prototype.getTilemapTile=function(a){var b=a.lij[0];return b>f.TILEMAP_SIZE_EXP?y.getTileNLevelsUp(a,f.TILEMAP_SIZE_EXP):this._topLevelTilemapOnlyTiles[b]};c.prototype._dispatchDataEvent=function(a,b,c,g,f){g=this._layerIndexByLayerViewId[c][g.uid];if(null!=g)a[b](g,c,f);else u.warn("TerrainSurface: received data from unknown layer")};
c.prototype._updateTileOverlayParams=function(){if(this.rootTiles){var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();b.renderData&&this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(b,b.renderData,this._overlayOpacity)}this._iteratorPool.release(a);this._renderer.setNeedsRender()}};c.prototype._updateOverlayOpacity=function(a){if(this.overlayManager&&(a=this.overlayManager.updateOpacity(a),!isNaN(a))){if(a!==this._overlayOpacity){var b=this._iteratorPool.acquire();
for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.renderData&&(c.renderData.overlayOpacity=a)}this._iteratorPool.release(b)}this._overlayOpacity=a;this._renderer.setNeedsRender()}};c.prototype.getStats=function(){var a=0,b=0,c=0,g=[],f=this._iteratorPool.acquire();for(f.reset(this.rootTiles);!f.done;){var e=f.next();a++;e.renderData&&(b++,e.visible&&(c++,e=e.lij[0],g[e]=null!=g[e]?g[e]+1:1))}this._iteratorPool.release(f);return{numNodes:a,numLeaves:b,numVisible:c,numVisiblePerLevel:g}};c.prototype.getUsedMemory=
function(){if(!this.tilingScheme)return 0;if(0<this._memoryUsed)return this._memoryUsed;var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();this._memoryUsed+=b.memoryUsed}this._iteratorPool.release(a);return this._memoryUsed};c.prototype.getMemoryUsage=function(){if(!this.tilingScheme)return{};var a=0,b=0,c=0,g=0,k=0,e=0,h=this._iteratorPool.acquire();h.reset(this.rootTiles);for(var l=this.tilingScheme.pixelSize,l=l[0]*l[1]*4;!h.done;){for(var m=h.next(),n=M(m),
q=0,u=m.layerInfo[f.LayerClass.MAP];q<u.length;q++){var p=u[q],p=p.data,t=0,v=0;p instanceof ga?t+=1.3*p.descriptor.width*p.descriptor.height*4:p instanceof HTMLImageElement?v+=l:p instanceof fa&&(e+=p.getGpuMemoryUsage(),c+=p.getCpuMemoryUsage());m.renderData||n?(a+=v,g+=t):(b+=v,k+=t)}n=0;for(q=m.layerInfo[f.LayerClass.ELEVATION];n<q.length;n++)p=q[n],p=p.data,a+=p?l:0;m.renderData&&(p=m.renderData.texture,g+=p&&p.descriptor?1.3*p.descriptor.width*p.descriptor.height*4:0,m=m.renderData.estimateGeometryMemoryUsage(),
e+=m,c+=m)}this._iteratorPool.release(h);return{cpuVisibleImageData:a,cpuInvisibleImageData:b,cpuGeometryData:c,gpuVisibleImageData:g,gpuInvisibleImageData:k,gpuGeometryData:e}};c.prototype.hasPendingUpdates=function(){if(this._streamDataSupplier.hasPendingDownloads()||0!==this._vectorTileLayerRequests)return!0;var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;)if(0<a.next().pendingUpdates)return this._iteratorPool.release(a),!0;this._iteratorPool.release(a);return!1};c.prototype.getTile=
function(a){var b=a.split("/").map(function(a){return+a});if(0===b[0])return this.rootTiles.forEach(function(a){if(a.lij[1]===b[1]&&a.lij[2]===b[2])return a}),null;var c=Math.pow(2,b[0]),f=Math.floor(b[1]/c),k=Math.floor(b[2]/c),e;this.rootTiles.some(function(a){return a.lij[1]===f&&a.lij[2]===k?(e=a,!0):!1});if(e){for(c=1<<b[0]-1;e.lij[0]<b[0];){var h=b[1]&c?2:0;0<(b[2]&c)&&h++;if(!e.children[h])return console.log("Tile "+a+" doesn't exist, smallest ancestor is "+y.tile2str(e)),null;e=e.children[h];
c>>=1}z(e.lij[0]===b[0]&&e.lij[1]===b[1]&&e.lij[2]===b[2],"not the right tile?");return e}return null};c.prototype.setBorders=function(a){this._renderer.drawBorders=a};c.prototype.setDisableRendering=function(a){this._renderer.disableRendering=a};Object.defineProperty(c.prototype,"debug",{get:function(){var a=this;return{renderer:this._renderer,mergeTile:function(b){return a._mergeTile(b)},updateTiles:function(b){return a._updateTiles(b)}}},enumerable:!0,configurable:!0});m([l.property({value:!1})],
c.prototype,"cullBackFaces",null);m([l.property({readOnly:!0})],c.prototype,"extent",null);m([l.property({readOnly:!0})],c.prototype,"loaded",void 0);m([l.property({value:1})],c.prototype,"baseOpacity",null);m([l.property({readOnly:!0})],c.prototype,"overlayManager",void 0);m([l.property({readOnly:!0})],c.prototype,"manifold",void 0);m([l.property()],c.prototype,"maxTextureScale",void 0);m([l.property({readOnly:!0})],c.prototype,"ready",null);m([l.property({value:1})],c.prototype,"renderOrder",null);
m([l.property({readOnly:!0})],c.prototype,"rootTiles",void 0);m([l.property({value:!0})],c.prototype,"skirtScale",null);m([l.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],c.prototype,"spatialReference",null);m([l.property({})],c.prototype,"backgroundImage",void 0);m([l.property({type:O})],c.prototype,"backgroundColor",void 0);m([l.property({dependsOn:["backgroundColor","backgroundImage"]})],c.prototype,"_background",null);m([l.property({value:!1})],c.prototype,"slicePlaneEnabled",
null);m([l.property({readOnly:!0})],c.prototype,"tilingScheme",void 0);m([l.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],c.prototype,"tilingSchemeLocked",void 0);m([l.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],c.prototype,"tilingSchemeDone",void 0);m([l.property({readOnly:!0})],c.prototype,"tilingSchemeLogic",void 0);m([l.property({value:!0})],c.prototype,"velvetOverground",null);m([l.property({value:!1})],c.prototype,"wireframe",null);return c=
m([l.subclass("esri.views.3d.terrain.TerrainSurface")],c)}(l.declared(P,V.Evented));var ha=1.2,ia=80/180*Math.PI,ja=110/180*Math.PI,la=12,A=v.vec4f64.create(),ka=q.create(),D=[0,0,0],E={spatialReference:null,tile:null,extent:null},t={spatialReference:null,extent:null,scale:0};return x});