// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/errors/CancelError ../../../../Color ../../../../core/asyncUtils ../../../../core/lang ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../geometry/support/aaBoundingBox ../../../../symbols/ObjectSymbol3DLayer ./ElevationAligners ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lodResourceUtils ./objectResourceUtils ./primitiveObjectSymbolUtils ./symbolComplexity ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Util ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(A,V,G,H,B,I,C,D,f,g,J,K,L,q,M,n,E,N,x,O,k,y,h,P,Q,r,R){A=function(t){function e(){var a=null!==t&&t.apply(this,arguments)||this;a._instanceIndexToGraphicUid=new Map;return a}G(e,t);Object.defineProperty(e.prototype,"lodRenderer",{get:function(){return this._lodRenderer},enumerable:!0,configurable:!0});e.prototype._prepareResources=function(){var a=this.symbol,b=this._getStageIdHint();this._optionalFields=[];if(!this._isPropertyDriven("size")){var c=n.validateSymbolLayerSize(this.symbol);
if(c){this._logWarning(c);this.reject();return}}a.resource&&a.resource.href?this._prepareModelResources(a.resource.href,b):this._preparePrimitiveResources(a.resource?a.resource.primitive:"sphere",b)};e.prototype._preparePrimitiveResources=function(a,b){if(x.isValidPrimitive(a)){var c=this.symbol;this._resourceBoundingBox=g.create(x.primitiveBoundingBox(a));this._resourceSize=f.vec3f64.fromArray(g.size(this._resourceBoundingBox));this._symbolSize=f.vec3f64.fromArray(n.computeSizeWithResourceSize(this._resourceSize,
c));var d=this._getMaterialOpacity(),d={specular:[0,0,0],opacity:d,transparent:1>d||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:u,diffuse:u,slicePlaneEnabled:this._context.slicePlaneEnabled},e=this.symbolContainer;if("point-3d"===e.type&&e.verticalOffset){var e=e.verticalOffset,l=e.minWorldLength,m=e.maxWorldLength;d.verticalOffset={screenLength:D.pt2px(e.screenLength),minWorldLength:l||0,maxWorldLength:null!=m?m:Infinity};d.castShadows=!1}this._context.screenSizePerspectiveEnabled&&
(d.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._isPropertyDriven("color")?d.externalColor=v:(c=c.material?B.toUnitRGBA(c.material.color):v,d.externalColor=c);this._fastUpdates=k.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(C.mixin(d,this._fastUpdates.materialParameters),d.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&
(d.instanced.push("color"),this._optionalFields.push("color"));c=new R(d,b+"_objectmat");this._lodResources=x.primitiveLodResources(a,c,b);this._originalOpacities=r.materialsFromLodResources(this._lodResources).map(function(){return 1});this._lodResources?(this.finalizeSymbolResources(),this.initializeLodRenderer(),this.complexity=this.computeComplexity(),this.resolve()):(this._logWarning("Unknown object symbol primitive: "+a),this.reject())}else this._logWarning("Unknown object symbol primitive: "+
a),this.reject()};e.prototype._prepareModelResources=function(a,b){var c=this,d=["transformation"];b={materialParamsMixin:{instanced:d,slicePlaneEnabled:this._context.slicePlaneEnabled},idHint:b,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=k.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(C.mixin(b.materialParamsMixin,this._fastUpdates.materialParameters),d.push("featureAttribute"),this._optionalFields.push("featureAttribute")):
this._hasPerInstanceColor()&&(d.push("color"),this._optionalFields.push("color"));d=this.symbolContainer;if("point-3d"===d.type&&d.verticalOffset){var d=d.verticalOffset,e=d.minWorldLength,l=d.maxWorldLength;b.materialParamsMixin.verticalOffset={screenLength:D.pt2px(d.screenLength),minWorldLength:e||0,maxWorldLength:null!=l?l:Infinity};b.materialParamsMixin.castShadows=!1}this._symbolLoaderPromise=I.safeCast(N.fetch(a,b));this._symbolLoaderPromise.then(function(a){c._symbolLoaderPromise=null;if(!c.isRejected()){var b=
E.makeLodResources(a.lods);E.fillEstimatedMinScreenSpaceRadius(b);b.levels.sort(function(a,b){return a.minScreenSpaceRadius-b.minScreenSpaceRadius});b.levels[0].minScreenSpaceRadius=Math.min(2,b.levels[0].minScreenSpaceRadius);c._lodResources=b;var d=c._context,e=c._getExternalColorParameters(c.symbol.material),m=c._getMaterialOpacity(),S=c._isPropertyDriven("opacity"),b=r.materialsFromLodResources(c._lodResources);c._originalOpacities=b.map(function(a){return a.getParameterValues().opacity||1});
b.forEach(function(a){var b=a.getParameterValues();a.setParameterValues(e);var c=b.opacity*m;a.setParameterValues({opacity:c,transparent:1>c||S||b.transparent});d.screenSizePerspectiveEnabled&&a.setParameterValues({screenSizePerspective:d.sharedResources.screenSizePerspectiveSettings})});c._resourceBoundingBox=a.referenceBoundingBox;c._resourceSize=f.vec3f64.fromArray(g.size(c._resourceBoundingBox));c._pivotOffset=f.vec3f64.fromArray(c._lodResources.levels[0].pivotOffset);c._symbolSize=f.vec3f64.fromArray(n.computeSizeWithResourceSize(c._resourceSize,
c.symbol));k.updateFastSymbolUpdatesState(c._fastUpdates,c._context.renderer,c._fastVisualVariableConvertOptions())&&b.forEach(function(a){return a.setParameterValues(c._fastUpdates.materialParameters)});c.finalizeSymbolResources();c.initializeLodRenderer();c.complexity=c.computeComplexity();c.resolve()}},function(a){c._symbolLoaderPromise=null;if(!c.isFulfilled()){if(!(a instanceof H)){var b="ObjectSymbol3DLayer failed to load";a&&a.message&&(b+=" ("+a.message+")");c._logWarning(b)}c.reject()}})};
e.prototype.finalizeSymbolResources=function(){var a=this._context.stage;this._materials=r.materialsFromLodResources(this._lodResources);this._materials.forEach(function(b){a.add(h.ModelContentType.MATERIAL,b)});this._textures=r.texturesFromLodResources(this._lodResources);this._textures.forEach(function(b){a.add(h.ModelContentType.TEXTURE,b)});this._geometries=r.geometriesFromLodResources(this._lodResources);this._geometries.forEach(function(b){a.add(h.ModelContentType.GEOMETRY,b)})};e.prototype.initializeLodRenderer=
function(){var a=this,b=this._context.stage;this._lodRenderer=new Q.LodRenderer(this._lodResources,this._optionalFields,function(b){return{layerUid:a._context.layer.uid,graphicUid:a._instanceIndexToGraphicUid.get(b)}},this._fastUpdates.enabled?{applyTransform:function(b,d,e){b.getFeatureAttribute(d,w);f.mat4.copy(e,k.evaluateModelTransform(a._fastUpdates.materialParameters,w,e))},scaleFactor:function(b,d){b.getFeatureAttribute(d,w);return k.evaluateModelTransformScaleFactor(a._fastUpdates.materialParameters,
w)}}:null);this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;b.addRenderPlugin(this._lodRenderer.slots,this._lodRenderer)};e.prototype._getExternalColorParameters=function(a){var b={};this._isPropertyDriven("color")?b.externalColor=v:a&&a.color?b.externalColor=B.toUnitRGBA(a.color):(b.externalColor=v,b.colorMixMode="ignore");return b};e.prototype.destroy=function(){t.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();
var a=this._context.stage;this._lodRenderer&&(a.removeRenderPlugin(this._lodRenderer),this._lodRenderer.destroy());this._materials&&this._materials.forEach(function(b){return a.remove(h.ModelContentType.MATERIAL,b.id)});this._textures&&this._textures.forEach(function(b){return a.remove(h.ModelContentType.TEXTURE,b.id)});this._geometries&&this._geometries.forEach(function(b){return a.remove(h.ModelContentType.GEOMETRY,b.id)})};e.prototype.createGraphics3DGraphic=function(a){var b=a.graphic;if(!this._validateGeometry(b.geometry))return null;
var c=q.placePointOnGeometry(b.geometry);if(!c)return this._logWarning("unsupported geometry type for icon symbol: "+b.geometry.type),null;var d="graphic"+b.uid,e=this.getGraphicElevationContext(b);return this._createAs3DShape(b,c,a.renderingInfo,e,d,b.uid)};e.prototype.notifyDestroyGraphicLayer=function(a){this._instanceIndexToGraphicUid.delete(a.instanceIndex)};e.prototype.graphicLayerToGraphicId=function(a){return 0};e.prototype.layerOpacityChanged=function(){var a=this,b=this._isPropertyDriven("opacity");
this._materials.forEach(function(c,d){d=a._getMaterialOpacity()*a._originalOpacities[d];c.setParameterValues({opacity:d,transparent:1>d||b})});return!0};e.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,q.needsElevationUpdates3D)};e.prototype.slicePlaneEnabledChanged=function(a,b){var c=this;this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;this._materials.forEach(function(a){a.setParameterValues({slicePlaneEnabled:c._context.slicePlaneEnabled})});
return!0};e.prototype.applyRendererDiff=function(a,b){var c=this,d;for(d in a.diff)switch(d){case "visualVariables":if(k.updateFastSymbolUpdatesState(this._fastUpdates,b,this._fastVisualVariableConvertOptions()))this._materials.forEach(function(a){return a.setParameterValues(c._fastUpdates.materialParameters)}),this._lodRenderer.notifyShaderTransformationChanged();else return!1;break;default:return!1}return!0};e.prototype.computeComplexity=function(){if(!this._lodResources)return t.prototype.computeComplexity.call(this);
var a=r.geometriesFromLodLevelResources(this._lodResources.levels[0]).reduce(function(a,b){return a+b.data.getIndices(P.VertexAttrConstants.POSITION).length},0)/3,b=O.defaultSymbolLayerMemoryComplexity(this.symbolContainer,this.symbol);return{primitivesPerFeature:a,primitivesPerCoordinate:0,memory:b}};e.prototype._createAs3DShape=function(a,b,c,d,e,l){a=this.getFastUpdateAttrValues(a);e=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?n.mixinColorAndOpacity(c.color,c.opacity):null;var m=this._context.clippingExtent;
y.pointToVector(b,p,this._context.elevationProvider.spatialReference);if(m&&!q.pointInBox2D(p,m))return null;y.pointToVector(b,p,this._context.renderSpatialReference);var m="absolute-height"!==d.mode,g=q.computeElevation(this._context.elevationProvider,b,d,this._context.renderCoordsHelper,m?F:null),k=f.mat4.identity(T);this._applyObjectRotation(c,k);this._applyObjectRotation(this.symbol,k);this._applyObjectScale(c,k);this._applyAnchor(k);p[0]=b.x;p[1]=b.y;p[2]=g;c=U;y.computeLinearTransformation(b.spatialReference,
p,c,this._context.renderSpatialReference)||console.warn("Could not locate symbol object properly, it might be misplaced");var g=this._lodRenderer.instanceData,h=g.addInstance();this._instanceIndexToGraphicUid.set(h,l);g.setLocalTransform(h,k,!1);g.setGlobalTransform(h,c);a&&g.setFeatureAttribute(h,a);e&&g.setColor(h,e);l=new L(this,h,K.perLodInstanceElevationAligner,d);m&&(l.alignedTerrainElevation=F.terrainElevation);l.needsElevationUpdates=q.needsElevationUpdates3D(d.mode);q.extendPointGraphicElevationContext(l,
b,this._context.elevationProvider);return l};e.prototype._applyObjectScale=function(a,b){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(a=this._isPropertyDriven("size")&&a.size?a.size:this._symbolSize,a=n.computeObjectScale(a,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters),1===a[0]&&1===a[1]&&1===a[2]||f.mat4.scale(b,b,a))};e.prototype._applyObjectRotation=function(a,b){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&
a instanceof J))return n.computeObjectRotation(a.heading,a.tilt,a.roll,b)};e.prototype._computeAnchor=function(){var a=f.vec3f64.create();switch(this.symbol.anchor){case "center":f.vec3.copy(a,g.center(this._resourceBoundingBox));f.vec3.negate(a,a);break;case "top":var b=g.center(this._resourceBoundingBox);f.vec3.set(a,-b[0],-b[1],-this._resourceBoundingBox[5]);break;case "bottom":b=g.center(this._resourceBoundingBox);f.vec3.set(a,-b[0],-b[1],-this._resourceBoundingBox[2]);break;case "relative":var b=
g.center(this._resourceBoundingBox),c=g.size(this._resourceBoundingBox),d=this.symbol.anchorPosition,d=d?f.vec3f64.fromValues(d.x,d.y,d.z):z;f.vec3.multiply(a,c,d);f.vec3.add(a,a,b);f.vec3.negate(a,a);break;default:this._pivotOffset?f.vec3.negate(a,this._pivotOffset):f.vec3.copy(a,z)}return a};e.prototype._applyAnchor=function(a){if(!this._fastUpdates.enabled||!this._fastUpdates.requiresShaderTransformation){var b=this._computeAnchor();b&&f.mat4.translate(a,a,b)}};e.prototype._hasPerInstanceColor=
function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};e.prototype._fastVisualVariableConvertOptions=function(){var a=this._resourceBoundingBox?f.vec3f64.fromArray(g.size(this._resourceBoundingBox)):u,b=this._resourceBoundingBox?this._computeAnchor():z,c=this._context.renderCoordsHelper.unitInMeters,d=n.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,c),e=f.vec3f64.fromValues(this.symbol.tilt||0,this.symbol.roll||0,this.symbol.heading||0);return{modelSize:a,
symbolSize:this._symbolSize||u,unitInMeters:c,transformation:{anchor:b,scale:d,rotation:e}}};return e}(M);var u=f.vec3f64.fromValues(1,1,1),v=f.vec4f64.fromValues(1,1,1,1),z=f.vec3f64.fromValues(0,0,0),p=f.vec3f64.create(),T=f.mat4f64.create(),U=f.mat4f64.create(),w=f.vec4f64.create(),F={verticalDistanceToGround:0,terrainElevation:0};return A});