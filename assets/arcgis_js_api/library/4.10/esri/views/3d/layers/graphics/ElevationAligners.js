// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../geometry/Point ./Graphics3DSymbolCommonCode ./graphicUtils ../../support/debugFlags ../../support/projectionUtils ../../webgl-engine/lib/Util".split(" "),function(J,q,k,F,z,G,A,u,H){Object.defineProperty(q,"__esModule",{value:!0});var I=H.VertexAttrConstants,v=new F,g=k.vec3f64.create(),e=k.vec3f64.create(),n=k.vec3f64.create(),c=k.mat4f64.create(),w=k.vec3f64.create(),r={verticalDistanceToGround:0,terrainElevation:0};
q.perVertexElevationAligner=function(d,a,h,b){d=d.stageObject;v.spatialReference=h.spatialReference;for(var B=d.getGeometryRecords(),l=B.length,c="absolute-height"!==a.mode,t=0,k=0;k<l;k++){var f=B[k].geometry,p=B[k].getShaderTransformation();e[0]=p[12];e[1]=p[13];e[2]=p[14];f.invalidateBoundingInfo();for(var p=f.data.getVertexAttr(),x=p[I.POSITION],f=x.data,p=p.mapPos.data,x=x.size,u=f.length/x,m=0,C=0,D=!1,w=0,E=0;E<u;E++){v.x=p[C++];v.y=p[C++];v.z=p[C++];n[0]=f[m];n[1]=f[m+1];n[2]=f[m+2];var y=
z.computeElevation(h,v,a,b,c?r:null);c&&(w+=r.terrainElevation);g[0]=f[m]+e[0];g[1]=f[m+1]+e[1];g[2]=f[m+2]+e[2];b.setAltitude(y,g);f[m]=g[0]-e[0];f[m+1]=g[1]-e[1];f[m+2]=g[2]-e[2];if(A.TESTS_DISABLE_UPDATE_THROTTLE_THRESHOLDS)D=!0;else if(y=q.updateThresholdInMeters/b.unitInMeters,Math.abs(n[0]-f[m])>=y||Math.abs(n[1]-f[m+1])>=y||Math.abs(n[2]-f[m+2])>=y)D=!0;m+=x}t+=w/u;D&&d.geometryVertexAttrsUpdated(k)}return t/l};q.perObjectElevationAligner=function(d,a,h,b,c){d=d.stageObject;var l=a.centerPointInElevationSR,
e=0;c=0;if(d.metadata.usesVerticalDistanceToGround)e=z.computeElevation(h,l,a,b,r),G.updateVertexAttributeAuxpos1w(d,r.verticalDistanceToGround),c=r.terrainElevation;else{var t="absolute-height"!==a.mode,e=z.computeElevation(h,l,a,b,t?r:null);t&&(c=r.terrainElevation)}a=d.getObjectTransformation();h=k.vec3.set(w,a[12],a[13],a[14]);A.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(g[0]=l.x,g[1]=l.y,g[2]=e,u.computeLinearTransformation(l.spatialReference,g,a,b.spatialReference)&&d.setObjectTransformation(a)):
b.setAltitudeOfTransformation(e,a);b=q.updateThresholdInMeters/b.unitInMeters;(Math.abs(a[12]-h[0])>=b||Math.abs(a[13]-h[1])>=b||Math.abs(a[14]-h[2])>=b)&&d.setObjectTransformation(a);return c};q.perLodInstanceElevationAligner=function(d,a,h,b,e){var l=a.centerPointInElevationSR,n=0;e=0;var t="absolute-height"!==a.mode,n=z.computeElevation(h,l,a,b,t?r:null);t&&(e=r.terrainElevation);a=d.graphics3DSymbolLayer.lodRenderer.instanceData;d=d.instanceIndex;a.getGlobalTransform(d,c);h=k.vec3.set(w,c[12],
c[13],c[14]);A.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(g[0]=l.x,g[1]=l.y,g[2]=n,u.computeLinearTransformation(l.spatialReference,g,c,b.spatialReference)&&a.setGlobalTransform(d,c)):b.setAltitudeOfTransformation(n,c);b=q.updateThresholdInMeters/b.unitInMeters;(Math.abs(c[12]-h[0])>=b||Math.abs(c[13]-h[1])>=b||Math.abs(c[14]-h[2])>=b)&&a.setGlobalTransform(d,c);return e};q.updateThresholdInMeters=.01;q.iterativeUpdatesEnabled=!0});