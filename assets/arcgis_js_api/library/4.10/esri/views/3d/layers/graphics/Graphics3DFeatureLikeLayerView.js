// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../Graphic ../../../../core/Accessor ../../../../core/compilerUtils ../../../../core/Handles ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/webMercatorUtils ../../../../renderers/support/diffUtils ../../../../tasks/support/Query ./constants ./Graphics3DCore ./Graphics3DElevationAlignment ./Graphics3DFrustumVisibility ./Graphics3DHighlights ./Graphics3DScaleVisibility ./Graphics3DSpatialIndex ./graphicUtils ../support/attributeUtils".split(" "),
function(F,G,p,e,h,q,r,t,u,g,c,k,l,v,w,x,y,z,A,B,C,D,m){return function(n){function b(a){a=n.call(this)||this;a._handles=new t;a.highlights=new A;a.suspendResumeExtentMode="computed";a.dataExtent=null;a.suspendResumeExtent=null;return a}p(b,n);Object.defineProperty(b.prototype,"suspended",{get:function(){return this.scaleVisibility&&this.scaleVisibility.suspended||this.frustumVisibility&&this.frustumVisibility.suspended},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",
{get:function(){return!!(this.graphicsCore&&this.graphicsCore.updating||this.frustumVisibility&&this.frustumVisibility.updating||this.scaleVisibility&&this.scaleVisibility.updating)},enumerable:!0,configurable:!0});b.prototype.normalizeCtorArgs=function(a){var b=a.queryGraphicUIDsInExtent||!a.scaleVisibilityEnabled&&!a.elevationAlignmentEnabled?null:new C({spatialReference:a.owner.view.spatialReference}),d=a.frustumVisibilityEnabled?new z:null,c=a.scaleVisibilityEnabled?new B:null,e=a.elevationAlignmentEnabled?
new y:null,f=function(a,d,E){return b.queryGraphicUIDsInExtent(a,d,E)};return{graphicsCore:new x({owner:a.owner,layer:a.layer,asyncUpdates:a.asyncGraphicsUpdates,basemapTerrain:a.owner.view.basemapTerrain,elevationFeatureExpressionEnabled:a.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1}),frustumVisibility:d,scaleVisibility:c,elevationAlignment:e,spatialIndex:b,updateClippingExtent:a.updateClippingExtent,suspendResumeExtentMode:a.suspendResumeExtentMode,dataExtent:a.dataExtent,queryGraphicUIDsInExtent:a.queryGraphicUIDsInExtent||
f}};b.prototype.initialize=function(){var a=this;this.scaleVisibility&&this._handles.add(this.layer.watch(["minScale","maxScale"],function(){return a.scaleVisibility.layerMinMaxScaleChangeHandler()}));this.elevationAlignment&&this._handles.add(this.layer.watch("elevationInfo",function(b,d){l.diff(b,d)&&a.graphicsCore.elevationInfoChange()}));this.graphicsCore&&(this._handles.add(this.layer.watch("labelsVisible",function(){return a.graphicsCore.updateVisibilityInfo()})),this._handles.add(this.layer.watch("labelingInfo",
function(b,d){l.diff(b,d)&&a.graphicsCore.updateLabelingInfo()})));this.idleClients=[this.frustumVisibility,this.scaleVisibility,this.graphicsCore,this.elevationAlignment]};b.prototype.setup=function(){var a=this;this.frustumVisibility&&this.frustumVisibility.setup(this.owner);var b=this.owner.view.basemapTerrain,d=this.owner.view.elevationProvider;this.scaleVisibility&&this.scaleVisibility.setup(this.owner,this.layer,this.queryGraphicUIDsInExtent,this.graphicsCore,b);this.elevationAlignment&&this.elevationAlignment.setup(this.owner,
this.queryGraphicUIDsInExtent,this.graphicsCore,d);this.highlights&&this.highlights.setup(this.graphicsCore);this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility,this.spatialIndex));this._set("deconfliction",this.owner.view.deconflictor.addGraphicsOwner(this.graphicsCore));this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,spatialIndex:this.spatialIndex,deconfliction:this.deconfliction,labeling:this.labeling,
highlights:this.highlights});this._handles.add([this.layer.watch("renderer",function(b){return a.graphicsCore.rendererChange(b)}),this.owner.watch("fullOpacity",function(){return a.graphicsCore.opacityChange()})]);this._handles.add(this.layer.on("graphic-update",function(b){return a.graphicsCore.graphicUpdateHandler(b)}));this.setupSuspendResumeExtent();this._handles.add(this.owner.view.resourceController.registerIdleFrameWorker({needsUpdate:function(){return a.needsIdleUpdate()},idleFrame:function(b){return a.idleUpdate(b)}}));
this.updateClippingExtent&&(this._handles.add(this.owner.view.watch("clippingArea",function(){return a._updateClippingExtent()})),this._updateClippingExtent());this.graphicsCore.startCreateGraphics();return this.graphicsCore.labelsEnabled?this.graphicsCore.updateLabelingInfo():u.resolve()};b.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);this.frustumVisibility&&(this.frustumVisibility.destroy(),this._set("frustumVisibility",null));this.scaleVisibility&&(this.scaleVisibility.destroy(),
this._set("scaleVisibility",null));this.elevationAlignment&&(this.elevationAlignment.destroy(),this._set("elevationAlignment",null));this.graphicsCore&&(this.graphicsCore.destroy(),this._set("graphicsCore",null));this.spatialIndex&&(this.spatialIndex.destroy(),this._set("spatialIndex",null));this.highlights&&(this.highlights.destroy(),this._set("highlights",null));this._set("layer",null);this._set("owner",null)};b.prototype.highlight=function(a,b,d){var c=this;if(a instanceof v){b=this.highlights.acquireSet(b,
d);var e=b.set,f=b.handle;this.owner.queryObjectIds(a).then(function(a){return c.highlights.setObjectIds(e,a)});return f}if("number"===typeof a||a instanceof h)return this.highlight([a],b,d);"toArray"in a&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof h)if(f=a,d&&f[0].attributes&&null!==m.attributeLookup(f[0].attributes,d))a=f.map(function(a){return m.attributeLookup(a.attributes,d)});else return a=f.map(function(a){return a.uid}),f=this.highlights.acquireSet(b,null),b=f.set,
f=f.handle,this.highlights.setUids(b,a),f;if("number"===typeof a[0])return f=this.highlights.acquireSet(b,d),b=f.set,f=f.handle,this.highlights.setObjectIds(b,a),f}return{remove:function(){}}};b.prototype.needsIdleUpdate=function(){for(var a=0,b=this.idleClients;a<b.length;a++){var d=b[a];if(d&&d.needsIdleUpdate())return!0}return!1};b.prototype.idleUpdate=function(a){for(var b=0,d=this.idleClients;b<d.length;b++){var c=d[b];if(c&&c.needsIdleUpdate()&&(c.idleUpdate(a),a.done()))break}};b.prototype._updateClippingExtent=
function(){var a=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(a,this.owner.view.spatialReference)&&(this.updateClippingExtent(a)||this.graphicsCore.recreateAllGraphics())};b.prototype.setupSuspendResumeExtent=function(){var a=this;(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(g.init(this,"suspendResumeExtentMode",function(b){a._handles.remove("suspendResumeExtentMode");switch(a.suspendResumeExtentMode){case "computed":a._handles.add(g.init(a.graphicsCore,"computedExtent",
function(b){return a.updateSuspendResumeExtent(b)}),"suspendResumeExtentMode");break;case "data":a._handles.add(g.init(a,"dataExtent",function(b){return a.updateSuspendResumeExtent(b)}),"suspendResumeExtentMode");break;default:r.neverReached(a.suspendResumeExtentMode)}}))};b.prototype.updateSuspendResumeExtent=function(a){a?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(a,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)};b.prototype.extentToSuspendResumeRect=function(a,
b){var c=this.owner.view.spatialReference;if(!a.spatialReference.equals(c)){if(!k.canProject(a,c))return;a=k.project(a,c)}return D.enlargeExtent(a,b,w.SUSPEND_RESUME_EXTENT_OPTIMISM)};b.prototype.suspendResumeExtentChanged=function(a){this.frustumVisibility&&this.frustumVisibility.setExtent(a);this.scaleVisibility&&this.scaleVisibility.setExtent(a)};e([c.property({aliasOf:"graphicsCore.layer"})],b.prototype,"layer",void 0);e([c.property({aliasOf:"graphicsCore.owner"})],b.prototype,"owner",void 0);
e([c.property({constructOnly:!0})],b.prototype,"updateClippingExtent",void 0);e([c.property({constructOnly:!0})],b.prototype,"queryGraphicUIDsInExtent",void 0);e([c.property({constructOnly:!0})],b.prototype,"graphicsCore",void 0);e([c.property({constructOnly:!0})],b.prototype,"spatialIndex",void 0);e([c.property({constructOnly:!0})],b.prototype,"scaleVisibility",void 0);e([c.property({constructOnly:!0})],b.prototype,"elevationAlignment",void 0);e([c.property({constructOnly:!0})],b.prototype,"frustumVisibility",
void 0);e([c.property({readOnly:!0})],b.prototype,"deconfliction",void 0);e([c.property({readOnly:!0})],b.prototype,"labeling",void 0);e([c.property({readOnly:!0})],b.prototype,"highlights",void 0);e([c.property()],b.prototype,"suspendResumeExtentMode",void 0);e([c.property()],b.prototype,"dataExtent",void 0);e([c.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],b.prototype,"suspended",null);e([c.property({readOnly:!0,dependsOn:["graphicsCore.updating",
"frustumVisibility.updating","scaleVisibility.updating"]})],b.prototype,"updating",null);return b=e([c.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],b)}(c.declared(q))});