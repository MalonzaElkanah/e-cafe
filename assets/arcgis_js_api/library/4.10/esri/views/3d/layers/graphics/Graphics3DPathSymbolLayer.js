// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../geometry/Point ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial".split(" "),function(r,U,H,t,I,J,m,K,
L,M,A,N,B,O,C,P){function Q(k,e,b,a){k=k.stageObject;for(var c=k.getGeometryRecords(),D=c.length,t="absolute-height"!==e.mode,E=0,f=0;f<D;f++){var F=c[f].geometry,n=[c[f].transformation[12],c[f].transformation[13],c[f].transformation[14]],h=F.data.getVertexAttr(),p=h[R.POSITION].data,S=h.zOffset.data,h=h.mapPos.data,x=h.length/3;T(p.length/3===x*z+2,"unexpected tube geometry");var l=0,y=0;u.spatialReference=b.spatialReference;for(var w=0,d=0;d<x;d++){u.x=h[3*d];u.y=h[3*d+1];u.z=h[3*d+2];var g=m.computeElevation(b,
u,e,a,t?G:null);t&&(w+=G.terrainElevation);var v=z;0!==d&&d!==x-1||v++;for(var r=0;r<v;r++)q[0]=p[l]+n[0],q[1]=p[l+1]+n[1],q[2]=p[l+2]+n[2],a.setAltitude(g+S[y],q),p[l]=q[0]-n[0],p[l+1]=q[1]-n[1],p[l+2]=q[2]-n[2],l+=3,y+=1;F.invalidateBoundingInfo()}k.geometryVertexAttrsUpdated(f);E+=w/x}return E/D}var T=C.assert;r=function(k){function e(){return null!==k&&k.apply(this,arguments)||this}H(e,k);e.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var b=L.validateSymbolLayerSize(this._getSymbolSize());
if(b){this._logWarning(b);this.reject();return}}var b=this._getStageIdHint(),a=this._getMaterialOpacityAndColor(),c=t.vec3f64.fromArray(a),a=a[3],c={diffuse:c,ambient:c,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),vertexColors:this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new P(c,b+"_3dlinemat");this._context.stage.add(A.ModelContentType.MATERIAL,this._material);this.resolve()};e.prototype.destroy=
function(){k.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(A.ModelContentType.MATERIAL,this._material.id),this._material=null)};e.prototype.createGraphics3DGraphic=function(b){var a=b.graphic;if("polyline"!==a.geometry.type)return this._logWarning("unsupported geometry type for path symbol: "+a.geometry.type),null;if(!this._validateGeometry(a.geometry))return null;var c="graphic"+a.uid,e=this.getGraphicElevationContext(a);return this._createAs3DShape(a,
b.renderingInfo,e,c,a.uid)};e.prototype.layerOpacityChanged=function(){var b=this._getMaterialOpacity(),a=1>b||this._isPropertyDriven("opacity");this._material.setParameterValues({opacity:b,transparent:a});return!0};e.prototype.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,m.needsElevationUpdates3D)};e.prototype.slicePlaneEnabledChanged=function(b,a){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};e.prototype._getPathSize=
function(b){b=b.size&&this._isPropertyDriven("size")?m.getSingleSizeDriver(b.size):this._getSymbolSize();return b/=this._context.renderCoordsHelper.unitInMeters};e.prototype._getSymbolSize=function(){return this.symbol.size||1};e.prototype._createAs3DShape=function(b,a,e,k,q){var c=b.geometry,f=c.paths;b=[];var r=[],n=[],h=t.vec3f64.create(),p=this._context.renderSpatialReference===M.SphericalECEFSpatialReference,u=Array(6),x=this._getPathSize(a),c=m.getGeometryVertexData3D(f,c.hasZ,c.spatialReference,
this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,e);this._logGeometryCreationWarnings(c,f,"paths","PathSymbol3DLayer");if(0<f.length){for(var f=c.geometryData.outlines,l=c.eleVertexData,y=c.vertexData,w=0;w<f.length;++w){var d=f[w];if(!(1>=d.count)){var g=d.index,v=d.count;if(this._context.clippingExtent&&(m.computeBoundingBox(l,g,v,u),m.boundingBoxClipped(u,this._context.clippingExtent)))continue;m.chooseOrigin(y,g,v,h);m.subtractCoordinates(y,
g,v,h);d=new Float64Array(l.buffer,3*g*l.BYTES_PER_ELEMENT,3*v);g=m.flatArrayToArrayOfArrays(y,g,v);g=B.createTubeGeometry(g,.5*x,z,p,h);g.getVertexAttr().mapPos={size:3,data:d,offsetIdx:0,strideIdx:3};this._material.getParams().vertexColors&&(d=this._getVertexOpacityAndColor(a),g=B.addVertexColors(g,d));d=new N(g,k+"path"+w);d.singleUse=!0;b.push(d);r.push(this._material);d=t.mat4f64.create();t.mat4.translate(d,d,h);n.push(d)}}if(0<b.length)return a=new O({geometries:b,materials:r,transformations:n,
castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:q},idHint:k}),a=new J(this,a,b,null,null,Q,e),a.alignedTerrainElevation=c.terrainElevation,a.needsElevationUpdates=m.needsElevationUpdates3D(e.mode),a}return null};return e}(K);var R=C.VertexAttrConstants,q=t.vec3f64.create(),u=new I,G={verticalDistanceToGround:0,terrainElevation:0},z=10;return r});