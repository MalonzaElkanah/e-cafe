// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/screenUtils ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingBox ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Util ../../webgl-engine/materials/ColorMaterial".split(" "),
function(x,O,C,D,E,y,q,F,r,G,H,I,m,J,K,t,u,z,L,M,A,v,N){x=function(w){function l(){var a=null!==w&&w.apply(this,arguments)||this;a._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};return a}C(l,w);l.prototype._prepareResources=function(){this._prepareFillResources();this._prepareOutlineResources();this.resolve()};l.prototype._prepareFillResources=function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),b={color:b,transparent:1>b[3]||this._isPropertyDriven("opacity"),
polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new N(b,a+"_colormat");this._context.stage.add(u.ModelContentType.MATERIAL,this._material)};l.prototype._prepareOutlineResources=function(){var a=this.symbol.outline;if(this._hasOutline=!!(a&&a.size&&0<a.size&&a.color))a={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:E.pt2px(a.size),slicePlaneEnabled:this._context.slicePlaneEnabled},this._outlineMaterial=1.5<=a.width?t.createRibbonMaterial(a):
t.createNativeMaterial(a),this._context.stage.add(u.ModelContentType.MATERIAL,this._outlineMaterial)};l.prototype.destroy=function(){w.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._material.id),this._material=null);this._outlineMaterial&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._outlineMaterial.id),this._outlineMaterial=null)};l.prototype.createGraphics3DGraphic=function(a){var b=a.graphic,
g=b.geometry.type;if("polyline"!==g&&"polygon"!==g&&"extent"!==g)return this._logWarning("unsupported geometry type for fill symbol: "+g),null;if(!this._validateGeometry(b.geometry))return null;g="graphic"+b.uid;a=this._getVertexOpacityAndColor(a.renderingInfo,Uint8Array,255);var k=this.getGraphicElevationContext(b);return"on-the-ground"===k.mode?this._createAsOverlay(b,a,k,g):this._createAs3DShape(b,a,k,g,b.uid)};l.prototype.layerOpacityChanged=function(){var a=this._material.getColor(),b=this._getMaterialOpacity();
this._material.setColor([a[0],a[1],a[2],b]);this._material.setTransparent(1>b||this._isPropertyDriven("opacity"));this._outlineMaterial&&(a=this._outlineMaterial.getColor(),a={color:[a[0],a[1],a[2],this._getOutlineOpacity()]},this._outlineMaterial.setParameterValues(a));return!0};l.prototype.layerElevationInfoChanged=function(a,b,g){var k=this._elevationContext.mode;if(null==g||null==k)return!1;if("on-the-ground"===g&&"on-the-ground"===k)return!0;if(g!==k&&("on-the-ground"===g||"on-the-ground"===
k))return!1;var h=m.needsElevationUpdates2D(k);return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return h})};l.prototype.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});this._outlineMaterial&&this._outlineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};l.prototype.setDrawOrder=function(a,b,g){this.updateSymbolLayerOrder(a,b);this._material&&(this._material.renderPriority=
a+b/2,g.add(this._material.id));this._outlineMaterial&&(this._outlineMaterial.renderPriority=a,g.add(this._outlineMaterial.id))};l.prototype._createAs3DShape=function(a,b,g,k,h){var d=this._getPolyGeometry(a);a=d.rings;var e=this._getOutlineGeometry(d,a),d=m.getGeometryVertexData3D(e,d.hasZ,d.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,g);c.idHint=k;c.color=b;c.data=d;var f;this._hasOutline&&(f=new d.vertexData.constructor(d.vertexData));
c.outNum=0;c.outGeometries=[];c.outTransforms=[];c.outMaterials=[];this._createAs3DShapeFill(c);c.data.vertexData=f;this._createAs3DShapeOutline(c);this._logGeometryCreationWarnings(c.data,a,"rings","FillSymbol3DLayer");if(0===c.outNum)return null;b=new M({geometries:c.outGeometries,materials:c.outMaterials,transformations:c.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:h},idHint:k});b=new I(this,b,c.outGeometries,null,null,G.perVertexElevationAligner,g);b.alignedTerrainElevation=
d.terrainElevation;b.needsElevationUpdates=m.needsElevationUpdates2D(g.mode);return b};l.prototype._createAs3DShapeFill=function(a){for(var b=a.data.geometryData.polygons,g=a.data.eleVertexData,k=a.data.vertexData,h=function(f){var e=b[f];f=e.count;var h=e.index;if(d._context.clippingExtent&&(m.computeBoundingBox(g,h,f,n),m.boundingBoxClipped(n,d._context.clippingExtent)))return"continue";var c=new Float64Array(g.buffer,3*h*g.BYTES_PER_ELEMENT,3*f),l=new Float64Array(k.buffer,3*h*k.BYTES_PER_ELEMENT,
3*f),e=e.holeIndices.map(function(a){return a-h}),e=y(c,e,3);if(0===e.length)return"continue";m.chooseOrigin(k,h,f,p);m.subtractCoordinates(k,h,f,p);f=d._createFillGeometry(e,0,l,c,a.color);f=new z(f,a.idHint);f.singleUse=!0;c=q.mat4f64.create();q.mat4.translate(c,c,p);a.outGeometries.push(f);a.outMaterials.push(d._material);a.outTransforms.push(c);a.outNum++},d=this,e=0;e<b.length;++e)h(e)};l.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,
g=a.data.eleVertexData,c=a.data.vertexData,h=0;h<b.length;++h){var d=b[h],e=d.index,f=d.count;if(this._context.clippingExtent&&(m.computeBoundingBox(g,e,f,n),m.boundingBoxClipped(n,this._context.clippingExtent)))continue;m.chooseOrigin(c,e,f,p);m.subtractCoordinates(c,e,f,p);d=new Float64Array(g.buffer,3*e*g.BYTES_PER_ELEMENT,3*f);e=new Float64Array(c.buffer,3*e*c.BYTES_PER_ELEMENT,3*f);e=t.createPolylineGeometry(e,d,!1,B,0);e=new z(e,a.idHint+"outline"+h);e.singleUse=!0;d=q.mat4f64.create();q.mat4.translate(d,
d,p);a.outGeometries.push(e);a.outMaterials.push(this._outlineMaterial);a.outTransforms.push(d);a.outNum++}};l.prototype._createAsOverlay=function(a,b,g,k){g=this._getPolyGeometry(a);a=g.rings;var h=this._getOutlineGeometry(g,a);this._material.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2;this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);g=m.getGeometryVertexDataDraped(h,g.spatialReference,this._context.overlaySR);c.idHint=k;c.color=b;c.data=g;var d;
this._hasOutline&&(d=new g.vertexData.constructor(g.vertexData));c.outNum=0;c.outGeometries=[];c.outBoundingBox=r.empty();this._createAsOverlayFill(c);c.data.vertexData=d;this._createAsOverlayOutline(c);this._logGeometryCreationWarnings(c.data,a,"rings","FillSymbol3DLayer");return 0<c.outNum?new H(this,c.outGeometries,c.outBoundingBox):null};l.prototype._createAsOverlayFill=function(a){for(var b=a.data.vertexData,g=a.data.geometryData.polygons,c=function(e){var f=g[e];e=f.count;var d=f.index,c=new Float64Array(b.buffer,
3*d*b.BYTES_PER_ELEMENT,3*e),f=f.holeIndices.map(function(a){return a-d}),c=y(c,f,3);if(0===c.length)return"continue";m.computeBoundingBox(b,d,e,n);if(m.boundingBoxClipped(n,h._context.clippingExtent))return"continue";r.expand(a.outBoundingBox,n);m.chooseOrigin(b,d,e,p);m.subtractCoordinates(b,d,e,p);m.setZ(b,d,e,h._getDrapedZ());e=q.mat4f64.create();q.mat4.translate(e,e,p);c=h._createFillGeometry(c,d,b,null,a.color);f=new A(c);f.material=h._material;var k=n;f.center=[.5*(k[0]+k[3]),.5*(k[1]+k[4]),
0];f.bsRadius=.5*Math.sqrt((k[3]-k[0])*(k[3]-k[0])+(k[4]-k[1])*(k[4]-k[1]));f.transformation=e;f.name=a.idHint;f.uniqueName=a.idHint+"#"+c.id;a.outGeometries.push(f);a.outNum++},h=this,d=0;d<g.length;++d)c(d)};l.prototype._createAsOverlayOutline=function(a){if(this._hasOutline)for(var b=a.data.vertexData,c=a.data.geometryData.outlines,k=0;k<c.length;++k){var h=c[k],d=h.index,h=h.count;m.computeBoundingBox(b,d,h,n);if(!m.boundingBoxClipped(n,this._context.clippingExtent)){r.expand(a.outBoundingBox,
n);m.chooseOrigin(b,d,h,p);m.subtractCoordinates(b,d,h,p);m.setZ(b,d,h,this._getDrapedZ());h=new Float64Array(b.buffer,3*d*b.BYTES_PER_ELEMENT,3*h);d=q.mat4f64.create();q.mat4.translate(d,d,p);var h=t.createPolylineGeometry(h,null,!0,B,0),e=new A(h);e.material=this._outlineMaterial;var f=n;e.center=[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0];e.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]));e.transformation=d;e.name=a.idHint+"outline";e.uniqueName=a.idHint+"outline#"+h.id;a.outGeometries.push(e);
a.outNum++}}};l.prototype._getOutlineGeometry=function(a,b){return b};l.prototype._getOutlineOpacity=function(){return this._getLayerOpacity()*this.symbol.outline.color.a};l.prototype._getOutlineColor=function(){var a=this.symbol.outline.color,b=this._getOutlineOpacity();return K.mixinColorAndOpacity(D.toUnitRGB(a),b)};l.prototype._getPolyGeometry=function(a){a=a.geometry;return"extent"===a.type?F.fromExtent(a):a};l.prototype._createFillGeometry=function(a,b,c,k,h){for(var d=a.length,e=new Uint32Array(d),
f=new Uint32Array(d),g=0;g<d;g++)e[g]=a[g]+b,f[g]=0;a={};b={};a[v.VertexAttrConstants.POSITION]=e;a[v.VertexAttrConstants.COLOR]=f;b[v.VertexAttrConstants.POSITION]={size:3,data:c};b[v.VertexAttrConstants.COLOR]={size:4,data:h};k&&(b.mapPos={size:3,data:k},a.mapPos=e);return new L(b,a)};return l}(J);var n=r.create(),p=q.vec3f64.create(),B=new Float32Array([255,255,255,255]),c={idHint:null,color:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return x});