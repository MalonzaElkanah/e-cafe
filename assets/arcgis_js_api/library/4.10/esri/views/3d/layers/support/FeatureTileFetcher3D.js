// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/Logger ../../../../core/now ../../../../core/promiseUtils ../../../../core/QueueProcessor ../../../../core/scheduling ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../../../tasks/support/QuantizationParameters ../../../../tasks/support/Query ./featureReference ./FeatureTile ./featureTileQuery3D".split(" "),
function(u,m,H,h,X,q,r,I,v,J,K,x,y,L,M,z,e,t,N,A,B,C,O,P){function n(e,b){return null!=e.objectId?e.objectId:e.attributes[b]}function Q(e){for(var b=0,a=0;a<e.length;a++){var c=e[a];c.features&&0<c.features.length&&c.alive&&(b=Math.max(b,c.descriptor.lij[0]))}return b}Object.defineProperty(m,"__esModule",{value:!0});var R=C.SingleFeatureReference,S=C.MultiFeatureReference,D=K.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");u=function(m){function b(a){a=m.call(this,a)||this;a.useTileCount=
!1;a.updating=!1;a.updatingTotal=0;a.updatingRemaining=0;a.expectedFeatureDiff=0;a.maximumNumberOfFeaturesExceeded=!1;a.maximumNumberOfFeaturesExceededThrottle=1E3;a.maximumNumberOfFeaturesExceededNext=0;a._fullRatio=1;a._farRatio=1;a.changes={updates:{adds:[],removes:[]},adds:[],removes:[]};a.handles=new J;a._dirty=!1;a.idToFeatureTile=new Map;a.displayingFeatureReferences=new Map;a.numDisplayingFeatureReferences=0;a.suspended=!0;a.pendingEdits=null;return a}H(b,m);Object.defineProperty(b.prototype,
"maximumNumberOfFeatures",{set:function(a){a=a||Infinity;var c=this._get("maximumNumberOfFeatures");a===c||1>a||(this._set("maximumNumberOfFeatures",a),this.maximumFeaturesUpdated(c,a))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"memoryForUnusedFeatures",{get:function(){var a=0;this.forEachFeatureTile(function(c){return a+=c.estimatedUnusedSize});return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"totalVertices",{get:function(){var a=0;this.forEachFeatureTile(function(c){return a+=
c.numVertices});return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"totalFeatures",{get:function(){var a=0;this.forEachFeatureTile(function(c){return a+=c.numFeatures});return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"filterExtent",{set:function(a){if(a&&this.tilingScheme&&!a.spatialReference.equals(this.tilingScheme.spatialReference))D.error("#filterExtent\x3d","extent needs to be in the same spatial reference as the tiling scheme");else{var c=
this._get("filterExtent");c===a||c&&a&&c.equals(a)||(a=a?a.clone():null,this._set("filterExtent",a),this.reclip(a,c))}},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;this.capabilities=this.calculateCapabilities();this.fetchQueue=this.createFetchQueue();var c=this.layerView.layer;this.handles.add(z.on(this,"tileDescriptors","change",function(){return a.setDirty()},function(){return a.setDirty()}));this.handles.add(c.watch("hasService",function(){return a._initMemCache()}));
z.init(c,"hasService",function(){return a._initMemCache()});this.objectIdField=c.objectIdField;this.FeatureReferenceClass=this.capabilities.supportsMultipleResolutions?S:R;this.featureTileQuery=P.createFeatureTileQuery3D(c);this._idleFrameWorker=this.layerView.view.resourceController.registerIdleFrameWorker({needsUpdate:function(){return a._dirty||0<a.maximumNumberOfFeaturesExceededNext},idleBegin:function(){return a.unpause()},idleFrame:function(c){return a.update(c)},idleEnd:function(){return a.pause()}});
this.setDirty()};b.prototype.destroy=function(){var a=this;this._idleFrameWorker&&(this._idleFrameWorker.remove(),this._idleFrameWorker=null);this.handles&&(this.handles.destroy(),this.handles=null);this.forEachFeatureTile(function(c){return a.cancelFetchTile(c)});this.fetchQueue.clear();this.pendingEdits&&(this.pendingEdits.edits.cancel(E),this.pendingEdits=null);this._memCache&&this._memCache.destroy();this._memCache=null};Object.defineProperty(b.prototype,"paused",{get:function(){return this.suspended||
!!this.pendingEdits},enumerable:!0,configurable:!0});b.prototype.filtersChanged=function(){var a=this;this.fetchQueue.clear();this._memCache&&this._memCache.clear();this.forEachFeatureTile(function(c){a.resetFetchTile(c);a.queueFetchTile(c)});this.setDirty()};b.prototype.suspend=function(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())};b.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.unpause())};b.prototype.pause=function(){this.paused&&(this.fetchQueue.pause(),
this.fetchQueue.reset(),this.updated())};b.prototype.unpause=function(){this.paused||(this.setDirty(),this.fetchQueue.resume(),this.updated())};b.prototype.getFeatureTileById=function(a){return this.idToFeatureTile.get(a)||null};b.prototype.forEachFeatureTile=function(a){this.idToFeatureTile.forEach(a)};b.prototype.applyEdits=function(a){var c=this;this.pendingEdits||(this.pendingEdits={edits:y.resolve(),count:0},this.pause());this.pendingEdits.count++;var d=this.pendingEdits.edits.then(function(){return a.result.catch(function(a){if(a===
E)throw a;return null}).then(function(a){return a?(c.applyEditsDeleteFeatures(a.deletedFeatures),v.safeCast(c.applyEditsAddUpdateFeatures(a.addedFeatures,a.updatedFeatures).then(function(){return a}))):a}).then(function(a){0===--c.pendingEdits.count&&(c.pendingEdits=null,c._memCache&&c._memCache.clear(),c.unpause());return a})});return this.pendingEdits.edits=d};b.prototype.applyEditsDeleteFeatures=function(a){var c=this;if(0!==a.length){var d=new Set;a.forEach(function(a){return d.add(a.objectId)});
this.forEachFeatureTile(function(a){if(a.features){var b=a.features.filter(function(a){return!d.has(n(a,c.objectIdField))});b.length!==a.features.length&&(a.setFeatures(b,0),c.invalidateCounts())}})}};b.prototype.applyEditsAddUpdateFeatures=function(a,c){return q(this,void 0,void 0,function(){var d,b,k,g=this;return r(this,function(f){switch(f.label){case 0:d=[];b=new Set;a.forEach(function(a){return d.push(a.objectId)});c.forEach(function(a){d.push(a.objectId);b.add(a.objectId)});if(0===d.length)return[2];
k=[];this.forEachFeatureTile(function(a){(a=v.safeCast(g.applyEditsAddUpdateTile(a,d,b)))&&k.push(a)});return[4,y.eachAlways(k)];case 1:return f.sent(),[2]}})})};b.prototype.applyEditsAddUpdateTile=function(a,c,d){return q(this,void 0,void 0,function(){var b,k,g,l,e,w,p,h=this;return r(this,function(f){switch(f.label){case 0:if(!a.features)return[2];b=this.createQuery(a);b.resultType=void 0;b.objectIds=c;return[4,this.queryFeatures(b)];case 1:k=f.sent();g=null;0<d.size&&(l=a.features.filter(function(a){return!d.has(n(a,
h.objectIdField))}),l.length!==a.features.length&&(g=l));if(0<k.features.length)for(g||(g=a.features.slice()),this.verticalScale.adjust(k.features),e=0,w=k.features;e<w.length;e++)p=w[e],g.push(p);g&&(a.setFeatures(g,0),this.invalidateCounts());return[2]}})})};b.prototype.queryFeatures=function(a){return this.featureTileQuery.queryFeaturesDehydrated(a,{timeout:T})};b.prototype.calculateCapabilities=function(){var a=this.layerView.layer,c=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsPagination),
d=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsResultType),b=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsQuantization),k=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsQuantizationEditMode),g=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsMaxRecordCountFactor),a=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsFormatPBF);return{supportsMultipleResolutions:this.calculateSupportsMultipleResolutions(),
supportsPagination:c,supportsResultType:d,supportsQuantization:b,supportsQuantizationEditMode:k,supportsMaxRecordCountFactor:g,supportsFormatPBF:a}};b.prototype.calculateSupportsMultipleResolutions=function(){var a=this.layerView.layer;switch(a.geometryType){case "polyline":return!0;case "polygon":return a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsQuantization;default:return!1}};b.prototype.createFetchQueue=function(){var a=this;return new L({concurrency:6,peeker:function(c){return a.highestPriorityTile(c)},
process:function(c){return v.safeCast(a.fetchTile(c))}})};b.prototype.highestPriorityTile=function(a){return a.reduce(function(a,d){return a&&a.descriptor.loadPriority<=d.descriptor.loadPriority?a:d},null)};b.prototype._initMemCache=function(){var a=this.layerView.layer;a.hasService?this._memCache||(this._memCache=this.layerView.view.resourceController.getMemCache(a.uid)):this._memCache&&(this._memCache.destroy(),this._memCache=null)};b.prototype.setDirty=function(){this._dirty=!0;this.forEachFeatureTile(function(a){a.featureLimit=
0});this.updated()};b.prototype.update=function(a){var c=this;this.maximumNumberOfFeaturesExceededNext&&x()>=this.maximumNumberOfFeaturesExceededNext&&this.updateMaximumNumberOfFeaturesExceeded();if(this._dirty&&this.constructed){this._dirty=!1;var d=this.getListOfTiles();this.markTilesNotAlive(d);this.addTiles(d);this.filterExtentTiles(d);this.removeTiles(d);var b=this.sortTiles(d);a.runWithProgress(function(){return c.displayTiles(b,a)})&&a.runWithProgress(function(){return c.queueFetchTiles(b,
a)})||this.setDirty();this.updated()}};b.prototype.markTilesNotAlive=function(a){for(var c=0;c<a.length;c++)a[c].alive=!1};b.prototype.addTiles=function(a){var c=this;this.suspended||this.tileDescriptors.forEach(function(d){var b=c.getFeatureTileById(d.id);b?b.alive=!0:a.push(c.addTile(d))})};b.prototype.filterExtentTiles=function(a){for(var c=0;c<a.length;c++){var b=a[c];b.alive&&(b.filtered=!b.intersects(this.filterExtent),b.filtered&&this.clearTile(b))}};b.prototype.removeTiles=function(a){for(var c=
a.length-1;0<=c;c--){var b=a[c];b.alive||(this.removeTile(b),c!==a.length-1&&(a[c]=a[a.length-1]),a.pop())}};b.prototype.sortTiles=function(a){a.sort(function(a,b){return a.descriptor.loadPriority-b.descriptor.loadPriority});return a};b.prototype.displayTiles=function(a,c){for(var b=this,f=this.updateRatio(a),k=function(a){if(!c.runWithProgress(function(){var c=1>b._fullRatio?f(a)*b._farRatio:1;a.reduceFeatures(c,b.objectIdField)&&b.setDirty();return b.showTile(a)}))return g.setDirty(),"break"},g=
this,l=0;l<a.length&&"break"!==k(a[l]);l++);return!0};b.prototype.queueFetchTiles=function(a,c){for(var b=this,f=function(a){if(!c.runWithProgress(function(){return b.queueFetchTile(a)}))return k.setDirty(),{value:!0}},k=this,g=0;g<a.length;g++){var l=f(a[g]);if("object"===typeof l)return l.value}return!0};b.prototype.reclip=function(a,c){var b=this;this.constructed&&(this.forEachFeatureTile(function(d){d.displayingFeatures&&0!==d.displayingFeatures.length&&(d.intersection(c,F),d.intersection(a,G),
t.equals(F,G)||b.hideTileFeatures(d))}),this.forEachFeatureTile(function(a){b.showTile(a)}),this.updated())};b.prototype.updated=function(){var a=this,c=this._dirty||0<this.fetchQueue.length;this._set("updating",c);if(c){var b=c=0,f=0,k=0,g=0,l=0,e=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.forEachFeatureTile(function(c){++f;if(c.isFetching&&c.hasPreciseFeatureCount){var d=a.maximumFeaturesForTile(c)*(1-c.emptyFeatureRatio);l+=d-(c.displayingFeatures?c.displayingFeatures.length*
e:0)}c.needsFetching?++g:0<c.numFeatures&&(++k,b+=c.numFeatures)});var h=g+=this.fetchQueue?this.fetchQueue.length:0;b?(h=g*b/k,c=b+h):c=f;l=Math.min(this.maximumNumberOfFeatures-this.features.length,l);this._set("updatingTotal",c);this._set("updatingRemaining",h);this._set("expectedFeatureDiff",l)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update();this.updating||(this.maximumNumberOfFeaturesExceededNext=this.maximumNumberOfFeaturesExceededNext||
x()+this.maximumNumberOfFeaturesExceededThrottle)};b.prototype.updateMaximumNumberOfFeaturesExceeded=function(){if(!this.updating){var a=!1;this.forEachFeatureTile(function(c){a=a||c.perTileMaximumNumberOfFeaturesExceeded});this.maximumNumberOfFeaturesExceededNext=0;this._set("maximumNumberOfFeaturesExceeded",a)}};b.prototype.updateRatio=function(a){for(var c=Q(a),b=function(a){return 1/(1<<c-a.descriptor.lij[0])},f=0,k=0,g=0;g<a.length;g++)var l=a[g],e=l.numFeatures,f=f+e,k=k+e*b(l);this._fullRatio=
Math.min(1,this.maximumNumberOfFeatures/f);this._farRatio=this.maximumNumberOfFeatures/k;this.scheduleUpdated();return b};b.prototype.maximumFeaturesUpdated=function(a,c){var b=this;a!==c&&(c>a&&this.forEachFeatureTile(function(a){if(a.featuresMissing){var c=b.maximumFeaturesForTile(a);a.features&&(a.features.length>=c||5===a.fetchStatus)||(b.cancelFetchTile(a),b.resetFetchTile(a))}}),this.setDirty())};b.prototype.addTile=function(a){a=new O(a);this.idToFeatureTile.set(a.id,a);this.resetFetchTile(a);
this.referenceDisplayingFeaturesFromRelatedTiles(a);return a};b.prototype.referenceDisplayingFeaturesFromRelatedTiles=function(a){var c=this,b=a.descriptor.resolution;this.forEachFeatureTile(function(d){if(d.displayingFeatures&&c.tilesAreRelated(a,d)){a.displayingFeatures=a.displayingFeatures||[];var f=0;for(d=d.displayingFeatures;f<d.length;f++){var g=d[f];a.displayingFeatures.push(g);g=c.displayingFeatureReferences.get(n(g,c.objectIdField));g.ref(b,g.feature);c.numDisplayingFeatureReferences++}}});
a.featureLimit=a.displayingFeatures?a.displayingFeatures.length:0};b.prototype.tilesAreRelated=function(a,c){if(a===c)return!1;a=a.descriptor.lij;var b=c.descriptor.lij;if(!a||!b)return!0;var f=a[0]<b[0];c=f?a:b;a=f?b:a;b=a[0]-c[0];if(0===b)return!1;b=1<<b;return Math.floor(a[1]/b)===c[1]&&Math.floor(a[2]/b)===c[2]};b.prototype.removeTile=function(a){this.clearTile(a);this.idToFeatureTile.delete(a.id)};b.prototype.resetFetchTile=function(a){a.intersects(this.filterExtent)?(a.fetchStatus=0,a.filtered=
!1):(a.needsFetching&&(a.fetchStatus=4),a.filtered=!0)};b.prototype.cancelFetchTile=function(a){var c=a.fetchRequest;c&&(a.fetchRequest=null,a.fetchStatus=0,c.cancel())};b.prototype.fetchTile=function(a){return q(this,void 0,void 0,function(){var c,b,f,k,g,l,e,h,p,m,n;return r(this,function(d){switch(d.label){case 0:if(!this.needsNumFeatures(a))return[3,4];d.label=1;case 1:return d.trys.push([1,3,,4]),c=a,[4,this.fetchCount(a)];case 2:return c.numFeatures=d.sent(),this.updateRatio(this.getListOfTiles()),
[3,4];case 3:return(b=d.sent())&&"cancel"===b.dojoType?[2]:[3,4];case 4:return f=this.maximumFeaturesForTile(a),k=Math.ceil(f/this.maxRecordCount),"dummy-tile-full-extent"===a.id||!this.capabilities.supportsMaxRecordCountFactor||a.numFeatures<=f&&k>B.MAX_MAX_RECORD_COUNT_FACTOR?[4,this.fetchPagedTile(a)]:[3,6];case 5:return[2,d.sent()];case 6:return g=this.createQuery(a),g.maxRecordCountFactor=Math.ceil(f/this.maxRecordCount),a.isRefetching&&a.features&&0<a.features.length&&(l=Math.ceil(a.features.length/
(1-a.emptyFeatureRatio)/this.maxRecordCount),g.maxRecordCountFactor=Math.max(l+1,g.maxRecordCountFactor)),[4,this.queryFeatures(g)];case 7:return e=d.sent(),h=e.features,m=(p=e.exceededTransferLimit)?g.maxRecordCountFactor>=B.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5,a.featuresMissing=h.length<a.numFeatures||p,n=this._removeEmptyFeatures(h),this.verticalScale.adjust(h),a.setFeatures(h,n),this.invalidateCounts(),[2,m]}})})};b.prototype.fetchCount=function(a){return q(this,void 0,void 0,function(){return r(this,
function(c){return[2,this.layerView.layer.queryFeatureCount(this.createQuery(a))]})})};b.prototype.fetchPagedTile=function(a){return q(this,void 0,void 0,function(){var c,b,f,k,g,e,h,m,p,n;return r(this,function(d){switch(d.label){case 0:k=b=c=0,g=this.maximumFeaturesForTile(a)-k,d.label=1;case 1:return e=this.createQuery(a),h=this.setPagingParameters(e,c,g),[4,this.queryFeatures(e)];case 2:return m=d.sent(),p=m.features,n=m.exceededTransferLimit,c+=e.num,k+=p.length,b+=this._removeEmptyFeatures(p),
this.verticalScale.adjust(p),a.featuresMissing=c<a.numFeatures||n,f=f?f.concat(p):p,a.setFeatures(f,b),this.invalidateCounts(),this.setDirty(),g=this.maximumFeaturesForTile(a)-k,!h||!n||0>=g?[2,n?4:5]:[3,1];case 3:return[2]}})})};b.prototype.createQuery=function(a){var c=this.layerView.layer.createQuery(),b=this.layerView.layer.capabilities&&this.layerView.layer.capabilities.data;b&&b.supportsZ&&null==c.returnZ&&(c.returnZ=!0);b=this.tilingScheme.spatialReference;c.outSpatialReference=b;var f=a.descriptor.extent;
f&&(c.geometry=t.toExtent(f,b));this.setResolutionParams(c,a);this.capabilities.supportsResultType&&(c.resultType="tile");return c};b.prototype.setPagingParameters=function(a,c,b){if(!this.capabilities.supportsPagination)return!1;a.start=c;0<b&&this.capabilities.supportsMaxRecordCountFactor?(a.maxRecordCountFactor=Math.ceil(b/this.maxRecordCount),a.num=Math.min(a.maxRecordCountFactor*this.maxRecordCount,b)):a.num=Math.min(this.maxRecordCount);return!0};b.prototype.getEffectiveTileResolution=function(a){if(null==
a.descriptor.resolution)return null;var b="global"===this.viewingMode?this.tilingScheme.resolutionAtLevel(3):Infinity;return Math.min(a.descriptor.resolution,b)*U};b.prototype.setResolutionParams=function(a,b){if(!this.capabilities.supportsMultipleResolutions)return this.setDefaultResolutionParams(a,b);var c=this.layerView.layer;if("point"===c.geometryType)return this.setDefaultResolutionParams(a,b);var f=this.getEffectiveTileResolution(b);if(null==f)return this.setDefaultResolutionParams(a,b);this.capabilities.supportsQuantization?
a.quantizationParameters=new A.default({mode:"view",originPosition:"upper-left",tolerance:f,extent:c.fullExtent}):"polyline"===c.geometryType&&(a.maxAllowableOffset=f)};b.prototype.setDefaultResolutionParams=function(a,b){this.capabilities.supportsQuantization&&this.capabilities.supportsQuantizationEditMode&&this.capabilities.supportsFormatPBF&&(a.quantizationParameters=new A.default({mode:"edit"}))};b.prototype._removeEmptyFeatures=function(a){for(var b=a.length,d=0;d<a.length;)N.hasVertices(a[d].geometry)?
++d:(a[d]=a[a.length-1],--a.length);return b-a.length};b.prototype.needsNumFeatures=function(a){return this.useTileCount&&!a.hasPreciseFeatureCount&&"dummy-tile-full-extent"!==a.id};Object.defineProperty(b.prototype,"maxRecordCount",{get:function(){return this.capabilities.supportsResultType?this.layerView.layer.tileMaxRecordCount:this.layerView.layer.maxRecordCount?this.layerView.layer.maxRecordCount:V},enumerable:!0,configurable:!0});b.prototype.queueFetchTile=function(a){var b=this;if(!a.needsFetching)return!1;
var d=this._memCache&&this._memCache.pop(a.id);if(d)return a.loadCache(d),this.setDirty(),this.scheduleUpdated(),!0;a.fetchStatus=a.needsRefetching?3:2;var f=!1,e=this.fetchQueue.push(a).then(function(b){a.fetchRequest=null;a.fetchStatus=b}).catch(function(c){a.fetchRequest===e&&(a.fetchRequest=null,a.fetchStatus=4);c&&"cancel"===c.dojoType?f=!0:(a.setFeatures([],0),b.invalidateCounts(),a.featuresMissing=!1,D.error("#fetchTile()",b.layerView.layer,c&&c.message?c.message:c))}).then(function(){f||b.setDirty();
b.scheduleUpdated()});e.isFulfilled()||(a.fetchRequest=e);return!0};b.prototype.scheduleUpdated=function(){var a=this;this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(M.schedule(function(){a.handles.remove("scheduleUpdated");a.updated()}),"scheduleUpdated")};b.prototype.showTile=function(a){if(a.displayingFeatures&&!a.needsDisplayUpdate)return!1;if(0===a.featureLimit||!a.features){var b=a.displayingFeatures&&0<a.displayingFeatures.length;this.hideTileFeatures(a);a.displayingFeatures=
[];return b}for(var b=a.descriptor.resolution,d=this.changes.updates,f=this.changes.adds,e=0;e<a.featureLimit;++e){var g=a.features[e],l=n(g,this.objectIdField),h=this.displayingFeatureReferences.get(l);h?(g=h.ref(b,g),g.oldVersion!==g.newVersion&&(d.removes.push(g.oldVersion),d.adds.push(g.newVersion))):(this.displayingFeatureReferences.set(l,new this.FeatureReferenceClass(b,g)),f.push(g));this.numDisplayingFeatureReferences++}this.hideTileFeatures(a);this.applyChanges();a.displayingFeatures=a.features.slice(0,
a.featureLimit);return!0};b.prototype.hideTile=function(a){this.cancelFetchTile(a);this.hideTileFeatures(a)};b.prototype.hideTileFeatures=function(a){if(a.displayingFeatures){for(var b=this.changes.updates,d=this.changes.removes,f=0,e=a.displayingFeatures;f<e.length;f++){var g=n(e[f],this.objectIdField),h=this.displayingFeatureReferences.get(g);h&&((h=h.unref(a.descriptor.resolution),this.numDisplayingFeatureReferences--,h)?h.oldVersion!==h.newVersion&&(null==h.newVersion?(this.displayingFeatureReferences.delete(g),
d.push(h.oldVersion)):(b.adds.push(h.newVersion),b.removes.push(h.oldVersion))):console.error("Hiding unreferenced feature"))}this.applyChanges();a.displayingFeatures=null}};b.prototype.applyChanges=function(){var a=this.changes.updates;0<a.removes.length&&(this.features.removeMany(a.removes),a.removes.length=0);0<a.adds.length&&(this.features.addMany(a.adds),a.adds.length=0);for(var a=this.changes.adds,b=this.changes.removes,d=Math.min(a.length,b.length),f=0;f<d;){var e=Math.min(f+W,d);this.features.addMany(a.slice(f,
e));this.features.removeMany(b.slice(f,e));f=e}a.length>d&&this.features.addMany(0===f?a:a.slice(f));b.length>d&&this.features.removeMany(0===f?b:b.slice(f));a.length=0;b.length=0};b.prototype.clearTile=function(a){this.hideTile(a);a.features&&this._memCache&&this._memCache.put(a.id,a.cacheItem,16+a.estimatedSize);a.setFeatures(null,0);this.invalidateCounts()};b.prototype.invalidateCounts=function(){this.notifyChange("totalVertices");this.notifyChange("totalFeatures");this.notifyChange("memoryForUnusedFeatures")};
b.prototype.getListOfTiles=function(){var a=Array(this.idToFeatureTile.size),b=0;this.forEachFeatureTile(function(c){return a[b++]=c});return a};Object.defineProperty(b.prototype,"storedFeatures",{get:function(){return this.getListOfTiles().reduce(function(a,b){return a+(b.features?b.features.length:0)},0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"debug",{get:function(){var a=this;return{update:function(b){return a.update(b)}}},enumerable:!0,configurable:!0});b.prototype.maximumFeaturesForTile=
function(a){var b=a.hasPreciseFeatureCount?a.numFeatures:this.maximumNumberOfFeatures;return Math.min(Math.ceil(b*(1>this._fullRatio?this._farRatio:1)/(1-a.emptyFeatureRatio)),b)};h([e.property({constructOnly:!0})],b.prototype,"features",void 0);h([e.property()],b.prototype,"tileDescriptors",void 0);h([e.property({constructOnly:!0})],b.prototype,"tilingScheme",void 0);h([e.property({value:Infinity})],b.prototype,"maximumNumberOfFeatures",null);h([e.property()],b.prototype,"useTileCount",void 0);h([e.property({constructOnly:!0})],
b.prototype,"layerView",void 0);h([e.property({readOnly:!0})],b.prototype,"updating",void 0);h([e.property({readOnly:!0})],b.prototype,"updatingTotal",void 0);h([e.property({readOnly:!0})],b.prototype,"updatingRemaining",void 0);h([e.property({readOnly:!0})],b.prototype,"expectedFeatureDiff",void 0);h([e.property({readOnly:!0})],b.prototype,"memoryForUnusedFeatures",null);h([e.property({readOnly:!0})],b.prototype,"maximumNumberOfFeaturesExceeded",void 0);h([e.property({constructOnly:!0})],b.prototype,
"maximumNumberOfFeaturesExceededThrottle",void 0);h([e.property({readOnly:!0})],b.prototype,"totalVertices",null);h([e.property({readOnly:!0})],b.prototype,"totalFeatures",null);h([e.property()],b.prototype,"filterExtent",null);h([e.property({constructOnly:!0})],b.prototype,"verticalScale",void 0);h([e.property({constructOnly:!0})],b.prototype,"viewingMode",void 0);return b=h([e.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],b)}(e.declared(I));m.FeatureTileFetcher3D=u;m.getFeatureId=
n;var V=2E3,F=t.create(),G=t.create(),E={},T=6E5,W=200,U=1/3;m.default=u});