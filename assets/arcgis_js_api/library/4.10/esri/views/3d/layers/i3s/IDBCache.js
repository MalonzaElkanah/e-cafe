// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/Error","../../../../core/promiseUtils"],function(l,k,m,f){function h(b){return f.create(function(d,a){b.oncomplete=function(){return d()};b.onerror=function(){return a(b.error)};b.onabort=function(){return a(b.error)}})}function g(b){return f.create(function(d,a){"done"===b.readyState?null!=b.error?a(b.error):d(b.result):(b.onsuccess=function(){return d(b.result)},b.onerror=function(){return a(b.error)})})}Object.defineProperty(k,"__esModule",{value:!0});
l=function(){function b(d,a,c){this._quotaReductionPromise=this._db=null;this._miss=this._hit=this._gcCounter=0;this._destroyed=!1;this.gcFrequency=50;this.maxByteSize=1073741824;this.quotaReductionFactor=.2;this._dbName=d;this._storeName=a;this._version=c}b.prototype.init=function(){var d=this;return f.resolve().then(function(){var a=indexedDB.open(d._dbName,d._version);a.onupgradeneeded=function(c){var e=a.result,b=a.transaction,f=e.objectStoreNames.contains(d._storeName)?b.objectStore(d._storeName):
e.createObjectStore(d._storeName),e=e.objectStoreNames.contains("last_access")?b.objectStore("last_access"):e.createObjectStore("last_access");e.indexNames.contains("date")||e.createIndex("date","date",{unique:!1});e.indexNames.contains("byteSize")||e.createIndex("byteSize","byteSize",{unique:!1});c.oldVersion<d._version&&(f.clear(),e.clear())};return g(a)}).then(function(a){d._destroyed?a.close():d._db=a})};b.prototype.destroy=function(){this._db&&(this._db.close(),this._db=null);this._destroyed=
!0};b.prototype.getHitRate=function(){return this._hit/(this._hit+this._miss)};b.prototype.put=function(d,a){var c=this;return null==this._db?f.reject(m("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:f.resolve()).then(function(){return c._put(d,a)}).catch(function(e){if(e&&"QuotaExceededError"===e.name)return null==c._quotaReductionPromise&&(c._quotaReductionPromise=c._getCacheSize().then(function(d){return c._removeLeastRecentlyAccessed(a.byteSize+
Math.ceil(d*c.quotaReductionFactor))}),c._quotaReductionPromise.then(function(){c._quotaReductionPromise=null},function(){c._quotaReductionPromise=null})),c._quotaReductionPromise.then(function(){return c._put(d,a)});throw e;}).then(function(){c._gcCounter--;0>c._gcCounter&&null!=c._db&&(c._gcCounter=c.gcFrequency,c._getCacheSize().then(function(a){return c._removeLeastRecentlyAccessed(a-c.maxByteSize)}))})};b.prototype.get=function(d){var a=this;return null==this._db?f.resolve(null):f.resolve().then(function(){var c=
a._db.transaction(a._storeName,"readonly").objectStore(a._storeName).get(d);return g(c)}).then(function(c){null==c?++a._miss:(++a._hit,a._db.transaction("last_access","readwrite").objectStore("last_access").put({date:(new Date).getTime(),byteSize:c.byteSize},d));return c}).catch(function(c){++a._miss;return null})};b.prototype.remove=function(d){var a=this;return null==this._db?f.resolve():f.resolve().then(function(){var c=a._db.transaction([a._storeName,"last_access"],"readwrite"),e=c.objectStore(a._storeName),
b=c.objectStore("last_access"),e=e.delete(d),b=b.delete(d);return f.all([g(e),g(b),h(c)])})};b.prototype._put=function(d,a){var c=this._db.transaction([this._storeName,"last_access"],"readwrite"),b=c.objectStore(this._storeName),n=c.objectStore("last_access"),b=b.put(a,d);d=n.put({date:(new Date).getTime(),byteSize:a.byteSize},d);return f.all([g(b),g(d),h(c)])};b.prototype._removeLeastRecentlyAccessed=function(d){if(!(0>=d)){var a=this._db.transaction([this._storeName,"last_access"],"readwrite"),
c=a.objectStore(this._storeName),b=a.objectStore("last_access"),f=0,g=b.index("date").openCursor(null,"next");g.onsuccess=function(a){a=g.result;null!=a&&(null!=a.value.byteSize&&(f+=a.value.byteSize),c.delete(a.primaryKey),b.delete(a.primaryKey),f<d&&a.continue())};return h(a)}};b.prototype._getCacheSize=function(){var b=this._db.transaction("last_access"),a=0,c=b.objectStore("last_access").index("byteSize").openKeyCursor();c.onsuccess=function(b){if(b=c.result){var d=b.key;null!=d&&(a+=d);b.continue()}};
return h(b).then(function(){return a})};return b}();k.IDBCache=l;k.whenTransaction=h;k.whenRequest=g});