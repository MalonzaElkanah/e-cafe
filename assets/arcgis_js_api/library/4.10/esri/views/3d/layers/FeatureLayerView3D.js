// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/compilerUtils ../../../core/Evented ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../layers/graphics/controllers/FeatureTileController3D ../../../layers/graphics/controllers/support/controllerUtils ./FeatureLikeLayerView3D ./support/layerViewUpdatingProperties ./support/popupUtils3D ../../layers/FeatureLayerView".split(" "),
function(h,B,k,e,m,n,p,q,r,g,d,t,u,v,w,x,y){h=function(f){function a(c){c=f.call(this)||this;c._controllerTotal=0;c._graphicsCoreTotal=0;c.suspendResumeExtentMode="data";return c}k(a,f);Object.defineProperty(a.prototype,"updatingPercentageValue",{get:function(){var c=0,b=0;this.controller&&this.controller.updating&&(c+=this.controller.updatingRemaining,b=this.controller.updatingTotal);var a=0;this.graphics3d&&this.graphics3d.graphicsCore&&(c+=this.graphics3d.graphicsCore.updatingRemaining,a=this.graphics3d.graphicsCore.updatingTotal);
0===b&&0===a?this._graphicsCoreTotal=this._controllerTotal=0:(this._controllerTotal=Math.max(b,this._controllerTotal),this._graphicsCoreTotal=Math.max(a,this._graphicsCoreTotal));return(b=this._controllerTotal+this._graphicsCoreTotal)?(b-c)/b*100:100},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return this.controller?!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded):!1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"asyncGraphicsUpdates",{get:function(){if(this.controller)switch(this.controller.mode){case "snapshot":return this.controller.serviceDataCount>z;case "tiles":break;default:q.neverReached(this.controller.mode)}return!0},enumerable:!0,configurable:!0});a.prototype.fetchPopupFeatures=function(c,b){var a=this;this.hasDraped||(c=null);return this.inherited(arguments,[c,b]).then(function(b){if(0===b.length)return b;var c=new Set,l=a.layer.objectIdField;a.graphics3DGraphics.forEach(function(b){return c.add(b.graphic.attributes[l])});
return b.filter(function(b){return c.has(b.attributes[l])})})};a.prototype.getViewSpatialReference=function(){return this.view.spatialReference};a.prototype.createFetchPopupFeaturesQueryGeometry=function(c,b){return x.createQueryGeometry(c,b,this.view)};a.prototype.createController=function(){return p(this,void 0,void 0,function(){var c,b=this;return n(this,function(a){c=new t({layerView:this,graphics:new A,extent:this.clippingExtent});this.handles.add(g.init(c,"serviceDataExtent",function(c){b.graphics3d&&
(b.graphics3d.dataExtent=c)}));this.handles.add(g.init(this,"suspended",function(b){b?c.suspend():c.resume()},!0));this.handles.add(g.init(this.graphics3d.graphicsCore,"displayFeatureLimit",function(){return b.updateDisplayFeatureLimit(c)}));this.handles.add(this.view.resourceController.memoryEvents.on("quality-changed",function(){return b.updateDisplayFeatureLimit()}));return[2,c]})})};a.prototype.doRefresh=function(){!this.suspended&&u.isRefreshable(this.controller)&&this.controller.refresh()};
a.prototype.getStats=function(){var c=this.inherited(arguments);if(this.controller&&c.features){var b=this.controller.debug;c.features+="/"+b.storedFeatures+"/"+b.totalFeatures;c.totalVertices=b.totalVertices}b=(b=this.controller&&this.controller.displayFeatureLimit)&&b.maximumSymbolComplexity;c.numTiles=this.controller?this.controller.tileDescriptors.length:0;c.partial=this.maximumNumberOfFeaturesExceeded;c.mode=this.controller?this.controller.mode:"n/a";c.symbolComplexity=b?"f:"+b.primitivesPerFeature+
",v:"+b.primitivesPerCoordinate:"n/a";var a=this.graphics3d&&this.graphics3d.graphicsCore,b=a?a.unprocessedMemoryEstimate:0,a=this.controller?this.controller.expectedFeatureDiff*a.usedMemoryPerGraphic:0;c.memory="u:"+(this.getUsedMemory()/1024/1024).toFixed(1)+", pc:"+(""+(b/1024/1024).toFixed(1))+", pf:"+(""+(a/1024/1024).toFixed(1))+" MB";return c};a.prototype.getUsedMemory=function(){var c=this.graphics3d&&this.graphics3d.graphicsCore;return(c?c.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:
0)};a.prototype.getUnloadedMemory=function(){var c=this.graphics3d&&this.graphics3d.graphicsCore;return(c?c.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*c.usedMemoryPerGraphic:0)};a.prototype.ignoresMemoryFactor=function(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride};a.prototype.updateDisplayFeatureLimit=function(c){void 0===c&&(c=this.controller);if(c&&this.graphics3d&&this.graphics3d.graphicsCore){var b=this.graphics3d.graphicsCore.displayFeatureLimit,
a=this.view.resourceController.memoryFactor;1!==a&&(b=m({},b,{maximumNumberOfFeatures:Math.ceil(b.maximumNumberOfFeatures*a),maximumTotalNumberOfFeatures:Math.ceil(b.maximumTotalNumberOfFeatures*a),minimumTotalNumberOfFeatures:Math.ceil(b.minimumTotalNumberOfFeatures*a)}));c.displayFeatureLimit=b}};e([d.property()],a.prototype,"layer",void 0);e([d.property()],a.prototype,"controller",void 0);e([d.property({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining",
"graphics3d.graphicsCore.updatingTotal"]})],a.prototype,"updatingPercentageValue",null);e([d.property({aliasOf:"controller.maximumNumberOfFeatures",set:null,get:null})],a.prototype,"maximumNumberOfFeatures",void 0);e([d.property({dependsOn:["suspended","controller.maximumNumberOfFeaturesExceeded"]})],a.prototype,"maximumNumberOfFeaturesExceeded",null);e([d.property(w.updatingPercentage)],a.prototype,"updatingPercentage",void 0);e([d.property({readOnly:!0,dependsOn:["controller.mode"]})],a.prototype,
"asyncGraphicsUpdates",null);e([d.property()],a.prototype,"suspendResumeExtentMode",void 0);return a=e([d.subclass("esri.views.3d.layers.FeatureLayerView3D")],a)}(d.declared(v,y));var A=function(f){function a(){var b=null!==f&&f.apply(this,arguments)||this;b.items=new Set;return b}k(a,f);c=a;Object.defineProperty(a.prototype,"length",{get:function(){return this.items.size},enumerable:!0,configurable:!0});a.prototype.addMany=function(b){for(var a=0;a<b.length;a++)this.items.add(b[a]);this.emit("change",
{added:b,removed:[],moved:[]})};a.prototype.removeMany=function(b){for(var a=0;a<b.length;a++)this.items.delete(b[a]);this.emit("change",{added:[],removed:b,moved:[]});return b};a.prototype.removeAll=function(){var b=this.toArray();this.emit("change",{added:[],removed:b,moved:[]})};a.prototype.toArray=function(){var b=[];this.items.forEach(function(a){return b.push(a)});return b};a.prototype.forEach=function(b){this.items.forEach(b)};a.prototype.some=function(b){return this.toArray().some(b)};a.prototype.find=
function(b){var a=null;this.forEach(function(c){!a&&b(c)&&(a=c)});return a};a.prototype.filter=function(a){var b=new c;this.forEach(function(c){a(c)&&b.items.add(c)});return b};var c;return a=c=e([d.subclass("esri.views.3d.layers.FeatureLayerView3D.SetCollection")],a)}(d.declared(r)),z=5E3;return h});