// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../request ../../../../core/arrayUtils ../../../../core/Error ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils ../../../../tasks/QueryTask ../../../../tasks/support/Query ./I3SBinaryReader ../../support/projectionUtils ../../support/buffer/typedArrayUtil".split(" "),function(Y,e,H,I,l,n,J,K,w,L,M,N,O,x,y){function u(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+
1,a.length),10)}function z(a,b,c,d,h,f){if(null!=c){var g=c.mbs;b!==d&&(g=P,x.mbsToMbs(c.mbs,d,g,b));if(0!==A(a,g)&&(f(c),c.children))for(g=0;g<c.children.length;++g)z(a,b,h[c.children[g].id],d,h,f)}}function A(a,b){var c=b[0],d=b[1],h=b[2];b=b[3];var f=0;if(c<a[0])var g=a[0]-c,f=f+g*g;d<a[1]&&(g=a[1]-d,f+=g*g);h<a[2]&&(g=a[2]-h,f+=g*g);c>a[3]&&(g=c-a[3],f+=g*g);d>a[4]&&(g=d-a[4],f+=g*g);h>a[5]&&(g=h-a[5],f+=g*g);if(f>b*b)return 0;if(0<f)return 1;f=Infinity;c-a[0]<f&&(f=c-a[0]);d-a[1]<f&&(f=d-a[1]);
h-a[2]<f&&(f=h-a[2]);a[3]-c<f&&(f=a[3]-c);a[4]-d<f&&(f=a[4]-d);a[5]-h<f&&(f=a[5]-h);return f>b?2:1}function v(a,b,c){var d=[],h=c&&c.missingFields;c=c&&c.originalFields;for(var f=0;f<a.length;f++){for(var g=a[f],k=g.toLowerCase(),e=!1,m=0,q=b;m<q.length;m++){var r=q[m];if(k===r.name.toLowerCase()){d.push(r.name);e=!0;c&&c.push(g);break}}!e&&h&&h.push(g)}return d}function Q(a,b){return a.filter(function(a){return a.toLowerCase()!==b.toLowerCase()}).concat([b])}function R(a,b,c,d){b.sort(function(a,
b){return a.attributes[c]-b.attributes[c]});var h=b.map(function(a){return a.attributes[c]}),f=[],g=v(d,a.fields,{originalFields:f});return B(a,h,g).then(function(a){for(var c=0;c<b.length;c++){var d=b[c],h=a[c];d.attributes={};for(var e=0;e<f.length;e++)d.attributes[f[e]]=h[g[e]]}return b})}function S(a,b){for(var c=[],d=0;d<a.length;d++){var h=a[d];h in b.attributes||c.push(h)}return c}function B(a,b,c){if(null!=a.maxRecordCount&&b.length>a.maxRecordCount){var d=T(b,a.maxRecordCount);return n.all(d.map(function(b){return B(a,
b,c)})).then(U)}d=new N({objectIds:b,outFields:c,orderByFields:[a.objectIdField]});return(new M(a.parsedUrl.path)).execute(d).then(function(a){return a&&a.features&&a.features.length===b.length?a.features.map(function(a){return a.attributes}):n.reject(new l("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function V(a,b,c,d,h){for(var f=[],g=0;g<b.attributeData.length;g++){var e=b.attributeData[g],p=a[g];p&&-1!==d.indexOf(p.name)&&(e=J.makeAbsolute(e.href,
b.baseUrl),f.push({url:e,storageInfo:p}))}return n.eachAlways(f.map(function(a){return H(a.url,{responseType:"array-buffer"}).then(function(b){return O.readBinaryAttribute(a.storageInfo,b.data)})})).then(function(a){var b=[];if(!h.ignoreUnavailableFields&&a.some(function(a){return null==a.value})){for(var b=[],d=0;d<a.length;d++)null==a[d].value&&b.push({name:f[d].storageInfo.name,error:a[d].error});return n.reject(new l("scenelayer:attribute-request-failed","Request for scene layer attributes failed",
{failedAttributes:b}))}for(var g=0;g<c.length;g++){for(var e=c[g],k={},d=0;d<a.length;d++)null!=a[d].value&&(k[f[d].storageInfo.name]=C(a[d].value,e));b.push(k)}return b})}function C(a,b){b=a[b];return y.isInt16Array(a)?b===W?null:b:y.isInt32Array(a)?b===X?null:b:b!==b?null:b}function T(a,b){var c=a.length;b=Math.ceil(c/b);for(var d=[],h=0;h<b;h++)d.push(a.slice(Math.floor(c*h/b),Math.floor(c*(h+1)/b)));return d}function U(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b}function D(a){var b=
new w(u(a.store.indexCRS||a.store.geographicCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function E(a){var b=new w(u(a.store.vertexCRS||a.store.projectedCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function t(a,b,c){if(!L.canProject(a,b))throw new l("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===c&&a.isGeographic)throw new l("layerview:local-gcs-not-supported",
"Geographic coordinate systems are not supported in local scenes",{});}function F(a,b,c){var d=D(a);a=E(a);t(d,b,c);t(a,b,c)}Object.defineProperty(e,"__esModule",{value:!0});e.DDS_ENCODING_STRING="image/vnd-ms.dds";e.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"];e.extractWkid=u;e.getAppropriateTextureEncoding=function(a,b){if(Array.isArray(a)){if(b&&(b=a.indexOf(e.DDS_ENCODING_STRING),-1<b))return b;for(b=0;b<a.length;b++)if(-1<e.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(a[b]))return b;
throw Error("Could not find appropriate texture encoding (among "+a.toString()+")");}return-1};e.findIntersectingNodes=z;e.buildTopNodeMap=function(a,b,c,d){void 0===d&&(d=Number.POSITIVE_INFINITY);if(0>=b)a.clear();else{var h=new Map,f=Number.POSITIVE_INFINITY;a.forEach(function(g,e){var k=c(g);if(e<b)f=Math.min(f,k),h.set(g.id,k);else if(!(k<=f||k>=d)){h.set(g.id,k);e=f=h.get(a.front().id);for(var k=0,m=1;m<b;++m){var l=h.get(a.data[m].id);l<f&&(k=m,e=f,f=l)}a.data[k]=g;f=e}});a.length=Math.min(a.length,
b);a.sort(function(a,b){return h.get(b.id)-h.get(a.id)})}};var P=K.vec4f64.create();e.intersectBoundingBoxWithMbs=A;e.findFieldsCaseInsensitive=v;e.whenGraphicAttributes=function(a,b,c,d,h,f){var g=!0===(f&&f.populateObjectId),e=f.ignoreUnavailableFields?void 0:[],p=1===d.length&&"*"===d[0];!p&&g&&(d=Q(d,c));d=p?d:v(d,a.fields,{missingFields:e});if(e&&0!==e.length)return n.reject(new l("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:e}));if(0===b.length)return n.resolve(b);
var e=a.associatedLayer,m=a.attributeStorageInfo,q=p?a.fields.map(function(a){return a.name}):d;if(e)return R(e,b,c,q);var r=S(q,b[0]);return 0===r.length?n.resolve(b):m?(a=h(b))?n.all(a.map(function(a){return V(m,a.node,a.indices,r,f).then(function(b){for(var c=0;c<a.graphics.length;c++){for(var d=0,f=q;d<f.length;d++){var g=f[d];g in b[c]||(b[c][g]=a.graphics[c].attributes[g])}a.graphics[c].attributes=b[c]}return a.graphics})})).then(I.concatAll):n.reject(new l("scenelayer:features-not-loaded",
"Tried to query attributes for unloaded features")):n.reject(new l("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var W=-Math.pow(2,15),X=-Math.pow(2,31);e.getCachedAttributeValue=C;e.convertFlatRangesToOffsets=function(a,b,c){void 0===c&&(c=2);b=null!=b?b:a.length/c;for(var d=new Uint32Array(b+1),e=0;e<b;e++){var f=a[e*c];d[e]=3*f;var g=(e-1)*c+1;if(0<=g&&f-1!==a[g])throw new l("Face ranges are not continuous");}d[d.length-1]=3*(a[(b-1)*c+1]+
1);return d};e.getIndexCrs=D;e.getVertexCrs=E;e.getCacheKeySuffix=function(a,b){return b===x.SphericalECEFSpatialReference?"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};e.checkSpatialReference=t;e.checkSpatialReferences=F;e.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null!=a.geometryType&&"triangles"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null==a.vertexAttributes||null==a.vertexAttributes.position));
if(b)throw new l("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{});};e.checkSceneLayerCompatibleWithView=function(a,b){F(a,b.spatialReference,b.viewingMode)};e.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null==a.geometryType||"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==
a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new l("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});};e.checkPointCloudLayerCompatibleWithView=function(a,b){t(a.spatialReference,b.spatialReference,b.viewingMode)};e.rendererNeedsTextures=function(a){if(null==a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===a.type||"class-breaks"===a.type)&&null==a.defaultSymbol)return!0;
a=a.getSymbols();if(0===a.length)return!0;for(var b=0;b<a.length;b++){var c=a[b];if("mesh-3d"!==c.type||0===c.symbolLayers.length)return!0;for(var d=0,c=c.symbolLayers.items;d<c.length;d++){var e=c[d];if("fill"!==e.type||null==e.material||"replace"!==e.material.colorMixMode)return!0}}return!1};var G=function(){return function(){this.material=this.edges=null}}();e.SymbolInfo=G;e.getSymbolInfo=function(a){var b=new G,c=!1,d=!1,e=0;for(a=a.symbolLayers.items;e<a.length;e++){var f=a[e];if("fill"===f.type&&
f.enabled){var g=f.material,k=f.edges;g&&!c&&(c=g.color,b.material={color:c?[c.r/255,c.g/255,c.b/255]:null,alpha:c?c.a:null,colorMixMode:g.colorMixMode},c=!0);k&&!d&&(b.edges=f.edges,d=!0)}}return b}});