// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../symbols/callouts/calloutUtils ./ElevationAligners ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextTexture ../../webgl-engine/materials/HUDMaterial".split(" "),function(O,P,v,A,w,E,F,G,H,
q,x,y,I,J,K,B){function t(d,c,a){d&&d.forEach(function(b){var e=c(b);e&&a(e,b.graphic)})}var C=[1,1,1,1],L=[0,0,1],z={mode:"relative-to-ground",offset:0},M=[0,0,0,1];return function(d){function c(){var a=null!==d&&d.apply(this,arguments)||this;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1};return a}v(c,d);c.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var a=y.validateSymbolLayerSize(this._getTextSize());if(a){this._logWarning(a);this.reject();
return}}this._anchor="center";this.resolve()};c.prototype.destroy=function(){d.prototype.destroy.call(this);this.isFulfilled()||this.reject()};c.prototype.createGraphics3DGraphic=function(a,b,c,N){void 0===b&&(b={});a=a.graphic;var f=q.placePointOnGeometry(a.geometry);if(!f)return this._logWarning("unsupported geometry type for text symbol: "+a.geometry.type),null;var e=b.text||this.symbol.text;if(!e||1>e.length)return null;null!=b.needsOffsetAdjustment&&(this._elevationOptions.needsOffsetAdjustment=
b.needsOffsetAdjustment);var l=this.getGraphicElevationContext(a,b.elevationOffset||0);return this._createAs3DShape(this.symbol,f,e,l,this._context.layer.id+"_label_"+a.uid,a.uid,b,c,N,"polyline"===a.geometry.type)};c.prototype.getGraphicElevationContext=function(a,b){void 0===b&&(b=0);a=d.prototype.getGraphicElevationContext.call(this,a);a.addOffsetRenderUnits(b);return a};c.prototype.layerOpacityChanged=function(){this._logWarning("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");
return!1};c.prototype.layerElevationInfoChanged=function(a,b){var c=this;t(a,b,function(a,b){c.updateGraphicElevationContext(b,a)});return!0};c.prototype.slicePlaneEnabledChanged=function(a,b){var c=this;t(a,b,function(a){var b=0;for(a=a.stageObject.geometryRecords;b<a.length;b++)a[b].material.setParameterValues({slicePlaneEnabled:c._context.slicePlaneEnabled})});return!0};c.prototype.updateGraphicElevationContext=function(a,b){a=this.getGraphicElevationContext(a,b.metadata.elevationOffset);b.elevationContext.set(a);
b.needsElevationUpdates=q.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode};c.prototype._defaultElevationInfoNoZ=function(){return z};c.prototype._createAs3DShape=function(a,b,c,d,f,t,l,g,n,k){var e=l.centerOffset||M,r=l.screenOffset||[0,0],u=l.debugDrawBorder||!1,v=l.translation||[0,0,0],D=l.anchor||this._anchor||"center";this._anchor=D;var x=a.material?A.toUnitRGBA(a.material.color):C,p=a.halo&&a.halo.color&&0<a.halo.size,y=p?A.toUnitRGBA(a.halo.color):C,p=p?w.pt2px(a.halo.size):0,z=
this._getTextSize(a),m=new K(c,{size:z,color:x,font:{family:a.font&&a.font.family?a.font.family:"sans-serif",weight:a.font&&a.font.weight?a.font.weight:"normal",style:a.font&&a.font.style?a.font.style:"normal"},halo:{size:p,color:y}},f),h;g?h=l:F.isCalloutSupport(this.symbolContainer)&&this.symbolContainer.hasVisibleVerticalOffset()&&(h=this.symbolContainer);a={textureId:n?n.textureId:m.id,texCoordScale:n?[1,1]:m.texcoordScale,occlusionTest:!0,screenOffset:r,anchorPos:D,polygonOffset:!0,color:[1,
1,1,1],centerOffsetUnits:l.centerOffsetUnits,debugDrawBorder:u,drawInSecondSlot:!0};h&&h.verticalOffset&&(h=h.verticalOffset,r=h.minWorldLength,u=h.maxWorldLength,a.verticalOffset={screenLength:w.pt2px(h.screenLength),minWorldLength:r||0,maxWorldLength:null!=u?u:Infinity});this._context.screenSizePerspectiveEnabled&&(h=this._context.sharedResources,r=h.screenSizePerspectiveSettings,a.screenSizePerspective=h.screenSizePerspectiveSettingsLabels.overridePadding(p),a.screenSizePerspectiveAlignment=r);
k&&(a.shaderPolygonOffset=1E-4);a.slicePlaneEnabled=this._context.slicePlaneEnabled;k=null;p=JSON.stringify(a);null!=g?(k=g.getMaterial(p),null==k&&(k=new B(a,f),g.addMaterial(p,k))):k=new B(a,f);k=[k];e=J.createPointGeometry(L,v,void 0,n?[0,0]:[m.textWidth,m.textHeight],e,n?[0,0]:null);e=[new I(e,f)];f=q.createStageObjectForPoint(this._context,b,e,k,null,null,d,f,this._context.layer.uid,t,!0);if(null===f)return null;g=new H(this,f.object,e,null==g?k:null,n?null:[m],G.perObjectElevationAligner,d);
g.alignedTerrainElevation=f.terrainElevation;g.needsElevationUpdates=q.needsElevationUpdates2D(d.mode)||"absolute-height"===d.mode;g.getScreenSize=function(a){void 0===a&&(a=E.vec2f64.create());a[0]=n?m.textWidth:m.width;a[1]=n?m.textHeight:m.height;return a};g.metadata={labelText:c,elevationOffset:l.elevationOffset||0};q.extendPointGraphicElevationContext(g,b,this._context.elevationProvider);return g};c.prototype._getTextSize=function(a){return w.pt2px((a||this.symbol).size)||12};return c}(x)});