// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/Handles ../../../../core/Logger ../../../../core/now ../../../../core/PooledArray ../../../../core/watchUtils ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../geometry/support/aaBoundingRect ./deconflictorDebug ../../support/debugFlags ../../support/earthUtils ../../support/geometryUtils ../../support/mathUtils ../../support/geometryUtils/sphere ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/Util ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),
function(E,x,fa,N,O,P,y,u,F,h,w,v,Q,R,z,G,S,T,H,U,B){function V(b){var a,c,l,p;return N(this,function(e){switch(e.label){case 0:a=[];for(c in b)a.push(c);l=0;e.label=1;case 1:if(!(l<a.length))return[3,4];p=a[l];return[4,b[p]];case 2:e.sent(),e.label=3;case 3:return l++,[3,1];case 4:return[2]}})}Object.defineProperty(x,"__esModule",{value:!0});var W=P.getLogger("esri.views.3d.graphics.Deconflictor"),I=h.vec4f64.create(),A=h.vec4f64.create(),J=h.vec4f64.create(),X=h.vec4f64.create(),Y=h.vec3f64.fromValues(0,
0,0),K=z.sphere.create(),C=z.ray.create(),L=h.vec3f64.create(),Z=w.create(),aa=w.create(),ba=function(){return function(){this.posView=this.yMax=this.yMin=this.xMax=this.xMin=0;this.pooled=this.visible=this.culled=!1}}(),ca=function(){return function(b,a,c){void 0===c&&(c={});this.graphics3DGraphic=b;this.slicePlaneEnabled=a;this.info=c}}(),da=function(){return function(b,a){void 0===a&&(a=new Map);this.graphics3DCore=b;this.graphics=a}}(),d;(function(b){b[b.Idle=0]="Idle";b[b.ProcessGraphics=1]=
"ProcessGraphics";b[b.ProcessLabels=2]="ProcessLabels";b[b.CleanGraphics=3]="CleanGraphics";b[b.CleanLabels=4]="CleanLabels";b[b.SortGraphics=5]="SortGraphics";b[b.SortLabels=6]="SortLabels";b[b.DeconflictGraphics=7]="DeconflictGraphics";b[b.DeconflictLabels=8]="DeconflictLabels"})(d||(d={}));E=function(){function b(a){var c,l,b=this;this.handles=new O;this.delayedRunInterval=200;this.nextRunTimestamp=Number.POSITIVE_INFINITY;this.state=d.Idle;this.contexts=[];this.iterators=this.graphics=null;this.accBinsNumX=
15;this.accBinsNumY=20;this.accBinsSizeY=this.accBinsSizeX=0;this.accBins=null;this.accNumTests=0;this.iconMarginFactor=-.1;this.slicePlaneViewSpace=null;this.view=a;this.graphics=(c={},c[0]={active:{},visible:new u,remove:new u},c[1]={active:{},visible:new u,remove:new u},c);this.iterators=(l={},l[0]={active:null,visible:null,remove:null,sort:null},l[1]={active:null,visible:null,remove:null,sort:null},l);this.handles.add([a.watch("state.camera",function(){b.updateSlicePlane();b.setDirty(0)}),a.watch("map.ground.opacity",
function(a,c){1!==a&&1!==c||b.setDirty(0)}),F.init(a,"qualityProfile",function(a){b.delayedRunInterval="low"===a?1E3:200}),F.init(a,"slicePlane",function(){return b.updateSlicePlane()})]);this.frameWorker=a.resourceController.registerFrameWorker(function(a){return b.run(a)},function(a){return b.shouldRun(a)})}b.prototype.updateSlicePlane=function(){var a=this.view&&this.view.slicePlane;a?(this.slicePlaneViewSpace||(this.slicePlaneViewSpace=z.boundedPlane.create()),z.boundedPlane.transform(a,this.view.state.camera.viewMatrix,
this.slicePlaneViewSpace),this.slicePlaneChanged()):this.slicePlaneViewSpace&&(this.slicePlaneViewSpace=null,this.slicePlaneChanged())};b.prototype.slicePlaneChanged=function(){for(var a=0,c=this.contexts;a<c.length;a++)if(c[a].graphics3DCore.symbolCreationContext.slicePlaneEnabled){this.setDirty();break}};b.prototype.destroy=function(){this.handles.destroy();this.handles=null;this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null);this.graphics[0].active=null;this.graphics[0].visible.clear();
this.graphics[0].remove.clear();this.graphics[1].active=null;this.graphics[1].visible.clear();this.graphics[1].remove.clear();this.view=this.iterators=this.graphics=null};b.prototype.addGraphicsOwner=function(a){var c=this,b=new da(a);this.contexts.push(b);this.setDirty(0);a=new M;a.addGraphic=function(a){c.addGraphic(b,a)};a.removeGraphic=function(a){c.removeGraphic(b,a)};a.labelingInfoChange=function(){c.layerPropertyChanged(b,"labelingInfo")};a.featureReductionChange=function(){c.layerPropertyChanged(b,
"featureReduction")};a.slicePlaneEnabledChange=function(){c.layerPropertyChanged(b,"slicePlaneEnabled")};a.clear=function(){b.graphics.forEach(function(a){c.removeGraphic(b,a.graphics3DGraphic)})};return a};b.prototype.removeGraphicsOwner=function(a){var c=this;a=this.findDeconflictionContext(a);if(-1!==a){var b=this.contexts.splice(a,1)[0];b.graphics.forEach(function(a){c.removeGraphic(b,a.graphics3DGraphic)});this.setDirty(0)}};b.prototype.setInitialIconVisibilityFlag=function(a,c){a=!this.isFeatureReductionEnabled(a);
c.setVisibilityFlag(2,a)};Object.defineProperty(b.prototype,"isDirty",{get:function(){return this.state!==d.Idle||Infinity!==this.nextRunTimestamp},enumerable:!0,configurable:!0});b.prototype.setDirty=function(a){void 0===a&&(a=this.delayedRunInterval);this.nextRunTimestamp>y()&&(this.nextRunTimestamp=y()+a)};b.prototype.shouldRun=function(a){return this.view.ready&&null!=this.view.state&&(Infinity!==this.nextRunTimestamp&&this.nextRunTimestamp<=y()||this.state!==d.Idle)};b.prototype.run=function(a){v.prepare(this.view);
switch(this.state){case d.Idle:this.nextRunTimestamp=Infinity,this.camera=this.view.state.camera,this.initBins(this.camera.fullWidth,this.camera.fullHeight),this.resetIterators();case d.ProcessGraphics:if(this.state=d.ProcessGraphics,!this.processActiveGraphics(0,a))break;case d.ProcessLabels:if(this.state=d.ProcessLabels,!this.processActiveGraphics(1,a))break;case d.CleanGraphics:if(this.state=d.CleanGraphics,!this.cleanVisibleGraphics(0,a))break;case d.CleanLabels:if(this.state=d.CleanLabels,!this.cleanVisibleGraphics(1,
a))break;case d.SortGraphics:if(this.state=d.SortGraphics,!this.sortVisibleGraphics(0,a))break;case d.SortLabels:if(this.state=d.SortLabels,!this.sortVisibleGraphics(1,a))break;case d.DeconflictGraphics:this.state=d.DeconflictGraphics;if(!this.deconflictVisibleGraphics(0,a))break;v.drawAccelerationStruct(this,this.graphics[0].visible);case d.DeconflictLabels:this.state=d.DeconflictLabels;if(!this.deconflictVisibleGraphics(1,a))break;v.drawAccelerationStruct(this,this.graphics[1].visible);default:this.state=
d.Idle}};b.prototype.findDeconflictionContext=function(a){for(var c=0;c<this.contexts.length;c++)if(this.contexts[c].graphics3DCore===a)return c;return-1};b.prototype.layerPropertyChanged=function(a,c){switch(c){case "featureReduction":c=!!this.isFeatureReductionEnabled(a.graphics3DCore);this.setGraphicsVisibilityFlags(a,c?!1:void 0);this.modifyGraphics(a,c,0);break;case "labelingInfo":c=this.isLabelDeconflictionEnabled(a.graphics3DCore);this.modifyGraphics(a,c,1);break;case "slicePlaneEnabled":var b=
a.graphics3DCore.symbolCreationContext.slicePlaneEnabled;a.graphics.forEach(function(a){a.slicePlaneEnabled=b});this.setDirty(0)}};b.prototype.modifyGraphics=function(a,c,b){var l=(c?this.addToActiveGraphics:this.removeFromActiveGraphics).bind(this);a.graphics.forEach(function(a){l(a,b)});this.setDirty(0)};b.prototype.addGraphic=function(a,c){var b=c.graphic.uid;c=new ca(c,a.graphics3DCore.symbolCreationContext.slicePlaneEnabled);a.graphics.set(b,c);this.isFeatureReductionEnabled(a.graphics3DCore)&&
this.addToActiveGraphics(c,0);this.isLabelDeconflictionEnabled(a.graphics3DCore)&&this.addToActiveGraphics(c,1);this.setDirty()};b.prototype.removeGraphic=function(a,c){c=c.graphic.uid;var b=a.graphics.get(c);b&&(this.removeFromActiveGraphics(b,0),this.removeFromActiveGraphics(b,1),a.graphics.delete(c),this.setDirty())};b.prototype.addToActiveGraphics=function(a,c){a.info[c]=new ba;this.graphics[c].active[a.graphics3DGraphic.graphic.uid]=a};b.prototype.removeFromActiveGraphics=function(a,c){this.removeFromVisibleGraphics(a,
c);this.resetGraphicVisibility(a,c);delete a.info[c];delete this.graphics[c].active[a.graphics3DGraphic.graphic.uid]};b.prototype.addToVisibleGraphics=function(a,c){var b=a.info[c];b&&!b.pooled&&(this.graphics[c].visible.push(a),b.pooled=!0)};b.prototype.removeFromVisibleGraphics=function(a,c){var b=a.info[c];b&&b.pooled&&(this.graphics[c].remove.push(a),b.pooled=!1)};b.prototype.processActiveGraphics=function(a,c){for(var b=this.getOrCreateActiveGraphicsIterator(a),p="global"===this.view.viewingMode&&
1===this.view.map.ground.opacity&&this.camera&&0<this.camera.relativeElevation;!c.done();){var e=b.next();if(e.done)return this.resetActiveGraphicsIterator(a),!0;var d=(e=e.value)&&e.info[a];d&&(this.collectGraphics3DGraphics(e,a,p),d.culled?this.removeFromVisibleGraphics(e,a):this.addToVisibleGraphics(e,a))}return!1};b.prototype.cleanVisibleGraphics=function(a,c){for(var b=this.graphics[a],p=this.getOrCreateRemoveGraphicsIterator(a,c);!c.done();)if(p.next().done)return b.remove.clear(),this.resetRemoveGraphicsIterator(a),
!0;return!1};b.prototype.sortVisibleGraphics=function(a,c){for(var b=this.getOrCreateSortGraphicsIterator(a,function(c,b){return c.info[a]&&b.info[a]?b.info[a].posView-c.info[a].posView:Number.MAX_VALUE},c);!c.done();)if(b.next().done)return this.resetSortGraphicsIterator(a),!0;return!1};b.prototype.deconflictVisibleGraphics=function(a,c){for(var b=this.getOrCreateVisibleGraphicsIterator(a),p=1===a;!c.done();){var e=b.next();if(e.done)return this.resetVisibleGraphicsIterator(a),!0;var e=e.value,d=
e.info[a];if(d&&!d.culled){var k=e.graphics3DGraphic,k=!(p&&!1===k.areVisibilityFlagsSet(2))&&!this.doesIntersectExistingPoly(e,a);(d.visible=k)&&this.addToBins(e,a);this.setGraphicVisibility(e,a,k);v.drawPoly(d,k?"green":"red")}}return!1};b.prototype.resetIterators=function(){this.iterators[0].active=null;this.iterators[0].visible=null;this.iterators[0].remove=null;this.iterators[0].sort=null;this.iterators[1].active=null;this.iterators[1].visible=null;this.iterators[1].remove=null;this.iterators[1].sort=
null};b.prototype.getOrCreateActiveGraphicsIterator=function(a){var c=this.graphics[a];a=this.iterators[a];a.active||(a.active=V(c.active));return a.active};b.prototype.resetActiveGraphicsIterator=function(a){this.iterators[a].active=null};b.prototype.getOrCreateVisibleGraphicsIterator=function(a){var c=this.graphics[a];a=this.iterators[a];a.visible||(a.visible=c.visible.iterableForEach());return a.visible};b.prototype.resetVisibleGraphicsIterator=function(a){this.iterators[a].visible=null};b.prototype.getOrCreateRemoveGraphicsIterator=
function(a,c){var b=this.graphics[a];a=this.iterators[a];a.remove||(a.remove=b.visible.iterableRemoveMany(b.remove.data,function(){return c.done()}));return a.remove};b.prototype.resetRemoveGraphicsIterator=function(a){this.iterators[a].remove=null};b.prototype.getOrCreateSortGraphicsIterator=function(a,c,b){var p=this.graphics[a];a=this.iterators[a];a.sort||(a.sort=p.visible.iterableSort(c,function(){return b.done()}));return a.sort};b.prototype.resetSortGraphicsIterator=function(a){this.iterators[a].sort=
null};b.prototype.collectGraphics3DGraphics=function(a,b,l){var c=a.graphics3DGraphic;if(!c.destroyed){var e=1===b,d=e?c._labelGraphics:c._graphics,e=e?0:this.iconMarginFactor;b=a.info[b];if(!c.areVisibilityFlagsSet(0))b.culled=!0;else if(d&&d.length){for(var c=w.empty(Z),k,f,q=0;q<d.length;q++){var m=d[q];if(m&&"object3d"===m.type){var n=m.stageObject,r=n?n.getNumGeometryRecords():0;if(!(1>r)){var t=n.getGeometryRecord(0),g=t.material;if(g instanceof U)if(1<r)W.warn("Graphic objects with more than 1 geometry record are not supported");
else{var r=this.camera,u=t.geometry.data.getVertexAttr();if(l&&(K.radius=R.earthRadius,h.vec3.sub(C.direction,n.getCenter(),this.camera.eye),h.vec3.copy(C.origin,this.camera.eye),S.intersectRay(K,C,L))){var v=1-Math.abs(Math.tan(h.vec3.angle(n.getCenter(),C.direction)))/this.view.width,v=Math.pow(v,4),x=h.vec3.sqrDist(this.camera.eye,L),y=h.vec3.sqrDist(this.camera.eye,n.getCenter());if(v*y>x){b.culled=!0;return}}if(!f){f=n.getCenter();t=t.origin.vec3;B.transformToWorld(f,t,I);B.transformToView(I,
t,r.viewMatrix,A);g.applyVerticalOffsetTransformation(A,u[H.VertexAttrConstants.NORMAL].data,n.objectTransformation,r,D);if(a.slicePlaneEnabled&&this.slicePlaneViewSpace&&z.boundedPlane.extrusionContainsPoint(this.slicePlaneViewSpace,A)){b.culled=!0;return}n=u[H.VertexAttrConstants.AUXPOS1].data;t="screen"!==g.getParams().centerOffsetUnits;B.transformToProjection(A,r.projectionMatrix,t?n:Y,J);f=B.transformToNDC(J,X);t||(f[0]+=n[0]/r.fullWidth*2,f[1]+=n[1]/r.fullHeight*2);if(-1>f[0]||-1>f[1]||-1>f[2]||
1<=f[0]||1<=f[1])break;k=A[2];!Q.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&b.visible&&(k*=.7)}m=m.getScreenSize(ea);T.applyPrecomputedScaleFactorVec2(m,D.factor,m);g=w.offset(g.calculateRelativeScreenBounds(m,D.scaleAlignment,aa),G.lerp(0,r.fullWidth,.5+.5*f[0]),G.lerp(0,r.fullHeight,.5+.5*f[1]));0!==e&&(m=e*Math.min(w.width(g),w.height(g)),g[0]-=m,g[1]-=m,g[2]+=m,g[3]+=m);w.expand(c,g)}}}}null!=k?(b.xMin=c[0],b.yMin=c[1],b.xMax=c[2],b.yMax=c[3],b.posView=k,b.culled=!1):b.culled=!0}}};b.prototype.doesIntersectExistingPoly=
function(a,b){var c=a.graphics3DGraphic.graphic.uid;a=a.info[b];for(var d=Math.floor(a.xMin/this.accBinsSizeX);d<=Math.floor(a.xMax/this.accBinsSizeX);d++)if(!(0>d||d>=this.accBinsNumX))for(var e=Math.floor(a.yMin/this.accBinsSizeY);e<=Math.floor(a.yMax/this.accBinsSizeY);e++)if(!(0>e||e>=this.accBinsNumY))for(var h=this.accBins[d][e],k=0;k<h.length;k++){var f=h.data[k],q=f.info[b];if(q&&q.visible&&f.graphics3DGraphic.graphic.uid!==c&&(this.accNumTests++,!(q.xMin>a.xMax||q.xMax<a.xMin||q.yMin>a.yMax||
q.yMax<a.yMin)))return!0}return!1};b.prototype.initBins=function(a,b){if(null==this.accBins){this.accBins=[];for(var c=0;c<this.accBinsNumX;c++){this.accBins.push([]);for(var d=this.accBins[this.accBins.length-1],e=0;e<this.accBinsNumY;e++)d.push(new u)}}for(c=0;c<this.accBinsNumX;c++)for(e=0;e<this.accBinsNumY;e++)this.accBins[c][e].clear();this.accBinsSizeX=a/this.accBinsNumX;this.accBinsSizeY=b/this.accBinsNumY;this.accNumTests=0};b.prototype.addToBins=function(a,b){b=a.info[b];for(var c=Math.floor(b.xMin/
this.accBinsSizeX);c<=Math.floor(b.xMax/this.accBinsSizeX);c++)if(!(0>c||c>=this.accBinsNumX))for(var d=Math.floor(b.yMin/this.accBinsSizeY);d<=Math.floor(b.yMax/this.accBinsSizeY);d++)0>d||d>=this.accBinsNumY||this.accBins[c][d].push(a)};b.prototype.isFeatureReductionEnabled=function(a){a=a.layer;return!(!a||!a.featureReduction||"selection"!==a.featureReduction.type)};b.prototype.isLabelDeconflictionEnabled=function(a){return a.labelsEnabled};b.prototype.setGraphicsVisibilityFlags=function(a,b){(a=
a.graphics3DCore.graphics3DGraphics)&&a.forEach(function(a){return a.setVisibilityFlag(2,b)})};b.prototype.setGraphicVisibility=function(a,b,d){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(2,d,b),1===b&&void 0!==d&&this.view.labeler.setLabelGraphicVisibility(a,d))};b.prototype.resetGraphicVisibility=function(a,b){this.setGraphicVisibility(a,b,void 0)};return b}();x.Deconflictor=E;var M=function(){return function(){}}();x.GraphicsOwner=M;var D={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},
scaleAlignment:0,minPixelSizeAlignment:0},ea=h.vec2f64.create()});