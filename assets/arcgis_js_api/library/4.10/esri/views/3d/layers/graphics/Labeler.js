// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../Color ../../../../core/Accessor ../../../../core/Handles ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/LabelClass ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./graphicUtils ./labelPlacement ../../support/debugFlags ../../webgl-engine/Stage ../../webgl-engine/lib/Layer ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextTexture ../../webgl-engine/lib/TextTextureAtlas".split(" "),
function(m,u,C,t,v,D,E,w,x,p,y,F,G,H,I,J,z,K,A,L,M){Object.defineProperty(u,"__esModule",{value:!0});m=function(m){function d(a){a=m.call(this)||this;a.labelStageLayer=null;a.labels={};a.labelsToAdd={};a.labelsToRemove={};a.labelingContexts=[];a.idHint="__labeler";a.dirty=!1;return a}C(d,m);k=d;d.prototype.setup=function(){var a=this;this.handles||(this.handles=new E,this.handles.add([this.view.watch("state.camera",function(){return a.setDirty()})]));this.labelStageLayer||(this.labelStageLayer=new K(this.idHint,
{isPickable:!1},this.idHint+"_labels"),this.view._stage.add(z.ModelContentType.LAYER,this.labelStageLayer),this.view._stage.addToViewContent([this.labelStageLayer.id]),this.textTextureAtlas=new M(this.idHint+"_atlas",this.view),this.hudMaterialCollection=new A(this.view._stage),this.calloutMaterialCollection=new A(this.view._stage));this.handles.add(this.view.resourceController.registerIdleFrameWorker({needsUpdate:function(){return a.needsIdleUpdate()},idleFrame:function(c){return a.idleUpdate(c)}}))};
d.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null);this.labelStageLayer&&(this.view._stage.removeFromViewContent([this.labelStageLayer.id]),this.view._stage.remove(z.ModelContentType.LAYER,this.labelStageLayer.id),this.labelStageLayer=null,this.textTextureAtlas.dispose(),this.textTextureAtlas=null,this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null,this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelingContexts=
[];this.labels={};this.labelsToAdd={};this.labelsToRemove={}};d.prototype.isActiveLabelingContext=function(a){return a.active&&this.labelsEnabled(a)};d.prototype.activateLabelingContext=function(a){for(var c in a.labels){var b=a.labels[c];this.labels[c]=b;b.graphics3DGraphic.setVisibilityFlag(0,!0,1)}a.active=!0};d.prototype.deactivateLabelingContext=function(a){for(var c in a.labels){var b=a.labels[c];b.graphics3DGraphic.setVisibilityFlag(0,!1,1);b.rendered&&(this.labelsToRemove[c]=a.labels[c]);
delete this.labels[c];delete this.labelsToAdd[c]}a.active=!1};d.prototype.addLabelTextureToAtlas=function(a){for(var c=0,b=0;b<a.graphics3DGraphic._labelGraphics.length;b++){var q=a.graphics3DGraphic._labelGraphics[b];if(q._labelClass){var d=a.textTextures[c];c++;d&&this.textTextureAtlas.addTextTexture(d,q.stageObject)}}a.rendered=!0};d.prototype.removeLabelTextureFromAtlas=function(a){for(var c=a.graphics3DGraphic,b=0;b<c._labelGraphics.length;b++)a.textTextures[b]&&this.textTextureAtlas.removeTextTexture(a.textTextures[b],
c._labelGraphics[b].stageObject);a.rendered=!1};d.prototype.needsIdleUpdate=function(){return this.isDirty};d.prototype.idleUpdate=function(a){if(this.view.ready){for(var c=!!a,b=!1,q=!1,d=0,e=this.labelingContexts;d<e.length;d++){var g=e[d];if(this.isActiveLabelingContext(g)){if(!this.hasValidLabelClassContext(g)){if(this.hasInvalidLabelClassContext(g)){this.deactivateLabelingContext(g);continue}this.createLabelClassContext(g);if(this.hasPendingLabelClassContext(g)){b=!0;continue}if(!this.hasValidLabelClassContext(g))continue}for(var l in g.labelsToInitialize){if(c&&
a.done())return;var h=g.labelsToInitialize[l];!h.hasGraphics3DResources&&this.createGraphics3DResources(h)&&(this.labels[l]=h,q=!0);h.hasGraphics3DResources&&!h.hasTextTextureResources&&h.visible&&this.createTextTextureResources(h);(h.visible&&h.hasTextTextureResources||!h.visible&&h.hasGraphics3DResources)&&delete g.labelsToInitialize[l]}}}c&&q&&this.view.deconflictor.setDirty();for(l in this.labelsToRemove)this.removeLabelTextureFromAtlas(this.labelsToRemove[l]),delete this.labelsToRemove[l];for(l in this.labelsToAdd)this.addLabelTextureToAtlas(this.labelsToAdd[l]),
delete this.labelsToAdd[l];b||(this.dirty=!1)}};d.prototype.hasPendingLabelClassContext=function(a){return a.labelClassPromise&&!a.labelClassPromise.isResolved()};d.prototype.hasValidLabelClassContext=function(a){return a.labelClassContexts&&a.labelClassContexts.length};d.prototype.hasInvalidLabelClassContext=function(a){return null===a.labelClassContexts};d.prototype.createLabelClassContext=function(a){if(a.labelClassPromise)return a.labelClassPromise;a.labelClassPromise=a.layer.when(function(){a.scaleVisibility&&
a.scaleVisibility.updateScaleRangeActive();var c=a.graphics3DCore,b=c.layer.labelingInfo&&c.layer.labelingInfo.filter(function(a){return!!a.symbol});if(!b||0===b.length)return null;var q=Array(b.length),b=b.map(function(a,b){var d=a.symbol,e=H.getGraphics3DSymbol(c.getOrCreateGraphics3DSymbol(d)),f=null;F.isCalloutSupport(d)&&d.hasVisibleCallout()&&(f=G.make(d,c.symbolCreationContext));q[b]={labelClass:a,graphics3DSymbol:e,graphics3DCalloutSymbolLayer:f,options:a.getOptions(),calloutSymbolLayerIndex:0};
return e});return w.all(b).then(function(){return q})}).then(function(c){c&&(a.labelClassContexts=c)}).catch(function(){a.labelClassContexts=null});return a.labelClassPromise};d.prototype.destroyLabelClassContext=function(a){for(var c=0,b=a.labelClassContexts;c<b.length;c++){var d=b[c];--d.graphics3DSymbol.referenced;d.graphics3DSymbol=null}a.labelClassContexts=[];a.labelClassPromise=null};d.prototype.createLabelText=function(a,c,b,d){if(!y.evaluateWhere(c.where,a.attributes))return null;c=c.getLabelExpression();
return c.expression?y.buildLabelText(c.expression,a,d.fields,b):null};d.prototype.createTextSymbolGraphic=function(a,c,b,d,f){a={text:a,centerOffset:b.centerOffset,translation:b.translation,elevationOffset:b.elevationOffset,screenOffset:b.screenOffset,anchor:b.anchor,needsOffsetAdjustment:b.needsOffsetAdjustment,centerOffsetUnits:b.centerOffsetUnits,verticalOffset:b.verticalOffset,debugDrawBorder:J.LABELS_SHOW_BORDER};k.tmpGraphicCreationContext.graphic=c;k.tmpGraphicCreationContext.renderingInfo=
null;k.tmpGraphicCreationContext.layer=d;return f.createGraphics3DGraphic(k.tmpGraphicCreationContext,a,this.hudMaterialCollection,this.textTextureAtlas)};d.prototype.createLineCalloutGraphic=function(a,c,b,d,f){k.tmpGraphicCreationContext.graphic=a;k.tmpGraphicCreationContext.renderingInfo={symbol:c,needsOffsetAdjustment:d.needsOffsetAdjustment,translation:d.translation,elevationOffset:d.elevationOffset,screenOffset:d.screenOffset,centerOffset:d.centerOffset,centerOffsetUnits:d.centerOffsetUnits,
materialCollection:this.calloutMaterialCollection};k.tmpGraphicCreationContext.layer=f;return b.createGraphics3DGraphic(k.tmpGraphicCreationContext)};d.prototype.createGraphics3DResources=function(a){var c=a.graphics3DGraphic;if(c.destroyed)return!1;var b=a.labelingContext,d=!1,f=c.graphic,e=b.labelClassContexts,g=b.layer,l=this.labelsEnabled(b);if(!e||0===e.length||!c._graphics[0])return!1;for(var h=0;h<e.length;h++){var r=e[h],k=r.labelClass,m=this.createLabelText(f,k,r.options,g);if(m){var n=r.graphics3DSymbol,
p=null;n.symbol&&"label-3d"===n.symbol.type&&(p=n.symbol);var t=n.childGraphics3DSymbols[0],n=I.get({graphics3DGraphic:c,labelSymbol:p,labelClass:r.labelClass});if(t&&n){if(d=this.createTextSymbolGraphic(m,f,n,g,t)){if(d._labelClass=k,c.addLabelGraphic(d,this.labelStageLayer,this.view._stage),b.spatialIndex&&b.spatialIndex.add(c),c.setVisibilityFlag(0,l,1),c.setVisibilityFlag(1,void 0,1),c.setVisibilityFlag(2,!1,1),d=!0,r.graphics3DCalloutSymbolLayer&&n.hasLabelVerticalOffset&&(f=this.createLineCalloutGraphic(f,
p,r.graphics3DCalloutSymbolLayer,n,g)))r.calloutSymbolLayerIndex=c._labelGraphics.length,c.addLabelGraphic(f,this.labelStageLayer,this.view._stage)}else return!1;break}}}b.scaleVisibility&&d&&b.scaleVisibility.updateGraphicLabelScaleVisibility(c);return a.hasGraphics3DResources=!0};d.prototype.destroyGraphics3DResources=function(a){a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};d.prototype.createTextTextureResources=function(a){var c=a.labelingContext,b=a.graphics3DGraphic,
d=c.labelClassContexts,c=c.layer,f=b.graphic;if(d&&0!==d.length&&b._graphics[0]){for(b=0;b<d.length;b++){var e=d[b],g=this.createLabelText(f,e.labelClass,e.options,c)||f.symbol&&f.symbol.text;if(g&&!(1>g.length)){var e=e.graphics3DSymbol.childGraphics3DSymbols[0].symbol,l=e.material?v.toUnitRGBA(e.material.color):B,h=e.halo&&e.halo.color&&0<e.halo.size,k=h?v.toUnitRGBA(e.halo.color):B,h=h?x.pt2px(e.halo.size):0,m=x.pt2px(e.size)||12,g=new L(g,{size:m,color:l,font:{family:e.font&&e.font.family?e.font.family:
"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},halo:{size:h,color:k}},c.id+"_label_"+f.uid);a.textTextures.push(g)}}a.hasTextTextureResources=!0}};d.prototype.destroyTextTextureResources=function(a){a.textTextures=[];a.hasTextTextureResources=!1};d.prototype.addGraphic=function(a,c){var b={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:a,graphics3DGraphic:c,textTextures:[]};c=c.graphic.uid;
a.labels[c]=b;this.isActiveLabelingContext(a)&&this.hasValidLabelClassContext(a)&&this.createGraphics3DResources(b)?this.labels[c]=b:a.labelsToInitialize[c]=b;this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};d.prototype.removeGraphic=function(a,c){c=c.graphic.uid;var b=a.labels[c];b&&(this.labels[c]&&(this.removeLabelTextureFromAtlas(b),delete this.labels[c],delete this.labelsToAdd[c],delete this.labelsToRemove[c]),b.hasTextTextureResources&&this.destroyTextTextureResources(b),
b.hasGraphics3DResources&&this.destroyGraphics3DResources(b),delete a.labels[c],delete a.labelsToInitialize[c],this.setDirty(a.graphics3DCore.asyncUpdates),this.view.deconflictor.setDirty())};d.prototype.labelsEnabled=function(a){return!0===a.layer.labelsVisible&&null!=a.layer.labelingInfo&&0<a.layer.labelingInfo.length};d.prototype.labelingInfoChange=function(a,c){if(c){for(var b=0;b<c.length;b++){var d=a.labels[c[b]];d&&(this.removeGraphic(a,d.graphics3DGraphic),this.addGraphic(a,d.graphics3DGraphic))}return w.create(function(a){return!0})}this.visibilityInfoChange(a);
this.resetLabels(a);return this.createLabelClassContext(a)};d.prototype.layerPropertyChanged=function(a,c){for(var b=function(b){var d=new Map,e;for(e in c.labels){var f=c.labels[e].graphics3DGraphic;d.set(f.graphic.uid,f)}b.graphics3DSymbol.childGraphics3DSymbols[0].layerPropertyChanged(a,d,function(a){return a._labelGraphics[0]});b.graphics3DCalloutSymbolLayer&&b.graphics3DCalloutSymbolLayer.layerPropertyChanged(a,d,function(a){return a._labelGraphics[b.calloutSymbolLayerIndex]})},d=0,f=c.labelClassContexts;d<
f.length;d++)b(f[d])};d.prototype.visibilityInfoChange=function(a){var c=a.layer.labelsVisible;c&&!a.active&&this.activateLabelingContext(a);!c&&a.active&&this.deactivateLabelingContext(a);this.setDirty(a.graphics3DCore.asyncUpdates)};d.prototype.resetLabels=function(a){for(var c in a.labels){var b=a.labels[c];this.labels[c]&&(this.removeLabelTextureFromAtlas(b),delete this.labels[c],delete this.labelsToAdd[c],delete this.labelsToRemove[c]);b.hasTextTextureResources&&this.destroyTextTextureResources(b);
b.hasGraphics3DResources&&this.destroyGraphics3DResources(b);b.visible=!1;b.rendered=!1;a.labelsToInitialize[c]=b}this.destroyLabelClassContext(a);this.labelStageLayer.invalidateSpatialQueryAccelerator();this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};d.prototype.findLabelingContext=function(a){for(var c=0,b=this.labelingContexts;c<b.length;c++){var d=b[c];if(d.graphics3DCore===a)return d}return null};d.prototype.addGraphicsOwner=function(a,c,b){var d=this;if(!this.findLabelingContext(a)){var f=
{graphics3DCore:a,layer:a.layer,scaleVisibility:c,spatialIndex:b,active:a.layer.labelsVisible,labelClassPromise:null,labelClassContexts:[],labels:{},labelsToInitialize:{}};this.labelingContexts.push(f);this.setDirty();return{addGraphic:function(a){return d.addGraphic(f,a)},removeGraphic:function(a){return d.removeGraphic(f,a)},layerLabelsEnabled:function(){return d.labelsEnabled(f)},labelingInfoChange:function(a){return d.labelingInfoChange(f,a)},elevationInfoChange:function(){return d.layerPropertyChanged("elevationInfo",
f)},slicePlaneEnabledChange:function(){return d.layerPropertyChanged("slicePlaneEnabled",f)},visibilityInfoChange:function(){return d.visibilityInfoChange(f)},reset:function(){return d.resetLabels(f)}}}};d.prototype.removeGraphicsOwner=function(a){if(a=this.findLabelingContext(a)){var c=this.labelingContexts.indexOf(a);this.labelingContexts.splice(c,1);for(var b in a.labels)this.removeGraphic(a,a.labels[b].graphics3DGraphic);this.setDirty()}};d.prototype.setLabelGraphicVisibility=function(a,c){a=
a.graphic.uid;var b=this.labels[a];b&&(c&&!b.rendered?(this.labelsToAdd[a]=b,b.hasTextTextureResources||(b.labelingContext.labelsToInitialize[a]=b)):!c&&b.rendered&&(this.labelsToRemove[a]=b),b.visible=c,this.setDirty(b.labelingContext.graphics3DCore.asyncUpdates))};Object.defineProperty(d.prototype,"labelStageLayerId",{get:function(){return this.labelStageLayer.id},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"isDirty",{get:function(){return this.dirty||this.textTextureAtlas&&
this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0});d.prototype.setDirty=function(a){void 0===a&&(a=!0);this.dirty=!0;a||this.idleUpdate()};Object.defineProperty(d.prototype,"updating",{get:function(){return this.labelingContexts.some(function(a){return a.labelClassPromise&&!a.labelClassPromise.isResolved()})},enumerable:!0,configurable:!0});var k;d.tmpGraphicCreationContext={graphic:null,renderingInfo:null,layer:null};t([p.property({constructOnly:!0})],d.prototype,"view",void 0);t([p.property({type:Boolean,
readOnly:!0})],d.prototype,"updating",null);return d=k=t([p.subclass()],d)}(p.declared(D));u.Labeler=m;var B=[0,0,0,1]});