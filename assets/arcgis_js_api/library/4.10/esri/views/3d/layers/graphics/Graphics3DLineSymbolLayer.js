// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingBox ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry".split(" "),
function(N,O,D,A,t,E,B,F,G,H,k,I,J,y,C,K,L,M){return function(n){function d(){return null!==n&&n.apply(this,arguments)||this}D(d,n);d.prototype._prepareResources=function(){var a=this.symbol,b=this._isPropertyDriven("size")||this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),c=this._getStageIdHint();a=null!=a.size?A.pt2px(a.size):1;c={idHint:c,width:a,color:this._getMaterialOpacityAndColor(),slicePlaneEnabled:this._context.slicePlaneEnabled};if(!this._isPropertyDriven("size")&&(a=
J.validateSymbolLayerSize(c.width))){this._logWarning(a);this.reject();return}if(b||1.5<=c.width)this._isPropertyDriven("size")&&(c.width=0),this._material=y.createRibbonMaterial(c);else if(0<c.width)this._material=y.createNativeMaterial(c);else{this.reject();return}this._context.stage.add(C.ModelContentType.MATERIAL,this._material);this.resolve()};d.prototype.destroy=function(){n.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(C.ModelContentType.MATERIAL,
this._material.id),this._material=null)};d.prototype.createGraphics3DGraphic=function(a){var b=a.renderingInfo;a=a.graphic;var c=a.geometry;if("polyline"!==c.type&&"polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for line symbol: "+c.type),null;if(!this._validateGeometry(c))return null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",d="graphic"+a.uid,e=this._getVertexOpacityAndColor(b,Float32Array,255),p=0;b.size&&this._isPropertyDriven("size")&&
(p=k.getSingleSizeDriver(b.size),p=A.pt2px(p));b=this.getGraphicElevationContext(a);return"on-the-ground"===b.mode?this._createAsOverlay(a,c,e,p,b,d):this._createAs3DShape(a,c,e,p,b,d,a.uid)};d.prototype.layerOpacityChanged=function(){var a=this._material.getColor(),a={color:[a[0],a[1],a[2],this._getMaterialOpacity()]};this._material.setParameterValues(a);return!0};d.prototype.layerElevationInfoChanged=function(a,b,c){var d=this._elevationContext.mode;if(null==c||null==d)return!1;if("on-the-ground"===
c&&"on-the-ground"===d)return!0;if(c!==d&&("on-the-ground"===c||"on-the-ground"===d))return!1;var e=k.needsElevationUpdates2D(d);return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return e})};d.prototype.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};d.prototype._getOutlineGeometry=function(a,b){return b};d.prototype._getGeometry=function(a){a=a.geometry;"extent"===a.type&&(a=E.fromExtent(a));return a};
d.prototype._createAs3DShape=function(a,b,c,d,e,p,l){var f=this._getGeometry(a),q=f[b],u=this._getOutlineGeometry(f,q);a=[];var v=[],g=[],m=t.vec3f64.create(),r=Array(6),f=k.getGeometryVertexData3D(u,f.hasZ,f.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,e);this._logGeometryCreationWarnings(f,q,b,"LineSymbol3DLayer");if(0<u.length){for(var q=f.geometryData.outlines,u=f.eleVertexData,n=f.vertexData,z=0;z<q.length;++z){var w=q[z];
if(!(1>=w.count)){var h=w.index,x=w.count;if(this._context.clippingExtent&&(k.computeBoundingBox(u,h,x,r),k.boundingBoxClipped(r,this._context.clippingExtent)))continue;k.chooseOrigin(n,h,x,m);k.subtractCoordinates(n,h,x,m);w=new Float64Array(u.buffer,3*h*u.BYTES_PER_ELEMENT,3*x);h=new Float64Array(n.buffer,3*h*n.BYTES_PER_ELEMENT,3*x);h=y.createPolylineGeometry(h,w,"rings"===b,c,d);h=new K(h,p+"path"+z);h.singleUse=!0;a.push(h);v.push(this._material);h=t.mat4f64.create();t.mat4.translate(h,h,m);
g.push(h)}}if(0<a.length)return b=new L({geometries:a,materials:v,transformations:g,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:l},idHint:p}),b=new H(this,b,a,null,null,F.perVertexElevationAligner,e),b.alignedTerrainElevation=f.terrainElevation,b.needsElevationUpdates=k.needsElevationUpdates2D(e.mode),b}return null};d.prototype._createAsOverlay=function(a,b,c,d,e,p){var l=this._getGeometry(a);this._material.renderPriority=this._symbolLayerOrder;var f=l[b],q=this._getOutlineGeometry(l,
f);a=[];e=Array(6);var n=B.empty(),v=t.vec3f64.create(),l=k.getGeometryVertexDataDraped(q,l.spatialReference,this._context.overlaySR);this._logGeometryCreationWarnings(l,f,b,"LineSymbol3DLayer");if(0<q.length){f=l.vertexData;q=l.geometryData.outlines;for(l=0;l<q.length;++l){var g=q[l],m=g.index,g=g.count;k.computeBoundingBox(f,m,g,e);if(!k.boundingBoxClipped(e,this._context.clippingExtent)){B.expand(n,e);k.chooseOrigin(f,m,g,v);k.subtractCoordinates(f,m,g,v);k.setZ(f,m,g,this._getDrapedZ());g=new Float64Array(f.buffer,
3*m*f.BYTES_PER_ELEMENT,3*g);m=t.mat4f64.create();t.mat4.translate(m,m,v);var g=y.createPolylineGeometry(g,null,"rings"===b,c,d),r=new M(g);r.material=this._material;r.center=[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];r.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]));r.transformation=m;r.name=p;r.uniqueName=p+"#"+g.id;a.push(r)}}return new G(this,a,n)}return null};return d}(I)});