// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports dojo/errors/CancelError ../../../../core/lang ../../../../core/promiseUtils ../../../../core/urlUtils ./I3SBinaryReader ./I3SUtil ../../webgl-engine/lib/Util".split(" "),function(l,w,t,u,n,p,q,r,v){l=function(){function e(a,c,b,d,g){this.loader=a;this.logger=c;this.defaultGeometrySchema=b;this.requiredAttributes=d;this.options=g;this.cancelled=!1;this.loadShared=function(a){if(null==a.sharedResource)return n.resolve({});var b=p.makeAbsolute(a.sharedResource.href,a.baseUrl);
return this.load(b,"json").then(function(a){e.fixTextureEncodings(a);e.addAbsoluteHrefTexture(a,b);return a})}}e.prototype.cancelAll=function(){this.cancelled=!0};e.prototype.load=function(a,c){var b=this;return n.create(function(d,g){b.loader.request(a,c).then(function(a,b){d(b)},function(b){g(Error("Failed to load: "+a))})})};e.prototype.loadAttribute=function(a,c,b){a=p.makeAbsolute(b,a);return this.load(a,"binary").then(function(a){return q.readBinaryAttribute(c,a)})};e.prototype.loadAttributes=
function(a,c,b){var d=this,g=b.map(function(b){return null==a.attributeData||null==a.attributeData[b.index]?(d.logger.error("Missing attributeData for '"+b.name+"' on node '"+a.id+"'"),n.resolve(null)):d.loadAttribute(c,b.attributeStorageInfo,a.attributeData[b.index].href).catch(function(c){d.logger.error("Failed to load attributeData for '"+b.name+"' on node '"+a.id+"'");return null})});return n.all(g).then(function(a){for(var d={},c=0;c<b.length;++c)a[c]&&(d[b[c].name]=a[c]);return d})};e.prototype.prepareBinaryGeometryData=
function(a,c,b,d){u.mixin(a.geometries[0].params,b);d||null!=b.vertexAttributes.region||delete b.vertexAttributes.region;if(null!=b.featureAttributes){d=b.featureAttributes;if(d.faceRange){var g=q.createTypedView(c,d.faceRange);a.componentOffsets=r.convertFlatRangesToOffsets(g,b.header.fields.featureCount,d.faceRange.valuesPerElement)}if(d.id){a.featureIds=[];var g=1,f=q.valueType2TypedArrayClassMap[d.id.valueType];"UInt64"===d.id.valueType&&(f=Uint32Array,g=2);c=new f(c,d.id.byteOffset,d.id.count*
d.id.valuesPerElement*g);for(f=0;f<b.header.fields.featureCount;f++)if(a.featureIds[f]=c[f*d.id.valuesPerElement*g],2===g){var e=c[f*d.id.valuesPerElement*g+1];if(2097150<=e)throw Error("ID exceeded maximum range supported by javascript (max \x3d 53bit-1 \x3d 9007199254740991)");a.featureIds[f]+=4294967296*e}}}};e.prototype.loadBundleData=function(a,c){var b=this,d=a.baseUrl,g=null,e=this.loadShared(a),h=null;null!=this.requiredAttributes&&(h=this.loadAttributes(a,d,this.requiredAttributes));var k=
null;null!=a.geometryData&&(d=p.makeAbsolute(a.geometryData[c].href,d),k=this.load(d,"binary"));return e.then(function(d){b.handleCancelled();return(b.options.loadFeatureData?b.loadFeatureData(a,c):n.resolve(null)).then(function(c){b.handleCancelled();var e=b.options.loadFeatureData?b.collectGeometries(a,c,d):b.meshPyramidGeometryData(a,d);c=null!=k?k.then(function(a){g=a;var c=Object.keys(d.materialDefinitions)[0],c=d.materialDefinitions[c].params.vertexRegions,f=q.createGeometryDataIndex(a,b.defaultGeometrySchema,
c);b.prepareBinaryGeometryData(e[0],a,f,c);return e}):n.resolve(e);var f=b.loadTextures(e,d);return n.all([f,c,h])}).then(function(a){var c=a[0],e=a[1];a=a[2];b.handleCancelled();var f=null;a&&(f={attributeData:a,loadedAttributes:b.requiredAttributes});return{allGeometryData:e,attributeDataInfo:f,geometryBuffer:g,sharedResource:d,textureData:c}})})};e.addAbsoluteHrefTexture=function(a,c){a=a.textureDefinitions;if(null!=a)for(var b=0,d=Object.keys(a);b<d.length;b++)for(var e=0,f=a[d[b]].images;e<f.length;e++){var h=
f[e];Array.isArray(h.href)?h.hrefConcat=h.href.map(function(a){return p.makeAbsolute(a,c)}):h.hrefConcat=p.makeAbsolute(h.href,c)}};e.fixTextureEncodings=function(a){a=a.textureDefinitions;if(null!=a)for(var c in a){var b=a[c];if(Array.isArray(b.encoding))for(var d=0;d<b.encoding.length;d++){var e=b.encoding[d];"data:"===e.substring(0,5)&&(b.encoding[d]=e.substring(5))}else e=b.encoding,"data:"===e.substring(0,5)&&(b.encoding=e.substring(5))}};e.prototype.loadTexture=function(a,c,b,d){var e=this;
return d===r.DDS_ENCODING_STRING?this.load(a,"binary").then(function(a){e.handleCancelled();return{i3sTexId:c,data:a,encoding:d}}):this.load(a,"image").then(function(a){var f=a;e.handleCancelled();if(b&&4096<=a.width*a.height){var f=Math.ceil(a.width/2),g=Math.ceil(a.height/2),m=document.createElement("canvas");m.width=f;m.height=g;m.getContext("2d").drawImage(a,0,0,f,g);f=m}return{i3sTexId:c,data:f,encoding:d}})};e.prototype.loadTextures=function(a,c){for(var b=[],d=0;d<a.length;d++){var g=a[d].geometries;
if(null!=g)for(var f=0;f<g.length;f++){var h=g[f].params.textureID||"none";if("none"!==h){null!=c.textureDefinitions&&null!=c.textureDefinitions[h]||this.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+h);var k=c.textureDefinitions[h];v.assert(void 0!==k,"geometry wants unknown texture "+h);if(0!==k.images.length){var m=k.images[k.images.length-1],p=this.options.textureFormat===e.TextureFormat.Downsampled,l=r.getAppropriateTextureEncoding(k.encoding,this.options.textureFormat===
e.TextureFormat.Compressed),k=-1<l?k.encoding[l]:k.encoding,m=-1<l?m.hrefConcat[l]:m.hrefConcat;this.options.loadTextureData?b.push(this.loadTexture(m,h,p,k)):b.push({i3sTexId:h,encoding:k,data:null})}}}}return n.all(b)};e.prototype.meshPyramidGeometryData=function(a,c){a=c.materialDefinitions?Object.keys(c.materialDefinitions)[0]:null;c=c.textureDefinitions?Object.keys(c.textureDefinitions)[0]:null;return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:a,textureID:c}}],featureDataPosition:[0,
0,0]}]};e.prototype.collectGeometries=function(a,c,b){a=[];b=0;for(c=c.featureData;b<c.length;b++){var d=c[b],e=d.geometries;if(null!=e)for(var f=0;f<e.length;f++)a.push({featureIds:[d.id],featureDataPosition:d.position,geometries:[d.geometries[f]]});else null!=d.position&&a.push({featureIds:[d.id],featureDataPosition:d.position,geometries:null})}return a};e.prototype.loadFeatureData=function(a,c){a=p.makeAbsolute(a.featureData[c].href,a.baseUrl);return this.load(a,"json")};e.prototype.handleCancelled=
function(){if(this.cancelled)throw new t;};return e}();(function(e){e=e.TextureFormat||(e.TextureFormat={});e[e.Compressed=0]="Compressed";e[e.Normal=1]="Normal";e[e.Downsampled=2]="Downsampled"})(l||(l={}));return l});