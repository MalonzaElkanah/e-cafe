// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Graphic ../../../core/has ../../../core/Logger ../../../core/PooledArray ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/gl-matrix ../../../core/libs/rbush/PooledRBush ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/contains ../../../layers/graphics/dehydratedFeatures ../../../layers/graphics/controllers/I3SOnDemandController ../../../renderers/support/renderingInfoUtils ./LayerView3D ./graphics/Graphics3DFeatureLikeLayerView ./graphics/Graphics3DVerticalScale ./i3s/I3SQueryEngine ./i3s/I3SUtil ./support/layerViewUpdatingProperties ./support/PopupSceneLayerView ../support/EventedArray ../support/orientedBoundingBox ../support/projectionUtils".split(" "),
function(u,fa,K,g,L,M,N,O,p,H,f,P,Q,v,J,R,B,S,T,U,V,W,X,w,Y,Z,aa,ba,D){var E=N.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D");u=function(u){function b(a){a=u.call(this)||this;a._nodesAddedToStage={};a.overlayUpdating=!1;a.supportsDraping=!0;a._queryEngine=null;a._memCache=null;a.loadedGraphics=new aa;a.progressiveLoadFactor=1;a.supportsHeightUnitConversion=!0;a._coordinatesOutsideExtentErrors=0;a._maxCoordinatesOutsideExtentErrors=20;a._definitionExpressionErrors=0;a._maxDefinitionExpressionErrors=
20;return a}K(b,u);b.prototype.initialize=function(){var a=this;w.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode);this.handles.add([H.init(this.layer,"rangeInfos",function(c){return a._rangeInfosChanged(c)}),this.layer.watch("renderer",function(c,b){return a._rendererChange(c,b)}),this.layer.watch("objectIdFilter",function(){return a._objectIdFilterChange()}),this.watch("_controller.parsedDefinitionExpression",function(){return a._definitionExpressionChange()})]);
this._set("graphics3d",new V({owner:this,layer:this.layer,asyncGraphicsUpdates:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:this.layer.fullExtent,updateClippingExtent:function(c){return a._updateClippingExtent(c)},queryGraphicUIDsInExtent:function(c,b,d){return a._queryGraphicUIDsInExtent(c,b,d)}}));this.supportsHeightUnitConversion&&(this._verticalScale=new W({sourceSpatialReference:this.layer.spatialReference,
destSpatialReference:this.view.spatialReference}));this.addResolvingPromise(this.graphics3d.setup());this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);this._memCache=this.view.resourceController.getMemCache(this.layer.uid);this._controller=new S({layerView:this});this.when(function(){a.handles.add([H.init(a,"maximumNumberOfFeatures",function(c){return a._controller.featureTarget=c}),H.whenTrue(a,"suspended",function(){return a._removeAllNodeData()})])})};b.prototype.destroy=function(){this.graphics3d&&
(this.graphics3d.destroy(),this._set("graphics3d",null));this._controller&&(this._controller.destroy(),this._controller=null);this._memCache.destroy();this._nodesAddedToStage=this._elevationUpdateNodes=this._memCache=null};Object.defineProperty(b.prototype,"maximumNumberOfFeatures",{get:function(){var a=this.graphics3d&&this.graphics3d.graphicsCore&&this.graphics3d.graphicsCore.displayFeatureLimit;return a?a.maximumNumberOfFeatures:0},set:function(a){null!=a?(this._override("maximumNumberOfFeatures",
a),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return this.suspended?!1:!!this._controller&&!this._controller.leafsReached},enumerable:!0,configurable:!0});b.prototype.whenGraphicAttributes=function(a,c){var b=this;return w.whenGraphicAttributes(this.layer,a,this._getObjectIdField(),c,function(a){for(var c=
new Map,d=[],n=0;n<a.length;n++){var m=a[n],l=b._findGraphicNodeAndIndex(m),k=c.get(l.node);k||(k={node:l.node,indices:[],graphics:[]},d.push(k));k.indices.push(l.index);k.graphics.push(m)}return d},{ignoreUnavailableFields:!0,populateObjectId:!0})};b.prototype.getGraphicFromGraphicUid=function(a){if(!this.loadedGraphics)return p.reject();var c=B.hydrateGraphic(this.loadedGraphics.find(function(c){return c.uid===a}),this.layer),b=this._getObjectIdField();if(!c||!c.attributes||!c.attributes[b])return p.reject();
c.layer=this.layer;c.sourceLayer=this.layer;return p.resolve(c)};b.prototype.whenGraphicBounds=function(a,c){return this.graphics3d.graphicsCore.whenGraphicBounds(a,c)};b.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};b.prototype.isUpdating=function(){return this.overlayUpdating||this._controller&&this._controller.updating||!this.graphics3d.destroyed&&this.graphics3d.updating};b.prototype.getRenderingInfo=function(a){if((a=T.getRenderingInfo(a,
{renderer:this.layer.renderer}))&&a.color){var c=a.color;c[0]/=255;c[1]/=255;c[2]/=255}return a};Object.defineProperty(b.prototype,"symbolUpdateType",{get:function(){return this.graphics3d.graphicsCore.symbolUpdateType},enumerable:!0,configurable:!0});b.prototype._findGraphicNodeAndIndex=function(a){a=a.attributes[this.layer.objectIdField];for(var c=0,b=Object.keys(this._nodesAddedToStage);c<b.length;c++){var d=b[c],e=this._findGraphicIndex(this._nodesAddedToStage[d].bundle,a);if(0<=e)return{node:this._controller.nodeIndex[d],
index:e}}return null};b.prototype._forAllFeatures=function(a,c){for(var b=0,d=Object.keys(this._nodesAddedToStage);b<d.length;b++){for(var e=d[b],r=this._nodesAddedToStage[e].bundle,h=0;h<r.length;h++)for(var m=r[h].graphics,l=0;l<m.length;l++){var k=m[l],f=r[h].featureIds[l];k.visible&&a(f,h,k)}null!=c&&c({nodeId:e})}};b.prototype._getGraphicIndices=function(a,c){a=this._nodesAddedToStage[a];for(var b=this._getObjectIdField(),d=[],e=0;e<c.length;e++){var r=this._findGraphicIndex(a.bundle,c[e].attributes[b]);
0<=r&&d.push(r)}return d};b.prototype._findGraphicIndex=function(a,c){for(var b=0;b<a.length;b++)for(var d=0,e=a[b].featureIds;d<e.length;d++)if(e[d]===c)return b;return-1};b.prototype._queryGraphicUIDsInExtent=function(a,c,b){if(this._controller){var d=this._controller.crsIndex;D.boundingRectToBoundingRect(a,c,y,d);var e=ca;v.fromRect(e,y);e[2]=-Infinity;e[5]=Infinity;null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new O);var n=this._elevationUpdateNodes;n.clear();this._controller.updateElevationChanged(e,
d,n);for(d=0;d<n.length;d++){var h=this._nodesAddedToStage[n.data[d].id];if(null!=h){if(!h.spatialIndex&&h.bundle.length>=da){for(var m=new Q.PooledRBush(9,M("csp-restrictions")?function(a){return{minX:a.extent[0],minY:a.extent[1],maxX:a.extent[2],maxY:a.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),l=I.length=0,k=h.bundle;l<k.length;l++){for(var f=k[l],g=J.empty(),p=0,z=f.graphics;p<z.length;p++)e=z[p],B.expandAABR(e.geometry,g);f.extent=g;I.push(f)}m.load(I);h.spatialIndex=
m}if(h.spatialIndex)e=y,D.boundingRectToBoundingRect(a,c,y,this.view.spatialReference),x.minX=e[0],x.minY=e[1],x.maxX=e[2],x.maxY=e[3],h.spatialIndex.search(x,function(a){var c=0;for(a=a.graphics;c<a.length;c++)b(a[c].uid)});else for(m=0,h=h.bundle;m<h.length;m++)for(f=h[m],l=0,f=f.graphics;l<f.length;l++)e=f[l],b(e.uid)}}}};b.prototype.highlight=function(a,c){void 0===c&&(c={});return this.graphics3d.highlight(a,c,this.layer.objectIdField)};b.prototype.addNodeData=function(a,c){var b=c.allGeometryData,
d=c.attributeDataInfo,e=this._controller.crsIndex;c=this.view.spatialReference;var r=[0,0,0],h=this._getObjectIdField();null==this._nodesAddedToStage[a.id]&&(this._nodesAddedToStage[a.id]={bundle:[],attributeInfo:d});var f=[];this._nodesAddedToStage[a.id].bundle=f;if(d=this.layer.fullExtent)d=this.layer.fullExtent.clone(),d.xmin-=.5,d.ymin-=.5,d.xmax+=.5,d.ymax+=.5,d.hasZ&&(d.zmin-=.5,d.zmax+=.5),d.hasM&&(d.mmin-=.5,d.mmax+=.5);for(var l=d,d=[],k=[],g=0;g<b.length;g++){var F=b[g],u=F.featureDataPosition,
z=u.length,v=F.geometries||[ea[z]],x=F.featureIds;l&&!R.extentContainsCoords3D(l,u)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&E.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&E.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++);for(var t=0;t<v.length;t++){var A=v[t];if("points"===A.params.type){var w=[],C=x[t<
x.length?t:0],y={};null!=C&&(y[h]=C);C=void 0;"Embedded"===A.type&&(C=A.params.vertexAttributes.position);for(A=0;A<C.length;A+=z){for(var q=0;q<z;q++)r[q]=u[q]+C[A+q];D.bufferToBuffer(r,e,0,G,c,0,1);q=B.makeDehydratedPoint(G[0],G[1],G[2],c);3>z&&(q.z=void 0);w.push({uid:L.generateUID(),geometry:q,attributes:y,visible:!0});a.obb||k.push(q.x,q.y,q.z?q.z:0)}d.push.apply(d,w);f.push({featureIds:F.featureIds,graphics:w})}}}a.numFeatures=d.length;this._updateNodeMemory(a);b=this._nodesAddedToStage[a.id];
this._setBundleAttributes(b.bundle,b.attributeInfo);0<k.length&&(e=this.view.renderSpatialReference,r=this._controller.crsVertex,D.bufferToBuffer(k,c,0,k,e,0,k.length/3),a.obb=ba.compute({data:k,size:3,offsetIdx:0,strideIdx:3}),D.vectorToVector(a.obb.center,e,a.obb.center,r),this._controller.updateVisibility(a.id));if(!this._controller.isGeometryVisible(a))return this._cacheNodeData(a.id,this._nodesAddedToStage[a.id]),delete this._nodesAddedToStage[a.id],p.resolve();this._verticalScale&&this._verticalScale.adjust(d);
this.loadedGraphics.addMany(d);this._filterNode(b);return p.resolve()};b.prototype.isNodeLoaded=function(a){return null!=this._nodesAddedToStage[a.id]};b.prototype._updateNodeMemory=function(a){a.memory=4096+a.numFeatures*this.graphics3d.graphicsCore.usedMemoryPerGraphic};b.prototype._cacheNodeData=function(a,c){var b=c.bundle.reduce(function(a,b){return b.graphics.reduce(function(a,b){return B.estimateSize(b)+a},512+8*b.featureIds.length+a)},1024);this._memCache.put(a,c,b)};b.prototype._removeAllNodeData=
function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(b){var c=a._nodesAddedToStage[b];c&&(a._updateNodeMemory(a._controller.nodeIndex[b]),a._cacheNodeData(b,c))});this._nodesAddedToStage={};this.loadedGraphics.clear()};b.prototype.removeNodeData=function(a){var b=this,n=[];a.forEach(function(a){var c=b._removeNodeStageData(a,n);c&&(b._updateNodeMemory(a),b._cacheNodeData(a.id,c))});this.loadedGraphics.removeUnorderedMany(n)};b.prototype._removeNodeStageData=function(a,b){var c=
this._nodesAddedToStage[a.id];if(!c)return null;for(var d=0,e=c.bundle;d<e.length;d++)b.push.apply(b,e[d].graphics);delete this._nodesAddedToStage[a.id];return c};b.prototype.loadCachedNodeData=function(a,b){return p.resolve(this._memCache.pop(a.id))};b.prototype.addCachedNodeData=function(a,b,n){for(var c=[],e=0,f=b.bundle;e<f.length;e++)c.push.apply(c,f[e].graphics);this._updateNodeMemory(a);this._nodesAddedToStage[a.id]=b;this.setAttributeData(a,n);this.loadedGraphics.addMany(c);this._filterNode(b);
return p.resolve()};b.prototype.getLoadedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)};b.prototype.getLoadedAttributes=function(a){if(a=this._nodesAddedToStage[a.id])return a.attributeInfo.loadedAttributes};b.prototype.getAttributeData=function(a){if(a=this._nodesAddedToStage[a.id])return a.attributeInfo.attributeData};b.prototype.setAttributeData=function(a,b){if(a=this._nodesAddedToStage[a.id])a.attributeInfo=b,this._setBundleAttributes(a.bundle,b),this._filterNode(a),this.graphics3d.graphicsCore.labelsEnabled&&
(b=a.bundle.map(function(a){return a.graphics.length&&a.graphics[0].uid}),this.graphics3d.graphicsCore.updateLabelingInfo(b))};b.prototype._setBundleAttributes=function(a,b){for(var c=0;c<a.length;c++)for(var d=0,e=a[c].graphics;d<e.length;d++){var f=e[d];f.attributes||(f.attributes={});if(b.loadedAttributes)for(var h=0,g=b.loadedAttributes;h<g.length;h++){var l=g[h].name;b.attributeData[l]&&(f.attributes[l]=w.getCachedAttributeValue(b.attributeData[l],c))}}};b.prototype._updateClippingExtent=function(a){this._controller&&
this._controller.updateClippingArea(a);return!1};b.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._rendererChange=function(a,b){var c=a?a.requiredFields:[],d=b?b.requiredFields:[];c.length===d.length&&c.every(function(a,b){return c[b]===d[b]})||this._reloadAllNodes()};b.prototype._rangeInfosChanged=function(a){null!=a&&0<a.length&&E.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};
b.prototype._objectIdFilterChange=function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(b){return a._filterNode(a._nodesAddedToStage[b])})};b.prototype._reloadAllNodes=function(){this._removeAllNodeData();this._controller&&this._controller.restartNodeLoading()};b.prototype._definitionExpressionChange=function(){this._definitionExpressionErrors=0};b.prototype._evaluateClause=function(a,b){try{return!!a.calculateValue(b)}catch(n){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&
E.error("Error while evaluating definitionExpression: "+n),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&E.error("Further errors are ignored"),!1}};b.prototype._filterNode=function(a){var b=this._getObjectIdField(),f=null;if(this.layer.objectIdFilter)var d=this.layer.objectIdFilter.ids,e="include"===this.layer.objectIdFilter.method,f=function(a){return 0<=d.indexOf(a)===e};var g=this._controller.parsedDefinitionExpression,h=0;for(a=a.bundle;h<
a.length;h++)for(var m=0,l=a[h].graphics;m<l.length;m++){var k=l[m],p=k.visible;f&&!f(k.attributes[b])?k.visible=!1:k.visible=g?this._evaluateClause(g,k):!0;p!==k.visible&&(t.graphic=k,t.property="visible",t.oldValue=p,t.newValue=k.visible,this.layer.graphicChanged(t))}};b.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};b.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};b.prototype.queryFeatures=function(a){return this._ensureQueryEngine().queryFeatures(a)};
b.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)};b.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};b.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,graphic:null},f=this;return new X(this.layer,{forAll:function(c,e){a._forAllFeatures(function(a,d,e){b.id=a;b.index=d;b.graphic=e;c(b)},e)},createGraphic:function(a){return B.hydrateGraphic(a.graphic,f.layer)},
requestFields:function(b,c,f){return w.whenGraphicAttributes(a.layer,c,a._getObjectIdField(),f,function(c){var d=a._getGraphicIndices(b.nodeId,c);return[{node:a._controller.nodeIndex[b.nodeId],indices:d,graphics:c}]},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){var b=v.empty(),c=a.layer.spatialReference;return{add:function(a){return B.expandAABB(a.graphic.geometry,b)},getExtent:function(){return v.toExtent(b,c)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};
b.prototype.getUsedMemory=function(){var a=this.graphics3d&&this.graphics3d.graphicsCore;return a?a.usedMemory:0};b.prototype.getUnloadedMemory=function(){var a=this.graphics3d&&this.graphics3d.graphicsCore;return.8*((this._controller?this._controller.unloadedMemoryEstimate:0)+(a?a.unprocessedMemoryEstimate:0))};b.prototype.ignoresMemoryFactor=function(){return this._controller&&this._controller.fixedFeatureTarget};b.prototype.getNumberOfNodes=function(){return Object.keys(this._nodesAddedToStage).length};
b.prototype.getNumberOfFeatures=function(){return this.loadedGraphics.length};b.prototype.getStats=function(){var a=this.inherited(arguments)||{};a.index=this._controller?Object.keys(this._controller.nodeIndex).length:0;a.nodes=Object.keys(this._nodesAddedToStage).length;a.features=this.loadedGraphics.length;this._controller&&this._controller.updateStats(a);return a};g([f.property()],b.prototype,"graphics3d",void 0);g([f.property()],b.prototype,"drawingOrder",void 0);g([f.property({aliasOf:"graphics3d.graphicsCore.hasDraped"})],
b.prototype,"hasDraped",void 0);g([f.property({type:Boolean})],b.prototype,"overlayUpdating",void 0);g([f.property({type:Boolean})],b.prototype,"supportsDraping",void 0);g([f.property()],b.prototype,"loadedGraphics",void 0);g([f.property()],b.prototype,"layer",void 0);g([f.property()],b.prototype,"_controller",void 0);g([f.property({dependsOn:["_controller.updating","graphics3d.updating","overlayUpdating"]})],b.prototype,"updating",void 0);g([f.property({dependsOn:["_controller.rootNodeVisible"]})],
b.prototype,"suspended",void 0);g([f.property(Y.updatingPercentage)],b.prototype,"updatingPercentage",void 0);g([f.property({aliasOf:"_controller.updatingPercentage"})],b.prototype,"updatingPercentageValue",void 0);g([f.property({type:Number,dependsOn:["graphics3d.graphicsCore.displayFeatureLimit"]})],b.prototype,"maximumNumberOfFeatures",null);g([f.property({readOnly:!0,dependsOn:["suspended","_controller.leafsReached"]})],b.prototype,"maximumNumberOfFeaturesExceeded",null);g([f.property({readOnly:!0,
aliasOf:"view.qualitySettings.sceneService.point.lodFactor"})],b.prototype,"lodFactor",void 0);return b=g([f.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],b)}(f.declared(U,Z.PopupSceneLayerView));var ea={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},da=100,y=J.create(),ca=v.create(v.POSITIVE_INFINITY),x={minX:0,minY:0,maxX:0,maxY:0},G=P.vec3f64.create(),I=[],t={graphic:null,
property:null,oldValue:null,newValue:null};return u});