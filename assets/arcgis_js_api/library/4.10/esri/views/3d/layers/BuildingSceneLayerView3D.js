// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Graphic ../../../request ../../../core/Collection ../../../core/compilerUtils ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ./BuildingComponentSublayerView3D ./BuildingGroupSublayerView3D ./LayerView3D ./i3s/I3SUtil ./support/layerViewUpdatingProperties".split(" "),function(y,z,A,p,g,l,q,k,m,h,n,f,r,
t,u,v,w){function x(e){return"string"===typeof e.fieldName&&"string"===typeof e.modelName&&Array.isArray(e.mostFrequentValues)&&Array.isArray(e.subLayerIds)&&e.subLayerIds.every(function(b){return"number"===typeof b})}return function(e){function b(){var a=null!==e&&e.apply(this,arguments)||this;a.componentLayerViews=new k;a.groupLayerViews=new k;a._componentPromises=[];a._loadingComponents=0;return a}p(b,e);Object.defineProperty(b.prototype,"updatingPercentageValue",{get:function(){var a=this.componentLayerViews,
c=this._loadingComponents,d=c+a.length;return a.reduce(function(a,c){return a+c.updatingPercentage},100*c)/d},enumerable:!0,configurable:!0});b.prototype.isUpdating=function(){return 0<this._loadingComponents||this.componentLayerViews.some(function(a){return a.updating})};b.prototype.initialize=function(){v.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode);this.initializeSubLayerViews(this.layer.sublayers,this);this.initDemolishedFilter()};b.prototype.destroy=
function(){this.groupLayerViews&&(this.groupLayerViews.forEach(function(a){return a.destroy()}),this.groupLayerViews=null);this.componentLayerViews&&(this.componentLayerViews.forEach(function(a){return a.destroy()}),this.componentLayerViews=null);this._componentPromises&&(this._componentPromises.forEach(function(a){return a.cancel()}),this._componentPromises=null)};b.prototype.initializeSubLayerViews=function(a,c){var d=this;a.forEach(function(a){if("building-group"===a.type){var b=new t({layer:a,
view:d.view,parent:c});d.groupLayerViews.push(b);d.initializeSubLayerViews(a.sublayers,b)}else d._loadingComponents++,b=a.load().then(function(){d._loadingComponents--;var b=new r({layer:a,view:d.view,parent:c});d.componentLayerViews.push(b);d.handles.add([n.init(b,"updating",function(){return d.notifyChange("updating")}),n.init(b,"updatingPercentage",function(){return d.notifyChange("updatingPercentageValue")})]);return b.when()}),d._componentPromises.push(b)})};b.prototype.getGraphicFromStageObject=
function(a,c){var b=this.componentLayerViews.find(function(b){return b.hasStageObject(a)});return b?b.getGraphicFromStageObject(a,c):h.reject()};b.prototype.fetchPopupFeatures=function(a,b){if(!b||0===b.length)return h.reject();var c=this._findComponent(b[0].sourceLayer);return m.isNone(c)?h.reject():c.fetchPopupFeatures(a,b)};b.prototype.whenGraphicBounds=function(a){var b=this._findComponent(a.sourceLayer);return m.isNone(b)?h.reject():b.whenGraphicBounds(a)};b.prototype._findComponent=function(a){return this.componentLayerViews.find(function(b){return a===
b.layer})};b.prototype.highlight=function(a,b){void 0===b&&(b={});a instanceof l?a=[a]:a instanceof k&&(a=a.toArray());var d=[];if(Array.isArray(a)&&0<a.length&&a[0]instanceof l){var c=new Map;for(b=0;b<a.length;b++){var e=a[b],f=c.get(e.sourceLayer);null==f&&(f=[],c.set(e.sourceLayer,f));f.push(e)}this.componentLayerViews.forEach(function(b){var a=c.get(b.layer);a&&d.push(b.highlight(a))})}return{remove:function(){return d.forEach(function(b){return b.remove()})}}};b.prototype.initDemolishedFilter=
function(){var b=this;q(this.layer.parsedUrl.path+"/statistics/summary",{query:{f:"json"},responseType:"json"}).then(function(a){a=a.data&&a.data.summary;if(Array.isArray(a))for(var d=0;d<a.length;d++){var c=a[d];if(null!=c&&"demolishedPhase"===c.modelName&&x(c)&&0<c.mostFrequentValues.length){b.setDemolishedFilter(c.fieldName,c.subLayerIds);break}}})};b.prototype.setDemolishedFilter=function(b,c){var a=this;h.eachAlways(this._componentPromises).then(function(){null!=a.componentLayerViews&&a.componentLayerViews.forEach(function(a){0<=
c.indexOf(a.layer.id)&&(a.demolishedFilterField=b)})})};g([f.property()],b.prototype,"layer",void 0);g([f.property()],b.prototype,"componentLayerViews",void 0);g([f.property()],b.prototype,"groupLayerViews",void 0);g([f.property(w.updatingPercentage)],b.prototype,"updatingPercentage",void 0);g([f.property({readOnly:!0})],b.prototype,"updatingPercentageValue",null);return b=g([f.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],b)}(f.declared(u))});