// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/gl-matrix ../../../../geometry/support/aaBoundingBox ../../support/geometryUtils ../../support/orientedBoundingBox ../../webgl-engine/lib/ProgramRepository ../../webgl-engine/materials/internal/MaterialUtil ../../webgl-engine/shaders/PointRendererPrograms ../../../webgl/BufferObject ../../../webgl/VertexArrayObject".split(" "),function(p,R,d,t,N,F,J,O,q,B,P){function C(b,a,c,f,d){if(c.drawScreenSpace)return c.fixedSize*a*f;d=(d?256:64)*a*f;
return c.drawFixedSize?Math.min(c.fixedSize/2,d):0<c.screenMinSize?Math.min(Math.max(c.screenMinSize*a*f,b/2),d):Math.min(b/2,d)}function L(b,a,c){null==c&&(c=d.vec3f64.create());c[0]=b.origin[0]+b.coordinates[3*a];c[1]=b.origin[1]+b.coordinates[3*a+1];c[2]=b.origin[2]+b.coordinates[3*a+2];return c}var M=d.mat4f64.create(),Q={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]};p=function(){function b(){this.didRender=
!1;this.needsRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=t.create(t.POSITIVE_INFINITY);this._programRep=null;this._needsPrograms=!0;this._programScreenDepth=this._programWorldDepth=this._programScreen=this._programWorld=null;this.tempMatrix4=d.mat4f32.create();this.tempVec3=d.vec3f32.create();this.nodes=[]}b.prototype.initializeRenderContext=function(a){this._programRep=
new J(a.rctx);this._needsPrograms=this.needsRender=!0};b.prototype.uninitializeRenderContext=function(a){this._programRep.dispose();this._programScreenDepth=this._programWorldDepth=this._programScreen=this._programWorld=this._programRep=null};b.prototype.intersect=function(a,c,f,b,e){var m=d.vec3f64.create(),g=d.vec3f64.create(),k=d.vec3f64.create(),G=d.vec3f64.create(),z=N.plane.create(),n=a.camera.perPixelRatio,H=a.camera.near,w=this._getSizeParams();d.vec3.subtract(g,b,f);var q=1/d.vec3.length(g);
d.vec3.scale(g,g,q);d.vec3.negate(k,g);d.vec4.set(z,g[0],g[1],g[2],-d.vec3.dot(g,f));var r={};e={};var p=t.create(),I=t.create(this._clipBox);t.offset(I,-f[0],-f[1],-f[2],I);for(var K=0,B=this.nodes;K<B.length;K++){var h=B[K],D=h.splatSize*this._scaleFactor,x=F.minimumDistancePlane(h.obb,z),v=F.maximumDistancePlane(h.obb,z),x=x-(w.drawScreenSpace?0:C(D,x+H,w,n,h.isLeaf)),v=v-(w.drawScreenSpace?0:C(D,v+H,w,n,h.isLeaf)),x=null!=r.dist&&null!=e.dist&&r.dist<x*q&&e.dist>v*q;if(!(0>v||x)&&(v=C(D,v+H,w,
n,h.isLeaf),F.intersectLine(h.obb,f,g,v))){v*=v;F.toAaBoundingBox(h.obb,p);t.offset(p,-f[0],-f[1],-f[2],p);x=!t.contains(I,p);d.vec3.subtract(G,h.origin,f);for(var J=h.coordinates.length/3,y=0;y<J;y++)if(m[0]=G[0]+h.coordinates[3*y],m[1]=G[1]+h.coordinates[3*y+1],m[2]=G[2]+h.coordinates[3*y+2],!x||t.containsPoint(I,m)){var u=d.vec3.dot(m,g),E=d.vec3.squaredLength(m)-u*u;if(!(E>v)){var A=u+H,l=w.drawScreenSpace?0:C(D,A,w,n,h.isLeaf);if(!(0>u-l||(A-=l,A=C(D,A,w,n,h.isLeaf),E>A*A))){E=this.layerUid+
"/"+h.id+"/"+y;u=(u-l)*q;if(null==r.dist||u<r.dist)if(l=r,null==c||c(f,b,u))l.point=L(h,y,l.point),l.dist=u,l.normal=k,l.pointId=E,l.layerUid=this.layerUid;if(null==e.dist||u>e.dist)if(l=e,null==c||c(f,b,u))l.point=L(h,y,l.point),l.dist=u,l.normal=k,l.pointId=E,l.layerUid=this.layerUid}}}}}null!=r.dist&&(f=a.minResult,null==f.dist||r.dist<f.dist)&&(c={type:"external",point:r.point,metadata:{pointId:r.pointId,layerUid:r.layerUid}},f.set(c,r.pointId,r.dist,r.normal,M,void 0),f.setIntersector("PointRenderer"));
null!=e.dist&&(a=a.maxResult,null==a.dist||e.dist>a.dist)&&(c={type:"external",point:e.point,metadata:{pointId:e.pointId,layerUid:e.layerUid}},a.set(c,e.pointId,e.dist,e.normal,M,void 0),a.setIntersector("PointRenderer"))};b.prototype.render=function(a){if(0!==a.pass&&1!==a.pass)return!1;for(var c=1===a.pass,b=a.rctx,k=0,e=this.nodes;k<e.length;k++){var m=e[k];null==m.vao&&this._initNode(a,m)}this._selectPrograms();k=this._getSizeParams();e=c?k.drawScreenSpace?this._programScreenDepth:this._programWorldDepth:
k.drawScreenSpace?this._programScreen:this._programWorld;if(null==e||0===this.nodes.length)return!0;var g=this._clipBox,q=!t.equals(g,t.POSITIVE_INFINITY,function(a,b){return a===b});q||(d.vec3.set(this.tempVec3,-Infinity,-Infinity,-Infinity),e.setUniform3fv("uClipMin",this.tempVec3),d.vec3.set(this.tempVec3,Infinity,Infinity,Infinity),e.setUniform3fv("uClipMax",this.tempVec3));b.setDepthTestEnabled(!0);b.bindProgram(e);e.setUniformMatrix4fv("uProjectionMatrix",a.camera.projectionMatrix);c&&e.setUniform2f("nearFar",
a.camera.near,a.camera.far);k.drawFixedSize&&e.setUniform2f("uPointScale",k.fixedSize,a.camera.fullHeight);for(var c=this._slicePlaneEnabled?a.sliceHelper&&a.sliceHelper.plane:null,p=0,z=this.nodes;p<z.length;p++){m=z[p];e.setUniform2f("uScreenMinMaxSize",k.screenMinSize,m.isLeaf?256:64);k.drawFixedSize||e.setUniform2f("uPointScale",m.splatSize*this._scaleFactor,a.camera.fullHeight);var n=m.origin;q&&(d.vec3.set(this.tempVec3,g[0]-n[0],g[1]-n[1],g[2]-n[2]),e.setUniform3fv("uClipMin",this.tempVec3),
d.vec3.set(this.tempVec3,g[3]-n[0],g[4]-n[1],g[5]-n[2]),e.setUniform3fv("uClipMax",this.tempVec3));d.mat4.identity(this.tempMatrix4);d.mat4.translate(this.tempMatrix4,this.tempMatrix4,n);d.mat4.multiply(this.tempMatrix4,a.camera.viewMatrix,this.tempMatrix4);e.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4);c&&O.bindSlicePlane(n,c,e);b.bindVAO(m.vao);b.drawArrays(0,0,m.coordinates.length/3)}return!0};Object.defineProperty(b.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},
set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"size",{get:function(){return this._size},set:function(a){this._size!==a&&(this._size=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"sizePx",{get:function(){return this._sizePx},
set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"clippingBox",{set:function(a){t.set(this._clipBox,a||t.POSITIVE_INFINITY)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender(),this._needsPrograms=!0)},enumerable:!0,configurable:!0});
b.prototype.addNode=function(a){this.nodes.push(a);this._requestRender()};b.prototype.removeNode=function(a){var b=null;this.nodes=this.nodes.filter(function(c){return c.id===a?(b=c,c.vao&&(c.vao.dispose(!0),c.vao=null),!1):!0});this._requestRender();return b};b.prototype.removeAll=function(){this.nodes.forEach(function(a){a.vao&&(a.vao.dispose(!0),a.vao=null)});this.nodes=[];this._requestRender()};b.prototype._initNode=function(a,b){a=a.rctx;b.vao=new P(a,q.program.attributes,Q,{positions:B.createVertex(a,
35044,b.coordinates),colors:B.createVertex(a,35044,b.rgb)})};b.prototype._requestRender=function(){this.didRender=!1;this.needsRender=!0};b.prototype._getSizeParams=function(){var a=this._useFixedSizes,b=a&&!this._useRealWorldSymbolSizes,d=b?this._sizePx:this._size,k=this._minSizePx;a&&(k=0);return{drawScreenSpace:b,drawFixedSize:a,fixedSize:d,screenMinSize:k}};b.prototype._selectPrograms=function(){this._needsPrograms&&(this._needsPrograms=!1,this._programWorld=this._programRep.getProgram(q.program,
{slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreen=this._programRep.getProgram(q.program,{drawScreenSize:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldDepth=this._programRep.getProgram(q.program,{depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenDepth=this._programRep.getProgram(q.program,{drawScreenSize:!0,depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}))};return b}();(function(b){b.isInstanceOfNode=function(a){return a.hasOwnProperty("splatSize")}})(p||
(p={}));return p});