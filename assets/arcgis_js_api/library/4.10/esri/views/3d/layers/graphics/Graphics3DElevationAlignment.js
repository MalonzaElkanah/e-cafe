// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/PooledArray ../../../../core/accessorSupport/decorators ../../../../geometry/support/aaBoundingRect".split(" "),function(w,x,r,n,t,p,m,d){var v=function(){function b(){this.extents=new p({allocator:function(a){return a||d.create()}});this.tempExtent=d.create()}Object.defineProperty(b.prototype,"count",{get:function(){return this.extents.length},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"area",{get:function(){var a=0;this.extents.forEach(function(c){return a+=d.area(c)});return a},enumerable:!0,configurable:!0});b.prototype.clear=function(){this.extents.clear()};b.prototype.add=function(a){this.contains(a)||(this.removeContained(a),d.set(this.extents.pushNew(),a))};b.prototype.pop=function(){return this.extents.pop()};b.prototype.forEach=function(a){this.extents.forEach(function(c){return a(c)})};b.prototype.mergeAll=
function(){for(;1<this.extents.length;){var a=this.extents.length-1;d.expand(this.extents.data[a-1],this.extents.data[a]);this.extents.pop()}};b.prototype.mergeTight=function(){for(var a=this.extents,c=this.tempExtent,h=!1;!h;)for(var h=!0,b=0;b<a.length;++b){for(var q=b,f=a.data[q],l=d.area(f),k=!1,g=a.length-1;g>q;--g){var e=a.data[g],u=d.area(e);d.expand(f,e,c);e=l+u;.05>(d.area(c)-e)/e&&(d.set(f,c),l=d.area(f),a.swapElements(g,a.length-1),a.pop(),k=!0)}if(k){h=!1;break}}};b.prototype.toArray=
function(){return this.extents.toArray()};b.prototype.contains=function(a){return this.extents.some(function(c){return d.contains(c,a)})};b.prototype.removeContained=function(a){for(var c=this.extents.length-1;0<=c;--c)d.contains(a,this.extents.data[c])&&(this.extents.swapElements(c,this.extents.length-1),this.extents.pop())};return b}();return function(b){function a(){var c=b.call(this)||this;c.dirtyExtents=new v;c.globalDirty=!1;c.dirtyGraphicsQueue=new p({deallocator:null});c.elevationUpdateEventHandle=
null;c.eventHandles=[];c.updateElevation=!1;c.layerView=null;c.graphicsCore=null;return c}r(a,b);Object.defineProperty(a.prototype,"updating",{get:function(){return this.hasPendingOperations()},enumerable:!0,configurable:!0});a.prototype.setup=function(c,a,b,d){var h=this;this.layerView=c;this.graphicsCore=b;this.elevationProvider=d;this.queryGraphicUIDsInExtent=a;this.elevationUpdateEventHandle=d.on("elevation-change",function(a){return h.elevationUpdateHandler(a)});this.eventHandles.push(this.layerView.watch("suspended",
function(){return h.suspendedChange()}))};a.prototype.destroy=function(){this.dirtyGraphicsQueue=null;this.elevationUpdateEventHandle&&(this.elevationUpdateEventHandle.remove(),this.elevationUpdateEventHandle=null);this.eventHandles.forEach(function(a){return a.remove()});this.queryGraphicUIDsInExtent=this.graphicsCore=this.layerView=this.eventHandles=null};a.prototype.clear=function(){this.dirtyGraphicsQueue.clear();this.notifyChange("updating")};a.prototype.suspendedChange=function(){!0===this.layerView.suspended?
this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&this.markAllGraphicsElevationDirty()};a.prototype.elevationInfoChange=function(){this.markAllGraphicsElevationDirty()};a.prototype.needsIdleUpdate=function(){return this.hasPendingOperations()};a.prototype.idleUpdate=function(a){var c=this;this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1);for(var b=this.layerView.view,d=this.graphicsCore.stageLayer.id,f=this.graphicsCore.labelsEnabled?b.labeler.labelStageLayerId:
null,l=!1;this.hasPendingOperations()&&!a.done();){for(;0<this.dirtyGraphicsQueue.length&&!a.done();){for(var k=Math.min(this.dirtyGraphicsQueue.length,100),g=0;g<k;g++){var e=this.dirtyGraphicsQueue.pop();(e=this.graphicsCore.getGraphics3DGraphicById(e))&&e.alignWithElevation(this.elevationProvider,b.renderCoordsHelper)}b._stage.processDirtyLayer(d);null!=f&&b._stage.processDirtyLayer(f)}for(;0<this.dirtyExtents.count&&100>this.dirtyGraphicsQueue.length&&!a.done();)l||(this.dirtyExtents.mergeTight(),
l=!0),k=this.dirtyExtents.pop(),this.queryGraphicUIDsInExtent(k,this.spatialReference,function(a){var b=c.graphicsCore.getGraphics3DGraphicById(a);b&&b.needsElevationUpdates()&&c.dirtyGraphicsQueue.push(a)})}b.deconflictor.setDirty();this.notifyChange("updating")};a.prototype.markAllGraphicsElevationDirty=function(){var a=this;this.dirtyExtents.clear();this.dirtyGraphicsQueue.clear();this.graphicsCore.graphics3DGraphics.forEach(function(c,b){return a.dirtyGraphicsQueue.push(b)});this.notifyChange("updating")};
a.prototype.hasPendingOperations=function(){return 0<this.dirtyGraphicsQueue.length||0<this.dirtyExtents.count||this.globalDirty};a.prototype.elevationUpdateHandler=function(a){var b=a.extent;this.layerView.suspended?this.updateElevation||(a=this.graphicsCore.computedExtent)&&b[2]>a.xmin&&b[0]<a.xmax&&b[3]>a.ymin&&b[1]<a.ymax&&(this.updateElevation=!0):(-Infinity===b[0]?this.globalDirty=!0:this.dirtyExtents.add(b),this.spatialReference=a.spatialReference,this.notifyChange("updating"))};n([m.property({readOnly:!0})],
a.prototype,"updating",null);return a=n([m.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],a)}(m.declared(t))});