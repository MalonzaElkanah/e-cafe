// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/gl-matrix ../../support/geometryUtils ../../support/stack ../../webgl-engine/lib/Selector ../../webgl-engine/lib/SelectorUtils".split(" "),function(x,y,g,k,h,m,z){Object.defineProperty(y,"__esModule",{value:!0});x=function(){function f(a,c,b){this.viewingMode=a;this.layerProvider=c;this.viewPropertyProvider=b;this.tmpSelector=new m(this.viewingMode);this.tmpRay=k.ray.create();this.externalIntersectionHandlers=new Set;this.intersectionTolerance=
m.DEFAULT_TOLERANCE;this.validateHUDSelector=new m(this.viewingMode);this.validateHUDSelector.enableHUDSelection=!1}f.prototype.intersectScreen=function(a,c,b){return this.intersectRay(this.getPickRay(a,this.tmpRay),c,b)};f.prototype.intersectScreenFreePointFallback=function(a,c,b){return this.intersectRayFreePointFallback(this.getPickRay(a,this.tmpRay),c,b)};f.prototype.intersectRay=function(a,c,b){b=this.computeIntersection(a,null,null,!1,b||this.tmpSelector);c=b?(a=b.minResult)?a.getIntersectionPoint(c):
!1:!1;return c};f.prototype.intersectRayFreePointFallback=function(a,c,b){return this.intersectRay(a,c,b)||this.intersectRayFreePointLocal(a,c)};f.prototype.intersectSelectorScreen=function(a,c,b,e){void 0===e&&(e=!1);return this.computeIntersection(this.getPickRay(a,this.tmpRay),a,b,e,c)};f.prototype.intersectToolSelectorScreen=function(a,c){var b=this.getPickRay(a,this.tmpRay),e=this.computeIntersection(b,a,null,!0,c),d=e.minResult;this.viewPropertyProvider.hasOpaqueTerrain()||d.hasIntersectionPoint&&
"TerrainRenderer"!==d.intersector||(e=this.computeIntersection(b,a,null,!1,c));return e};f.prototype.setTolerance=function(a){void 0===a&&(a=m.DEFAULT_TOLERANCE);this.intersectionTolerance=a};f.prototype.addIntersectionHandler=function(a){this.externalIntersectionHandlers.add(a)};f.prototype.removeIntersectionHandler=function(a){this.externalIntersectionHandlers.delete(a)};f.prototype.getPickRay=function(a,c){void 0===c&&(c=k.ray.create());var b=this.viewPropertyProvider.camera();return k.ray.fromScreen(b,
a,c)};f.prototype.intersectRayFreePointLocal=function(a,c){if("local"!==this.viewingMode)return!1;var b=this.viewPropertyProvider.extent(),e=Math.max(b.xmax-b.xmin,b.ymax-b.ymin,8*Math.max(b.xmax-b.xmin,b.ymax-b.ymin));if(0===e)return g.vec3.add(c,a.origin,g.vec3.normalize(h.sv3d.get(),a.direction)),!0;var d=this.viewPropertyProvider.camera(),f=Math.max(0,b.xmin-d.eye[0],d.eye[0]-b.xmax),b=Math.max(0,b.ymin-d.eye[1],d.eye[1]-b.ymax),d=e/Math.max(1,Math.pow(Math.max(0,Math.log(e/(Math.abs(d.relativeElevation)+
Number.MIN_VALUE))),2)),d=Math.max(d,Math.min(Math.sqrt(f*f+b*b),e)),e=g.vec3.scale(h.sv3d.get(),a.direction,d/g.vec3.length(a.direction));g.vec3.add(c,a.origin,e);return!0};f.prototype.computeIntersection=function(a,c,b,e,d){var f=this,n=this.viewPropertyProvider.camera(),p=h.sv3d.get();n.projectPoint(a.origin,p);c?g.vec2.copy(c,p):c=p;var q=[],r=[];this.layerProvider.forEachLayer(function(a){a.isPickable&&(a.isSliceable?r:q).push(a)});b&&(q=q.filter(function(a){return b.has(a.id)}),r=r.filter(function(a){return b.has(a.id)}));
d=d||new m(this.viewingMode);var k=a.origin,w=g.vec3.add(h.sv3d.get(),a.origin,a.direction);d.init(q,k,w,c,n,this.intersectionTolerance,e,null);var u=(a=this.viewPropertyProvider.slicePlane())?z.sliceFilterPredicate(a):null;d.run(r,k,w,c,n,this.intersectionTolerance,e,u);this.externalIntersectionHandlers.forEach(function(a){a.intersect(d,a.slicePlaneEnabled?u:null,k,w,c)});if(d.hudResults.length){a=d.hudResults;a.sort(function(a,b){return b.dist-a.dist});a=a[a.length-1];var v=h.sv3d.get(),l=h.sv3d.get(),
t=h.sv3d.get();this.unprojectHUDResultHit(a.center,v,l,t);p=g.vec3.distance(a.center,l)/g.vec3.distance(l,t)*.99;this.validateHUDSelector.init(q,l,t,v,n,this.intersectionTolerance,e,null);this.validateHUDSelector.run(r,l,t,v,n,this.intersectionTolerance,e,u);this.externalIntersectionHandlers.forEach(function(a){a.intersect(f.validateHUDSelector,a.slicePlaneEnabled?u:null,l,t,v)});e=this.validateHUDSelector.minResult;(null==e.dist||p<=e.dist)&&d.minResult.copyFrom(a)}return d};f.prototype.unprojectHUDResultHit=
function(a,c,b,e){var d=this.viewPropertyProvider.camera();d.projectPoint(a,c);c[0]=Math.round(c[0]);c[1]=Math.round(c[1]);a=h.sv3d.get();a[0]=c[0];a[1]=c[1];a[2]=0;d.unprojectPoint(a,b);a[2]=1;d.unprojectPoint(a,e)};return f}();y.SceneIntersectionHelper=x});