// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/gl-matrix ../../support/debugFlags ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ./glUtil3D ./Util ../shaders/HighlightPrograms ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),function(A,B,p,q,u,v,w,x,m,y,r,n,z){return function(){function h(b,f){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,
viewportWidth:0,viewportHeight:0};this.blur1Fbo=this.blur0Fbo=this.quadVAO=null;this._rctx=f;this.viewportToRestore=p.vec4f64.create();this.defaultOptions={color:p.vec4f32.fromValues(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05};this.blurProgram=b.getProgram(m.blurPass,{gaussianSamples:5});this.blurGridProgram=b.getProgram(m.blurPass,{gaussianSamples:5,gridOptimization:!0});this.applyProgram=b.getProgram(m.applyPass);this.applyGridProgram=b.getProgram(m.applyPass,
{gridOptimization:!0});this.applyGridDebugProgram=b.getProgram(m.applyPass,{gridOptimization:!0,gridDebug:!0});this.downsampleProgram=b.getProgram(m.downsamplePass)}Object.defineProperty(h.prototype,"enabled",{get:function(){return null!==this.blur0Fbo},set:function(b){b?this.enable():this.disable()},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"profilingCallback",{get:function(){return q.HIGHLIGHTS_PROFILE_TO_CONSOLE?function(b){return console.log(b)}:null},enumerable:!0,configurable:!0});
h.prototype.setDefaultOptions=function(b){this.defaultOptions=b};h.prototype.render=function(b,f){var t=!q.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,d=q.HIGHLIGHTS_VISUALIZE_BLOCKS,c=b.camera,k=b.fbo,a=this._rctx;x.assert(this.enabled);p.vec4.copy(this.viewportToRestore,c.fullViewport);var g=Math.ceil(f.width/1),l=Math.ceil(f.height/1);this.blur0Fbo.resize(g,l);this.blur1Fbo.resize(g,l);a.bindVAO(this.quadVAO);a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);a.setBlendingEnabled(!1);var e=null,h=
c=e=null;if(t){var m=this._grid;this._gridUpdateResources(f,32);this._gridComputeMipmap();c=m.vao;h=4;e=this.blurGridProgram;a.bindProgram(e);a.bindTexture(m.coverageMipmap[m.mipmapLevels].colorTexture,1);e.setUniform1i("coverageTex",1)}else c=this.quadVAO,h=5,e=this.blurProgram,a.bindProgram(e);a.bindVAO(c);a.bindFramebuffer(this.blur0Fbo);a.setViewport(0,0,g,l);a.setClearColor(0,0,0,0);a.clear(a.gl.COLOR_BUFFER_BIT);e.setUniform1i("tex",0);a.bindTexture(f.colorTexture,0);e.setUniform2f("blurSize",
1/g,0);a.drawArrays(h,0,n.vertexCount(c,"geometry"));a.bindFramebuffer(this.blur1Fbo);a.clear(a.gl.COLOR_BUFFER_BIT);a.bindTexture(this.blur0Fbo.colorTexture,0);e.setUniform2f("blurSize",0,1/l);a.drawArrays(h,0,n.vertexCount(c,"geometry"));a.bindFramebuffer(k);a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(770,771,1,771);a.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]);t?(e=d?this.applyGridDebugProgram:this.applyGridProgram,
a.bindProgram(e),e.setUniform1i("coverageTex",2),a.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,2)):(e=this.applyProgram,a.bindProgram(e));e.setUniform1i("tex",0);a.bindTexture(this.blur1Fbo.colorTexture,0);e.setUniform1i("origin",1);a.bindTexture(f.colorTexture,1);b=b.pixelRatio||1;e.setUniform4fv("color",this.defaultOptions.color);e.setUniform1f("outlineSize",8.6*b);e.setUniform1f("blurSize",.4*b);e.setUniform4f("opacities",this.defaultOptions.haloOpacity,this.defaultOptions.haloOpacityOccluded,
this.defaultOptions.fillOpacity,this.defaultOptions.fillOpacityOccluded);a.drawArrays(h,0,n.vertexCount(c,"geometry"));a.bindVAO(null);a.setDepthWriteEnabled(!0);a.setDepthTestEnabled(!0);a.setBlendingEnabled(!1)};h.prototype.enable=function(){if(!this.enabled){this.quadVAO=w.createQuadVAO(this._rctx);var b={colorTarget:0,depthStencilTarget:0,width:0,height:0},f={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=r.createWithAttachments(this._rctx,
f,b);this.blur1Fbo=r.createWithAttachments(this._rctx,f,b)}};h.prototype.disable=function(){this.enabled&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.blur1Fbo=this.blur0Fbo=this.quadVAO=null)};h.prototype._gridUpdateResources=function(b,f){var h=this._rctx,d=this._grid,c=!1;null===d.coverageMipmap&&(d.coverageMipmap=[b],c=!0);if(d.viewportWidth!==b.width||d.viewportHeight!==b.height)c=!0,d.viewportWidth=b.width,d.viewportHeight=b.height;d.coverageMipmap[0]=b;d.cellPixelSize!==
f&&(d.cellPixelSize=f,c=!0);if(c){for(f=1;f<d.coverageMipmap.length;f++)d.coverageMipmap[f].dispose();d.mipmapLevels=Math.ceil(Math.log(d.cellPixelSize)*Math.LOG2E);d.coverageMipmap.length=d.mipmapLevels+1;for(f=0;f<d.mipmapLevels;f++)c=d.coverageMipmap[f],c=r.createWithAttachments(h,{target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)},{colorTarget:0,depthStencilTarget:0,width:Math.ceil(c.width/2),height:Math.ceil(c.height/
2)}),d.coverageMipmap[f+1]=c}var c=Math.ceil(b.height/d.cellPixelSize),k=Math.ceil(b.width/d.cellPixelSize);if(!d.vao||d.verticalCellCount!==c||d.horizontalCellCount!==k){d.verticalCellCount=c;d.horizontalCellCount=k;b=c+1;f=k+1;for(var c=1/c,k=1/k,a=new Float32Array(24*b*f),g=0,l=0;l<b;l++)for(var e=0;e<f;e++)a[g+0]=(e-.5)*k*2-1,a[g+1]=(l-.5)*c*2-1,a[g+2]=e*k,a[g+3]=l*c,a[g+4]=(e+.5)*k*2-1,a[g+5]=(l-.5)*c*2-1,a[g+6]=e*k,a[g+7]=l*c,a[g+8]=(e-.5)*k*2-1,a[g+9]=(l+.5)*c*2-1,a[g+10]=e*k,a[g+11]=l*c,a[g+
12]=(e-.5)*k*2-1,a[g+13]=(l+.5)*c*2-1,a[g+14]=e*k,a[g+15]=l*c,a[g+16]=(e+.5)*k*2-1,a[g+17]=(l-.5)*c*2-1,a[g+18]=e*k,a[g+19]=l*c,a[g+20]=(e+.5)*k*2-1,a[g+21]=(l+.5)*c*2-1,a[g+22]=e*k,a[g+23]=l*c,g+=24;d.vao&&d.vao.dispose(!0);d.vao=new z(h,u.Default3D,{geometry:v.Pos2Tex},{geometry:y.createVertex(h,35044,a)})}};h.prototype._gridComputeMipmap=function(){var b=this._rctx,f=this._grid,h=this.downsampleProgram;b.bindVAO(this.quadVAO);for(var d=0;d<f.mipmapLevels;d++){b.bindFramebuffer(f.coverageMipmap[d+
1]);b.bindTexture(f.coverageMipmap[d].colorTexture,0);var c=f.coverageMipmap[d+1].width,k=f.coverageMipmap[d+1].height;b.bindProgram(h);h.setUniform1i("tex",0);h.setUniform2f("invFramebufferDim",1/c,1/k);b.setViewport(0,0,c,k);b.drawArrays(5,0,n.vertexCount(this.quadVAO,"geometry"))}};return h}()});