// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/gl-matrix ../../support/mathUtils ./Camera ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ./glUtil3D ./Util ../shaders/MiscPrograms ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),function(Q,D,a,R,ha,ia,ja,ka,n,la,ma,na,oa,S,pa){function t(b,f){a.vec2.set(T,b[f],b[f+3]);return T}var qa=function(){return function(){this.camera=
new ha;this.lightMat=a.mat4f64.create()}}();Q=function(){function e(a,b){this.doShadowMapMipmapsWork=!1;this.textureRes=4096;this.numCascades=1;this.maxNumCascades=2;this.cascadeDistances=[0,0,0,0,0];this.cascades=[];this.programRep=a;this.rctx=b;this.emptyTexture=ka.createEmptyTexture(b);for(a=0;4>a;++a)this.cascades.push(new qa)}e.prototype.dispose=function(){this.emptyTexture.dispose();this.emptyTexture=null};Object.defineProperty(e.prototype,"textureResolution",{get:function(){return this.textureRes},
set:function(a){this.textureRes=a},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"maxCascades",{get:function(){return this.maxNumCascades},set:function(a){this.maxNumCascades=R.clamp(Math.floor(a),1,4)},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"enabled",{get:function(){return!!this.depthTexture},set:function(a){a?this.enable():this.disable()},enumerable:!0,configurable:!0});e.prototype.getDepthTexture=function(){return this.depthTexture};e.prototype.getCascades=
function(){for(var a=0;a<this.numCascades;++a)P[a]=this.cascades[a];P.length=this.numCascades;return P};e.prototype.prepare=function(f,u,G,l){n.assert(this.enabled);a.mat4.multiply(U,f.projectionMatrix,f.viewMatrix);var c=l.near,p=l.far;2>c&&(c=2);2>p&&(p=2);c>=p&&(c=2,p=4);this.numCascades=Math.min(1+Math.floor(n.logWithBase(p/c,4)),this.maxNumCascades);G=Math.pow(p/c,1/this.numCascades);for(l=0;l<this.numCascades+1;++l)this.cascadeDistances[l]=c*Math.pow(G,l);a.mat4.invert(V,U);a.mat4.lookAt(W,
[0,0,0],[-u[0],-u[1],-u[2]],[0,1,0]);G=f.viewMatrix;f=f.projectionMatrix;for(l=0;l<this.numCascades;++l){var e=this.cascades[l],p=-this.cascadeDistances[l],c=-this.cascadeDistances[l+1],p=(f[10]*p+f[14])/Math.abs(f[11]*p+f[15]),c=(f[10]*c+f[14])/Math.abs(f[11]*c+f[15]);n.assert(p<c);for(var d=0;8>d;++d){a.vec4.set(X,0===d%4||3===d%4?-1:1,0===d%4||1===d%4?-1:1,4>d?p:c,1);a.vec4.transformMat4(q[d],X,V);for(var g=0;3>g;++g)q[d][g]/=q[d][3]}a.vec3.negate(Y,q[0]);a.mat4.translate(Z,W,Y);e.camera.viewMatrix=
Z;for(d=0;8>d;++d)a.vec3.transformMat4(q[d],q[d],e.camera.viewMatrix);a.vec3.copy(z,q[0]);a.vec3.copy(A,q[0]);for(d=1;8>d;++d)for(g=0;3>g;++g)z[g]=Math.min(z[g],q[d][g]),A[g]=Math.max(A[g],q[d][g]);z[2]-=200;A[2]+=200;e.camera.near=-A[2];e.camera.far=-z[2];c=1/q[0][3];p=1/q[4][3];n.assert(c<p);var g=c+Math.sqrt(c*p),d=Math.sin(R.acos(G[2]*u[0]+G[6]*u[1]+G[10]*u[2])),g=g/d,c=q,L=g,E=d,d=aa,v=ba,k=ra,x=ca,g=da;a.vec2.set(w,0,0);for(var h=0;4>h;++h)a.vec2.add(w,w,c[h]);a.vec2.scale(w,w,.25);a.vec2.set(H,
0,0);for(h=4;8>h;++h)a.vec2.add(H,H,c[h]);a.vec2.scale(H,H,.25);a.vec2.lerp(F[0],c[4],c[5],.5);a.vec2.lerp(F[1],c[5],c[6],.5);a.vec2.lerp(F[2],c[6],c[7],.5);a.vec2.lerp(F[3],c[7],c[4],.5);for(var B=0,y=a.vec2.squaredDistance(F[0],w),h=1;4>h;++h){var I=a.vec2.squaredDistance(F[h],w);I<y&&(y=I,B=h)}a.vec2.subtract(m,F[B],c[B+4]);h=m[0];m[0]=-m[1];m[1]=h;a.vec2.subtract(ea,H,w);a.vec2.lerp(m,m,ea,E);a.vec2.normalize(m,m);B=E=void 0;E=B=a.vec2.dot(a.vec2.subtract(C,c[0],w),m);for(h=1;8>h;++h)y=a.vec2.dot(a.vec2.subtract(C,
c[h],w),m),y<E?E=y:y>B&&(B=y);a.vec2.copy(d,w);a.vec2.scale(C,m,E-L);a.vec2.add(d,d,C);for(var I=-1,D=1,h=L=y=0;8>h;++h){a.vec2.subtract(M,c[h],d);a.vec2.normalize(M,M);var N=m[0]*M[1]-m[1]*M[0];0<N?N>I&&(I=N,y=h):N<D&&(D=N,L=h)}n.verify(0<I,"leftArea");n.verify(0>D,"rightArea");a.vec2.scale(J,m,E);a.vec2.add(J,J,w);a.vec2.scale(K,m,B);a.vec2.add(K,K,w);O[0]=-m[1];O[1]=m[0];v=n.rayRay2D(d,c[L],K,a.vec2.add(C,K,O),1,v);k=n.rayRay2D(d,c[y],K,C,1,k);x=n.rayRay2D(d,c[y],J,a.vec2.add(C,J,O),1,x);c=n.rayRay2D(d,
c[L],J,C,1,g);n.verify(v,"rayRay");n.verify(k,"rayRay");n.verify(x,"rayRay");n.verify(c,"rayRay");k=aa;c=ba;d=ca;x=da;g=e.camera.projectionMatrix;a.vec2.subtract(r,d,x);a.vec2.scale(r,r,.5);b[0]=r[0];b[1]=r[1];b[2]=0;b[3]=r[1];b[4]=-r[0];b[5]=0;b[6]=r[0]*r[0]+r[1]*r[1];b[7]=r[0]*r[1]-r[1]*r[0];b[8]=1;b[6]=-a.vec2.dot(t(b,0),k);b[7]=-a.vec2.dot(t(b,1),k);k=a.vec2.dot(t(b,0),d)+b[6];v=a.vec2.dot(t(b,1),d)+b[7];h=a.vec2.dot(t(b,0),x)+b[6];x=a.vec2.dot(t(b,1),x)+b[7];k=-(k+h)/(v+x);b[0]+=b[1]*k;b[3]+=
b[4]*k;b[6]+=b[7]*k;k=1/(a.vec2.dot(t(b,0),d)+b[6]);v=1/(a.vec2.dot(t(b,1),d)+b[7]);b[0]*=k;b[3]*=k;b[6]*=k;b[1]*=v;b[4]*=v;b[7]*=v;b[2]=b[1];b[5]=b[4];b[8]=b[7];b[7]+=1;k=a.vec2.dot(t(b,1),c)+b[7];v=a.vec2.dot(t(b,2),c)+b[8];h=a.vec2.dot(t(b,1),d)+b[7];x=a.vec2.dot(t(b,2),d)+b[8];k=-.5*(k/v+h/x);b[1]+=b[2]*k;b[4]+=b[5]*k;b[7]+=b[8]*k;k=a.vec2.dot(t(b,1),c)+b[7];v=a.vec2.dot(t(b,2),c)+b[8];h=-v/k;b[1]*=h;b[4]*=h;b[7]*=h;g[0]=b[0];g[1]=b[1];g[2]=0;g[3]=b[2];g[4]=b[3];g[5]=b[4];g[6]=0;g[7]=b[5];g[8]=
0;g[9]=0;g[10]=1;g[11]=0;g[12]=b[6];g[13]=b[7];g[14]=0;g[15]=b[8];e.camera.projectionMatrix[10]=2/(z[2]-A[2]);e.camera.projectionMatrix[14]=-(z[2]+A[2])/(z[2]-A[2]);a.mat4.multiply(e.lightMat,e.camera.projectionMatrix,e.camera.viewMatrix);c=this.textureRes/2;e.camera.viewport[0]=0===l%2?0:c;e.camera.viewport[1]=0===Math.floor(l/2)?0:c;e.camera.viewport[2]=c;e.camera.viewport[3]=c}this.lastOrigin=null;this.cascadeDistances[this.numCascades]=100*p;u=this.rctx;l=u.gl;u.bindFramebuffer(this.fbo);u.bindTexture(null,
7);u.setClearColor(1,1,1,1);u.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT);u.setBlendingEnabled(!1)};e.prototype.finish=function(a){n.assert(this.enabled);this.rctx.bindFramebuffer(a);this.doShadowMapMipmapsWork&&this.depthTexture.generateMipmap()};e.prototype.bind=function(a){var b=this.rctx,f=this.enabled;b.bindTexture(f?this.depthTexture:this.emptyTexture,7);b.bindProgram(a);a.setUniform1i("depthTex",7);a.setUniform1f("depthHalfPixelSz",f?.5/this.textureRes:-1);a.setUniform1i("shadowMapNum",this.numCascades);
a.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.cascadeDistances[1],this.cascadeDistances[2],this.cascadeDistances[3])};e.prototype.bindAll=function(a){a=a.getProgramsUsingUniform("shadowMapDistance");for(var b=0;b<a.length;b++)this.bind(a[b])};e.prototype.bindView=function(b,e){if(this.enabled){var f=this.lastOrigin;if(!f||f[0]!==e[0]||f[1]!==e[1]||f[2]!==e[2])for(this.lastOrigin=this.lastOrigin||a.vec3f64.create(),a.vec3.copy(this.lastOrigin,e),f=0;f<this.numCascades;++f){a.mat4.translate(fa,
this.cascades[f].lightMat,e);for(var l=0;16>l;++l)ga[16*f+l]=fa[l]}b.setUniformMatrix4fv("shadowMapMatrix",ga)}};e.prototype.drawDebugQuad=function(a){n.assert(this.enabled);var b=this.rctx,e=b.gl;if(!this.debugQuadVAO){var f=new Float32Array([0,0,0,0,256,0,1,0,0,256,0,1,256,256,1,1]);this.debugQuadVAO=new pa(b,ia.Default3D,{geometry:ja.Pos2Tex},{geometry:ma.createVertex(b,e.STATIC_DRAW,f)})}var f=this.programRep.getProgram(la.showDepth),c=this.debugQuadVAO;b.setDepthTestEnabled(!1);b.bindProgram(f);
f.setUniformMatrix4fv("proj",a);f.setUniform1i("depthTex",0);b.bindTexture(this.depthTexture,0);b.bindVAO(c);S.assertCompatibleVertexAttributeLocations(c,f);b.drawArrays(e.TRIANGLE_STRIP,0,S.vertexCount(c,"geometry"));b.setDepthTestEnabled(!0)};e.prototype.enable=function(){if(!this.enabled){var a=this.rctx.gl;this.depthTexture=new oa(this.rctx,{target:a.TEXTURE_2D,pixelFormat:a.RGBA,dataType:a.UNSIGNED_BYTE,wrapMode:a.CLAMP_TO_EDGE,samplingMode:a.NEAREST,flipped:!0,width:this.textureRes,height:this.textureRes});
this.fbo=na.createWithAttachments(this.rctx,this.depthTexture,{colorTarget:0,depthStencilTarget:1,width:this.textureRes,height:this.textureRes})}};e.prototype.disable=function(){this.enabled&&this.fbo&&(this.fbo.dispose(),this.depthTexture=this.fbo=null)};return e}();var Z=a.mat4f64.create(),U=a.mat4f64.create(),V=a.mat4f64.create(),X=a.vec4f64.create(),q=[];for(D=0;8>D;++D)q.push(a.vec4f64.create());var z=a.vec3f64.create(),A=a.vec3f64.create(),aa=a.vec2f64.create(),ba=a.vec2f64.create(),ra=a.vec2f64.create(),
ca=a.vec2f64.create(),da=a.vec2f64.create(),W=a.mat4f64.create(),Y=a.vec3f64.create(),P=[],fa=a.mat4f64.create(),ga=new Float32Array(64),w=a.vec2f64.create(),H=a.vec2f64.create(),F=[a.vec2f64.create(),a.vec2f64.create(),a.vec2f64.create(),a.vec2f64.create()],m=a.vec2f64.create(),ea=a.vec2f64.create(),C=a.vec2f64.create(),M=a.vec2f64.create(),J=a.vec2f64.create(),K=a.vec2f64.create(),O=a.vec2f64.create(),T=a.vec2f64.create(),r=a.vec2f64.create(),b=a.mat3f64.create();return Q});