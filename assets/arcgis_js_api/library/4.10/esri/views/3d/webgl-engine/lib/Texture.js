// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Logger ../../../../core/libs/gl-matrix-2/gl-matrix ../../support/imageUtils ../../support/mathUtils ../../support/buffer/typedArrayUtil ./DDSUtil ./DefaultVertexBufferLayouts ./glUtil3D ./IdGen ./Util ../shaders/MiscPrograms ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),function(D,E,m,t,u,k,h,q,v,w,x,n,y,z,l,A){function B(c,a,b,e,f,g,d){d=!1!==d;u.requestImage(a).then(function(a){n.assert(1<=a.width&&1<=a.height);b.samplingMode=
d?9987:9729;b.hasMipmap=d;!d&&33071===b.wrapMode||k.isPowerOfTwo(a.width)&&k.isPowerOfTwo(a.height)?(b.width=a.width,b.height=a.height,a=new l(c,b,a)):a=r(c,a,b,e,f);c.bindTexture(a);g(a)}).catch(function(b){var c=200<a.length?a.slice(0,100)+"..."+a.slice(a.length-100):a;C.error("Failed to load image from uri",c,b);g(null)})}function r(c,a,b,e,f){var g=k.nextHighestPowerOfTwo(a.width),d=k.nextHighestPowerOfTwo(a.height);n.assert(g!==a.width||d!==a.height);b.width=g;b.height=d;var h=new l(c,b),p=z.createWithAttachments(c,
h,{colorTarget:0,depthStencilTarget:0});a=new l(c,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!!b.flipped,maxAnisotropy:8,preMultiplyAlpha:b.preMultiplyAlpha},a);c.bindFramebuffer(p);void 0===f&&(f=c.getViewport(),f=[f.x,f.y,f.width,f.height]);c.setViewport(0,0,g,d);e=e.getProgram(y.texOnly);g=t.mat4f64.create();c.bindProgram(e);e.setUniformMatrix4fv("model",g);e.setUniformMatrix4fv("view",g);e.setUniformMatrix4fv("proj",g);e.setUniform4f("color",1,1,1,1);
e.setUniform1i("tex",0);e=w.createQuadVAO(c,v.Pos3Tex);c.bindTexture(a,0);c.bindVAO(e);c.setDepthTestEnabled(!1);c.setBlendingEnabled(!1);c.drawArrays(5,0,A.vertexCount(e,"geometry"));c.setDepthTestEnabled(!0);c.bindFramebuffer(null);c.setViewport(f[0],f[1],f[2],f[3]);e.dispose(!0);a.dispose();c.bindFramebuffer(null);p.detachColorTexture();p.dispose();b.hasMipmap&&h.generateMipmap();return h}var C=m.getLogger("esri.views.3d.webgl-engine.lib.Texture");return function(){function c(a,b,e){this.data=
a;this.id=c.idGen.gen(b);this.unloadFunc=void 0;this.params=e||{};this.params.mipmap=!1!==this.params.mipmap;this.params.noUnpackFlip=this.params.noUnpackFlip||!1;this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1;this.params.wrap=this.params.wrap||{s:10497,t:10497};this.estimatedTexMemRequired=c.estimateTexMemRequired(this.data,this.params)}c.estimateTexMemRequired=function(a,b){return null==a?0:h.isArrayBuffer(a)||h.isUint8Array(a)?a.byteLength:a instanceof Image||a instanceof ImageData||
a instanceof HTMLCanvasElement?(b.mipmap?4/3:1)*a.width*a.height*4:(b.mipmap?4/3:1)*b.width*b.height*4||0};c.prototype.getEstimatedTexMemRequired=function(){return this.estimatedTexMemRequired};c.prototype.dispose=function(){this.data=void 0};c.prototype.deferredLoading=function(){return"string"===typeof this.data};c.prototype.getWidth=function(){return this.params.width};c.prototype.getHeight=function(){return this.params.height};c.prototype.initializeThroughUpload=function(a,b,e,f,g){var d=this.data;
b.flipped=!this.params.noUnpackFlip;b.samplingMode=this.params.mipmap?9987:9729;b.hasMipmap=this.params.mipmap;b.wrapMode=this.params.wrap;b.preMultiplyAlpha=this.params.preMultiplyAlpha;if("string"===typeof d)B(a,d,b,e,f,g,this.params.mipmap);else{if(d instanceof Image||d instanceof ImageData||d instanceof HTMLCanvasElement){this.params.width=d.width;this.params.height=d.height;var m=33071===this.params.wrap.s&&33071===this.params.wrap.t;!this.params.mipmap&&m||k.isPowerOfTwo(d.width)&&k.isPowerOfTwo(d.height)?
(b.width=d.width,b.height=d.height,b=new l(a,b,d)):b=r(a,d,b,e,f)}else if(h.isArrayBuffer(d)&&this.params.encoding===c.DDS_ENCODING)b=q.createDDSTexture(a,b,d,this.params.mipmap);else if(h.isUint8Array(d)&&this.params.encoding===c.DDS_ENCODING)b=q.createDDSTexture(a,b,d.buffer,this.params.mipmap);else if(h.isUint8Array(d))n.assert(0<this.params.width&&0<this.params.height),b.pixelFormat=1===this.params.components?6409:6408,b.width=this.params.width,b.height=this.params.height,b=new l(a,b,d);else{if(null!==
d)throw console.warn("Unsupported image data"),Error("Unsupported image data");b=new l(a,b,null)}a.bindTexture(b);g(b)}this.data=void 0};c.prototype.setUnloadFunc=function(a){this.unloadFunc=a};c.prototype.unload=function(){void 0!==this.unloadFunc&&(this.unloadFunc(this.id),this.unloadFunc=void 0)};c.createEmpty=function(a){void 0===a&&(a="emptyTexture");return new c(new Uint8Array([0,0,0,0]),a,{width:1,height:1,wrap:{s:33071,t:33071}})};c.idGen=new x;c.DDS_ENCODING="image/vnd-ms.dds";return c}()});