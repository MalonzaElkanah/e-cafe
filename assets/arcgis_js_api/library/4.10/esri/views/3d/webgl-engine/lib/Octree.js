// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/PooledArray ../../../../core/libs/gl-matrix-2/gl-matrix ../../support/geometryUtils ./Util".split(" "),function(D,P,A,f,x,L){function E(c,a,b){b=b||c;b[0]=c[0]+a;b[1]=c[1]+a;b[2]=c[2]+a;return b}function z(c,a,b){return!x.frustum.intersectsSphere(b,x.sphere.wrap(a,c))}function M(c,a,b){if(!r.length)for(var d=0;8>d;++d)r[d]={index:0,distance:0};for(d=0;8>d;++d){var e=F[d];r[d].index=d;r[d].distance=t(c,a,e)}r.sort(function(a,b){return a.distance-b.distance});
for(d=0;8>d;++d)b[d]=r[d].index;return b}function B(c,a){for(var b=Infinity,d=null,e=0;8>e;++e){var q=t(c,a,G[e]);q<b&&(b=q,d=G[e])}return d}function t(c,a,b){return a*(c[0]*b[0]+c[1]*b[1]+c[2]*b[2])}D=function(){function c(a,b,d,e){this._maximumObjectsPerNode=10;this._maximumDepth=20;this._degenerateObjects=new Set;this._objectCount=0;this._objectToBoundingSphere=d;e&&(void 0!==e.maximumObjectsPerNode&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),void 0!==e.maximumDepth&&(this._maximumDepth=
e.maximumDepth));isNaN(a[0])||isNaN(a[1])||isNaN(a[2])||isNaN(b)?this._root=new g(null,f.vec3f64.fromValues(0,0,0),.5):this._root=new g(null,a,b/2)}Object.defineProperty(c.prototype,"center",{get:function(){return this._root.center},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"size",{get:function(){return 2*this._root.halfSize},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"root",{get:function(){return this._root.node},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"maximumObjectsPerNode",{get:function(){return this._maximumObjectsPerNode},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"maximumDepth",{get:function(){return this._maximumDepth},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"objectCount",{get:function(){return this._objectCount},enumerable:!0,configurable:!0});c.prototype.add=function(a,b){a=this._objectOrObjectsArray(a);b=null==b?a.length:b;this._objectCount+=b;this._grow(a);for(var d=g.acquire(),e=0;e<b;e++){var c=
a[e];d.init(this._root);this._isDegenerate(c)?this._degenerateObjects.add(c):this._add(c,d)}g.release(d)};c.prototype.remove=function(a,b){a=this._objectOrObjectsArray(a);this._objectCount-=a.length;for(var d=g.acquire(),e=0;e<a.length;e++){var c=a[e],h=b||this._boundingSphereFromObject(c,H);this._isValidRadius(h.radius)?(d.init(this._root),this._remove(c,h,d)):this._degenerateObjects.delete(c)}g.release(d);this._shrink()};c.prototype.update=function(a,b){if(this._isValidRadius(b.radius)||!this._isDegenerate(a))this.remove(a,
b),this.add(a)};c.prototype.forEachAlongRay=function(a,b,d){var e=this;this._forEachNode(this._root,function(c){if(!e._intersectsNode(a,b,c))return!1;c=c.node;c.terminals.forEach(function(c){e._intersectsObject(a,b,c)&&d(c)});null!==c.residents&&c.residents.forEach(function(c){e._intersectsObject(a,b,c)&&d(c)});return!0})};c.prototype.forEach=function(a){this._forEachNode(this._root,function(b){b=b.node;b.terminals.forEach(a);null!==b.residents&&b.residents.forEach(a);return!0});this._degenerateObjects.forEach(a)};
c.prototype.forEachDegenerateObject=function(a){this._degenerateObjects.forEach(a)};c.prototype.findClosest=function(a,b,d,e,c){return this._findClosest(a,"front-to-back"===b?u.FRONT_TO_BACK:u.BACK_TO_FRONT,d,e,c)};c.prototype.forEachInDepthRange=function(a,b,d,e,c,f,k,n){this._forEachInDepthRange(a,b,"front-to-back"===d?u.FRONT_TO_BACK:u.BACK_TO_FRONT,e,c,f,k,n)};c.prototype.forEachNode=function(a){this._forEachNode(this._root,function(b){return a(b.node,b.center,2*b.halfSize)})};c.prototype._intersectsNode=
function(a,b,d){E(d.center,2*-d.halfSize,m);E(d.center,2*d.halfSize,l);return L.rayBoxTest(a,b,m,l)};c.prototype._intersectsObject=function(a,b,d){var e=this._objectToBoundingSphere.getRadius(d);return 0<e?x.sphere.intersectsRay(x.sphere.wrap(e,this._objectToBoundingSphere.getCenter(d)),x.ray.wrap(a,b)):!0};c.prototype._forEachNode=function(a,b){a=g.acquire().init(a);for(var d=[a];0!==d.length;){a=d.pop();if(b(a)&&!a.isLeaf())for(var e=0;e<a.node.children.length;e++)a.node.children[e]&&d.push(g.acquire().init(a).advance(e));
g.release(a)}};c.prototype._forEachNodeDepthOrdered=function(a,b,d,e){void 0===e&&(e=u.FRONT_TO_BACK);a=g.acquire().init(a);var c=[a];for(d=M(d,e,N);0!==c.length;){a=c.pop();if(b(a)&&!a.isLeaf())for(e=7;0<=e;--e){var f=d[e];f>=a.node.children.length||a.node.children[f]&&c.push(g.acquire().init(a).advance(f))}g.release(a)}};c.prototype._findClosest=function(a,b,d,e,c){var h=this,k=Infinity,n=Infinity,g=null,q=B(a,b),m=0,l=function(c){++m;if(!e||e(c)){var f=h._objectToBoundingSphere.getCenter(c),q=
h._objectToBoundingSphere.getRadius(c);if(!d||!z(f,q,d)){var f=t(a,b,f),l=f-q;l<k&&(k=l,n=f+q,g=c)}}};this._forEachNodeDepthOrdered(this._root,function(e){if(null!=c&&m>=c||d&&z(e.center,e.halfSize*I,d))return!1;f.vec3.scale(p,q,e.halfSize);f.vec3.add(p,p,e.center);if(t(a,b,p)>n)return!1;e=e.node;e.terminals.forEach(function(a){l(a)});null!==e.residents&&e.residents.forEach(function(a){l(a)});return!0},a,b);return g};c.prototype._forEachInDepthRange=function(a,b,d,e,c,h,k,g){var q=this,n=-Infinity,
l=Infinity,m={setRange:function(a){d===u.FRONT_TO_BACK?(n=Math.max(n,a.near),l=Math.min(l,a.far)):(n=Math.max(n,-a.far),l=Math.min(l,-a.near))}};m.setRange(e);var r=t(b,d,a),w=B(b,d),x=B(b,-1*d),v=0,y=function(a){++v;if(!k||k(a)){var e=q._objectToBoundingSphere.getCenter(a),f=q._objectToBoundingSphere.getRadius(a),g=t(b,d,e)-r;g-f>l||g+f<n||h&&z(e,f,h)||c(a,m)}};this._forEachNodeDepthOrdered(this._root,function(a){if(null!=g&&v>=g||h&&z(a.center,a.halfSize*I,h))return!1;f.vec3.scale(p,w,a.halfSize);
f.vec3.add(p,p,a.center);if(t(b,d,p)-r>l)return!1;f.vec3.scale(p,x,a.halfSize);f.vec3.add(p,p,a.center);if(t(b,d,p)-r<n)return!1;a=a.node;a.terminals.forEach(function(a){y(a)});null!==a.residents&&a.residents.forEach(function(a){y(a)});return!0},b,d)};c.prototype._objectOrObjectsArray=function(a){if(Array.isArray(a))return a;J[0]=a;return J};c.prototype._remove=function(a,b,d){v.length=0;b=d.advanceTo(b,function(a,b){v.push(a.node,b)})?d.node.terminals:d.node.residents;b.removeUnordered(a);if(0===
b.length)for(a=v.length-2;0<=a&&this._purge(v[a],v[a+1]);a-=2);};c.prototype._nodeIsEmpty=function(a){if(0!==a.terminals.length)return!1;if(null!==a.residents)return 0===a.residents.length;for(var b=0;b<a.children.length;b++)if(a.children[b])return!1;return!0};c.prototype._purge=function(a,b){0<=b&&(a.children[b]=null);return this._nodeIsEmpty(a)?(null===a.residents&&(a.residents=new A({shrink:!0})),!0):!1};c.prototype._add=function(a,b){b.advanceTo(this._boundingSphereFromObject(a,H))?b.node.terminals.push(a):
(b.node.residents.push(a),b.node.residents.length>this._maximumObjectsPerNode&&b.depth<this._maximumDepth&&this._split(b))};c.prototype._split=function(a){var b=a.node.residents;a.node.residents=null;for(var d=0;d<b.length;d++){var e=g.acquire().init(a);this._add(b.data[d],e);g.release(e)}};c.prototype._grow=function(a){var b=this;if(0!==a.length&&(a=this._boundingSphereFromObjects(a,function(a,d){return b._boundingSphereFromObject(a,d)},w),this._isValidRadius(a.radius)&&!this._fitsInsideTree(a)))if(this._nodeIsEmpty(this._root.node))f.vec3.copy(this._root.center,
a.center),this._root.halfSize=1.25*a.radius;else{var d=g.acquire();this._rootBoundsForRootAsSubNode(a,d);this._placingRootViolatesMaxDepth(d)?this._rebuildTree(a,d):this._growRootAsSubNode(d);g.release(d)}};c.prototype._rebuildTree=function(a,b){var d=this;f.vec3.copy(C.center,b.center);C.radius=b.halfSize;a=this._boundingSphereFromObjects([a,C],function(a){return a},O);b=g.acquire().init(this._root);this._root.initFrom(null,a.center,1.25*a.radius);this._forEachNode(b,function(a){d.add(a.node.terminals.data,
a.node.terminals.length);null!==a.node.residents&&d.add(a.node.residents.data,a.node.residents.length);return!0});g.release(b)};c.prototype._placingRootViolatesMaxDepth=function(a){var b=0;this._forEachNode(this._root,function(a){b=Math.max(b,a.depth);return!0});return b+Math.log(a.halfSize/this._root.halfSize)*Math.LOG2E>this._maximumDepth};c.prototype._rootBoundsForRootAsSubNode=function(a,b){var d=a.radius,c=a.center;a=-Infinity;for(var f=this._root.center,h=this._root.halfSize,k=0;3>k;k++){var g=
Math.max(0,Math.ceil((f[k]-h-(c[k]-d))/(2*h))),l=Math.max(0,Math.ceil((c[k]+d-(f[k]+h))/(2*h)))+1;a=Math.max(a,Math.pow(2,Math.ceil(Math.log(g+l)*Math.LOG2E)));y[k].min=g;y[k].max=l}for(k=0;3>k;k++)g=y[k].min,l=y[k].max,d=(a-(g+l))/2,g+=Math.ceil(d),l+=Math.floor(d),K[k]=f[k]-h-g*h*2+(l+g)*h;return b.initFrom(null,K,a*h,0)};c.prototype._growRootAsSubNode=function(a){var b=this._root.node;f.vec3.copy(w.center,this._root.center);w.radius=this._root.halfSize;this._root.init(a);a.advanceTo(w,null,!0);
a.node.children=b.children;a.node.residents=b.residents;a.node.terminals=b.terminals};c.prototype._shrink=function(){for(;;){var a=this._findShrinkIndex();if(-1===a)break;this._root.advance(a);this._root.depth=0}};c.prototype._findShrinkIndex=function(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;for(var a=null,b=this._root.node.children,d=0,c=0;c<b.length&&null==a;)d=c++,a=b[d];for(;c<b.length;)if(b[c++])return-1;return d};c.prototype._isDegenerate=function(a){a=this._objectToBoundingSphere.getRadius(a);
return!this._isValidRadius(a)};c.prototype._isValidRadius=function(a){return!isNaN(a)&&-Infinity!==a&&Infinity!==a&&0<a};c.prototype._fitsInsideTree=function(a){var b=this._root.center,c=this._root.halfSize,e=a.center;return a.radius<=c&&e[0]>=b[0]-c&&e[0]<=b[0]+c&&e[1]>=b[1]-c&&e[1]<=b[1]+c&&e[2]>=b[2]-c&&e[2]<=b[2]+c};c.prototype._boundingSphereFromObject=function(a,b){f.vec3.copy(b.center,this._objectToBoundingSphere.getCenter(a));b.radius=this._objectToBoundingSphere.getRadius(a);return b};c.prototype._boundingSphereFromObjects=
function(a,b,c){if(1===a.length){var d=b(a[0],w);f.vec3.copy(c.center,d.center);c.radius=d.radius}else{m[0]=Infinity;m[1]=Infinity;m[2]=Infinity;l[0]=-Infinity;l[1]=-Infinity;l[2]=-Infinity;for(var g=0;g<a.length;g++)if(d=b(a[g],w),this._isValidRadius(d.radius)){var h=m,k=d.center,n=d.radius;h[0]=Math.min(h[0],k[0]-n);h[1]=Math.min(h[1],k[1]-n);h[2]=Math.min(h[2],k[2]-n);h=l;k=d.center;d=d.radius;h[0]=Math.max(h[0],k[0]+d);h[1]=Math.max(h[1],k[1]+d);h[2]=Math.max(h[2],k[2]+d)}f.vec3.lerp(c.center,
m,l,.5);c.radius=Math.max(l[0]-m[0],l[1]-m[1],l[2]-m[2])/2}return c};return c}();var g=function(){function c(a,b,c,e){void 0===c&&(c=0);void 0===e&&(e=0);this.center=f.vec3f64.create();this.initFrom(a,b,c,0)}c.prototype.init=function(a){return this.initFrom(a.node,a.center,a.halfSize,a.depth)};c.prototype.initFrom=function(a,b,d,e){void 0===a&&(a=null);void 0===d&&(d=this.halfSize);void 0===e&&(e=this.depth);this.node=a||c.createEmptyNode();b&&f.vec3.copy(this.center,b);this.halfSize=d;this.depth=
e;return this};c.prototype.advance=function(a){var b=this.node.children[a];b||(b=c.createEmptyNode(),this.node.children[a]=b);this.node=b;this.halfSize/=2;this.depth++;a=F[a];this.center[0]+=a[0]*this.halfSize;this.center[1]+=a[1]*this.halfSize;this.center[2]+=a[2]*this.halfSize;return this};c.prototype.advanceTo=function(a,b,c){for(void 0===c&&(c=!1);;){if(this.isTerminalFor(a))return b&&b(this,-1),!0;if(this.isLeaf()&&!c)return b&&b(this,-1),!1;this.isLeaf()&&(this.node.residents=null);var d=this._childIndex(a);
b&&b(this,d);this.advance(d)}};c.prototype.isLeaf=function(){return null!=this.node.residents};c.prototype.isTerminalFor=function(a){return a.radius>this.halfSize/2};c.prototype._childIndex=function(a){a=a.center;for(var b=this.center,c=0,e=0;3>e;e++)b[e]<a[e]&&(c|=1<<e);return c};c.createEmptyNode=function(){return{children:[null,null,null,null,null,null,null,null],terminals:new A({shrink:!0}),residents:new A({shrink:!0})}};c.acquire=function(){if(0===this._pool.length)return new c;var a=this._pool[this._pool.length-
1];this._pool.length--;return a};c.release=function(a){this._pool.push(a)};c._pool=[];return c}(),u;(function(c){c[c.FRONT_TO_BACK=1]="FRONT_TO_BACK";c[c.BACK_TO_FRONT=-1]="BACK_TO_FRONT"})(u||(u={}));var F=[f.vec3f64.fromValues(-1,-1,-1),f.vec3f64.fromValues(1,-1,-1),f.vec3f64.fromValues(-1,1,-1),f.vec3f64.fromValues(1,1,-1),f.vec3f64.fromValues(-1,-1,1),f.vec3f64.fromValues(1,-1,1),f.vec3f64.fromValues(-1,1,1),f.vec3f64.fromValues(1,1,1)],G=[f.vec3f64.fromValues(-1,-1,-1),f.vec3f64.fromValues(-1,
-1,1),f.vec3f64.fromValues(-1,1,-1),f.vec3f64.fromValues(-1,1,1),f.vec3f64.fromValues(1,-1,-1),f.vec3f64.fromValues(1,-1,1),f.vec3f64.fromValues(1,1,-1),f.vec3f64.fromValues(1,1,1)],I=Math.sqrt(3),J=[null],K=f.vec3f64.create(),p=f.vec3f64.create(),m=f.vec3f64.create(),l=f.vec3f64.create(),v=[],H={center:f.vec3f64.create(),radius:0},w={center:f.vec3f64.create(),radius:0},C={center:f.vec3f64.create(),radius:0},O={center:f.vec3f64.create(),radius:0},y=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],r=[],
N=[];return D});