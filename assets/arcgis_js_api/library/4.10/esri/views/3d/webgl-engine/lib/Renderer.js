// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/iteratorUtils ../../../../core/libs/gl-matrix-2/gl-matrix ../../support/buffer/glUtil ./ComponentUtils ./DefaultVertexAttributeLocations ./Float32ArrayList ./FxaaRenderPass ./HighlightTextureHelper ./InstanceBufferData ./IntervalUtilities ./LinearDepthTextureHelper ./NormalTextureHelper ./RenderContext ./RenderPluginManager ./SmaaRenderPass ./StencilRenderingHelper ./Util ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/HUDMaterial ../../../webgl/BufferObject ../../../webgl/Profiling ../../../webgl/Texture ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),
function(K,pa,S,w,L,W,Q,X,aa,ba,ca,Y,da,ea,fa,ga,ha,ia,C,ja,ka,la,M,ma,Z,D,N){function R(e){return e.instanceParameters.hidden?[]:W.generateVisibleIndexRanges(e.instanceParameters.componentVisibilities,e.componentOffsets)}function T(e,a,b){var d=e.origin.vec3;C.setMatrixTranslation3(I,-d[0],-d[1],-d[2]);w.mat4.multiply(a,I,e.transformation);w.mat4.invert(b,a);w.mat4.transpose(b,b)}function B(e,a,b){for(var d in e){var c=e[d];a(d,c);c.origin2data.forEach(function(a,d){b(d,a)})}}function U(e){return!1===
e.preinterleaved?C.getFirstObjectValue(e.indices).length:e.indexCount}var O=w.mat4f64.create();K=function(){function e(a,b,d,c,f){this._lighting=new ka.SceneLighting;this._mat2DataMerged={};this._mat2DataInstanced={};this._mat2DataPreinterleaved={};this._renderOrder=[];this._renderContext=new fa;this._isRendering=!1;this._highlights=[];this._threshold=1535;this._needsRender=!0;this._fallbackDepthStencilTexture=null;this._stats=new na;this._edgeView=null;this.ssaoEnabled=!1;this.renderOptions={antialiasing:"smaa",
earlyOcclusionPixelDraw:!1};this._programRep=a;this._materialRep=b;this._orderedRendering=f;this._rctx=c;this._fxaaPass=new aa(c);this._smaaPass=new ha(c);this._renderContext.rctx=c;this._renderContext.lightingData=this._lighting.getOld();c.setDepthTestEnabled(!0);c.setFaceCullingEnabled(!0);c.setBlendingEnabled(!1);c.setBlendFunctionSeparate(770,771,1,771);this._bindParameters={view:null,proj:null,viewInvTransp:null,fovY:0,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,
ssaoEnabled:!1,origin:null,pixelRatio:null,slicePlane:null};this._linearDepthTextureHelper=new da(c);this._normalTextureHelper=new ea(c);this._highlightTextureHelper=new ba(c);this._stencilRenderingHelper=new ia(c);this._renderPlugins=new ga.RenderPluginManager({rctx:c,gl:c.gl,programRep:a,textureRep:d,materialRep:b});this._initializeFramebufferTexture()}e.prototype._initializeFramebufferTexture=function(){var a=this._rctx.gl,a=this._rctx.contextAttributes.alpha?a.RGBA:a.RGB,b=new Z(this._rctx,{target:3553,
pixelFormat:a,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:a,texture:b}};e.prototype.dispose=function(){var a=this,b=function(b){a._releaseMaterials(b)},d=function(a,b){b.type===t.Preinterleaved?b.instances.forEach(function(a){return a.vao.dispose(!0)}):b.vao.dispose(!0)};B(this._mat2DataMerged,b,d);B(this._mat2DataInstanced,b,d);B(this._mat2DataPreinterleaved,b,d);this._mat2DataPreinterleaved=this._mat2DataInstanced=this._mat2DataMerged=null;this._framebuffer.texture.dispose();
this._framebuffer.texture=null;this._linearDepthTextureHelper.enabled=!1;this._normalTextureHelper.enabled=!1;this._stencilRenderingHelper.enabled=!1;this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null);this._highlightTextureHelper&&(this._highlightTextureHelper.dispose(),this._highlightTextureHelper=null)};Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources},
enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"edgeView",{get:function(){var a=this;null==this._edgeView&&(this._edgeView=new ja.EdgeView(this._rctx,this._programRep,{setNeedsRender:function(){a._needsRender=!0}}),this._edgeView.initialize());return this._edgeView},enumerable:!0,configurable:!0});e.prototype.setLighting=function(a){this._lighting.set(a)};Object.defineProperty(e.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!0,configurable:!0});
e.prototype.resetNeedsRender=function(){this._needsRender=!1;this._renderPlugins.resetNeedsRender()};e.prototype.needsRender=function(){return this._needsRender||this._renderPlugins.needsRender()};e.prototype.getCombinedStats=function(){var a=this;this._stats.VBOallocatedSize=0;this._stats.VBOoptimalSize=0;this._stats.VBOusedSize=0;var b=function(){},d=function(b,d){d.type===t.Preinterleaved?d.instances.forEach(function(b){b=b.vao.size;a._stats.VBOallocatedSize+=b/4;a._stats.VBOusedSize+=b/4;a._stats.VBOoptimalSize+=
b/4}):(a._stats.VBOallocatedSize+=d.buffer.getArray().length,a._stats.VBOusedSize+=d.buffer.getSize(),a._stats.VBOoptimalSize+=d.optimalCount)};B(this._mat2DataMerged,b,d);B(this._mat2DataInstanced,b,d);B(this._mat2DataPreinterleaved,b,d);this._stats.VBOallocatedSize*=.00390625;this._stats.VBOusedSize*=.00390625;this._stats.VBOoptimalSize*=.00390625;return this._stats};e.prototype.getFramebufferTexture=function(a){switch(a){case "linearDepth":return this._linearDepthTextureHelper.framebuffer.colorTexture;
case "normals":return this._normalTextureHelper.framebuffer.colorTexture}return null};e.prototype._addHighlight=function(a){var b=this._getInstance(a);if(null===b)console.error("No instance found for RenderGeometry {name: '"+a.name+"', uniqueName: '"+a.uniqueName+"'}");else if(this._highlights.push(b),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights)};e.prototype._removeHighlight=function(a){var b=
this._highlights.length;this._highlights=this._highlights.filter(function(b){return b.uniqueName!==a.uniqueName});if(b!==this._highlights.length){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights);this._needsRender=!0}};Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return 0<this._highlights.length},enumerable:!0,configurable:!0});e.prototype._renderHUDVisibility=function(a){var b=this,d=la.shouldRenderVisibilityDuringRenderPass(a.pass),c=a.offscreenRenderingHelper&&
a.offscreenRenderingHelper.enabled,f=!1;d&&c&&a.offscreenRenderingHelper.renderHUDVisibility(function(){f=b._renderInternalSlot(14,a)});return f};e.prototype.renderGeometrySlotsPt1=function(a){this._renderPlugins.render(1,a);this._renderInternalSlot(2,a);this._renderPlugins.render(3,a);this._renderInternalSlot(4,a);this._renderPlugins.render(5,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);this._renderPlugins.render(16,this._renderContext);this._renderInternalSlot(6,a);this.renderOptions.earlyOcclusionPixelDraw&&
(this._renderHUDVisibility(a),this._renderInternalSlot(21,this._renderContext));this._renderPlugins.render(7,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep)};e.prototype.renderTransparentTerrain=function(a){return this._renderPlugins.render(8,a)};e.prototype.renderGeometrySlots=function(a){this.renderGeometrySlotsPt1(a);this.renderTransparentTerrain(a)};e.prototype.renderHUD=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this._renderInternalSlot(22,this._renderContext);
this._renderInternalSlot(19,this._renderContext);this._renderInternalSlot(20,this._renderContext)};e.prototype._renderHighlights=function(a,b){if(b&&b.enabled&&(this.hasHighlights||this._renderPlugins.needsHighlight())){var d=null;b.profilingCallback&&(d=ma.startMeasurement(this._renderContext.rctx));var c=a.fbo;this._highlightTextureHelper.prepareHighlightPass(a.camera);this.renderGeometryPass(4,a,null,null,this._renderContext.sliceHelper);this._rctx.clear(this._rctx.gl.DEPTH_BUFFER_BIT);this.renderHUD("both");
this._highlightTextureHelper.finish(c);b.render(a,this._highlightTextureHelper.framebuffer);null!==d&&b.profilingCallback&&d.stop(function(a){b.profilingCallback&&b.profilingCallback(a)})}};e.prototype._needsRenderOccluded=function(a){for(var b in this._mat2DataInstanced){var d=this._mat2DataInstanced[b][0];if(d&&d.renderOccluded&&d.beginSlot(a)&&d.isVisible())return!0}return!1};e.prototype._renderOccluded=function(a,b,d){if(b&&d&&d.enabled){var c=this._needsRenderOccluded(4)||this._needsRenderOccluded(6)||
this._needsRenderOccluded(9);if(b.enabled=c)c=this._renderContext,b.setupFBOs(a),b.prepareColorPass(),c.pass=0,c.renderOccludedOnly=!0,this._renderInternalSlot(4,c),this._renderInternalSlot(6,c),this._renderInternalSlot(9,c),c.renderOccludedOnly=!1,b.finish(d.framebuffer),b.apply()}};e.prototype._renderUnordered=function(a,b,d){var c=this,f=this._rctx;this._isRendering=!0;this._stats.reset();var g=a.camera,n=a.fbo,h=a.pixelRatio;this._updateGlobalUniforms(g.projectionMatrix);this._renderContext.pass=
0;this._renderContext.camera=g;this._renderContext.pixelRatio=h;this._renderContext.shadowMap=b;this._renderContext.sliceHelper=d.slice;this._renderContext.ssaoHelper=d.ssao;this._renderContext.offscreenRenderingHelper=d.offscreenRendering;this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper;this._renderContext.depth=this._linearDepthTextureHelper.framebuffer;this._renderContext.normals=this._normalTextureHelper.framebuffer;this._renderContext.highlight=this._highlightTextureHelper.framebuffer;
this._renderContext.options=this.renderOptions;d.offscreenRendering.enabled=!0;d.offscreenRendering.initializeFrame(g,n);this._renderPlugins.render(0,this._renderContext);this.renderGeometrySlotsPt1(this._renderContext);this._edgeView&&this.edgeView.shouldRender()&&d.offscreenRendering.renderSeparateAndComposite(function(){c._edgeView.render(c._bindParameters)},void 0,"alpha");h=b=!1;this.renderOptions.earlyOcclusionPixelDraw||(b=this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(21,
this._renderContext));(h=this.renderTransparentTerrain(this._renderContext))&&b&&(d.offscreenRendering.compositeTransparentTerrainOntoHUDVisibility(),d.offscreenRendering.renderToTargets(function(){return c.renderHUD("occluded")},d.offscreenRendering.mainColor,d.offscreenRendering.tmpDepth,void 0,!0));h&&d.offscreenRendering.compositeTransparentTerrainOntoMain();d.offscreenRendering.renderToTargets(function(){c._renderInternalSlot(9,c._renderContext);c._renderPlugins.render(17,c._renderContext);c._renderPlugins.render(18,
c._renderContext);c._renderOccluded(g,d.renderOccluded,d.offscreenRendering);d.slice&&d.slice.isEnabled&&(c._renderInternalSlot(10,c._renderContext),c._renderInternalSlot(11,c._renderContext),c._renderInternalSlot(12,c._renderContext),c._renderInternalSlot(13,c._renderContext))},d.offscreenRendering.mainColor,d.offscreenRendering.mainDepth);b=this.renderOptions.antialiasing;"smaa"===b&&this._smaaPass.loadResources(function(){c._needsRender=!0});"smaa"===b&&this._smaaPass.enable()?(this._fxaaPass.disable(),
this._smaaPass.render({colorTexture:d.offscreenRendering.colorTexture},n)):"fxaa"===b&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:d.offscreenRendering.colorTexture},n)):(d.offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable());f.bindFramebuffer(n);this._renderContext.framebufferTex=d.offscreenRendering.colorTexture;this.renderHUD("notOccluded");this._renderHighlights(a,d.highlight);this._isRendering=!1};e.prototype._renderGeometryPassOrderedHighlight=
function(a){this._renderInternalHighlights()};e.prototype._renderGeometryPassOrderedMaterial=function(a){for(var b=null,d=0;d<this._renderOrder.length;d++){var c=this._renderOrder[d][1];if(c.instanced){var f=c.instanced||c.merged,g=f[a.pass];g&&g.isVisible()&&(this._renderInternalInstanced(f,g,this._bindParameters,Infinity),b=null)}c.merged&&(f=c.merged,(g=f[a.pass])&&g.isVisible()&&(c=g.getProgram(),c!==b&&(c.setUniformMatrix4fv("model",O),c.hasUniform("modelNormal")&&c.setUniformMatrix4fv("modelNormal",
O)),b=c,this._renderInternalMerged(f,g,this._bindParameters,Infinity)))}};e.prototype._renderGeometryPassOrdered=function(a){var b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;G[0]=b.near;G[1]=b.far;this._bindParameters.nearFar=G;this._bindParameters.lightingData=a.lightingData;this._bindParameters.viewport=b.fullViewport;this._bindParameters.framebufferTex=this._framebuffer.texture;this._bindParameters.pixelRatio=
a.pixelRatio;this._bindParameters.slicePlane=a.sliceHelper&&a.sliceHelper.plane;a.isHighlightPass?this._renderGeometryPassOrderedHighlight(a):this._renderGeometryPassOrderedMaterial(a)};e.prototype._renderOrdered=function(a,b){this._stats.reset();this.renderGeometryPass(a,b)};e.prototype.prepareRender=function(a){this._renderPlugins.prepareRender(a);this._renderContext.rctx.setDepthFunction(513)};e.prototype.render=function(a,b){this._orderedRendering?this._renderOrdered(0,a):this._renderUnordered(a,
b.shadowMap,b)};e.prototype.renderAuxiliaryBuffers=function(a,b){var d=b.ssao,c=b.slice;b=b.shadowMap;var f=this.ssaoEnabled||this._renderPlugins.needsLinearDepth(),g=a.camera,n=a.fbo;if(this._linearDepthTextureHelper.enabled=f)this._linearDepthTextureHelper.setupFBOs(g),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(1,a,b,d,c),this._linearDepthTextureHelper.finish(n);if(this._normalTextureHelper.enabled=this.ssaoEnabled)this._normalTextureHelper.setupFBOs(g),this._normalTextureHelper.prepareNormalPass(),
this.renderGeometryPass(2,a,b,d,c),this._normalTextureHelper.finish(n),d.computeSSAO(g,n,this._linearDepthTextureHelper.framebuffer,this._normalTextureHelper.framebuffer);d.bindAll(this._programRep)};e.prototype.renderGeometryPass=function(a,b,d,c,f){this._isRendering=!0;var g=b.camera;b=b.pixelRatio;this._updateGlobalUniforms(g.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=g;this._renderContext.pixelRatio=b;this._renderContext.shadowMap=d;this._renderContext.ssaoHelper=
c;this._renderContext.depth=this._linearDepthTextureHelper.framebuffer;this._renderContext.normals=this._normalTextureHelper.framebuffer;this._renderContext.sliceHelper=f;this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext);this._isRendering=!1};e.prototype._renderGeometryPassUnordered=function(a){this.renderGeometrySlots(a)};e.prototype._renderInternalHighlights=function(a){void 0===a&&(a=null);for(var b=!1,d=0;d<this._highlights.length;++d){var c=
this._highlights[d],f=c.matData[4];f&&(null===a||f.beginSlot(a))&&f.isVisible()&&(b=this._renderInternalHighlight(c,this._bindParameters,4)||b)}return b};e.prototype._renderInternalSlotOccluded=function(a,b){var d=!1,c;for(c in this._mat2DataInstanced){var f=this._mat2DataInstanced[c],g=f[b.pass];g&&g.renderOccluded&&g.beginSlot(a)&&g.isVisible()&&(d=this._renderInternalInstanced(f,g,this._bindParameters,a)||d)}return d};e.prototype._renderInternalSlotMaterial=function(a,b){var d=!1,c;for(c in this._mat2DataInstanced){var f=
this._mat2DataInstanced[c],g=f[b.pass];g&&g.beginSlot(a)&&g.isVisible()&&(d=this._renderInternalInstanced(f,g,this._bindParameters,a)||d)}for(var f=this._programRep.getProgramsUsingUniform("model"),g=this._programRep.getProgramsUsingUniform("modelNormal"),n=0;n<f.length;n++){var h=f[n];h.setUniformMatrix4fv("model",O);-1<g.indexOf(h)&&h.setUniformMatrix4fv("modelNormal",O)}for(c in this._mat2DataMerged)f=this._mat2DataMerged[c],(g=f[b.pass])&&g.beginSlot(a)&&g.isVisible()&&(d=this._renderInternalMerged(f,
g,this._bindParameters,a)||d);for(c in this._mat2DataPreinterleaved)f=this._mat2DataPreinterleaved[c],(g=f[b.pass])&&g.beginSlot(a)&&g.isVisible()&&(d=this._renderInternalPreinterleaved(f,g,this._bindParameters,a)||d);2===a&&this._stencilRenderingHelper.finish();return d};e.prototype._renderInternalSlotHighlights=function(a,b){return this._renderInternalHighlights(a)};e.prototype._renderInternalSlot=function(a,b){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;
this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;G[0]=b.camera.near;G[1]=b.camera.far;var d=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=G;this._bindParameters.lightingData=b.lightingData;this._bindParameters.viewport=b.camera.fullViewport;this._bindParameters.framebufferTex=d?d.colorTexture:null;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=
!!b.shadowMap&&b.shadowMap.enabled;this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.enabled;this._bindParameters.pixelRatio=b.pixelRatio;this._bindParameters.slicePlane=b.sliceHelper&&b.sliceHelper.plane;this._bindParameters.hudVisibilityTexture=d?d.hudVisibilityTexture:null;return b.isHighlightPass?this._renderInternalSlotHighlights(a,b):b.renderOccludedOnly?this._renderInternalSlotOccluded(a,b):this._renderInternalSlotMaterial(a,b)};e.prototype._renderInternalInstanced=function(a,b,
d,c){var f=this,g=this._rctx,n=g.gl,h=!1,e=b.getDrawMode(),k=g.capabilities.instancing,p=!1;a.origin2data.forEach(function(a){d.origin=a.origin;2===c&&(f._stencilRenderingHelper.enabled=!0,f._stencilRenderingHelper.prepareStencilWritePass());var q=!1;if(b.instanced)for(var m in a.perGeometryDataInfo){var l=a.perGeometryDataInfo[m];h||(b.bind(g,d),h=!0);g.bindVAO(l.vao);var t=b.getProgram();D.assertCompatibleVertexAttributeLocations(l.vao,t);q||(b.bindView(g,d),q=!0);var t=l.to-l.from,w=l.refCount;
e===n.TRIANGLES&&(f._stats.trianglesRendered+=w*t/3);k.drawArraysInstanced(e,l.from,t,w);p=!0;f._stats.drawCallsAngleInstanced++;f._stats.instancesDrawnAngle+=w}else a.instances.forEach(function(c){var k=c.displayedIndexRange;k&&0===k.length||(h||(b.bind(g,d),h=!0),q||(g.bindVAO(a.vao),b.bindView(g,d),q=!0),b.bindInstance(g,c),f._stats.drawCallsInstanced++,e===n.TRIANGLES&&(f._stats.trianglesRendered+=(c.to-c.from)/3),k?f._drawArraysFaceRange(k,c.from,e):g.drawArrays(e,c.from,c.to-c.from),p=!0)})});
g.bindVAO(null);h&&b.release(g,d);return p};e.prototype._renderInternalHighlight=function(a,b,d){var c=this._rctx,f=c.gl;d=a.matData[d];var g=d.getDrawMode(),n=a.instance,h=n.highlightedIndexRange,e=this._renderContext.offscreenRenderingHelper,e=(e?e.depthTexture:null)||this._getFallbackDepthTexture(),k=d.getProgram(),p=c.capabilities.instancing;b.origin=a.originData.origin;var q=!1;if(d.instanced&&a.type===t.Instanced)for(a=a.instancedVAO,d.bind(c,b),c.bindVAO(a),D.assertCompatibleVertexAttributeLocations(a,
k),d.bindView(c,b),a=0;a<h.length;a++){var u=h[a],q=u.range?u.range[0]+n.from:n.from,u=u.range?u.range[1]-u.range[0]+1:n.to-n.from;c.bindTexture(e,5);k.setUniform1i("depthTex",5);k.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);p.drawArraysInstanced(g,q,u,1);g===f.TRIANGLES&&(this._stats.trianglesRendered+=1*u/3);this._stats.drawCallsHighlight++;q=!0}else if(a.type===t.Instanced&&d.instanced)console.error("_renderInternalHighlight: incompatible instance type");
else{d.bind(c,b);d.bindView(c,b);p=null;switch(a.type){case t.Merged:u=a.originData;c.bindVAO(u.vao);k.setUniformMatrix4fv("model",O);break;case t.Instanced:u=a.originData;c.bindVAO(u.vao);d.bindInstance(c,n);break;case t.Preinterleaved:u=a.originData,a=u.instances.get(a.uniqueName).vao,c.bindVAO(a),d.bindInstance(c,n),p=a.indexBuffer&&a.indexBuffer.indexType}for(a=0;a<h.length;a++){u=h[a];q=u.range?u.range[0]+n.from:n.from;u=u.range?u.range[1]-u.range[0]+1:n.to-n.from;c.bindTexture(e,5);d.getProgram().setUniform1i("depthTex",
5);k.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);if(p){var v=D.getBytesPerElement(p);c.drawElements(g,u,p,q*v)}else c.drawArrays(g,q,u);g===f.TRIANGLES&&(this._stats.trianglesRendered+=u/3);this._stats.drawCallsHighlight++;q=!0}}c.bindVAO(null);d.release(c,b);return q};e.prototype._drawArraysFaceRange=function(a,b,d){for(var c=this._rctx,f=0;f<a.length;f++){var g=a[f];c.drawArrays(d,g[0]+b,g[1]-g[0]+1)}this._stats.drawCallsFragmented+=
a.length-1};e.prototype._drawElementsFaceRange=function(a,b,d,c){for(var f=this._rctx,g=D.getBytesPerElement(c),e=0;e<a.length;e++){var h=a[e];f.drawElements(d,h[1]-h[0]+1,c,(h[0]+b)*g)}this._stats.drawCallsFragmented+=a.length-1};e.prototype._renderInternalMerged=function(a,b,d,c){var f=this,g=this._rctx,e=g.gl,h=!1,m=!1;a.origin2data.forEach(function(a){d.origin=a.origin;2===c&&(f._stencilRenderingHelper.enabled=!0,f._stencilRenderingHelper.prepareStencilWritePass());if(!a.displayedIndexRange||
0!==a.displayedIndexRange.length){m||(b.bind(g,d),m=!0);var n=b.getProgram();g.bindVAO(a.vao);D.assertCompatibleVertexAttributeLocations(a.vao,n);b.bindView(g,d);f._stats.drawCallsMerged++;n=b.getDrawMode();n===e.TRIANGLES&&(f._stats.trianglesRendered+=a.vao.vertexBuffers.geometry.size/3);a.displayedIndexRange?f._drawArraysFaceRange(a.displayedIndexRange,0,n):g.drawArrays(n,0,D.vertexCount(a.vao,"geometry"));h=!0}});m&&b.release(g,d);return h};e.prototype._renderInternalPreinterleaved=function(a,
b,d,c){var f=this,g=this._rctx,e=g.gl,h=!1,m=!1,k=b.getDrawMode();a.origin2data.forEach(function(a){d.origin=a.origin;var n=!1;2===c&&(f._stencilRenderingHelper.enabled=!0,f._stencilRenderingHelper.prepareStencilWritePass());a.instances.forEach(function(a){var c=a.instance,l=a.vao;a=c.displayedIndexRange;if(!a||0!==a.length){m||(b.bind(g,d),m=!0);var q=b.getProgram();D.assertCompatibleVertexAttributeLocations(l,q);g.bindVAO(l);n||(b.bindView(g,d),n=!0);b.bindInstance(g,c);f._stats.drawCallsPreinterleaved++;
k===e.TRIANGLES&&(f._stats.trianglesRendered+=(c.to-c.from)/3);l=l.indexBuffer&&l.indexBuffer.indexType;a?l?f._drawElementsFaceRange(a,c.from,k,l):f._drawArraysFaceRange(a,c.from,k):l?(a=D.getBytesPerElement(l),g.drawElements(k,c.to-c.from,l,c.from*a)):g.drawArrays(k,c.from,c.to-c.from);h=!0}})});g.bindVAO(null);m&&b.release(g,d);return h};e.prototype._updateGlobalUniforms=function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),d=0;d<b.length;d++)b[d].setUniformMatrix4fv("proj",a);
if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d])}};e.prototype.print=function(){var a=Object.keys(this._mat2DataMerged).length,b=Object.keys(this._mat2DataInstanced).length,d=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+
a+"/"+b+"/"+d);var c=0;B(this._mat2DataMerged,function(){},function(a,b){c+=b.instances.size});var f=0;B(this._mat2DataInstanced,function(){},function(a,b){f+=b.instances.size});var g=0;B(this._mat2DataPreinterleaved,function(){},function(a,b){g+=b.instances.size});console.log("number of instances (merged/instanced/preinterleaved): "+c+"/"+f+"/"+g)};e.prototype.isEmpty=function(){for(var a in this._mat2DataInstanced){var b=this._mat2DataInstanced[a];if(!S.everyMap(b.origin2data,function(a){return 0===
a.instances.size}))return!1}for(a in this._mat2DataMerged)if(b=this._mat2DataMerged[a],!S.everyMap(b.origin2data,function(a){return 0===a.instances.size}))return!1;for(a in this._mat2DataPreinterleaved)if(b=this._mat2DataPreinterleaved[a],!S.everyMap(b.origin2data,function(a){return 0===a.instances.size}))return!1;return!0};e.prototype.modify=function(a,b,d,c){this._isRendering&&console.warn("Renderer.modify called while rendering");var f=[],g=[],e=[];this._classifyRenderGeometry(a,f,g,e);a=[];var h=
[],m=[];this._classifyRenderGeometry(b,a,h,m);var k={};d&&this._performUpdates(d,k);d=[];this._modifyMerged(f,a,d,k);this._modifyInstanced(g,h,d);this._modifyPreinterleaved(e,m,d);this._updateMergedFaceranges(k);this._releaseMaterials(d);f=this._highlights.length;if(b&&0<b.length&&0<f&&(this._highlights=this._highlights.filter(function(a){return!b.some(function(b){return b.uniqueName===a.uniqueName})}),f!==this._highlights.length&&this.onHasHighlightsChanged))this.onHasHighlightsChanged(this.hasHighlights);
this._updateHighlightVAOs();c&&this._modifyMaterials(c);this._needsRender=!0};e.prototype._classifyRenderGeometry=function(a,b,d,c){for(var f=0;f<a.length;f++){var g=a[f];if(1<=U(g.data))switch(this._getType(g)){case t.Merged:b.push(g);break;case t.Instanced:d.push(g);break;case t.Preinterleaved:c.push(g)}}};e.prototype._performUpdates=function(a,b){for(var d=0;d<a.length;d++){var c=a[d],f=c.updateType,c=c.renderGeometry,g=this._getType(c)===t.Merged;if(1<=U(c.data)){f&2&&this._updateFaceranges(c,
b);if(f&32){var e=this._getInstance(c);e&&this._updateHighlightFaceranges(c,e.instance)}f&4||g&&f&16?this._updateVertexAttributes(c,!g):!g&&f&16&&this._updateInstanceTransformation(c)}}};e.prototype._updateFaceranges=function(a,b){var d=a.material.id,c=a.origin.id,f=this._getType(a),g;if(f===t.Preinterleaved){var e=this._getOriginData(f,d,c);g=e.instances.get(a.uniqueName).instance}else e=this._getOriginData(f,d,c),(g=e.instances.get(a.uniqueName))&&f===t.Merged&&(b[this._modifiedMergedFacerangesKey(d,
c)]=e);g&&(g.displayedIndexRange=R(a),this._updateHighlightFaceranges(a,g))};e.prototype._updateHighlightFaceranges=function(a,b){if(b){var d=b.highlightedIndexRange,c;c=a.instanceParameters.hidden?null:W.generateHighlightedIndexRanges(a.instanceParameters.componentVisibilities,a.instanceParameters.componentHighlights,a.componentOffsets);(b.highlightedIndexRange=c)&&!d?this._addHighlight(a):!c&&d&&this._removeHighlight(a)}};e.prototype._updateMergedFaceranges=function(a){var b=function(b){var c=a[b];
c.displayedIndexRange=[];var d=!0;c.instances.forEach(function(a){a.displayedIndexRange?(c.displayedIndexRange.push.apply(c.displayedIndexRange,Y.offsetIntervals(a.displayedIndexRange,a.from)),d=!1):c.displayedIndexRange.push([a.from,a.to-1])});c.displayedIndexRange=d?null:Y.mergeIntervals(c.displayedIndexRange)},d;for(d in a)b(d)};e.prototype._updateVertexAttributes=function(a,b){var d=a.material,c=d.bufferWriter,f=d.id,g=a.origin.id,d=c.vertexBufferLayout.stride/4,e=this._getType(a);if(e===t.Preinterleaved)console.error("Updating Preinterleaved geometry not supported");
else{var e=this._getOriginData(e,f,g),f=e.instances.get(a.uniqueName),g=e.buffer.getArray(),e=e.vao,h,m;b||(T(a,P,J),h=P,m=J);c.write({transformation:h,invTranspTransformation:m},a.data,a.instanceParameters,c.vertexBufferLayout.createView(g.buffer),f.from);C.assert(f.from+c.elementCount(a.data)===f.to,"material VBO layout has changed");e.vertexBuffers.geometry.setSubData(g,f.from*d*4,f.from*d*4,f.to*d*4)}};e.prototype._updateInstanceTransformation=function(a){var b=this._getType(a),d=a.material.id,
c=a.origin.id;b===t.Preinterleaved?(b=this._getOriginData(b,d,c),c=b.instances.get(a.uniqueName).instance,T(a,c.transformation,c.transformationNormal)):(b=this._getOriginData(b,d,c),c=b.instances.get(a.uniqueName),b=b.perGeometryDataInfo[a.data.id],d=b.instanceBufferData,T(a,c.transformation,c.transformationNormal),d&&(a=d.getSlot(a.idx),d.fill(a,0,c.transformation),d.fill(a,16,c.transformationNormal),a=4*d.getOffset(a),c=D.getStride(b.vao.layout.instance),b.vao.vertexBuffers.instance.setSubData(d.getArray(),
a,a,a+c)))};e.prototype._modifyMerged=function(a,b,d,c){a=this._compMatToDelta(a,b,t.Merged);b=this._mat2DataMerged;for(var f in a){var g=a[f],e;for(e in g){var h=g[e],m=h.optimalCount,k=h.sparseCount,p=h.material,q=p.bufferWriter.vertexBufferLayout,u=q.stride/4,v=b[f];null==v&&(C.assert(0<m),v=this._initializeMatData(p),b[f]=v,this._orderedRendering&&this._insertIntoRenderOrder(v,p.renderPriority,"merged"));var l=v.origin2data.get(e);null==l&&(C.assert(0<m),l=this._createMergedData(q,m,h.origin),
v.origin2data.set(e,l));if(0===m)l.vao.dispose(!0),l.vao=null,v.origin2data.delete(e),0===v.origin2data.size&&(d.push(f),delete b[f],this._orderedRendering&&this._removeFromRenderOrder(v,"merged"));else{var w=(q=m<h.sparseCount/2)?m:k,m=oa,k=l.buffer.getSize(),v=l.buffer.getArray(),w=l.buffer.resize(w);q||w?this._rebuildMerged(l,h.toRemove,u,v,m):0<h.toRemove.length?(this._removeMergedByErasing(l,h.toRemove,u,m),0<h.toAdd.length&&(m.end=k)):(m.begin=k,m.end=k);q=I;C.setMatrixTranslation3(q,-h.origin[0],
-h.origin[1],-h.origin[2]);this._appendMerged(l,p,h.toAdd,u,q,m);h=l.vao.vertexBuffers.geometry;h.byteSize!==l.buffer.getArray().buffer.byteLength?h.setData(l.buffer.getArray()):(q=m.begin,p=m.end,q<p&&(u=l.buffer.getArray(),q*=4,h.setSubData(u,q,q,4*p)));if(m.updatedDisplayedIndexRange||l.displayedIndexRange)c[this._modifiedMergedFacerangesKey(f,e)]=l}}}};e.prototype._createMergedData=function(a,b,d){return{type:t.Merged,instances:new Map,vao:new N(this._rctx,Q.Default3D,{geometry:L.glLayout(a)},
{geometry:M.createVertex(this._rctx,35044)}),buffer:new X(b),optimalCount:0,origin:d}};e.prototype._rebuildMerged=function(a,b,d,c,f){for(var g=0;g<b.length;++g){var e=a.instances.get(b[g].uniqueName);a.optimalCount-=(e.to-e.from)*d;a.instances.delete(b[g].uniqueName)}var h=0,m=a.buffer.getArray();f.begin=0;f.end=0;var k=-1,p=-1,q=0;a.instances.forEach(function(a){var b=a.from*d,g=a.to*d,f=g-b;k!==p&&p!==b?(m.set(c.subarray(k,p),q),q+=p-k,k=b):-1===k&&(k=b);p=g;a.from=h/d;h+=f;a.to=h/d});k!==p&&m.set(c.subarray(k,
p),q);f.end=h};e.prototype._removeMergedByErasing=function(a,b,d,c){if(0!==b.length){c.begin=Infinity;c.end=-Infinity;for(var f=-1,g=-1,e=0;e<b.length;e++){var h=b[e].uniqueName,m=a.instances.get(h),k=m.from*d,m=m.to*d;f!==g&&g!==k?(a.buffer.erase(f,g),f=k):-1===f&&(f=k);g=m;a.instances.delete(h);a.optimalCount-=m-k;k<c.begin&&(c.begin=k);m>c.end&&(c.end=m)}f!==g&&a.buffer.erase(f,g)}};e.prototype._appendMerged=function(a,b,d,c,e,g){g.updatedDisplayedIndexRange=!1;b=b.bufferWriter;for(var f=0;f<d.length;f++){var h=
d[f],m=h.data;w.mat4.multiply(P,e,h.transformation);w.mat4.invert(J,P);w.mat4.transpose(J,J);var k=g.end;b.write({transformation:P,invTranspTransformation:J},m,h.instanceParameters,b.vertexBufferLayout.createView(a.buffer.getArray().buffer),g.end/c);var m=b.elementCount(m)*c,p=k+m;C.assert(null==a.instances.get(h.uniqueName));var q=R(h),k=new V(h.name,k/c,p/c,q,void 0,void 0,h.idx);a.instances.set(h.uniqueName,k);this._updateHighlightFaceranges(h,k);q&&(g.updatedDisplayedIndexRange=!0);a.optimalCount+=
m;g.end+=m}};e.prototype._modifyInstanced=function(a,b,d){var c=this._rctx,e=t.Instanced;a=this._compMatToDelta(a,b,e);var g=this._mat2DataInstanced,n;for(n in a){var h=a[n];b=function(a){var b=h[a];if(0===b.optimalCount)return b=g[n],b.origin2data.get(a).vao.dispose(!0),b.origin2data.delete(a),0===b.origin2data.size&&(d.push(n),delete g[n],m._orderedRendering&&m._removeFromRenderOrder(b,"instanced")),"continue";var f=b.material,k=f.bufferWriter,l=g[n];if(null==l){var p=f.renderPriority,l=m._initializeMatData(f);
g[n]=l;m._orderedRendering&&m._insertIntoRenderOrder(l,p,"instanced")}var f=k.vertexBufferLayout,t=(p=l[0].instanced?k.instanceBufferLayout:void 0)&&p.fields.get("instanceColor"),D=p&&p.fields.get("instanceFeatureAttribute"),E=f.stride/4,r=l.origin2data.get(a);null==r&&(r={type:e,instances:new Map,vao:new N(c,Q.Default3D,{geometry:L.glLayout(f)},{geometry:M.createVertex(c,35044)}),buffer:new X(b.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:b.origin},l.origin2data.set(a,r));a=r.buffer.getSize();
var H=r.buffer.getArray(),A=b.optimalCount<b.sparseCount/2,x=r.buffer.resize(A?b.optimalCount:b.sparseCount),z;for(z in b.perGeometryDelta)if((l=r.perGeometryDataInfo[z])&&l.instanceBufferData){var B=b.perGeometryDelta[z].removeCount;0<B&&l.instanceBufferData.prepareFree(B)}B=b.toRemove;if(A||x){for(A=0;A<B.length;++A){x=B[A];r.instances.delete(x.uniqueName);z=x.data.id;var F=l=r.perGeometryDataInfo[z];0===--F.refCount&&null==b.dataId2refCount[z]?(r.optimalCount-=(F.to-F.from)*E,delete r.perGeometryDataInfo[z]):
l.instanceBufferData&&l.instanceBufferData.free(x.idx)}a=0;var A=r.buffer.getArray(),x={},y;for(y in r.perGeometryDataInfo)F=r.perGeometryDataInfo[y],C.assert(null==x[F.from]),x[F.from]=F;for(var G in x)F=x[G],y=F.from*E,l=F.to*E,A.set(H.subarray(y,l),a),F.from=a/E,a+=l-y,F.to=a/E;r.instances.forEach(function(a){a.from=r.perGeometryDataInfo[a.dataId].from;a.to=r.perGeometryDataInfo[a.dataId].to})}else for(A=0;A<B.length;++A)x=B[A],r.instances.delete(x.uniqueName),z=x.data.id,l=r.perGeometryDataInfo[z],
0===--l.refCount&&null==b.dataId2refCount[z]?(y=l.from*E,l=l.to*E,r.buffer.erase(y,l),r.optimalCount-=l-y,delete r.perGeometryDataInfo[z]):l.instanceBufferData&&l.instanceBufferData.free(x.idx);C.setMatrixTranslation3(I,-b.origin[0],-b.origin[1],-b.origin[2]);for(z in b.perGeometryDelta)(l=r.perGeometryDataInfo[z])&&l.instanceBufferData&&(A=b.perGeometryDelta[z].addCount,0<A&&l.instanceBufferData.prepareAllocate(A));G=b.toAdd;for(A=0;A<G.length;++A)if(x=G[A],y=x.data,z=y.id,l=r.perGeometryDataInfo[z],
null==l?(k.write({},y,void 0,k.vertexBufferLayout.createView(r.buffer.getArray().buffer),a/E),H=k.elementCount(y)*E,y=a/E,a+=H,l=a/E,r.optimalCount+=H,l={refCount:1,from:y,to:l,vao:null,instanceBufferData:null},p&&(y=p.stride/4,l.vao=new N(c,Q.Default3D,{geometry:L.glLayout(f),instance:L.glLayout(p,{divisor:1})},{geometry:r.vao.vertexBuffers.geometry,instance:M.createVertex(c,35044)}),l.instanceBufferData=new ca(y,b.perGeometryDelta[z].addCount)),r.perGeometryDataInfo[z]=l):++l.refCount,C.assert(l.from*
E<=r.buffer.getSize()&&l.to*E<=r.buffer.getSize()),y=w.mat4f64.create(),w.mat4.multiply(y,I,x.transformation),H=R(x),y=new V(x.name,l.from,l.to,H,y,x.instanceParameters,x.idx,z),r.instances.set(x.uniqueName,y),m._updateHighlightFaceranges(x,y),l=l.instanceBufferData)H=l.allocate(x.idx),l.fill(H,0,y.transformation),l.fill(H,16,y.transformationNormal),t&&l.fill(H,t.offset/4,x.instanceParameters.color),D&&l.fill(H,D.offset/4,x.instanceParameters.featureAttribute);C.assert(r.optimalCount===b.optimalCount);
k=new Float32Array(r.buffer.getArray().buffer,0,r.buffer.getSize());r.vao.vertexBuffers.geometry.setData(k);for(z in r.perGeometryDataInfo)if(f=r.perGeometryDataInfo[z],f.vao&&(k=f.vao.vertexBuffers.instance))p=b.perGeometryDelta[z],0<p.addCount+p.removeCount&&(f=f.instanceBufferData.compact(),k.setData(f))};var m=this,k;for(k in h)b(k)}};e.prototype._modifyPreinterleaved=function(a,b,d){for(var c=this._rctx,f=t.Preinterleaved,e=this._mat2DataPreinterleaved,n=0;n<a.length;n++){var h=a[n],m=h.material,
k=m.bufferWriter,p=m.id,q=h.origin.id,u=h.origin.vec3,v=e[p];null==v&&(v=this._initializeMatData(m),e[p]=v);p=v.origin2data.get(q);null==p&&(p={type:f,origin:u,count:0,instances:new Map},v.origin2data.set(q,p));C.setMatrixTranslation3(I,-u[0],-u[1],-u[2]);v=w.mat4f64.create();w.mat4.multiply(v,I,h.transformation);m=R(h);q=h.data;q.preinterleaved?null==q.vertexData?C.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available."):(v=new V(h.name,0,q.indexCount,m,v,h.instanceParameters,
h.idx,q.id),m=q.indexData?M.createIndex(c,35044,q.indexData):null,k=new N(c,Q.Default3D,{geometry:L.glLayout(k.vertexBufferLayout)},{geometry:M.createVertex(c,35044)},m),k.vertexBuffers.geometry.setData(q.vertexData),q.indexData=null,q.vertexData=null,p.count+=1,p.instances.set(h.uniqueName,{instance:v,vao:k}),this._updateHighlightFaceranges(h,v)):C.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(a=0;a<b.length;a++)h=b[a],c=h.origin,m=h.material,p=m.id,q=c.id,h=h.uniqueName,
v=e[p],c=v.origin2data.get(q),c.instances.get(h).vao.dispose(),c.instances.delete(h),--c.count,0===c.count&&v.origin2data.delete(q),0===v.origin2data.size&&(d.push(p),delete e[p])};e.prototype._compMatToDelta=function(a,b,d){var c={};this._updateMatToDelta(a,!0,d,c);this._updateMatToDelta(b,!1,d,c);return c};e.prototype._updateMatToDelta=function(a,b,d,c){d=d===t.Instanced;for(var f=0;f<a.length;f++){var e=a[f],n=e.origin,h=e.material,m=h.bufferWriter,k=h.id,p=d?this._mat2DataInstanced[k]:this._mat2DataMerged[k],
p=p&&p.origin2data.get(n.id),q=c[k];null==q&&(q={},c[k]=q);k=q[n.id];if(null==k){k={optimalCount:null==p?0:p.optimalCount,sparseCount:null==p?0:p.buffer.getSize(),material:h,toAdd:[],toRemove:[],perGeometryDelta:null,origin:n.vec3};if(d){h={};if(void 0!==p)for(var u in p.perGeometryDataInfo)h[u]=p.perGeometryDataInfo[u].refCount;k.dataId2refCount=h;k.perGeometryDelta={}}q[n.id]=k}n=m.vertexBufferLayout.stride/4;m=m.elementCount(e.data)*n;d?(n=e.data.id,h=k.perGeometryDelta[n],h||(h={addCount:0,removeCount:0},
k.perGeometryDelta[n]=h),b?(h.addCount++,null==k.dataId2refCount[n]&&(k.dataId2refCount[n]=0),1===++k.dataId2refCount[n]&&(k.optimalCount+=m,k.sparseCount+=m),k.toAdd.push(e)):(h.removeCount++,0===--k.dataId2refCount[n]&&(delete k.dataId2refCount[n],k.optimalCount-=m),k.toRemove.push(e))):b?(k.optimalCount+=m,k.sparseCount+=m,k.toAdd.push(e)):(k.optimalCount-=m,k.toRemove.push(e))}};e.prototype._getType=function(a){if(a.data.preinterleaved)return t.Preinterleaved;var b=!1,d=U(a.data),b=(b=(b=b||!1===
a.material.canBeMerged)||a.material.instanced)||!0===a.material.renderOccluded;a.singleUse||(b=b||d>this._threshold);return b?t.Instanced:t.Merged};e.prototype._getTargetMat2Data=function(a){switch(a){case t.Merged:return this._mat2DataMerged;case t.Instanced:return this._mat2DataInstanced;case t.Preinterleaved:return this._mat2DataPreinterleaved}};e.prototype._getOriginData=function(a,b,d){return this._getTargetMat2Data(a)[b].origin2data.get(d)};e.prototype._modifiedMergedFacerangesKey=function(a,
b){return a+"_"+b};e.prototype._insertIntoRenderOrder=function(a,b,d){for(var c=a[0].materialId,e=this._renderOrder.length,g=0;g<e&&this._renderOrder[g][0]>=b;){var n=this._renderOrder[g][1];if(n.id===c){C.assert(!n[d],"matData for type already exists");n[d]=a;return}g++}c={id:c,instanced:null,merged:null};c[d]=a;this._renderOrder.splice(g,0,[b,c])};e.prototype._removeFromRenderOrder=function(a,b){var d=a[0].materialId;for(a=0;this._renderOrder[a][1].id!==d;)a++;d=this._renderOrder[a][1];d[b]=null;
d.instanced||d.merged||this._renderOrder.splice(a,1)};e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(a,b){a=a.matData[0].renderPriority;b=b.matData[0].renderPriority;return a>b?-1:b>a?1:0})};e.prototype._updateRenderOrder=function(a,b){for(var d=b.length,c=0;c<d&&b[c][1].id!==a;)c++;if(c<d){a=b[c][1];a=(a.merged||a.instanced)[0].renderPriority;var e=b[c][0];if(a!==b[c][0])for(b[c][0]=a,e=a>e?-1:1,c+=e;-1<c&&c<d&&e*b[c][0]>e*a;){var g=b[c];b[c]=b[c-e];b[c-e]=g;c+=
e}}};e.prototype._modifyMaterials=function(a){var b=this;a.forEach(function(a){b._materialRep.updateMaterialParameters(a)})};e.prototype.modifyRenderOrder=function(a){var b=this;this._orderedRendering&&(a.forEach(function(a){b._updateRenderOrder(a,b._renderOrder)}),this._sortHighlightsByRenderOrder(),this._needsRender=!0)};e.prototype._initializeMatData=function(a){var b={origin2data:new Map};b[0]=this._materialRep.aquire(a);b[3]=this._materialRep.aquireDepthShadowMap(a);b[2]=this._materialRep.aquireNormal(a);
b[1]=this._materialRep.aquireDepth(a);b[4]=this._materialRep.aquireHighlight(a);return b};e.prototype._releaseMaterials=function(a){if(Array.isArray(a))for(var b=0;b<a.length;b++)this._materialRep.release(a[b]),this._materialRep.releaseDepthShadowMap(a[b]),this._materialRep.releaseNormal(a[b]),this._materialRep.releaseDepth(a[b]),this._materialRep.releaseHighlight(a[b]);else this._materialRep.release(a),this._materialRep.releaseDepthShadowMap(a),this._materialRep.releaseNormal(a),this._materialRep.releaseDepth(a),
this._materialRep.releaseHighlight(a)};e.prototype._getInstance=function(a){var b=a.uniqueName,d=a.material.id,c=this._getType(a),d=this._getTargetMat2Data(c)[d];if(!d)return null;a=d.origin2data.get(a.origin.id);if(!a)return null;var e;return(e=a.type===t.Preinterleaved?a.instances.get(b).instance:a.instances.get(b))?{type:c,uniqueName:b,instance:e,matData:d,originData:a,instancedVAO:null,instancedVAOBaseInstance:null}:null};e.prototype._createBaseInstanceVAO=function(a){var b=this._rctx,d=a.instance,
c=a.originData;if(a.type===t.Instanced&&c.perGeometryDataInfo){var c=c.perGeometryDataInfo[d.dataId],e=c.instanceBufferData;e&&(c=c.vao,d=e.getSlot(d.idx),a.instancedVAOBaseInstance!==d&&(e=D.setBaseInstanceOffset(c.layout,d),a.instancedVAO=new N(b,c.locations,e,c.vertexBuffers,c.indexBuffer),a.instancedVAOBaseInstance=d))}};e.prototype._updateHighlightVAOs=function(){for(var a=0;a<this._highlights.length;++a)this._createBaseInstanceVAO(this._highlights[a])};e.prototype._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||
(this._fallbackDepthStencilTexture=new Z(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255])));return this._fallbackDepthStencilTexture};return e}();(function(e){var a=function(){function a(){this.reset()}a.prototype.reset=function(){this.VBOusedSize=this.VBOoptimalSize=this.VBOallocatedSize=this.instancesDrawnAngle=this.drawCallsHighlight=this.drawCallsFragmented=this.drawCallsPreinterleaved=this.drawCallsMerged=this.drawCallsAngleInstanced=
this.drawCallsInstanced=this.trianglesRendered=0};return a}();e.RenderStats=a})(K||(K={}));var na=K.RenderStats,V=function(){return function(e,a,b,d,c,f,g,n){this.name=e;this.from=a;this.to=b;this.displayedIndexRange=d;this.transformation=c;this.instanceParameters=f;this.idx=g;this.dataId=n;null!=c&&(this.transformationNormal=w.mat4f64.create(),w.mat4.copy(this.transformationNormal,c),w.mat4.invert(this.transformationNormal,this.transformationNormal),w.mat4.transpose(this.transformationNormal,this.transformationNormal))}}(),
t;(function(e){e[e.Merged=0]="Merged";e[e.Instanced=1]="Instanced";e[e.Preinterleaved=2]="Preinterleaved"})(t||(t={}));var oa={updatedDisplayedIndexRange:!1,begin:0,end:0},G=w.vec2f64.create(),I=w.mat4f64.create(),P=w.mat4f64.create(),J=w.mat4f64.create();return K});