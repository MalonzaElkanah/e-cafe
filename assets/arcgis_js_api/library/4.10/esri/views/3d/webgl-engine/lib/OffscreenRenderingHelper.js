// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/compilerUtils ./glUtil3D ./RenderTargetHelper ./Util ../shaders/OffscreenPrograms ../../../webgl/Util".split(" "),function(r,t,k,l,m,n,e,h){var p=[0,0,0,0],q=[0,1,0,1];return function(){function a(c,b){this.dimensions={width:4,height:4};this._enabled=!1;this._background={type:"color",color:[0,0,0,1]};this._rctx=b;b=this.renderTargetHelper=new m.RenderTargetHelper(b);this.mainColor=b.registerColorTarget({name:"mainColor"});this.mainDepth=b.registerDepthTarget({name:"mainDepth"});
this.hudVisibility=b.registerColorTarget({name:"hudVisibility",dataType:32819});this.tmpColor=b.registerColorTarget({name:"tmpColor"});this.tmpDepth=b.registerDepthTarget({name:"tmpDepth"});this._compositeProgram=c.getProgram(e.compositePass);this._compositeTransparentToHUDVisibilityProgram=c.getProgram(e.compositeTransparentToHUDVisibilityPass)}Object.defineProperty(a.prototype,"width",{get:function(){return this.dimensions.width},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"height",{get:function(){return this.dimensions.height},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"enabled",{get:function(){return this._enabled},set:function(c){c?this.enable():this.disable()},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"background",{get:function(){return this._background},set:function(c){this._background=c},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"framebuffer",{get:function(){return this.renderTargetHelper.getFramebuffer(this.dimensions,
this.mainColor,this.mainDepth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"colorTexture",{get:function(){return this.framebuffer.colorTexture},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"depthTexture",{get:function(){return this.renderTargetHelper.getDepthTexture(this.mainDepth,this.dimensions)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hudVisibilityTexture",{get:function(){return this.getColorTexture(this.hudVisibility)},enumerable:!0,
configurable:!0});a.prototype.initializeFrame=function(c,b){n.assert(this.enabled);var a=this._rctx,d=a.gl;c=c.fullViewport;this.dimensions.width=c[2];this.dimensions.height=c[3];this.mainFbo=b;this.bindTarget(this.mainColor,this.mainDepth);a.setClearStencil(0);b=this._background.color;a.setClearColor(b[0]*b[3],b[1]*b[3],b[2]*b[3],b[3]);a.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT|d.STENCIL_BUFFER_BIT)};a.prototype.renderSeparateAndComposite=function(c,b,a){void 0===b&&(b=p);void 0===a&&(a="none");
this.renderToTargets(c,this.tmpColor,this.mainDepth,b);this.composite(this.getColorTexture(this.tmpColor),this.framebuffer,a)};a.prototype.renderHUDVisibility=function(c){this.renderToTargets(c,this.hudVisibility,this.mainDepth,q)};a.prototype.compositeTransparentTerrainOntoHUDVisibility=function(){var c=this,b=this._rctx;this.renderToTargets(function(){var a=c._compositeTransparentToHUDVisibilityProgram;b.bindProgram(a);a.setUniform1i("tex",1);b.bindTexture(c.getColorTexture(c.tmpColor),1);b.setDepthTestEnabled(!1);
b.setBlendingEnabled(!1);b.setColorMask(!1,!0,!1,!1);b.bindVAO(c.quadVAO);b.drawArrays(5,0,h.vertexCount(c.quadVAO,"geometry"));b.setColorMask(!0,!0,!0,!0);b.setDepthTestEnabled(!0)},this.hudVisibility,this.mainDepth)};a.prototype.compositeTransparentTerrainOntoMain=function(){this.composite(this.getColorTexture(this.tmpColor),this.framebuffer,"premultiplied-alpha")};a.prototype.bindFramebuffer=function(){this._rctx.bindFramebuffer(this.framebuffer)};a.prototype.renderDepthDetached=function(c){this.bindTarget(this.mainColor);
c();this.bindTarget(this.mainColor,this.mainDepth)};a.prototype.composite=function(c,b,a){void 0===c&&(c=this.framebuffer.colorTexture);void 0===b&&(b=this.mainFbo);void 0===a&&(a="none");var d=this._rctx,f=this._compositeProgram;d.bindFramebuffer(b);d.setDepthTestEnabled(!1);d.bindProgram(f);f.setUniform1i("tex",1);d.bindTexture(c,1);switch(a){case "none":d.setBlendingEnabled(!1);break;case "alpha":d.setBlendFunctionSeparate(770,771,1,771);d.setBlendingEnabled(!0);break;case "premultiplied-alpha":d.setBlendFunction(1,
771);d.setBlendingEnabled(!0);break;default:k.neverReached(a)}d.bindVAO(this.quadVAO);d.drawArrays(5,0,h.vertexCount(this.quadVAO,"geometry"));d.setDepthTestEnabled(!0);d.setBlendingEnabled(!1)};a.prototype.enable=function(){this.enabled||(this._enabled=!0,this.quadVAO=l.createQuadVAO(this._rctx))};a.prototype.disable=function(){this.enabled&&(this._enabled=!1,this.renderTargetHelper.disposeAllResource(),this.quadVAO.dispose(!0),this.quadVAO=null)};a.prototype.renderToTargets=function(a,b,e,d,f){var c=
this._rctx,g=c.gl;this.bindTarget(b,e);b=0;d&&(c.setClearColor(d[0],d[1],d[2],Math.max(1E-13,d[3])),b|=g.COLOR_BUFFER_BIT);f&&(b|=g.DEPTH_BUFFER_BIT);c.clear(b);a();g.flush();this.bindTarget(this.mainColor,this.mainDepth)};a.prototype.bindTarget=function(a,b){a=this.renderTargetHelper.getFramebuffer(this.dimensions,a,b);this._rctx.bindFramebuffer(a)};a.prototype.getColorTexture=function(a){return this.renderTargetHelper.getColorTexture(a,this.dimensions)};return a}()});