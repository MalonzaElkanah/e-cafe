// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/arrayUtils ../../../../../core/promiseUtils ../../../../../core/requireUtils ../../../../../core/workers ../../../../../core/libs/gl-matrix-2/gl-matrix ../../../support/mathUtils ../../../support/buffer/BufferView ../../../support/buffer/typedArrayUtil ../../../support/buffer/utils ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../PreinterleavedGeometryData ../TextureBackedBuffer/BufferManager ./bufferLayouts ./edgeBufferWriters ./EdgeProcessingWorker ./EdgeRenderer ./strokes ./util ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject module".split(" "),
function(Q,I,J,p,C,R,K,S,T,A,L,U,M,V,W,X,Y,N,Z,B,O,aa,v,ba,u,H,P,ca){Object.defineProperty(I,"__esModule",{value:!0});var fa=function(){function d(a,c,b){this.rctx=a;this.programRepository=c;this.callbacks=b;this.profilingCallback=null;this.perObjectData=new Map;this.renderers=new Map;this.localOrigins=new Y.LocalOriginManager(new W);this.gpuMemoryUsage=this.numberOfRenderedEdges=0;this.worker=new aa;this.workerThread=null;this.destroyed=!1;this.tmpModelPosition=A.vec3f64.create();this.tmpCameraPosition=
A.vec3f64.create();this.componentColorManager=new Z.BufferManager(this.rctx,2)}d.prototype.initialize=function(){var a=this;T.open(S.getAbsMid("./EdgeProcessingWorker",Q,ca)).then(function(c){a.destroyed?c.close():a.workerThread=c});for(var c=B.VertexLayout.createBuffer(4),b=0;4>b;b++)c.sideness.set(b,0,0===b||3===b?0:1),c.sideness.set(b,1,0===b||1===b?0:1);this.verticesBufferObject=H.createVertex(this.rctx,35044,c.buffer)};d.prototype.destroy=function(){this.destroyed||(this.workerThread&&(this.workerThread.close(),
this.workerThread=null),this.verticesBufferObject&&(this.verticesBufferObject.dispose(),this.verticesBufferObject=null),this.destroyed=!0)};d.prototype.getGpuMemoryUsage=function(){return this.gpuMemoryUsage};Object.defineProperty(d.prototype,"numberOfRenderedPrimitives",{get:function(){return this.numberOfRenderedEdges},enumerable:!0,configurable:!0});d.prototype.shouldRender=function(){return 0<this.renderers.size};d.prototype.addObject=function(a,c,b,f){return p(this,void 0,void 0,function(){var e,
m,d,g,h,k,n;return C(this,function(r){switch(r.label){case 0:if(this.hasObject(a))return[2];e=[];d={loaded:K.create(function(a){return m=a}),renderables:[]};this.perObjectData.set(a,d);if(f&&f.mergeGeometries&&1<a.geometries.length&&this.canMergeGeometries(a))e.push(this.addObjectMergedGeometries(a,d,c,b));else for(g=0;g<a.geometries.length;g++)h=a.geometries[g],k=a.geometryRecords[g],n=k.material,n.supportsEdges&&(h.data instanceof N?e.push(this.addGeometryPreinterleaved(a,d,h,h.data,k,c,b)):e.push(this.addGeometryNonPreinterleaved(a,
d,h,h.data,k,c[0],b)));return[4,K.all(e)];case 1:return r.sent(),this.callbacks.setNeedsRender(),m(),[2]}})})};d.prototype.hasObject=function(a){return this.perObjectData.has(a)};d.prototype.updateAllComponentOpacities=function(a,c){return p(this,void 0,void 0,function(){var b,f;return C(this,function(e){switch(e.label){case 0:return[4,this.getObjectEntry(a)];case 1:return b=e.sent(),f=c instanceof Array?function(a){return c[a]}:function(a){return c},b.renderables.forEach(function(a){for(var c=a.components.meta.length,
b=0;b<c;b++){var e=f(b),d=a.components.meta[b],m=d.index;d.material.opacity=e;a.components.buffer.textureBuffer.setDataElement(m,1,3,255*e)}a.allTransparent=u.determineAllTransparent(a.components.meta)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateAllComponentMaterials=function(a,c,b,f){void 0===f&&(f=!0);return p(this,void 0,void 0,function(){var e,d,q=this;return C(this,function(g){switch(g.label){case 0:return[4,this.getObjectEntry(a)];case 1:return e=g.sent(),d=b.slicePlaneEnabled||
!1,e.renderables.forEach(function(a){var b=c[0],e=u.determineRequiresUberRenderer(c),g=v.EdgeRenderer.getKey(e,b.type,d);if(g!==a.rendererKey){var m=q.renderers.get(a.rendererKey),b=q.acquireRenderer(e,b,d);m.removeRenderable(a);m.refCount.decrement();a.rendererKey=g;b.addRenderable(a)}for(g=0;g<c.length;g++)a.components.meta[g].material=c[g];f&&q.updateComponentBuffer(a.components);a.allTransparent=u.determineAllTransparent(a.components.meta)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateObjectVisibility=
function(a,c){return p(this,void 0,void 0,function(){var b;return C(this,function(f){switch(f.label){case 0:return[4,this.getObjectEntry(a)];case 1:return b=f.sent(),b.renderables.forEach(function(a){a.visible=c}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.removeObject=function(a){var c=this,b=this.perObjectData.get(a);b&&(this.perObjectData.delete(a),b.loaded.then(function(){b.renderables.forEach(function(a){c.removeRenderable(a)});c.callbacks.setNeedsRender()}))};d.prototype.getObjectEntry=
function(a){return p(this,void 0,void 0,function(){var c;return C(this,function(b){switch(b.label){case 0:c=this.perObjectData.get(a);if(!c)throw"no object";return[4,c.loaded];case 1:return b.sent(),[2,c]}})})};d.prototype.removeAll=function(){var a=this;this.perObjectData.forEach(function(c,b){a.removeObject(b)})};d.prototype.createSolidEdgeMaterial=function(a){return J({},da,a,{type:"solid"})};d.prototype.createSketchEdgeMaterial=function(a){return J({},ea,a,{type:"sketch"})};d.prototype.render=
function(a){var c=this;this.localOrigins.updateViewMatrices(a.view);this.renderers.forEach(function(a){0===a.refCount.value&&(c.renderers.delete(a.key),a.dispose())});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();var b=a.view,f=0,e=0;this.renderers.forEach(function(a){a.forEachRenderable(function(a){f+=a.statistics.averageEdgeLength;e++})});var d={distanceFalloffFactor:f/e*40,minimumEdgeLength:u.estimateLengthAtDistance(a.viewport[3],a.fovY,1,3.5)},q=this.rctx.capabilities.blendMinMax;
q?(this.rctx.setDepthWriteEnabled(!1),this.rctx.setBlendingEnabled(!0),this.rctx.setBlendEquationSeparate(32774,q.MAX),this.rctx.setBlendFunctionSeparate(1,0,1,1)):(this.rctx.setDepthWriteEnabled(!0),this.rctx.setBlendingEnabled(!1));this.rctx.setDepthTestEnabled(!0);this.rctx.setDepthFunction(515);this.updateObjectCameraDistances(a);this.numberOfRenderedEdges=0;this.renderers.forEach(function(b){c.renderRegularEdges(b,a,d);c.renderSilhouetteEdges(b,a,d)});this.rctx.setDepthWriteEnabled(!0);this.rctx.setDepthFunction(513);
this.rctx.setBlendEquationSeparate(32774,32774);this.rctx.setBlendFunctionSeparate(1,0,1,1);a.view=b};d.prototype.computeModelTransformWithLocalOrigin=function(a,c,b){a.getCombinedStaticTransformation(c,b);c.origin?this.localOrigins.register(c.origin):(a=A.vec3.set(this.tmpModelPosition,b[12],b[13],b[14]),c.origin=this.localOrigins.aquire(a));X.applyToModelMatrix(c.origin.vec3,b);return b};d.prototype.updateComponentBuffer=function(a){var c=a.meta;a=a.buffer;for(var b=0;b<c.length;b++){var f=c[b].material,
e=c[b].index,d=L.clamp(Math.round(f.size*v.LINE_WIDTH_FRACTION_FACTOR),0,255),q=L.clamp(f.extensionLength,-v.EXTENSION_LENGTH_OFFSET,255-v.EXTENSION_LENGTH_OFFSET)+v.EXTENSION_LENGTH_OFFSET,g="solid"===f.type?0:1,h=255*f.opacity,f=f.color;a.textureBuffer.setData(e,0,255*f[0],255*f[1],255*f[2],255*f[3]);a.textureBuffer.setData(e,1,d,q,g,h)}};d.prototype.createComponentBuffers=function(a){for(var c=[],b=this.componentColorManager.getBuffer(a.length),f=0;f<a.length;f++){var e=a[f],d=b.aquireIndex();
c.push({index:d,material:e})}a={meta:c,buffer:b};this.updateComponentBuffer(a);return a};d.prototype.extractEdges=function(a,c,b,f){return this.worker.process({data:c,originalIndices:f,writerSettings:a,skipDeduplicate:b},this.workerThread)};d.prototype.createEdgeResources=function(a){var c={};if(0<a.regular.lodInfo.lengths.length){var b=new P(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:O.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:H.createVertex(this.rctx,
35044,a.regular.instancesData.buffer)});c.regular={vao:b,lod:a.regular.lodInfo}}0<a.silhouette.lodInfo.lengths.length&&(b=new P(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:O.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:H.createVertex(this.rctx,35044,a.silhouette.instancesData.buffer)}),c.silhouette={vao:b,lod:a.silhouette.lodInfo});return c};d.prototype.disposeEdgeResources=function(a){a.regular&&(a.regular.vao.vertexBuffers.instances.dispose(),
a.regular.vao.dispose(!1),a.regular.vao=null);a.silhouette&&(a.silhouette.vao.vertexBuffers.instances.dispose(),a.silhouette.vao.dispose(!1),a.silhouette.vao=null)};d.prototype.addGeometryNonPreinterleaved=function(a,c,b,f,e,d,q){return p(this,void 0,void 0,function(){var b,h,m,n;return C(this,function(g){switch(g.label){case 0:return b=f.getAttribute("position"),h=this.computeModelTransformWithLocalOrigin(a,e,A.mat4f64.create()),m=e.origin,n={position:b,indices:f.getIndices("position"),modelTransform:h,
origin:m},[4,this.addNonPreinterleaved(a,c,n,d,q)];case 1:return g.sent(),[2]}})})};d.prototype.addNonPreinterleaved=function(a,c,b,f,e){return p(this,void 0,void 0,function(){var a,d,g,h,k,n,r,l,D,w,E,z,t,y,x;return C(this,function(m){switch(m.label){case 0:a=this.acquireRenderer(!1,f,e.slicePlaneEnabled||!1);d=b.modelTransform;g=b.origin;h=b.indices;k=b.position;n=k.data.length/k.strideIdx;r=B.EdgeInputBufferLayout.createBuffer(n);for(l=0;l<n;l++)r.position.set(l,0,k.data[k.offsetIdx+l*k.strideIdx+
0]),r.position.set(l,1,k.data[k.offsetIdx+l*k.strideIdx+1]),r.position.set(l,2,k.data[k.offsetIdx+l*k.strideIdx+2]);D=this.createComponentBuffers([f]);u.fillComponenBufferIndices(D.meta,[0,r.componentIndex.count],r.componentIndex);return[4,this.extractEdges(a.writerSettings,r,!1,h)];case 1:return w=m.sent(),E=this.createEdgeResources(w),z=E.regular,t=E.silhouette,y=(z?z.vao.size:0)+(t?t.vao.size:0),x={regular:z,silhouette:t,transform:{modelMatrix:d,origin:g},statistics:{gpuMemoryUsage:y,averageEdgeLength:w.averageEdgeLength},
components:D,visible:!0,allTransparent:u.determineAllTransparent(D.meta),distanceToCamera:0,rendererKey:a.key},c.renderables.push(x),a.addRenderable(x),this.gpuMemoryUsage+=y,[2]}})})};d.prototype.addGeometryPreinterleaved=function(a,c,b,f,e,d,q){return p(this,void 0,void 0,function(){var b,h,m,n,r,l,D,w,E,z,t,y,x,p,F,v,G;return C(this,function(g){switch(g.label){case 0:b=f.getAttribute("position");if(!b||!M.isFloat32Array(b.data))return console.warn("Geometry has no float32 `position` attribute, skipping it."),
[2];h=d[0];m=u.determineRequiresUberRenderer(d);n=this.acquireRenderer(m,h,q.slicePlaneEnabled||!1);r=this.computeModelTransformWithLocalOrigin(a,e,A.mat4f64.create());l=e.origin;D=f.getIndices("position");w=new U.BufferViewVec3f(b.data.buffer,4*b.offsetIdx,4*b.strideIdx);E=B.EdgeInputBufferLayout.createBuffer(w.count);V.vec3.copy(E.position,w);z=this.createComponentBuffers(d);u.fillComponenBufferIndices(z.meta,f.componentOffsets,E.componentIndex,D);t=f.hasPositionData;return[4,this.extractEdges(n.writerSettings,
E,t,D)];case 1:return y=g.sent(),x=this.createEdgeResources(y),p=x.regular,F=x.silhouette,v=(p?p.vao.size:0)+(F?F.vao.size:0),G={regular:p,silhouette:F,transform:{modelMatrix:r,origin:l},statistics:{gpuMemoryUsage:v,averageEdgeLength:y.averageEdgeLength},components:z,visible:!a.isHidden(e),allTransparent:u.determineAllTransparent(z.meta),distanceToCamera:0,rendererKey:n.key},c.renderables.push(G),n.addRenderable(G),this.gpuMemoryUsage+=v,[2]}})})};d.prototype.canMergeGeometries=function(a){for(var c=
null,b=null,f=0;f<a.geometries.length;f++){var e=a.geometryRecords[f];if(e.material.supportsEdges){if(a.geometries[f].data instanceof N)return!1;if(!c)c=e.transformation;else if(!R.equals(c,e.transformation))return!1;if(!b&&e.origin)b=e;else if(b&&e.origin&&b.origin.id!==e.origin.id)return!1}}return!0};d.prototype.addObjectMergedGeometries=function(a,c,b,f){return p(this,void 0,void 0,function(){var e,d,q,g,h,k,n,r,l,p,w,v,z,t,y,x,u,F,B,G,H;return C(this,function(m){switch(m.label){case 0:e=new Map;
d=0;g=q=null;for(h=0;h<a.geometries.length;h++)if(k=a.geometries[h],n=a.geometryRecords[h],r=n.material,r.supportsEdges&&(!g&&n.origin&&(g=n),l=k.data.getIndices("position"),d+=l?l.length:0,l&&null==q||q===Uint16Array))q=M.isUint16Array(l)?Uint16Array:Uint32Array;p=d?new q(d):null;w=[];for(h=v=0;h<a.geometries.length;h++)if(k=a.geometries[h],z=a.geometryRecords[h],r=z.material,r.supportsEdges){t=k.data.getAttribute("position");l=k.data.getIndices("position");y=e.get(t.data);if(null==y){y=w.length/
3;for(x=t.offsetIdx;x<t.data.length;x+=t.strideIdx)w.push(t.data[x+0]),w.push(t.data[x+1]),w.push(t.data[x+2]);e.set(t.data,y)}if(l)for(u=0;u<l.length;u++)p[v++]=y+l[u]}F=g||a.geometryRecords[0];B=this.computeModelTransformWithLocalOrigin(a,F,A.mat4f64.create());G=F.origin;for(h=0;h<a.geometryRecords.length;h++)a.geometryRecords[h].origin=G;H={position:{data:w,offsetIdx:0,strideIdx:3},indices:p,modelTransform:B,origin:G};return[4,this.addNonPreinterleaved(a,c,H,b[0],f)];case 1:return m.sent(),[2]}})})};
d.prototype.acquireRenderer=function(a,c,b){var d=v.EdgeRenderer.getKey(a,c.type,b),e=this.renderers.get(d);this.strokesTexture||(this.strokesTexture=ba.generateStrokesTexture(this.rctx));e||(e=new v.EdgeRenderer(this.rctx,this.programRepository,{type:c.type,slicePlaneEnabled:b,strokesTexture:this.strokesTexture,uber:a}),this.renderers.set(d,e));e.refCount.increment();return e};d.prototype.removeRenderable=function(a){var c=this.renderers.get(a.rendererKey);c.removeRenderable(a);c.refCount.decrement();
this.disposeEdgeResources(a);this.localOrigins.release(a.transform.origin);this.gpuMemoryUsage-=a.statistics.gpuMemoryUsage;for(var c=0,b=a.components.meta;c<b.length;c++)a.components.buffer.releaseIndex(b[c].index)};d.prototype.updateObjectCameraDistances=function(a){var c=this;a=a.viewInvTransp;A.vec3.set(this.tmpCameraPosition,a[3],a[7],a[11]);this.perObjectData.forEach(function(a,d){var b=A.vec3.distance(d.getCenter(),c.tmpCameraPosition);a.renderables.forEach(function(a){return a.distanceToCamera=
b})})};d.prototype.renderRegularEdges=function(a,c,b){var d=this;a.bindRegularEdges(c,b);a.forEachRenderable(function(e){if(e.visible&&e.regular&&!e.allTransparent){var f=u.computeEdgeCount(e.regular.lod.lengths,e.distanceToCamera,b);c.view=d.localOrigins.getViewMatrix(e.transform.origin);a.renderRegularEdges(e,c,f);d.numberOfRenderedEdges+=f}})};d.prototype.renderSilhouetteEdges=function(a,c,b){var d=this;a.bindSilhouetteEdges(c,b);a.forEachRenderable(function(e){if(e.visible&&e.silhouette&&!e.allTransparent){var f=
u.computeEdgeCount(e.silhouette.lod.lengths,e.distanceToCamera,b);c.view=d.localOrigins.getViewMatrix(e.transform.origin);a.renderSilhouetteEdges(e,c,f);d.numberOfRenderedEdges+=f}})};return d}();I.EdgeView=fa;var da={color:A.vec4f64.fromValues(0,0,0,.2),size:1,extensionLength:0,opacity:1},ea={color:A.vec4f64.fromValues(0,0,0,.2),size:1,extensionLength:0,opacity:1}});