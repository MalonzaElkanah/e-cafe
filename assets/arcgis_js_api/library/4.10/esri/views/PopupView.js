// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/awaiterHelper ../core/tsSupport/generatorHelper ../core/Accessor ../core/arrayUtils ../core/promiseUtils ../core/accessorSupport/decorators".split(" "),function(w,x,y,r,t,l,m,u,v,p,q){return function(n){function b(){return null!==n&&n.apply(this,arguments)||this}r(b,n);b.prototype.fetchPopupFeatures=function(a){return this._fetchPopupFeaturesAsync(a)};b.prototype._fetchPopupFeaturesAsync=
function(a){return l(this,void 0,void 0,function(){var c,g,b,e,d,h;return m(this,function(k){switch(k.label){case 0:return[4,this.when()];case 1:return k.sent(),[4,this._prepareFetchPopupFeatures(a)];case 2:return c=k.sent(),g=c.mapPoint,b=this._queryLayerPopupFeatures(c),e=p.resolve(c.clientOnlyGraphics),d=[e].concat(b),h=p.eachAlwaysValues(d).then(v.concatAll),[2,{promise:h,location:g,promises:d}]}})})};b.prototype._queryLayerPopupFeatures=function(a){var c=a.mapPoint;return a.layerViewsAndGraphics.map(function(a){return a.layerView.fetchPopupFeatures(c,
a.graphics)})};b.prototype._isValidPopupGraphic=function(a){return a&&!!a.getEffectivePopupTemplate()};b.prototype._prepareFetchPopupFeatures=function(a){return l(this,void 0,void 0,function(){var c,b,f,e,d,h,k;return m(this,function(g){switch(g.label){case 0:return[4,this._popupHitTestGraphics(a)];case 1:return c=g.sent(),b=c.clientGraphics,f=c.mapPoint,e=this._getFetchPopupLayerViews(),d=this._graphicsPerFetchPopupLayerView(b,e),h=d.layerViewsAndGraphics,k=d.clientOnlyGraphics,[2,{clientOnlyGraphics:k,
layerViewsAndGraphics:h,mapPoint:f}]}})})};b.prototype._popupHitTestGraphics=function(a){return l(this,void 0,void 0,function(){var c,b,f,e,d=this;return m(this,function(g){switch(g.label){case 0:return[4,this.popupHitTest(a)];case 1:return c=g.sent(),b=c.results,f=c.mapPoint,e=b.map(function(a){return a.graphic}).filter(function(a){return d._isValidPopupGraphic(a)}),[2,{clientGraphics:e,mapPoint:f}]}})})};b.prototype._getFetchPopupLayerViews=function(){var a=this,c=[];this.allLayerViews.forEach(function(b){a._isValidPopupLayerView(b)&&
c.push(b)});this._isValidPopupLayerView(this.graphicsView)&&c.push(this.graphicsView);return c};b.prototype._isValidPopupLayerView=function(a){return a&&(!("layer"in a)||!a.suspended)&&"function"===typeof a.fetchPopupFeatures};b.prototype._graphicsPerFetchPopupLayerView=function(a,b){var c=[],f=new Map;b=b.map(function(a){var b=[];"layer"in a?f.set(a.layer,b):f.set(a.graphics,b);return{layerView:a,graphics:b}});for(var e=0;e<a.length;e++){var d=a[e],h=f.get(d.layer)||null;h?h.push(d):c.push(d)}return{layerViewsAndGraphics:b,
clientOnlyGraphics:c}};return b=t([q.subclass("esri.views.PopupView")],b)}(q.declared(u))});